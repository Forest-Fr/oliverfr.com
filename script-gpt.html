<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ScriptGPT</title>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;display:flex;flex-direction:column;height:100vh;}
    #app{flex:1;display:flex;overflow:hidden;}
    #sidebar{width:280px;border-right:1px solid #ccc;padding:16px;box-sizing:border-box;overflow:auto;}
    #main{flex:1;display:flex;flex-direction:column;}
    .section{margin-bottom:16px;}
    select,input,textarea,button{width:100%;margin-top:4px;padding:8px;box-sizing:border-box;}
    #code{flex:1;font-family:monospace;white-space:pre;overflow:auto;padding:16px;background:#f9f9f9;}
  </style>
</head>
<body>

  <h1 style="padding:16px;margin:0;border-bottom:1px solid #ddd;">ScriptGPT 增强脚本生成器</h1>
  <div id="app">
    <div id="sidebar">
      <!-- 1. 需求输入 -->
      <div class="section">
        <label>1. 自然语言需求：</label>
        <textarea id="req" rows="4" placeholder="比如：帮我生成一个 GitHub Actions Workflow，用来 CI 测试 Node.js 项目…"></textarea>
      </div>

      <!-- 2. 模板选择 -->
      <div class="section">
        <label>2. 选择脚本类型：</label>
        <select id="tpl">
          <option value="github-actions">GitHub Actions</option>
          <option value="terraform-aws">Terraform AWS</option>
          <option value="dockerfile">Dockerfile</option>
          <!-- 更多模板… -->
        </select>
      </div>

      <!-- 3. 参数配置 -->
      <div class="section">
        <label>3. 参数配置 (JSON)：</label>
        <textarea id="params" rows="4" placeholder='{"node_version":"16","region":"us-east-1"}'></textarea>
      </div>

      <!-- 4. 操作按钮 -->
      <div class="section">
        <button id="btnGenerate">生成脚本</button>
        <button id="btnValidate" disabled>Lint 校验</button>
        <button id="btnExecute" disabled>一键执行 (Sandbox)</button>
      </div>
    </div>

    <div id="main">
      <div id="code">等待生成…</div>
    </div>
  </div>

  <script>
  (function(){
    const API_BASE = 'https://script-gpt.mefans.workers.dev/';
    const $=id=>document.getElementById(id);
    const reqEl       = $('req');
    const tplEl       = $('tpl');
    const paramsEl    = $('params');
    const btnGen      = $('btnGenerate');
    const btnVal      = $('btnValidate');
    const btnExe      = $('btnExecute');
    const codeEl      = $('code');

    let currentScript = '';

    // SSE 订阅工具
    async function streamTo(el, url, body){
      el.textContent = '';
      const resp = await fetch(url, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(body)
      });
      if (!resp.ok) {
        el.textContent = `Error ${resp.status}`;
        return;
      }
      const reader = resp.body.getReader(), decoder = new TextDecoder();
      let buf = '';
      while(true){
        const {value,done} = await reader.read();
        if(done) break;
        buf += decoder.decode(value,{stream:true});
        const parts = buf.split('\n\n');
        buf = parts.pop();
        for(const chunk of parts){
          const m = chunk.match(/^data: (.+)$/m);
          if(m && m[1] !== '[DONE]'){
            el.textContent += m[1];
            el.scrollTop = el.scrollHeight;
          }
        }
      }
      currentScript = el.textContent;
      btnVal.disabled = false;
      btnExe.disabled = false;
    }

    // 生成脚本
    btnGen.onclick = () => {
      const req    = reqEl.value.trim();
      const tpl    = tplEl.value;
      let params   = {};
      try{ params = paramsEl.value ? JSON.parse(paramsEl.value) : {}; }
      catch(e){ return alert('参数 JSON 格式错误'); }

      streamTo(codeEl, API_BASE + '/api/generate-script', {
        requirement: req, template: tpl, parameters: params
      });
    };

    // lint 校验 (demo stub)
    btnVal.onclick = async () => {
      const resp = await fetch(API_BASE + '/api/validate-script', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ script: currentScript })
      });
      const result = await resp.json();
      alert(result.success ? 'Lint 通过' : '发现问题：\n' + result.issues.join('\n'));
    };

    // 一键执行 (sandbox stub)
    btnExe.onclick = async () => {
      const resp = await fetch(API_BASE + '/api/execute-script', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ script: currentScript })
      });
      const log = await resp.text();
      alert('执行日志：\n' + log);
    };

  })();
  </script>

</body>
</html>
