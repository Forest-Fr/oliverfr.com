<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workflow Console</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1120;
      --card:#0f172a;
      --border:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --accent:#38bdf8;
      --danger:#ef4444;
      --ok:#22c55e;
      --warn:#f59e0b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      --radius: 14px;
    }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(56,189,248,.10), transparent 60%),
                  radial-gradient(900px 500px at 90% 10%, rgba(34,197,94,.08), transparent 55%),
                  var(--bg);
      color: var(--text);
    }
    .wrap{
      max-width: 1100px;
      margin: 26px auto 60px;
      padding: 0 16px;
    }
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom: 14px;
    }
    h1{
      font-size: 20px;
      margin:0;
      letter-spacing:.2px;
    }
    .sub{
      margin-top:6px;
      color: var(--muted);
      font-size: 13px;
      line-height: 1.4;
      max-width: 720px;
    }
    .statusBadge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border:1px solid var(--border);
      border-radius: 999px;
      background: rgba(15,23,42,.65);
      white-space: nowrap;
      font-size: 13px;
      color: var(--muted);
    }
    .dot{
      width:10px;height:10px;border-radius:50%;
      background: #64748b;
      box-shadow: 0 0 0 4px rgba(100,116,139,.15);
    }
    .dot.ok{ background: var(--ok); box-shadow: 0 0 0 4px rgba(34,197,94,.15); }
    .dot.bad{ background: var(--danger); box-shadow: 0 0 0 4px rgba(239,68,68,.15); }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      .top{ flex-direction: column; }
    }
    .card{
      background: rgba(15,23,42,.72);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: 0 10px 24px rgba(0,0,0,.22);
    }
    .card h2{
      font-size: 14px;
      margin: 0 0 10px;
      color: #dbeafe;
      letter-spacing: .2px;
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      margin-bottom: 10px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
    }
    input, textarea, select{
      width: 100%;
      box-sizing: border-box;
      background: rgba(2,6,23,.55);
      border: 1px solid rgba(148,163,184,.25);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 10px;
      outline: none;
      font-family: var(--sans);
      font-size: 13px;
    }
    input:focus, textarea:focus{
      border-color: rgba(56,189,248,.65);
      box-shadow: 0 0 0 4px rgba(56,189,248,.12);
    }
    textarea{
      min-height: 120px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.45;
      resize: vertical;
    }
    .col{
      flex: 1 1 260px;
      min-width: 240px;
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    button{
      appearance: none;
      border: 1px solid rgba(148,163,184,.22);
      background: rgba(2,6,23,.35);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor: pointer;
      font-size: 13px;
      transition: transform .06s ease, border-color .15s ease, background .15s ease;
    }
    button:hover{
      border-color: rgba(56,189,248,.50);
      background: rgba(56,189,248,.10);
    }
    button:active{ transform: translateY(1px); }
    button.primary{
      border-color: rgba(56,189,248,.55);
      background: rgba(56,189,248,.14);
    }
    button.danger{
      border-color: rgba(239,68,68,.45);
      background: rgba(239,68,68,.10);
    }
    button:disabled{
      opacity: .55;
      cursor: not-allowed;
    }
    .kv{
      display:grid;
      grid-template-columns: 160px 1fr;
      gap: 8px 10px;
      font-size: 12px;
      margin-top: 10px;
    }
    .k{ color: var(--muted); }
    .v{
      font-family: var(--mono);
      overflow-wrap:anywhere;
    }
    .hint{
      margin-top:10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.45;
    }
    .out{
      margin-top: 10px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.45);
      padding: 10px;
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.45;
      white-space: pre-wrap;
      word-break: break-word;
      min-height: 220px;
    }
    .mini{
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(2,6,23,.30);
      font-family: var(--mono);
      font-size: 11px;
      color: var(--muted);
      overflow-wrap:anywhere;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Workflow Console</h1>
        <div class="sub">
          面向展示与验收：通过 Gateway 触发 Temporal Workflow / Activity，并把关键链路字段（workflow_id/job_id/run_id/traceparent/x-request-id）直接呈现，
          便于在 Grafana Tempo 里检索同一条链路，验证 Service Graph、瀑布图和 Span 树。
          本页面不包含任何密钥，不直连数据库，不触碰管理权限边界。
        </div>
      </div>
      <div class="statusBadge" id="badge">
        <span class="dot" id="badgeDot"></span>
        <span id="badgeText">Not checked</span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>1) Connection</h2>
        <div class="row">
          <div class="col">
            <label>Gateway URL (base)</label>
            <input id="gatewayUrl" placeholder="e.g. https://workflow-gateway-xxxx.us-central1.run.app" />
            <div class="mini">提示：建议将本页面部署在你的域名下；若跨域报错，需要 Gateway 允许你的页面 Origin。</div>
          </div>
          <div class="col">
            <label>Grafana URL (optional, for convenience)</label>
            <input id="grafanaUrl" placeholder="e.g. https://YOUR-STACK.grafana.net" />
            <div class="mini">仅用于生成快捷跳转链接，不会发请求。</div>
          </div>
        </div>

        <div class="btnRow">
          <button class="primary" id="btnReady">Check Gateway /readyz</button>
          <button id="btnSave">Save Settings</button>
          <button class="danger" id="btnReset">Reset</button>
        </div>

        <div class="kv">
          <div class="k">Last check</div><div class="v" id="lastCheck">-</div>
          <div class="k">Ready result</div><div class="v" id="readyResult">-</div>
        </div>
      </div>

      <div class="card">
        <h2>2) Trace Context (deterministic, for Tempo search)</h2>
        <div class="row">
          <div class="col">
            <label>workflow_id</label>
            <input id="workflowId" />
          </div>
          <div class="col">
            <label>job_id</label>
            <input id="jobId" />
          </div>
        </div>

        <div class="row">
          <div class="col">
            <label>x-request-id (we generate & send)</label>
            <input id="xRequestId" />
          </div>
          <div class="col">
            <label>traceparent (W3C)</label>
            <input id="traceparent" />
          </div>
        </div>

        <div class="btnRow">
          <button id="btnNewIds">Generate New IDs</button>
          <button id="btnCopyKeys">Copy Keys</button>
          <button id="btnOpenGrafana" class="primary">Open Grafana (if set)</button>
        </div>

        <div class="hint">
          Tempo 检索建议（复制到 Explore / TraceQL 或搜索栏）：
          <span class="pill">service.name="workflow-gateway"</span>
          <span class="pill">job_id="&lt;job_id&gt;"</span>
          <span class="pill">temporal.workflow_id="&lt;workflow_id&gt;"</span>
          <span class="pill">trace_id="&lt;x-request-id&gt;"</span>
        </div>
      </div>

      <div class="card">
        <h2>3) Start Workflow (DocWorkflow)</h2>

        <div class="row">
          <div class="col">
            <label>payload (JSON)</label>
            <textarea id="payload">{ "doc": "demo", "note": "from workflow-console.html" }</textarea>
          </div>
        </div>

        <div class="btnRow">
          <button class="primary" id="btnStartDoc">POST /workflow/doc/start</button>
          <button id="btnDocStatus">GET /workflow/doc/status (wait result)</button>
        </div>

        <div class="kv">
          <div class="k">run_id</div><div class="v" id="runId">-</div>
          <div class="k">last endpoint</div><div class="v" id="lastEndpoint">-</div>
        </div>

        <div class="hint">
          说明：Gateway 的 <span class="pill">/workflow/doc/status</span> 会等待 workflow 完成并返回 result（用于瀑布图和跨组件链路验收）。
        </div>
      </div>

      <div class="card">
        <h2>4) Ops (optional): Neon Jobs Store via Gateway</h2>

        <div class="row">
          <div class="col">
            <label>List jobs: status / q / page</label>
            <div class="row" style="margin-bottom:0;">
              <div class="col"><input id="opsStatus" placeholder="status (optional)" /></div>
              <div class="col"><input id="opsQ" placeholder="q (optional)" /></div>
            </div>
            <div class="row" style="margin-bottom:0;">
              <div class="col"><input id="opsPage" placeholder="page" value="1" /></div>
              <div class="col"><input id="opsPageSize" placeholder="page_size" value="20" /></div>
            </div>
          </div>
        </div>

        <div class="btnRow">
          <button id="btnOpsList">GET /ops/jobs</button>
          <button id="btnOpsGet">GET /ops/jobs/{job_id}</button>
        </div>

        <div class="hint">
          说明：这里只做只读展示，不做删除/写库操作；符合“前端不触碰管理权限”的边界。
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:14px;">
      <h2>Output</h2>
      <div class="mini" id="outMeta">-</div>
      <div class="out" id="out">Ready.</div>
    </div>
  </div>

<script>
  // ---------- utilities ----------
  const $ = (id) => document.getElementById(id);

  function nowIso(){
    return new Date().toISOString();
  }

  function safeJsonParse(s){
    try { return { ok:true, value: JSON.parse(s) }; }
    catch(e){ return { ok:false, error: String(e) }; }
  }

  function bytesToHex(bytes){
    return Array.from(bytes).map(b => b.toString(16).padStart(2,'0')).join('');
  }

  function randomHex(nBytes){
    const arr = new Uint8Array(nBytes);
    crypto.getRandomValues(arr);
    return bytesToHex(arr);
  }

  // W3C traceparent: version(2)-traceid(32)-spanid(16)-flags(2)
  function newTraceparent(){
    const traceId = randomHex(16); // 16 bytes => 32 hex
    const spanId  = randomHex(8);  // 8 bytes  => 16 hex
    const flags = "01"; // sampled
    return `00-${traceId}-${spanId}-${flags}`;
  }

  function newId(prefix){
    const hex = randomHex(8);
    return `${prefix}-${hex}`;
  }

  function normalizeBaseUrl(u){
    u = (u || "").trim();
    if (!u) return "";
    // remove trailing slash
    return u.replace(/\/+$/,"");
  }

  function setBadge(ok, text){
    const dot = $("badgeDot");
    const t = $("badgeText");
    dot.classList.remove("ok","bad");
    if (ok === true) dot.classList.add("ok");
    if (ok === false) dot.classList.add("bad");
    t.textContent = text || "Not checked";
  }

  function showOutput(obj, meta){
    $("outMeta").textContent = meta || "";
    if (typeof obj === "string") {
      $("out").textContent = obj;
      return;
    }
    try{
      $("out").textContent = JSON.stringify(obj, null, 2);
    }catch(e){
      $("out").textContent = String(obj);
    }
  }

  function getSettings(){
    return {
      gatewayUrl: normalizeBaseUrl(localStorage.getItem("wf_console_gateway") || ""),
      grafanaUrl: normalizeBaseUrl(localStorage.getItem("wf_console_grafana") || "")
    };
  }

  function saveSettings(gatewayUrl, grafanaUrl){
    localStorage.setItem("wf_console_gateway", normalizeBaseUrl(gatewayUrl));
    localStorage.setItem("wf_console_grafana", normalizeBaseUrl(grafanaUrl));
  }

  function resetSettings(){
    localStorage.removeItem("wf_console_gateway");
    localStorage.removeItem("wf_console_grafana");
  }

  function ensureIdsIfEmpty(){
    if (!$("workflowId").value.trim()) $("workflowId").value = newId("wf");
    if (!$("jobId").value.trim()) $("jobId").value = $("workflowId").value.trim();
    if (!$("xRequestId").value.trim()) $("xRequestId").value = newId("req");
    if (!$("traceparent").value.trim()) $("traceparent").value = newTraceparent();
  }

  async function callApi(method, path, bodyObj){
    const base = normalizeBaseUrl($("gatewayUrl").value);
    if (!base) throw new Error("Gateway URL is empty.");

    ensureIdsIfEmpty();

    const url = base + path;

    const headers = {
      "content-type": "application/json",
      "x-request-id": $("xRequestId").value.trim(),
      "traceparent": $("traceparent").value.trim(),
    };

    // Keep these keys visible for your gateway span attributes / neon store linkage
    // (Your gateway code already attaches job_id/temporal.workflow_id to current span)
    headers["x-oliverfr-job-id"] = $("jobId").value.trim();
    headers["x-oliverfr-workflow-id"] = $("workflowId").value.trim();

    const init = { method, headers };

    if (bodyObj !== undefined && bodyObj !== null){
      init.body = JSON.stringify(bodyObj);
    }

    $("lastEndpoint").textContent = `${method} ${path}`;

    const started = performance.now();
    let res, text;
    try{
      res = await fetch(url, init);
      text = await res.text();
    }catch(e){
      throw new Error(`Fetch failed: ${String(e)}`);
    }
    const ms = Math.round(performance.now() - started);

    let parsed = text;
    try{ parsed = JSON.parse(text); } catch(e){ /* keep as text */ }

    return { ok: res.ok, status: res.status, ms, url, data: parsed };
  }

  function copyToClipboard(s){
    return navigator.clipboard.writeText(s);
  }

  // ---------- init ----------
  (function init(){
    const st = getSettings();
    $("gatewayUrl").value = st.gatewayUrl;
    $("grafanaUrl").value = st.grafanaUrl;

    $("workflowId").value = localStorage.getItem("wf_console_workflowId") || "";
    $("jobId").value      = localStorage.getItem("wf_console_jobId") || "";
    $("xRequestId").value = localStorage.getItem("wf_console_xRequestId") || "";
    $("traceparent").value= localStorage.getItem("wf_console_traceparent") || "";
    $("runId").textContent= localStorage.getItem("wf_console_runId") || "-";

    ensureIdsIfEmpty();

    // persist ids on change
    ["workflowId","jobId","xRequestId","traceparent"].forEach(id=>{
      $(id).addEventListener("change", ()=>{
        localStorage.setItem("wf_console_"+id, $(id).value.trim());
      });
    });
  })();

  // ---------- handlers ----------
  $("btnSave").addEventListener("click", ()=>{
    saveSettings($("gatewayUrl").value, $("grafanaUrl").value);
    showOutput({ ok:true, saved:true, at: nowIso(), settings: getSettings() }, "Saved settings");
  });

  $("btnReset").addEventListener("click", ()=>{
    resetSettings();
    $("gatewayUrl").value = "";
    $("grafanaUrl").value = "";
    setBadge(null,"Not checked");
    showOutput({ ok:true, reset:true, at: nowIso() }, "Reset done");
  });

  $("btnNewIds").addEventListener("click", ()=>{
    $("workflowId").value = newId("wf");
    $("jobId").value = $("workflowId").value;
    $("xRequestId").value = newId("req");
    $("traceparent").value = newTraceparent();
    localStorage.setItem("wf_console_workflowId", $("workflowId").value.trim());
    localStorage.setItem("wf_console_jobId", $("jobId").value.trim());
    localStorage.setItem("wf_console_xRequestId", $("xRequestId").value.trim());
    localStorage.setItem("wf_console_traceparent", $("traceparent").value.trim());
    $("runId").textContent = "-";
    localStorage.removeItem("wf_console_runId");

    showOutput({
      ok:true,
      workflow_id: $("workflowId").value.trim(),
      job_id: $("jobId").value.trim(),
      "x-request-id": $("xRequestId").value.trim(),
      traceparent: $("traceparent").value.trim(),
      at: nowIso()
    }, "Generated new IDs");
  });

  $("btnCopyKeys").addEventListener("click", async ()=>{
    const s =
`workflow_id=${$("workflowId").value.trim()}
job_id=${$("jobId").value.trim()}
x-request-id=${$("xRequestId").value.trim()}
traceparent=${$("traceparent").value.trim()}
run_id=${($("runId").textContent || "").trim()}`;
    try{
      await copyToClipboard(s);
      showOutput({ ok:true, copied:true, at: nowIso(), keys: s }, "Copied keys to clipboard");
    }catch(e){
      showOutput({ ok:false, error: String(e), keys: s }, "Copy failed (browser permission?)");
    }
  });

  $("btnOpenGrafana").addEventListener("click", ()=>{
    const g = normalizeBaseUrl($("grafanaUrl").value);
    if (!g){
      showOutput({ ok:false, error:"Grafana URL not set." }, "Open Grafana");
      return;
    }
    window.open(g, "_blank", "noopener,noreferrer");
  });

  $("btnReady").addEventListener("click", async ()=>{
    setBadge(null,"Checking...");
    $("lastCheck").textContent = nowIso();

    try{
      const r = await callApi("GET", "/readyz");
      $("readyResult").textContent = `HTTP ${r.status} (${r.ms}ms)`;
      setBadge(r.ok, r.ok ? "Gateway ready" : "Gateway not ready");
      showOutput(r, "GET /readyz");
    }catch(e){
      $("readyResult").textContent = "failed";
      setBadge(false, "Check failed");
      showOutput({ ok:false, error: String(e) }, "GET /readyz failed");
    }
  });

  $("btnStartDoc").addEventListener("click", async ()=>{
    const p = safeJsonParse($("payload").value || "{}");
    if (!p.ok){
      showOutput({ ok:false, error:"Payload JSON invalid", detail: p.error }, "Payload parse failed");
      return;
    }

    const body = {
      workflow_id: $("workflowId").value.trim(),
      job_id: $("jobId").value.trim(),
      payload: p.value
    };

    showOutput({ note:"Starting DocWorkflow...", body }, "POST /workflow/doc/start");
    try{
      const r = await callApi("POST", "/workflow/doc/start", body);
      // try capture run_id
      const runId = (r.data && r.data.run_id) ? String(r.data.run_id) : "";
      if (runId){
        $("runId").textContent = runId;
        localStorage.setItem("wf_console_runId", runId);
      }
      showOutput({
        ...r,
        keys: {
          workflow_id: $("workflowId").value.trim(),
          job_id: $("jobId").value.trim(),
          "x-request-id": $("xRequestId").value.trim(),
          traceparent: $("traceparent").value.trim(),
          run_id: runId || null
        }
      }, "POST /workflow/doc/start");
    }catch(e){
      showOutput({ ok:false, error: String(e) }, "POST /workflow/doc/start failed");
    }
  });

  $("btnDocStatus").addEventListener("click", async ()=>{
    const wid = $("workflowId").value.trim();
    const rid = ($("runId").textContent || "").trim();
    if (!wid){
      showOutput({ ok:false, error:"workflow_id empty" }, "Cannot call status");
      return;
    }

    const qs = new URLSearchParams({ workflow_id: wid });
    if (rid && rid !== "-") qs.set("run_id", rid);

    showOutput({ note:"Fetching DocWorkflow result (this may wait until completed)...", workflow_id: wid, run_id: rid || null }, "GET /workflow/doc/status");
    try{
      const r = await callApi("GET", "/workflow/doc/status?" + qs.toString());
      showOutput({
        ...r,
        keys: {
          workflow_id: wid,
          job_id: $("jobId").value.trim(),
          "x-request-id": $("xRequestId").value.trim(),
          traceparent: $("traceparent").value.trim(),
          run_id: rid && rid !== "-" ? rid : (r.data && r.data.run_id ? String(r.data.run_id) : null)
        }
      }, "GET /workflow/doc/status");
    }catch(e){
      showOutput({ ok:false, error: String(e) }, "GET /workflow/doc/status failed");
    }
  });

  $("btnOpsList").addEventListener("click", async ()=>{
    const qs = new URLSearchParams();
    const st = $("opsStatus").value.trim();
    const q = $("opsQ").value.trim();
    const page = $("opsPage").value.trim() || "1";
    const ps = $("opsPageSize").value.trim() || "20";
    if (st) qs.set("status", st);
    if (q) qs.set("q", q);
    qs.set("page", page);
    qs.set("page_size", ps);

    showOutput({ note:"Listing jobs..." }, "GET /ops/jobs");
    try{
      const r = await callApi("GET", "/ops/jobs?" + qs.toString());
      showOutput(r, "GET /ops/jobs");
    }catch(e){
      showOutput({ ok:false, error: String(e) }, "GET /ops/jobs failed");
    }
  });

  $("btnOpsGet").addEventListener("click", async ()=>{
    const jobId = $("jobId").value.trim();
    if (!jobId){
      showOutput({ ok:false, error:"job_id empty" }, "GET /ops/jobs/{job_id}");
      return;
    }
    showOutput({ note:"Fetching job...", job_id: jobId }, "GET /ops/jobs/{job_id}");
    try{
      const r = await callApi("GET", "/ops/jobs/" + encodeURIComponent(jobId));
      showOutput(r, "GET /ops/jobs/" + jobId);
    }catch(e){
      showOutput({ ok:false, error: String(e) }, "GET /ops/jobs/{job_id} failed");
    }
  });
</script>
</body>
</html>
