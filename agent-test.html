<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Agent Worker 测试面板</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-page: #edf2ff;
      --bg-card: #ffffff;
      --bg-card-soft: #f5f7ff;
      --border-subtle: #e2e8ff;
      --border-strong: #c7d2fe;
      --text-main: #111827;
      --text-sub: #6b7280;
      --text-mute: #9ca3af;
      --accent: #4f46e5;
      --accent-soft: rgba(79, 70, 229, 0.1);
      --accent-strong: #3730a3;
      --danger: #ef4444;
      --radius-lg: 18px;
      --radius-md: 10px;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.14);
      --shadow-subtle: 0 8px 20px rgba(15, 23, 42, 0.12);
      --sidebar-width: 280px;
      --insight-width: 320px;
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e0e7ff 0, #eef2ff 55%, #e5e7eb 100%);
      color: var(--text-main);
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 20px;
    }

    .app-shell {
      display: flex;
      flex-direction: row;
      width: min(1320px, 100%);
      height: 100%;
      max-height: 880px;
      background: linear-gradient(145deg, #f9fafb, #eef2ff);
      border-radius: 26px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.45);
      position: relative;
    }

    /* 左侧：会话列表 */

    .sidebar {
      width: var(--sidebar-width);
      background: radial-gradient(circle at top left, #1e293b 0, #020617 60%);
      color: #e5e7eb;
      padding: 18px 18px 16px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      border-right: 1px solid rgba(148, 163, 184, 0.3);
      position: relative;
      z-index: 1;
    }

    .sidebar-header {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .sidebar-title-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .sidebar-title {
      font-weight: 700;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.35);
    }

    .sidebar-subtitle {
      font-size: 12px;
      color: #9ca3af;
    }

    .sidebar-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tag-chip {
      font-size: 11px;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.65);
      color: #e5e7eb;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: radial-gradient(circle at top, rgba(148, 163, 184, 0.26), transparent);
    }

    .tag-chip strong {
      font-weight: 600;
    }

    .sidebar-divider {
      height: 1px;
      background: linear-gradient(to right, rgba(148, 163, 184, 0.5), transparent);
      margin-top: 6px;
    }

    .sidebar-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }

    .btn-new-session {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: #f9fafb;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(79, 70, 229, 0.5);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, background 0.1s ease-out;
    }

    .btn-new-session:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 24px rgba(79, 70, 229, 0.6);
      background: linear-gradient(135deg, #4338ca, #4f46e5);
    }

    .btn-new-session:active {
      transform: translateY(0);
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.6);
    }

    .btn-icon {
      width: 16px;
      height: 16px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.4);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .sidebar-env {
      font-size: 11px;
      color: #9ca3af;
      padding: 3px 7px;
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.8);
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(15, 23, 42, 0.45);
    }

    .sidebar-env-dot {
      width: 5px;
      height: 5px;
      border-radius: 999px;
      background: #22c55e;
    }

    .session-list {
      flex: 1;
      margin-top: 4px;
      padding-top: 4px;
      overflow: hidden auto;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .session-item {
      position: relative;
      border-radius: 12px;
      padding: 8px 9px;
      cursor: pointer;
      border: 1px solid transparent;
      background: rgba(15, 23, 42, 0.45);
      display: flex;
      flex-direction: column;
      gap: 4px;
      transition: background 0.08s ease-out, border 0.08s ease-out, transform 0.06s ease-out;
    }

    .session-item:hover {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(148, 163, 184, 0.7);
    }

    .session-item.active {
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.6), rgba(37, 99, 235, 0.6));
      border-color: #c7d2fe;
      transform: translateX(2px);
    }

    .session-header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .session-header-left {
      display: flex;
      align-items: center;
      gap: 4px;
      flex: 1;
      min-width: 0;
    }

    .session-title {
      font-size: 13px;
      font-weight: 500;
      color: #e5e7eb;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      max-width: 160px;
    }

    .btn-rename-session {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 11px;
      padding: 0;
      cursor: pointer;
      opacity: 0;
      transition: opacity 0.08s ease-out, color 0.08s ease-out;
    }

    .session-item:hover .btn-rename-session {
      opacity: 1;
    }

    .btn-rename-session:hover {
      color: #e5e7eb;
    }

    .session-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
    }

    .session-tokens {
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      border: 1px solid rgba(148, 163, 184, 0.7);
      font-size: 10px;
    }

    .btn-delete-session {
      border: none;
      background: transparent;
      color: #9ca3af;
      font-size: 13px;
      padding: 0 0 0 4px;
      cursor: pointer;
      opacity: 0.0;
      transition: opacity 0.08s ease-out, color 0.08s ease-out;
    }

    .session-item:hover .btn-delete-session {
      opacity: 1;
    }

    .btn-delete-session:hover {
      color: #fecaca;
    }

    .sidebar-footer {
      margin-top: 6px;
      font-size: 11px;
      color: #6b7280;
    }

    /* 中间：聊天面板 */

    .main-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 18px 14px;
      gap: 10px;
      position: relative;
      z-index: 0;
    }

    .main-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .main-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .breadcrumbs {
      font-size: 11px;
      color: var(--text-mute);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .breadcrumbs span {
      display: inline-flex;
      align-items: center;
    }

    .agent-title-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .agent-name {
      font-size: 18px;
      font-weight: 700;
    }

    .pill {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: var(--bg-card-soft);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .main-header-right {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 11px;
      color: var(--text-mute);
    }

    .env-pill {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px dashed #d4d4ff;
      background: rgba(219, 234, 254, 0.6);
      color: #1d4ed8;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-weight: 500;
    }

    .env-pill-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
    }

    .chat-surface {
      flex: 1;
      border-radius: 18px;
      background: radial-gradient(circle at top left, #eef2ff 0, #f9fafb 55%);
      border: 1px solid var(--border-subtle);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: inset 0 0 0 1px rgba(148, 163, 184, 0.08);
    }

    .chat-messages {
      flex: 1;
      padding: 16px 18px 12px;
      overflow: auto;
      scroll-behavior: smooth;
    }

    .chat-empty {
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      color: var(--text-mute);
      text-align: center;
      font-size: 13px;
    }

    .chat-message {
      max-width: 80%;
      padding: 10px 12px;
      border-radius: 14px;
      margin-bottom: 8px;
      font-size: 14px;
      line-height: 1.5;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .chat-message.user {
      margin-left: auto;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      border-bottom-right-radius: 4px;
      box-shadow: 0 10px 22px rgba(79, 70, 229, 0.35);
    }

    .chat-message.assistant {
      margin-right: auto;
      background: rgba(255, 255, 255, 0.95);
      border-bottom-left-radius: 4px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.08);
    }

    .chat-input-bar {
      border-top: 1px solid var(--border-subtle);
      padding: 10px 12px;
      background: linear-gradient(to top, rgba(249, 250, 251, 0.94), rgba(249, 250, 251, 0.9));
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      align-items: flex-end;
    }

    .chat-input {
      flex: 1;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      padding: 8px 10px;
      resize: none;
      min-height: 42px;
      max-height: 96px;
      font-size: 14px;
      line-height: 1.4;
      outline: none;
      background: rgba(255, 255, 255, 0.96);
    }

    .chat-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(79, 70, 229, 0.3);
    }

    .send-button {
      border: none;
      border-radius: 999px;
      padding: 9px 18px;
      font-size: 13px;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      background: linear-gradient(135deg, #4f46e5, #6366f1);
      color: white;
      box-shadow: 0 10px 24px rgba(79, 70, 229, 0.5);
      transition: transform 0.08s ease-out, box-shadow 0.08s ease-out, opacity 0.08s ease-out;
    }

    .send-button:hover:not([disabled]) {
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(79, 70, 229, 0.6);
    }

    .send-button:active:not([disabled]) {
      transform: translateY(0);
      box-shadow: 0 6px 14px rgba(31, 41, 55, 0.55);
    }

    .send-button[disabled] {
      opacity: 0.65;
      cursor: default;
      box-shadow: 0 4px 10px rgba(148, 163, 184, 0.6);
    }

    .send-button-icon {
      font-size: 14px;
      background: rgba(15, 23, 42, 0.3);
      border-radius: 999px;
      padding: 4px;
      display: inline-flex;
    }

    .input-hint-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-mute);
    }

    .input-hint-row strong {
      color: var(--text-sub);
    }

    /* 右侧：调用概览 & 原始 JSON */

    .insight-panel {
      width: var(--insight-width);
      padding: 14px 14px 12px;
      border-left: 1px solid rgba(148, 163, 184, 0.4);
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.98), #020617);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .insight-card {
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.98), rgba(15, 23, 42, 0.96));
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      padding: 10px 11px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.8);
    }

    .insight-card h3 {
      margin: 0 0 6px;
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .insight-tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(37, 99, 235, 0.25);
      border: 1px solid rgba(129, 140, 248, 0.7);
    }

    .call-overview-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-bottom: 2px;
      color: #9ca3af;
    }

    .call-overview-row span:last-child {
      color: #e5e7eb;
    }

    .call-overview-row strong {
      color: #e5e7eb;
    }

    .call-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid rgba(52, 211, 153, 0.8);
      background: rgba(5, 150, 105, 0.2);
      color: #bbf7d0;
    }

    .call-status-pill.error {
      border-color: rgba(248, 113, 113, 0.9);
      background: rgba(127, 29, 29, 0.85);
      color: #fecaca;
    }

    .call-status-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }

    .call-status-pill.error .call-status-dot {
      background: #f97373;
    }

    .raw-json-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .json-buttons {
      display: flex;
      gap: 6px;
    }

    .btn-ghost {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      background: rgba(15, 23, 42, 0.7);
      font-size: 11px;
      padding: 3px 8px;
      color: #e5e7eb;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.08s ease-out, border 0.08s ease-out, transform 0.06s ease-out;
    }

    .btn-ghost:hover {
      background: rgba(15, 23, 42, 0.95);
      border-color: rgba(251, 191, 36, 0.85);
      transform: translateY(-0.5px);
    }

    .btn-ghost:active {
      transform: translateY(0);
    }

    .raw-json-body {
      position: relative;
      border-radius: 10px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top left, rgba(17, 24, 39, 0.9), #020617);
      padding: 8px 9px;
      max-height: 160px;
      overflow: hidden;
      transition: max-height 0.18s ease-out;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono",
        "Courier New", monospace;
      font-size: 11px;
      color: #e5e7eb;
    }

    .raw-json-body.open {
      max-height: 260px;
      overflow: auto;
    }

    .raw-json-placeholder {
      color: #6b7280;
      font-size: 11px;
    }

    .raw-json-pre {
      margin: 0;
      white-space: pre-wrap;
      word-break: break-word;
    }

    .agent-desc-list {
      list-style: none;
      padding-left: 0;
      margin: 6px 0 0;
      font-size: 11px;
      color: #9ca3af;
    }

    .agent-desc-list li {
      margin-bottom: 4px;
      display: flex;
      gap: 4px;
    }

    .agent-desc-list li span {
      color: #e5e7eb;
    }

    /* toast */

    .toast {
      position: absolute;
      right: 24px;
      bottom: 22px;
      z-index: 40;
      padding: 8px 11px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.92);
      color: #f9fafb;
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(248, 250, 252, 0.22);
    }

    .toast.visible {
      display: inline-flex;
    }

    .toast-icon {
      font-size: 14px;
    }

    /* 顶部移动端按钮 & 遮罩，桌面端默认隐藏 */

    .mobile-top-bar {
      display: none;
    }

    .mobile-overlay {
      display: none;
    }

    @media (max-width: 1120px) {
      /* 中屏默认隐藏右侧面板（移动端另外覆盖） */
      .insight-panel {
        display: none;
      }
    }

/* === 手机端布局（替换原有 @media (max-width: 900px) 整段）=== */
@media (max-width: 900px) {
  body {
    padding: 0;
  }

  .app-shell {
    border-radius: 0;
    box-shadow: none;
    max-height: none;
    height: 100%;
    overflow: hidden; /* 防止左右推时露出太大的空白 */
  }

  /* 由主面板负责平移*/


    .main-panel {
    padding-top: 46px;           /* 原来就有的，用于给顶部图标腾空间 */
    transition: transform 0.2s ease-out;
  }

  /* 顶部两条横线跟随 app-shell 一起平移 */
  .app-shell.push-right .mobile-top-bar {
    transform: translateX(min(80%, 320px));
  }

  .app-shell.push-left .mobile-top-bar {
    transform: translateX(-min(80%, 340px));
  }

  /* 左侧菜单打开时：主界面整体向右推 */
  .app-shell.push-right .main-panel {
    transform: translateX(min(80%, 320px));
  }

  /* 右侧 insight 打开时：主界面整体向左推 */
  .app-shell.push-left .main-panel {
    transform: translateX(-min(80%, 340px));
  }

  /* 顶部左右“二横线”按钮条 */
  .mobile-top-bar {
    position: fixed;
    top: 10px;
    left: 0;
    right: 0;
    padding: 0 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 40;
    pointer-events: none;
  }

  .mobile-toggle-btn {
    width: 34px;
    height: 34px;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
    border: none;
    background: transparent;
    padding: 0;
    margin: 0;
  }

  .mobile-toggle-icon {
    position: relative;
    width: 18px;
    height: 14px;
  }

  .mobile-toggle-icon span {
    position: absolute;
    height: 2px;
    border-radius: 999px;
    background: #111827;
  }

  /* 左侧图标：两条线偏左 */
  .mobile-toggle-btn-left .mobile-toggle-icon span:nth-child(1) {
    top: 2px;
    left: 0;
    right: 8px;
  }
  .mobile-toggle-btn-left .mobile-toggle-icon span:nth-child(2) {
    bottom: 2px;
    left: 0;
    right: 3px;
  }

  /* 右侧图标：两条线偏右（镜像） */
  .mobile-toggle-btn-right .mobile-toggle-icon span:nth-child(1) {
    top: 2px;
    left: 8px;
    right: 0;
  }
  .mobile-toggle-btn-right .mobile-toggle-icon span:nth-child(2) {
    bottom: 2px;
    left: 3px;
    right: 0;
  }

  /* 遮罩层：在主界面和抽屉之间 */
  .mobile-overlay {
    display: block;
    position: fixed;
    inset: 0;
    background: rgba(15, 23, 42, 0.35);
    z-index: 25;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.18s ease-out;
  }

  .mobile-overlay.visible {
    opacity: 1;
    pointer-events: auto;
  }

  /* 左侧 sidebar 抽屉（固定在视口左边，不随主界面一起移动） */
  .sidebar {
    position: fixed;
    top: 0;
    bottom: 0;
    left: 0;
    width: min(80%, 320px);
    max-width: 320px;
    transform: translateX(-100%);
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    z-index: 30;
  }

  .sidebar.sidebar-open {
    transform: translateX(0);
    box-shadow: 0 24px 60px rgba(15, 23, 42, 0.88);
  }

  /* 右侧 insight 抽屉（固定在视口右边） */
  .insight-panel {
    display: flex;
    position: fixed;
    top: 0;
    bottom: 0;
    right: 0;
    width: min(80%, 340px);
    max-width: 340px;
    transform: translateX(100%);
    transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
    z-index: 30;
  }

  .insight-panel.insight-open {
    transform: translateX(0);
    box-shadow: 0 24px 60px rgba(15, 23, 42, 0.88);
  }
}




  </style>
</head>
<body>
  <div class="app-shell">
    <!-- 手机端顶部左右菜单按钮 -->
    <div class="mobile-top-bar">
      <button class="mobile-toggle-btn mobile-toggle-btn-left" id="btnMobileSidebar" aria-label="展开会话列表">
        <div class="mobile-toggle-icon">
          <span></span>
          <span></span>
        </div>
      </button>
      <button class="mobile-toggle-btn mobile-toggle-btn-right" id="btnMobileInsight" aria-label="展开调用概览">
        <div class="mobile-toggle-icon">
          <span></span>
          <span></span>
        </div>
      </button>
    </div>

    <!-- 左侧：会话列表 -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title-row">
          <div class="sidebar-title">
            <span class="status-dot"></span>
            Agent Worker 控制台
          </div>
        </div>
        <div class="sidebar-subtitle">本地对接 · Cloudflare &AI 智能体</div>
        <div class="sidebar-tags">
          <div class="tag-chip"><strong>Agent</strong> worker-agent</div>
          <div class="tag-chip"><strong>Model</strong> gpt-5-mini</div>
          <div class="tag-chip"><strong>Route</strong> Worker → OpenAI Chat</div>
        </div>
        <div class="sidebar-divider"></div>
      </div>

      <div class="sidebar-actions">
        <button class="btn-new-session" id="btnNewSession">
          <span class="btn-icon">＋</span>
          新建会话
        </button>
        <div class="sidebar-env">
          <span class="sidebar-env-dot"></span>
          环境：Dev
        </div>
      </div>

      <div class="session-list" id="sessionList">
        <!-- JS 渲染会话 -->
      </div>

      <div class="sidebar-footer">
        本页面仅作 <strong>AI 智能体链路测试</strong>，不保存服务端日志。
      </div>
    </aside>

    <!-- 中间：主聊天区域 -->
    <main class="main-panel">
      <div class="main-header">
        <div class="main-header-left">
          <div class="breadcrumbs">
            <span>Agent Worker 测试面板</span>
            <span>·</span>
            <span>前端 → Cloudflare  → OpenAI Chat Completions</span>
          </div>
          <div class="agent-title-row">
            <div class="agent-name">Agent Worker 测试面板</div>
            <div class="pill">
              <span>Agent:</span>
              <strong id="currentAgentLabel">worker-agent</strong>
            </div>
            <div class="pill">
              <span>模型:</span>
              <strong id="currentModelLabel">gpt-5-mini</strong>
            </div>
          </div>
        </div>
        <div class="main-header-right">
          <div class="env-pill">
            <span class="env-pill-dot"></span>
            <span>Worker: AI Agent</span>
          </div>
        </div>
      </div>

      <section class="chat-surface">
        <div class="chat-messages" id="chatMessages">
          <div class="chat-empty" id="chatEmpty">
            <div>这里会显示你和 Worker 智能体的对话记录。</div>
            <div>试试输入：<strong>「帮我把下面的报错信息按原因拆解一下」</strong>。</div>
          </div>
        </div>

        <div class="chat-input-bar">
          <div class="chat-input-row">
            <textarea
              id="chatInput"
              class="chat-input"
              placeholder="在这里输入：比如『帮我总结一下今天要做的三件事』，然后按 Ctrl+Enter 或点击发送。"
            ></textarea>
            <button id="btnSend" class="send-button">
              <span class="send-button-icon">↗</span>
              <span id="btnSendLabel">发送</span>
            </button>
          </div>
          <div class="input-hint-row">
            <span>支持多行输入。<strong>Ctrl+Enter</strong> 发送。</span>
            <span id="requestMetaHint">就绪：调用 Cloudflare   &AI智能体。</span>
          </div>
        </div>
      </section>

      <div class="toast" id="toast">
        <span class="toast-icon">⚠️</span>
        <span id="toastText">错误信息</span>
      </div>
    </main>

    <!-- 右侧：调用概览 -->
    <aside class="insight-panel">
      <div class="insight-card">
        <h3>
          调用概览
          <span class="insight-tag">最近一次</span>
        </h3>
        <div class="call-overview-row">
          <span>耗时</span>
          <span id="ovDuration">-</span>
        </div>
        <div class="call-overview-row">
          <span>状态</span>
          <span id="ovStatus">
            <span class="call-status-pill">
              <span class="call-status-dot"></span>
              尚未调用
            </span>
          </span>
        </div>
        <div class="call-overview-row">
          <span>模型</span>
          <span id="ovModel">gpt-5-mini</span>
        </div>
        <div class="call-overview-row">
          <span>Prompt tokens</span>
          <span id="ovPromptTokens">-</span>
        </div>
        <div class="call-overview-row">
          <span>Completion tokens</span>
          <span id="ovCompletionTokens">-</span>
        </div>
        <div class="call-overview-row">
          <span>Total tokens</span>
          <span id="ovTotalTokens">-</span>
        </div>
      </div>

      <div class="insight-card">
        <div class="raw-json-header">
          <span>原始返回</span>
          <div class="json-buttons">
            <button class="btn-ghost" id="btnToggleJson">展开 JSON</button>
            <button class="btn-ghost" id="btnCopyJson">复制</button>
          </div>
        </div>
        <div class="raw-json-body" id="rawJsonBody">
          <div class="raw-json-placeholder" id="rawJsonPlaceholder">
            尚未调用。调用后这里会显示 Worker 与 OpenAI 返回的完整 JSON。
          </div>
          <pre class="raw-json-pre" id="rawJsonPre" style="display:none;"></pre>
        </div>
      </div>

      <div class="insight-card">
        <h3>
          智能体说明
          <span class="insight-tag">worker-agent · Dev</span>
        </h3>
        <ul class="agent-desc-list">
          <li>· <span>职责：</span>验证 Cloudflare  → OpenAI gpt-5-mini 聊天链路。</li>
          <li>· <span>能力：</span>回答自然语言问题，展示模型与 tokens 信息。</li>
          <li>· <span>限制：</span>不访问业务数据库、不执行写操作工具调用。</li>
          <li>· <span>适用场景：</span>本地联调、链路健康检查、最小可用智能体测试。</li>
        </ul>
      </div>
    </aside>

    <!-- 移动端遮罩 -->
    <div class="mobile-overlay" id="mobileOverlay"></div>
  </div>

  <script>
    // === Config ===
    const WORKER_ENDPOINT = "https://agent.mefans.workers.dev/";
    const DB_NAME = "agentWorkerDB";
    const DB_VERSION = 1;
    const SESSION_STORE = "sessions"; // 静态桶：会话 + 右侧 overview
    const MESSAGE_STORE = "messages"; // 动态桶：消息流水
    const MAX_SESSIONS = 50;

    const LS_SESSIONS_KEY = "agentWorker:sessions";
    const LS_MESSAGES_KEY = "agentWorker:messages";

    // === State ===
    let dbPromise = null;
    let useIndexedDB = true;
    let sessions = [];
    let currentSessionId = null;
    let isSending = false;
    let lastRawResponse = "";

        // 移动端抽屉状态（左右）
    let isSidebarOpenMobile = false;
    let isInsightOpenMobile = false;

    let lastOverview = null;
    let currentMobilePanel = null;

    const el = {};

    document.addEventListener("DOMContentLoaded", () => {
      cacheDom();
      bindGlobalEvents();
      initApp();
    });

    async function initApp() {
      try {
        await initIndexedDB();
        await initSessions();
      } catch (err) {
        showFatalError(err);
      }
    }

    function cacheDom() {
      el.appShell = document.querySelector(".app-shell");
      el.sessionList = document.getElementById("sessionList");
      el.btnNewSession = document.getElementById("btnNewSession");
      el.chatMessages = document.getElementById("chatMessages");
      el.chatEmpty = document.getElementById("chatEmpty");
      el.chatInput = document.getElementById("chatInput");
      el.btnSend = document.getElementById("btnSend");
      el.btnSendLabel = document.getElementById("btnSendLabel");
      el.requestMetaHint = document.getElementById("requestMetaHint");

      el.ovDuration = document.getElementById("ovDuration");
      el.ovStatus = document.getElementById("ovStatus");
      el.ovModel = document.getElementById("ovModel");
      el.ovPromptTokens = document.getElementById("ovPromptTokens");
      el.ovCompletionTokens = document.getElementById("ovCompletionTokens");
      el.ovTotalTokens = document.getElementById("ovTotalTokens");

      el.rawJsonBody = document.getElementById("rawJsonBody");
      el.rawJsonPlaceholder = document.getElementById("rawJsonPlaceholder");
      el.rawJsonPre = document.getElementById("rawJsonPre");
      el.btnToggleJson = document.getElementById("btnToggleJson");
      el.btnCopyJson = document.getElementById("btnCopyJson");

      el.toast = document.getElementById("toast");
      el.toastText = document.getElementById("toastText");

            // 移动端抽屉相关（顶栏 + 遮罩 + 左右抽屉 + 整体容器）
      el.appShell = document.querySelector(".app-shell");
      el.mobileTopBar = document.querySelector(".mobile-top-bar");
      el.mobileOverlay = document.getElementById("mobileOverlay");
      el.btnToggleSidebar = document.getElementById("btnToggleSidebar");
      el.btnToggleInsight = document.getElementById("btnToggleInsight");
      el.sidebar = document.querySelector(".sidebar");
      el.insightPanel = document.querySelector(".insight-panel");

      el.btnMobileSidebar = document.getElementById("btnMobileSidebar");
      el.btnMobileInsight = document.getElementById("btnMobileInsight");
      el.mobileOverlay = document.getElementById("mobileOverlay");
    }

    function bindGlobalEvents() {

      // ===== 移动端左右抽屉：两条横线菜单 =====
      if (el.btnToggleSidebar) {
        el.btnToggleSidebar.addEventListener("click", () => {
          const willOpen = !isSidebarOpenMobile;
          isSidebarOpenMobile = willOpen;

          if (el.sidebar) {
            el.sidebar.classList.toggle("sidebar-open", willOpen);
          }
          if (el.appShell) {
            el.appShell.classList.toggle("push-right", willOpen);
            // 打开左侧时，确保右侧关闭
            if (willOpen) {
              el.appShell.classList.remove("push-left");
            }
          }
          if (el.mobileTopBar) {
            el.mobileTopBar.classList.toggle("push-right", willOpen);
            if (willOpen) {
              el.mobileTopBar.classList.remove("push-left");
            }
          }
          if (willOpen && isInsightOpenMobile) {
            // 左侧打开时，顺便关掉右侧抽屉
            isInsightOpenMobile = false;
            if (el.insightPanel) {
              el.insightPanel.classList.remove("insight-open");
            }
          }
          updateMobileOverlay();
        });
      }

      if (el.btnToggleInsight) {
        el.btnToggleInsight.addEventListener("click", () => {
          const willOpen = !isInsightOpenMobile;
          isInsightOpenMobile = willOpen;

          if (el.insightPanel) {
            el.insightPanel.classList.toggle("insight-open", willOpen);
          }
          if (el.appShell) {
            el.appShell.classList.toggle("push-left", willOpen);
            // 打开右侧时，确保左侧关闭
            if (willOpen) {
              el.appShell.classList.remove("push-right");
            }
          }
          if (el.mobileTopBar) {
            el.mobileTopBar.classList.toggle("push-left", willOpen);
            if (willOpen) {
              el.mobileTopBar.classList.remove("push-right");
            }
          }
          if (willOpen && isSidebarOpenMobile) {
            isSidebarOpenMobile = false;
            if (el.sidebar) {
              el.sidebar.classList.remove("sidebar-open");
            }
          }
          updateMobileOverlay();
        });
      }

      if (el.mobileOverlay) {
        el.mobileOverlay.addEventListener("click", () => {
          // 点击遮罩：统一关闭左右抽屉 & 复位整体 transform
          isSidebarOpenMobile = false;
          isInsightOpenMobile = false;

          if (el.sidebar) {
            el.sidebar.classList.remove("sidebar-open");
          }
          if (el.insightPanel) {
            el.insightPanel.classList.remove("insight-open");
          }
          if (el.appShell) {
            el.appShell.classList.remove("push-right", "push-left");
          }
          if (el.mobileTopBar) {
            el.mobileTopBar.classList.remove("push-right", "push-left");
          }
          updateMobileOverlay();
        });
      }

      el.btnNewSession.addEventListener("click", () => {
        handleNewSession();
      });

      el.sessionList.addEventListener("click", (event) => {
        const target = event.target;
        const item = target.closest("[data-session-id]");
        if (!item) return;

        const id = item.getAttribute("data-session-id");
        const deleteBtn = target.closest("[data-action='delete-session']");
        const renameBtn = target.closest("[data-action='rename-session']");

        if (deleteBtn) {
          event.stopPropagation();
          handleDeleteSession(id);
          return;
        }

        if (renameBtn) {
          event.stopPropagation();
          handleRenameSession(id);
          return;
        }

        selectSession(id);
      });

      el.btnSend.addEventListener("click", () => {
        triggerSend();
      });

      el.chatInput.addEventListener("keydown", (event) => {
        if ((event.ctrlKey || event.metaKey) && event.key === "Enter" && !event.shiftKey) {
          event.preventDefault();
          triggerSend();
        }
      });

      el.btnToggleJson.addEventListener("click", () => {
        const isOpen = el.rawJsonBody.classList.toggle("open");
        el.btnToggleJson.textContent = isOpen ? "收起 JSON" : "展开 JSON";
      });

      el.btnCopyJson.addEventListener("click", async () => {
        if (!lastRawResponse) {
          showToast("当前没有可复制的 JSON");
          return;
        }
        try {
          await navigator.clipboard.writeText(lastRawResponse);
          showToast("已复制 JSON 到剪贴板");
        } catch (err) {
          console.error(err);
          showToast("复制失败，请检查浏览器权限");
        }
      });

      if (el.btnMobileSidebar) {
        el.btnMobileSidebar.addEventListener("click", () => {
          toggleMobilePanel("left");
        });
      }

      if (el.btnMobileInsight) {
        el.btnMobileInsight.addEventListener("click", () => {
          toggleMobilePanel("right");
        });
      }

      if (el.mobileOverlay) {
        el.mobileOverlay.addEventListener("click", () => {
          closeMobilePanels();
        });
      }

      window.addEventListener("resize", () => {
        if (!isMobileViewport()) {
          closeMobilePanels();
        }
      });
    }
    //在 bindGlobalEvents 下面加一个小 helper
    // 控制遮罩显示：只要有任一抽屉打开就显示
    function updateMobileOverlay() {
      if (!el.mobileOverlay) return;
      const visible = isSidebarOpenMobile || isInsightOpenMobile;
      if (visible) {
        el.mobileOverlay.classList.add("visible");
      } else {
        el.mobileOverlay.classList.remove("visible");
      }
    }

    function isMobileViewport() {
      return window.matchMedia && window.matchMedia("(max-width: 900px)").matches;
    }

    function toggleMobilePanel(target) {
      if (!isMobileViewport()) return;
      const sidebar = document.querySelector(".sidebar");
      const insight = document.querySelector(".insight-panel");
      if (!sidebar || !insight || !el.appShell) return;

      const isSame = currentMobilePanel === target;
      if (isSame) {
        closeMobilePanels();
        return;
      }

      if (target === "left") {
        sidebar.classList.add("sidebar-open");
        insight.classList.remove("insight-open");
        el.appShell.classList.add("push-right");
        el.appShell.classList.remove("push-left");
        currentMobilePanel = "left";
      } else if (target === "right") {
        insight.classList.add("insight-open");
        sidebar.classList.remove("sidebar-open");
        el.appShell.classList.add("push-left");
        el.appShell.classList.remove("push-right");
        currentMobilePanel = "right";
      }

      if (el.mobileOverlay) {
        el.mobileOverlay.classList.add("visible");
      }
    }

    function closeMobilePanels() {
      const sidebar = document.querySelector(".sidebar");
      const insight = document.querySelector(".insight-panel");
      if (sidebar) sidebar.classList.remove("sidebar-open");
      if (insight) insight.classList.remove("insight-open");
      if (el.appShell) {
        el.appShell.classList.remove("push-right", "push-left");
      }
      currentMobilePanel = null;
      if (el.mobileOverlay) {
        el.mobileOverlay.classList.remove("visible");
      }
    }

    // === IndexedDB + localStorage 封装 ===

    async function initIndexedDB() {
      if (!("indexedDB" in window)) {
        useIndexedDB = false;
        console.warn("[IndexedDB] 不支持，自动使用 localStorage。");
        return;
      }

      try {
        dbPromise = new Promise((resolve, reject) => {
          let request;
          try {
            request = indexedDB.open(DB_NAME, DB_VERSION);
          } catch (err) {
            reject(err);
            return;
          }

          request.onerror = () => {
            reject(request.error || new Error("indexedDB open error"));
          };

          request.onsuccess = () => {
            resolve(request.result);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(SESSION_STORE)) {
              const sessionStore = db.createObjectStore(SESSION_STORE, { keyPath: "id" });
              sessionStore.createIndex("updatedAt", "updatedAt", { unique: false });
            }
            if (!db.objectStoreNames.contains(MESSAGE_STORE)) {
              const messageStore = db.createObjectStore(MESSAGE_STORE, { keyPath: "id" });
              messageStore.createIndex("sessionId", "sessionId", { unique: false });
            }
          };
        });

        await dbPromise;
      } catch (err) {
        console.warn("[IndexedDB] 初始化失败，自动切换 localStorage。", err);
        dbPromise = null;
        useIndexedDB = false;
      }
    }

    function dbReadAll(storeName, indexName, query, direction = "prev") {
      if (!useIndexedDB || !dbPromise) return Promise.resolve([]);
      return dbPromise.then(
        (db) =>
          new Promise((resolve, reject) => {
            try {
              const tx = db.transaction(storeName, "readonly");
              let store = tx.objectStore(storeName);
              if (indexName) {
                store = store.index(indexName);
              }
              const items = [];
              const req = store.openCursor(query, direction);
              req.onerror = () => reject(req.error);
              req.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                  items.push(cursor.value);
                  cursor.continue();
                } else {
                  resolve(items);
                }
              };
            } catch (e) {
              reject(e);
            }
          })
      );
    }

    function dbPut(storeName, value) {
      if (!useIndexedDB || !dbPromise) return Promise.resolve();
      return dbPromise.then(
        (db) =>
          new Promise((resolve, reject) => {
            try {
              const tx = db.transaction(storeName, "readwrite");
              const store = tx.objectStore(storeName);
              const req = store.put(value);
              req.onerror = () => reject(req.error);
              req.onsuccess = () => resolve();
            } catch (e) {
              reject(e);
            }
          })
      );
    }

    function dbDelete(storeName, key) {
      if (!useIndexedDB || !dbPromise) return Promise.resolve();
      return dbPromise.then(
        (db) =>
          new Promise((resolve, reject) => {
            try {
              const tx = db.transaction(storeName, "readwrite");
              const store = tx.objectStore(storeName);
              const req = store.delete(key);
              req.onerror = () => reject(req.error);
              req.onsuccess = () => resolve();
            } catch (e) {
              reject(e);
            }
          })
      );
    }

    function dbDeleteWhereMessages(sessionId) {
      if (!useIndexedDB || !dbPromise) return Promise.resolve();
      return dbPromise.then(
        (db) =>
          new Promise((resolve, reject) => {
            try {
              const tx = db.transaction(MESSAGE_STORE, "readwrite");
              const store = tx.objectStore(MESSAGE_STORE);
              const index = store.index("sessionId");
              const req = index.openCursor(IDBKeyRange.only(sessionId));
              req.onerror = () => reject(req.error);
              req.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor) {
                  cursor.delete();
                  cursor.continue();
                } else {
                  resolve();
                }
              };
            } catch (e) {
              reject(e);
            }
          })
      );
    }

    function dbReadMessagesBySession(sessionId) {
      if (!useIndexedDB || !dbPromise) return Promise.resolve([]);
      return dbPromise.then(
        (db) =>
          new Promise((resolve, reject) => {
            try {
              const tx = db.transaction(MESSAGE_STORE, "readonly");
              const store = tx.objectStore(MESSAGE_STORE);
              const index = store.index("sessionId");
              const req = index.getAll(IDBKeyRange.only(sessionId));
              req.onerror = () => reject(req.error);
              req.onsuccess = () => resolve(req.result || []);
            } catch (e) {
              reject(e);
            }
          })
      );
    }

    async function loadSessionsFromStorage() {
      if (useIndexedDB && dbPromise) {
        try {
          return await dbReadAll(SESSION_STORE, "updatedAt");
        } catch (err) {
          console.warn("[IndexedDB] 读取 sessions 失败，降级到 localStorage。", err);
          useIndexedDB = false;
          dbPromise = null;
        }
      }
      try {
        const raw = localStorage.getItem(LS_SESSIONS_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      } catch (err) {
        console.warn("[localStorage] 读取 sessions 失败。", err);
        return [];
      }
    }

    async function loadMessagesFromStorage(sessionId) {
      if (useIndexedDB && dbPromise) {
        try {
          return await dbReadMessagesBySession(sessionId);
        } catch (err) {
          console.warn("[IndexedDB] 读取 messages 失败，降级到 localStorage。", err);
          useIndexedDB = false;
          dbPromise = null;
        }
      }
      try {
        const raw = localStorage.getItem(LS_MESSAGES_KEY);
        if (!raw) return [];
        const parsed = JSON.parse(raw);
        if (!Array.isArray(parsed)) return [];
        return parsed.filter((m) => m.sessionId === sessionId);
      } catch (err) {
        console.warn("[localStorage] 读取 messages 失败。", err);
        return [];
      }
    }

    async function saveSession(session) {
      // 先确保内存 sessions 更新
      const idx = sessions.findIndex((s) => s.id === session.id);
      if (idx === -1) sessions.push(session);
      else sessions[idx] = session;

      if (useIndexedDB && dbPromise) {
        try {
          await dbPut(SESSION_STORE, session);
          return;
        } catch (err) {
          console.warn("[IndexedDB] 写入 session 失败，降级到 localStorage。", err);
          useIndexedDB = false;
          dbPromise = null;
        }
      }

      try {
        localStorage.setItem(LS_SESSIONS_KEY, JSON.stringify(sessions));
      } catch (err) {
        console.warn("[localStorage] 写入 sessions 失败。", err);
      }
    }

    async function saveMessage(message) {
      if (useIndexedDB && dbPromise) {
        try {
          await dbPut(MESSAGE_STORE, message);
          return;
        } catch (err) {
          console.warn("[IndexedDB] 写入 message 失败，降级到 localStorage。", err);
          useIndexedDB = false;
          dbPromise = null;
        }
      }

      try {
        const raw = localStorage.getItem(LS_MESSAGES_KEY);
        const arr = raw ? (JSON.parse(raw) || []) : [];
        arr.push(message);
        localStorage.setItem(LS_MESSAGES_KEY, JSON.stringify(arr));
      } catch (err) {
        console.warn("[localStorage] 写入 messages 失败。", err);
      }
    }

    async function deleteSessionAndMessages(sessionId) {
      if (useIndexedDB && dbPromise) {
        try {
          await dbDeleteWhereMessages(sessionId);
          await dbDelete(SESSION_STORE, sessionId);
        } catch (err) {
          console.warn("[IndexedDB] 删除会话失败，尝试 localStorage。", err);
          useIndexedDB = false;
          dbPromise = null;
        }
      }

      if (!useIndexedDB || !dbPromise) {
        try {
          const rawS = localStorage.getItem(LS_SESSIONS_KEY);
          let arrS = rawS ? JSON.parse(rawS) : [];
          if (Array.isArray(arrS)) {
            arrS = arrS.filter((s) => s.id !== sessionId);
            localStorage.setItem(LS_SESSIONS_KEY, JSON.stringify(arrS));
          }
          const rawM = localStorage.getItem(LS_MESSAGES_KEY);
          let arrM = rawM ? JSON.parse(rawM) : [];
          if (Array.isArray(arrM)) {
            arrM = arrM.filter((m) => m.sessionId !== sessionId);
            localStorage.setItem(LS_MESSAGES_KEY, JSON.stringify(arrM));
          }
        } catch (err) {
          console.warn("[localStorage] 删除会话失败。", err);
        }
      }
    }

    // === Session / message model ===

    function createSessionObject() {
      const id = crypto.randomUUID ? crypto.randomUUID() : "s_" + Date.now();
      const ts = Date.now();
      return {
        id,
        title: "新会话",
        createdAt: ts,
        updatedAt: ts,
        totalTokens: 0,
        isEmpty: true,
        lastCallOverview: null,
        lastRawJson: "",
      };
    }

    function createMessage(sessionId, role, content) {
      const id = crypto.randomUUID
        ? crypto.randomUUID()
        : "m_" + Date.now() + "_" + Math.random();
      return {
        id,
        sessionId,
        role,
        content,
        createdAt: Date.now(),
      };
    }

    async function initSessions() {
      let stored = await loadSessionsFromStorage();
      if (!stored || stored.length === 0) {
        const session = createSessionObject();
        sessions = [session];
        currentSessionId = session.id;
        await saveSession(session);
      } else {
        sessions = stored;
        currentSessionId = sessions[0].id;
      }
      renderSessionList();
      await renderCurrentSessionMessages();
      hydrateCurrentSessionInsights();
    }

    function formatShortTime(timestamp) {
      if (!timestamp) return "-";
      const d = new Date(timestamp);
      const hh = String(d.getHours()).padStart(2, "0");
      const mm = String(d.getMinutes()).padStart(2, "0");
      return `${hh}:${mm}`;
    }

    function renderSessionList() {
      el.sessionList.innerHTML = "";
      sessions.forEach((session) => {
        const item = document.createElement("div");
        item.className = "session-item" + (session.id === currentSessionId ? " active" : "");
        item.setAttribute("data-session-id", session.id);

        const headerRow = document.createElement("div");
        headerRow.className = "session-header-row";

        const headerLeft = document.createElement("div");
        headerLeft.className = "session-header-left";

        const titleSpan = document.createElement("div");
        titleSpan.className = "session-title";
        titleSpan.textContent = session.title || "未命名会话";

        const renameBtn = document.createElement("button");
        renameBtn.className = "btn-rename-session";
        renameBtn.setAttribute("data-action", "rename-session");
        renameBtn.textContent = "✎";

        headerLeft.appendChild(titleSpan);
        headerLeft.appendChild(renameBtn);

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-delete-session";
        deleteBtn.setAttribute("data-action", "delete-session");
        deleteBtn.textContent = "×";

        headerRow.appendChild(headerLeft);
        headerRow.appendChild(deleteBtn);

        const metaRow = document.createElement("div");
        metaRow.className = "session-meta";

        const timeSpan = document.createElement("span");
        timeSpan.textContent = formatShortTime(session.updatedAt);

        const tokenSpan = document.createElement("span");
        tokenSpan.className = "session-tokens";
        tokenSpan.textContent = `${session.totalTokens || 0} tokens`;

        metaRow.appendChild(timeSpan);
        metaRow.appendChild(tokenSpan);

        item.appendChild(headerRow);
        item.appendChild(metaRow);

        el.sessionList.appendChild(item);
      });
    }

    async function selectSession(sessionId) {
      if (!sessionId) return;
      if (sessionId === currentSessionId) {
        if (isMobileViewport()) closeMobilePanels();
        return;
      }
      currentSessionId = sessionId;
      renderSessionList();
      await renderCurrentSessionMessages();
      hydrateCurrentSessionInsights();
      if (isMobileViewport()) closeMobilePanels();
    }

    async function renderCurrentSessionMessages() {
      if (!currentSessionId) return;
      const messages = await loadMessagesFromStorage(currentSessionId);
      if (!messages || messages.length === 0) {
        el.chatMessages.innerHTML = "";
        el.chatMessages.appendChild(el.chatEmpty);
        el.chatEmpty.style.display = "flex";
        return;
      }
      el.chatMessages.innerHTML = "";
      messages
        .sort((a, b) => a.createdAt - b.createdAt)
        .forEach((msg) => {
          appendMessageBubble(msg.role, msg.content, false);
        });
      scrollToBottom();
    }

    async function handleNewSession() {
      const existingEmpty = sessions.find((s) => s.isEmpty);
      if (existingEmpty) {
        currentSessionId = existingEmpty.id;
        renderSessionList();
        await renderCurrentSessionMessages();
        hydrateCurrentSessionInsights();
        if (isMobileViewport()) closeMobilePanels();
        return;
      }

      const session = createSessionObject();
      sessions.unshift(session);
      currentSessionId = session.id;
      await saveSession(session);
      await cleanupOldSessionsIfNecessary();

      renderSessionList();
      await renderCurrentSessionMessages();
      hydrateCurrentSessionInsights();
    }

    async function handleDeleteSession(sessionId) {
      if (!sessionId) return;

      await deleteSessionAndMessages(sessionId);

      sessions = sessions.filter((s) => s.id !== sessionId);

      if (sessions.length === 0) {
        const newSession = createSessionObject();
        sessions = [newSession];
        currentSessionId = newSession.id;
        await saveSession(newSession);
      } else if (currentSessionId === sessionId) {
        currentSessionId = sessions[0].id;
      }

      if (!useIndexedDB || !dbPromise) {
        try {
          localStorage.setItem(LS_SESSIONS_KEY, JSON.stringify(sessions));
        } catch (e) {
          console.warn("[localStorage] 同步 sessions 失败。", e);
        }
      }

      renderSessionList();
      await renderCurrentSessionMessages();
      hydrateCurrentSessionInsights();
    }

    async function handleRenameSession(sessionId) {
      const session = sessions.find((s) => s.id === sessionId);
      if (!session) return;
      const newTitle = window.prompt("请输入会话标题：", session.title || "");
      if (newTitle === null) return;
      const trimmed = newTitle.trim();
      session.title = trimmed || "未命名会话";
      session.updatedAt = Date.now();
      await saveSession(session);
      renderSessionList();
    }

    async function cleanupOldSessionsIfNecessary() {
      if (sessions.length <= MAX_SESSIONS) return;
      const sorted = [...sessions].sort((a, b) => b.updatedAt - a.updatedAt);
      const keep = sorted.slice(0, MAX_SESSIONS);
      const remove = sorted.slice(MAX_SESSIONS);

      sessions = keep;

      for (const s of remove) {
        await deleteSessionAndMessages(s.id);
      }

      if (!useIndexedDB || !dbPromise) {
        try {
          localStorage.setItem(LS_SESSIONS_KEY, JSON.stringify(sessions));
        } catch (e) {
          console.warn("[localStorage] 清理 sessions 时同步失败。", e);
        }
      }
    }

    // === Worker 调用 ===

    async function triggerSend() {
      if (isSending) return;
      const raw = el.chatInput.value.trim();
      if (!raw) {
        showToast("请输入内容后再发送。");
        return;
      }
      if (!currentSessionId) {
        showToast("当前会话未就绪，请刷新页面。");
        return;
      }

      isSending = true;
      setSendingState(true);

      const userMsg = createMessage(currentSessionId, "user", raw);
      await saveMessage(userMsg);

      const session = sessions.find((s) => s.id === currentSessionId);
      if (session && (session.isEmpty || !session.title || session.title === "新会话")) {
        session.isEmpty = false;
        session.title = deriveTitleFromText(raw);
        session.updatedAt = Date.now();
        await saveSession(session);
      }

      appendMessageBubble("user", raw, true);
      el.chatInput.value = "";

      const start = performance.now();
      let ok = false;
      let modelName = "gpt-5-mini";
      let usage = null;
      let outputText = "";
      lastRawResponse = "";
      lastOverview = null;

      try {
        const res = await fetch(WORKER_ENDPOINT, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ input: raw }),
        });

        const durationMs = performance.now() - start;

        if (!res.ok) {
          const text = await res.text().catch(() => "");
          lastRawResponse = text || "";
          updateCallOverviewError(res.status, durationMs, null);
          updateRawJson(text || "");
          lastOverview = {
            ok: false,
            status: res.status,
            durationMs,
            modelName,
            usage: null,
          };
          showToast("Worker 调用失败，请检查 Worker 日志。");
        } else {
          const data = await res.json();
          ok = true;
          outputText = data.output || "";
          modelName = data.model || modelName;
          usage = data.usage || null;
          lastRawResponse = JSON.stringify(data, null, 2);
          updateCallOverviewSuccess(durationMs, modelName, usage);
          updateRawJson(lastRawResponse);
          lastOverview = {
            ok: true,
            status: res.status || 200,
            durationMs,
            modelName,
            usage: usage || null,
          };
        }
      } catch (err) {
        console.error(err);
        const durationMs = performance.now() - start;
        updateCallOverviewError("网络错误", durationMs, null);
        lastRawResponse = String(err || "Unknown error");
        updateRawJson(lastRawResponse);
        lastOverview = {
          ok: false,
          status: "network_error",
          durationMs,
          modelName,
          usage: null,
        };
        showToast("网络异常，无法访问 Worker。");
      } finally {
        isSending = false;
        setSendingState(false);
      }

      const sessionForMeta = sessions.find((s) => s.id === currentSessionId);

      if (ok) {
        const assistantMsg = createMessage(
          currentSessionId,
          "assistant",
          outputText || "（Worker 未返回内容）"
        );
        await saveMessage(assistantMsg);

        if (sessionForMeta) {
          const usedTokens =
            (usage && (usage.total_tokens || usage.totalTokens)) || 0;
          sessionForMeta.totalTokens =
            (sessionForMeta.totalTokens || 0) + usedTokens;
          sessionForMeta.updatedAt = Date.now();
        }

        appendMessageBubble("assistant", outputText || "（Worker 未返回内容）", true);
        scrollToBottom();
      }

      if (sessionForMeta && lastOverview) {
        sessionForMeta.lastCallOverview = lastOverview;
        sessionForMeta.lastRawJson = lastRawResponse;
        if (!sessionForMeta.updatedAt) {
          sessionForMeta.updatedAt = Date.now();
        }
        await saveSession(sessionForMeta);
      }

      if (ok) {
        renderSessionList();
      }

      hydrateCurrentSessionInsights();
    }

    function deriveTitleFromText(text) {
      const trimmed = text.replace(/\s+/g, " ").trim();
      if (!trimmed) return "新会话";
      return trimmed.length > 22 ? trimmed.slice(0, 22) + "…" : trimmed;
    }

    function setSendingState(sending) {
      el.btnSend.disabled = sending;
      el.btnSendLabel.textContent = sending ? "调用中…" : "发送";
      el.requestMetaHint.textContent = sending
        ? "正在调用 Cloudflare  &AI智能体…"
        : "就绪：调用 Cloudflare Worker 智能体。";
    }

    function appendMessageBubble(role, content, hideEmptyHint) {
      if (hideEmptyHint && el.chatEmpty.parentNode === el.chatMessages) {
        el.chatEmpty.style.display = "none";
        el.chatMessages.innerHTML = "";
      }

      const bubble = document.createElement("div");
      bubble.className = "chat-message " + role;
      bubble.textContent = content;

      el.chatMessages.appendChild(bubble);
    }

    function scrollToBottom() {
      requestAnimationFrame(() => {
        el.chatMessages.scrollTop = el.chatMessages.scrollHeight;
      });
    }

    // === 调用概览 / JSON ===

    function resetCallOverview() {
      el.ovDuration.textContent = "-";
      el.ovModel.textContent = "gpt-5-mini";
      el.ovPromptTokens.textContent = "-";
      el.ovCompletionTokens.textContent = "-";
      el.ovTotalTokens.textContent = "-";

      const pill = document.createElement("span");
      pill.className = "call-status-pill";
      pill.innerHTML = '<span class="call-status-dot"></span> 尚未调用';
      el.ovStatus.innerHTML = "";
      el.ovStatus.appendChild(pill);
    }

    function hydrateCurrentSessionInsights() {
      const session = sessions.find((s) => s.id === currentSessionId) || null;
      if (!session || !session.lastCallOverview || !session.lastRawJson) {
        resetCallOverview();
        updateRawJson("");
        return;
      }
      const overview = session.lastCallOverview;
      const modelName = overview.modelName || "gpt-5-mini";
      const usage = overview.usage || null;

      if (overview.ok) {
        updateCallOverviewSuccess(
          typeof overview.durationMs === "number" ? overview.durationMs : 0,
          modelName,
          usage
        );
      } else {
        updateCallOverviewError(
          overview.status || "-",
          typeof overview.durationMs === "number" ? overview.durationMs : null,
          usage
        );
      }
      updateRawJson(session.lastRawJson || "");
    }

    function updateCallOverviewSuccess(durationMs, modelName, usage) {
      el.ovDuration.textContent = `${durationMs.toFixed(0)} ms`;

      const pill = document.createElement("span");
      pill.className = "call-status-pill";
      pill.innerHTML = '<span class="call-status-dot"></span> 成功';
      el.ovStatus.innerHTML = "";
      el.ovStatus.appendChild(pill);

      el.ovModel.textContent = modelName || "gpt-5-mini";
      const pt = (usage && (usage.prompt_tokens || usage.promptTokens)) || "-";
      const ct =
        (usage && (usage.completion_tokens || usage.completionTokens)) || "-";
      const tt = (usage && (usage.total_tokens || usage.totalTokens)) || "-";
      el.ovPromptTokens.textContent = pt;
      el.ovCompletionTokens.textContent = ct;
      el.ovTotalTokens.textContent = tt;
    }

    function updateCallOverviewError(status, durationMs, usage) {
      el.ovDuration.textContent =
        typeof durationMs === "number" ? `${durationMs.toFixed(0)} ms` : "-";

      const pill = document.createElement("span");
      pill.className = "call-status-pill error";
      pill.innerHTML = `<span class="call-status-dot"></span> 失败（${status}）`;
      el.ovStatus.innerHTML = "";
      el.ovStatus.appendChild(pill);

      if (!usage) {
        el.ovPromptTokens.textContent = "-";
        el.ovCompletionTokens.textContent = "-";
        el.ovTotalTokens.textContent = "-";
      }
    }

    function updateRawJson(text) {
      if (!text) {
        el.rawJsonPlaceholder.style.display = "block";
        el.rawJsonPre.style.display = "none";
        el.rawJsonPre.textContent = "";
        return;
      }
      el.rawJsonPlaceholder.style.display = "none";
      el.rawJsonPre.style.display = "block";

      try {
        const parsed = typeof text === "string" ? JSON.parse(text) : text;
        el.rawJsonPre.textContent = JSON.stringify(parsed, null, 2);
      } catch {
        el.rawJsonPre.textContent = text;
      }
    }

       // === Toast ===

    let toastTimer = null;

    function showToast(message) {
      el.toastText.textContent = message;
      el.toast.classList.add("visible");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        el.toast.classList.remove("visible");
      }, 2800);
    }

    function showFatalError(err) {
      console.error(err);
      showToast("初始化失败，请检查浏览器控制台。");
    }

    // === Mobile drawer logic · 仅手机端使用 ===
    (function () {
      const mainPanel  = document.querySelector(".main-panel");
      const sidebarEl  = document.querySelector(".sidebar");
      const insightEl  = document.querySelector(".insight-panel");
      const overlayEl  = document.getElementById("mobileOverlay");
      const btnSidebar = document.getElementById("btnMobileSidebarToggle");
      const btnInsight = document.getElementById("btnMobileInsightToggle");

      // 桌面端或元素缺失时，直接退出，不影响其它逻辑
      if (!mainPanel || !sidebarEl || !overlayEl || !btnSidebar || !btnInsight) return;

      let sidebarOpen = false;
      let insightOpen = false;

      function syncOverlay() {
        if (sidebarOpen || insightOpen) {
          overlayEl.classList.add("visible");
        } else {
          overlayEl.classList.remove("visible");
        }
      }

      // 左侧会话栏按钮：打开时主面板向右推
      btnSidebar.addEventListener("click", () => {
        sidebarOpen = !sidebarOpen;
        sidebarEl.classList.toggle("sidebar-open", sidebarOpen);
        mainPanel.classList.toggle("push-right", sidebarOpen);

        if (sidebarOpen) {
          // 只允许一侧打开
          insightOpen = false;
          if (insightEl) insightEl.classList.remove("insight-open");
          mainPanel.classList.remove("push-left");
        }

        syncOverlay();
      });

      // 右侧调用概览按钮：打开时主面板向左推
      btnInsight.addEventListener("click", () => {
        insightOpen = !insightOpen;
        if (insightEl) {
          insightEl.classList.toggle("insight-open", insightOpen);
        }
        mainPanel.classList.toggle("push-left", insightOpen);

        if (insightOpen) {
          sidebarOpen = false;
          sidebarEl.classList.remove("sidebar-open");
          mainPanel.classList.remove("push-right");
        }

        syncOverlay();
      });

      // 点击遮罩：关闭两边抽屉 & 还原主界面
      overlayEl.addEventListener("click", () => {
        sidebarOpen = false;
        insightOpen = false;
        sidebarEl.classList.remove("sidebar-open");
        if (insightEl) insightEl.classList.remove("insight-open");
        mainPanel.classList.remove("push-right");
        mainPanel.classList.remove("push-left");
        syncOverlay();
      });
    })();
  </script>
</body>
</html>









