<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ç« åå°ç®¡ç†</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* â€”â€” æ ·å¼å…¨éƒ¨ä¿ç•™ â€”â€” */
    body{font-family:Arial,sans-serif;background:#f8f8f8;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
    h1{font-size:24px;display:flex;align-items:center;gap:10px}
    .btn{padding:8px 16px;background:#333;color:#fff;border:none;cursor:pointer;margin-right:5px}.btn:hover{background:#555}
    .hidden{display:none}
    textarea,input[type=text],input[type=file]{width:100%;margin:5px 0}
    table{width:100%;max-width:960px;border-collapse:collapse;margin-top:20px;background:#fff}
    th,td{padding:10px;border:1px solid #ddd;text-align:left}th{background:#f0f0f0}
    .admin-bar{display:flex;justify-content:space-between;align-items:center;max-width:960px;width:100%;margin-bottom:20px;flex-wrap:wrap}
    .admin-bar>input{flex:1;min-width:200px;margin:5px}.admin-bar>div{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;min-width:200px;margin:5px}
    #previewModal{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;max-width:700px;width:90%;z-index:999;overflow-y:auto;max-height:80vh}
    #previewModal h3{margin-top:0}#previewModal img{max-width:100%}#markdownContent{white-space:pre-wrap}
    @media(max-width:768px){.admin-bar{flex-direction:column;align-items:stretch}.btn,textarea{width:100%;margin:5px 0}table,thead,tbody,th,td,tr{display:block}thead{display:none}tbody tr{border:1px solid #ddd;margin-bottom:15px;background:#fff;padding:10px}tbody td{display:flex;justify-content:space-between;padding:8px 5px;border:none;border-bottom:1px solid #eee}tbody td::before{content:attr(data-label);font-weight:bold;color:#555;flex:1;margin-right:10px}#submitBtn,#cancelEditBtn{width:100%}}
  </style>
</head>
<body>
<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<div id="authArea"><button id="loginBtn" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button></div>

<div id="adminArea" class="hidden">
  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦" />
    <div>
      <button id="searchBtn" class="btn">ğŸ” æœç´¢</button>
      <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
  <input type="text" id="newTitle" placeholder="æ ‡é¢˜" />
  <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
  <input type="file" id="coverInput" accept="image/*" />
  <div style="display:flex;gap:10px;margin-bottom:10px;flex-wrap:wrap;">
    <button id="submitBtn" class="btn">æäº¤</button>
    <button id="cancelEditBtn" class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
    <button class="btn" onclick="generateWithGPT()">AIç”Ÿæˆæ–‡ç« ç»“æ„ + SEO</button>
    <button id="generateStaticHtmlBtn" class="btn">ç”Ÿæˆé™æ€æ–‡ç« æ–‡ä»¶</button>
  </div>

  <div style="overflow-x:auto;width:100%;">
    <table id="articlesTable">
      <thead>
        <tr><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ›´æ–°æ—¶é—´</th>
            <th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="previewModal" class="hidden">
    <h3 id="previewTitle"></h3>
    <img id="previewCover" />
    <div id="markdownContent"></div>
    <button class="btn" onclick="closePreview()">å…³é—­</button>
  </div>
</div>

<!-- ä¾èµ– -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
/* ========== å…¨å±€å¸¸é‡ ========== */
const WORKER_BASE  = 'https://gpt.mefans.workers.dev';  // ä½ çš„ Worker åŸŸåï¼ˆä¸å¸¦ /gptï¼‰
const GPT_ENDPOINT = `${WORKER_BASE}/gpt`;              // ä¸“ç”¨ GPT ç«¯ç‚¹

const ANON_KEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
const ADMIN_EMAIL = 'oliveroogle@gmail.com';
const client      = supabase.createClient(WORKER_BASE, ANON_KEY);

/* å·¥å…·å‡½æ•° */
const weekdayMap = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
function getBeijingISOString() {
  return new Date(Date.now() + 8*3600e3).toISOString().replace('Z','+08:00');
}
function formatBeijingTime(str) { return new Date(str).toLocaleString('zh-CN',{hour12:false}); }
function getWeekday(str) { return weekdayMap[new Date(str).getDay()]; }
function esc(s){return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));}

/* ========== ä¸»é€»è¾‘ ========== */
document.addEventListener('DOMContentLoaded', async () => {
  const $ = id => document.getElementById(id);
  const authArea   = $('authArea');
  const adminArea  = $('adminArea');
  const loginBtn   = $('loginBtn');
  const logoutBtn  = $('logoutBtn');
  const submitBtn  = $('submitBtn');
  const cancelBtn  = $('cancelEditBtn');
  const searchBtn  = $('searchBtn');
  const searchInput= $('searchInput');
  const tableBody  = document.querySelector('#articlesTable tbody');

  let currentEditId=null,currentPage=1,limit=5,loading=false;

  /* â€”â€”â€” ä¼šè¯æ£€æµ‹ â€”â€”â€” */
  const { data:{session} } = await client.auth.getSession();
  if (session?.user?.email === ADMIN_EMAIL){
    authArea.classList.add('hidden');adminArea.classList.remove('hidden');loadArticles();
  }

  /* ç™»å½• & ç™»å‡º */
  loginBtn.onclick = () => client.auth.signInWithOAuth({provider:'github',options:{redirectTo:location.href}});
  logoutBtn.onclick= async()=>{await client.auth.signOut();location.reload();};

  /* æäº¤ï¼ˆæ–°å¢ / ç¼–è¾‘ï¼‰ */
  submitBtn.onclick = async()=>{
    const title=$('newTitle').value.trim(),content=$('newContent').value.trim();
    if(!title||!content)return alert('æ ‡é¢˜æˆ–å†…å®¹ä¸èƒ½ä¸ºç©º');
    const { data:{session} }=await client.auth.getSession();
    if(!session)return alert('è¯·å…ˆç™»å½•');
    let cover='';
    const file=$('coverInput').files[0];
    if(file){
      const {data,error}=await client.storage.from('articles').upload(`covers/${Date.now()}_${file.name}`,file);
      if(error)return alert('å°é¢ä¸Šä¼ å¤±è´¥ï¼š'+error.message);
      cover=client.storage.from('articles').getPublicUrl(data.path).data.publicUrl;
    }
    const now=getBeijingISOString();
    const row={title,content,author_email:session.user.email,updated_at:now,cover_url:cover||undefined};
    const res=currentEditId
      ? await client.from('articles').update(row).eq('id',currentEditId)
      : await client.from('articles').insert([{...row,created_at:now}]);
    if(res.error)return alert('æäº¤å¤±è´¥ï¼š'+res.error.message);
    cancelBtn.click();loadArticles(true);
  };

  cancelBtn.onclick=()=>{
    $('newTitle').value=$('newContent').value=$('coverInput').value='';
    currentEditId=null;cancelBtn.classList.add('hidden');
  };

  /* åˆ é™¤ / ç¼–è¾‘ / é¢„è§ˆ */
  window.deleteArticle=async id=>{
    if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;
    const{error}=await client.from('articles').delete().eq('id',id);
    if(error)return alert('åˆ é™¤å¤±è´¥ï¼š'+error.message);
    loadArticles(true);
  };
  window.editArticle=row=>{
    $('newTitle').value=row.title;$('newContent').value=row.content;
    currentEditId=row.id;cancelBtn.classList.remove('hidden');window.scrollTo(0,0);
  };
  window.previewArticle=row=>{
    $('previewTitle').textContent=row.title;
    $('previewCover').src=row.cover_url||'';
    $('markdownContent').innerHTML=marked.parse(row.content||'');
    $('previewModal').classList.remove('hidden');
  };
  window.closePreview=()=>$('previewModal').classList.add('hidden');

  searchBtn.onclick=()=>loadArticles(true,searchInput.value.trim());
  window.addEventListener('scroll',()=>{if(innerHeight+scrollY>=document.body.offsetHeight-10)loadArticles();});

  /* åˆ—è¡¨åŠ è½½ */
  async function loadArticles(reset=false,keyword=''){
    if(loading)return;loading=true;
    if(reset){tableBody.innerHTML='';currentPage=1;}
    let q=client.from('articles').select('*').order('created_at',{ascending:false})
      .range((currentPage-1)*limit,currentPage*limit-1);
    if(keyword)q=q.ilike('title',`%${keyword}%`);
    const{data,error}=await q;
    if(error){alert('åŠ è½½å¤±è´¥ï¼š'+error.message);loading=false;return;}
    data.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td data-label="æ ‡é¢˜">${esc(r.title)}</td>
        <td data-label="ä½œè€…">${esc(r.author_email)}</td>
        <td data-label="å†…å®¹">${esc((r.content||'').slice(0,60))}...</td>
        <td data-label="åˆ›å»ºæ—¶é—´">${formatBeijingTime(r.created_at)}</td>
        <td data-label="æ›´æ–°æ—¶é—´">${formatBeijingTime(r.updated_at)}</td>
        <td data-label="æ˜ŸæœŸ">${getWeekday(r.created_at)}</td>
        <td data-label="å°é¢">${r.cover_url?`<img src="${r.cover_url}" style="height:40px;">`:''}</td>
        <td data-label="æ“ä½œ">
          <button class="btn" onclick='previewArticle(${JSON.stringify(r)})'>é¢„è§ˆ</button>
          <button class="btn" onclick='editArticle(${JSON.stringify(r)})'>ç¼–è¾‘</button>
          <button class="btn" onclick='deleteArticle("${r.id}")'>åˆ é™¤</button>
        </td>`;
      tableBody.appendChild(tr);
    });
    loading=false;if(data.length===limit)currentPage++;
  }

  /* ç”Ÿæˆé™æ€ HTML é€»è¾‘ï¼ˆä¿æŒä¸å˜ï¼Œç•¥ï¼‰ */
  document.getElementById('generateStaticHtmlBtn').addEventListener('click',async()=>{
    const title=$('newTitle').value.trim(),content=$('newContent').value.trim();
    if(!title||!content)return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
    const createdAt=getBeijingISOString().split('T')[0];
    const slug=title.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
    const desc=(window._lastSeo||{}).desc||esc(title);
    const kw  =(window._lastSeo||{}).kw  ||'Bluetooth headphones, MeFan';
    const html=`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/>
<title>${esc(title)} | MeFan æŠ€æœ¯åšå®¢</title>
<meta name="description" content="${esc(desc)}"/>
<meta name="keywords" content="${esc(kw)}"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<meta name="robots" content="index, follow"/>
<link rel="canonical" href="https://oliverfr.com/articles/${slug}.html"/>
<style>body{font-family:Arial,sans-serif;margin:40px auto;max-width:700px;line-height:1.6}h1{font-size:28px;margin-bottom:20px}.meta{color:#888;font-size:14px;margin-bottom:20px}img{max-width:100%;margin:20px 0}</style></head>
<body><h1>${esc(title)}</h1><div class="meta">å‘å¸ƒæ—¥æœŸï¼š${createdAt} ï½œ ä½œè€…ï¼šOliverÂ F.</div>
${marked.parse(content)}</body></html>`;
    const res=await fetch('https://upload-articlejs.mefans.workers.dev/',{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({slug,html})
    }).then(r=>r.json());
    res.success?alert('å·²å‘å¸ƒä¸Šçº¿ï¼ç‚¹å‡»æŸ¥çœ‹ï¼š'+res.url):alert('å‘å¸ƒå¤±è´¥ï¼š'+JSON.stringify(res));
  });
});

/* ========== GPT ç”Ÿæˆ ========= */
async function generateWithGPT(){
  const topic=document.getElementById('newTitle').value.trim();
  if(!topic)return alert('è¯·å…ˆè¾“å…¥ä¸€ä¸ªä¸»é¢˜æ ‡é¢˜åå†ç‚¹å‡»ç”Ÿæˆ');
  try{
    const res=await fetch(GPT_ENDPOINT,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({topic})
    });
    const result=await res.json();
    if(!result.success)throw new Error(result.detail||result.message||'ç”Ÿæˆå¤±è´¥');
    document.getElementById('newContent').value=result.content||'';
    window._lastSeo={desc:result.description||'',kw:result.keywords||''};
    alert('âœ… AI å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æ£€æŸ¥ç¼–è¾‘åŒºï¼');
  }catch(err){
    console.error('GPT ç”Ÿæˆå¼‚å¸¸:',err);
    alert('âŒ GPT å†…å®¹ç”Ÿæˆå¤±è´¥ï¼š'+err.message);
  }
}
</script>
</body>
</html>
