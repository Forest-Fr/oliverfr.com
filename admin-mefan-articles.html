<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>æ–‡ç« åå°ç®¡ç†</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    body { font-family: Arial,sans-serif; background:#f8f8f8; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center }
    h1 { font-size:24px; margin-bottom:10px }
    .btn { padding:8px 16px; background:#333; color:#fff; border:none; cursor:pointer; margin:5px }
    .btn:hover { background:#555 }
    .hidden { display:none }
    textarea,input[type="text"],input[type="file"] { width:100%; margin:5px 0 }
    table { width:100%; max-width:960px; border-collapse:collapse; margin-top:20px; background:#fff }
    th,td { padding:10px; border:1px solid #ddd; text-align:left }
    th { background:#f0f0f0 }
    .admin-bar { display:flex; justify-content:space-between; align-items:center; max-width:960px; width:100%; margin-bottom:20px; flex-wrap:wrap }
    .admin-bar > input { flex:1; min-width:200px; margin:5px }
    .admin-bar > div   { display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin:5px }
    #previewModal { position:fixed; top:10%; left:50%; transform:translateX(-50%); background:#fff; padding:20px; border:1px solid #ccc; max-width:700px; width:90%; z-index:999; overflow-y:auto; max-height:80vh }
    #previewModal img { max-width:100% }
    #markdownContent { white-space:pre-wrap }
    @media(max-width:768px){
      .admin-bar { flex-direction:column }
      .btn,textarea { width:100% }
      table,thead,tbody,th,td,tr { display:block }
      thead { display:none }
      tbody tr { margin-bottom:15px; padding:10px; border:1px solid #ddd; background:#fff }
      tbody td { display:flex; justify-content:space-between; padding:8px 5px; border-bottom:1px solid #eee }
      tbody td::before { content:attr(data-label); font-weight:bold; margin-right:10px }
    }
  </style>

  <!-- 1. UMD ç‰ˆ Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <!-- 2. Markdown è§£æ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <!-- 3. UMD ç‰ˆ Editor.js + æ’ä»¶ -->
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2/dist/editor.umd.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
</head>
<body>
  <h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

  <div id="authArea">
    <button id="loginBtn" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button>
  </div>

  <div id="adminArea" class="hidden">
    <!-- æœç´¢ & ç™»å‡º -->
    <div class="admin-bar">
      <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦"/>
      <div>
        <button id="searchBtn" class="btn">ğŸ” æœç´¢</button>
        <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <!-- ç¼–è¾‘åŒºåˆ‡æ¢ -->
    <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
    <input type="text" id="newTitle" placeholder="æ ‡é¢˜"/>
    <div style="display:flex; gap:10px; margin:5px 0;">
      <button id="toggleToEditor" class="btn">ğŸ“ å¯è§†åŒ–æ¨¡å¼</button>
      <button id="toggleToTextarea" class="btn hidden">ğŸ–Š Markdown æ¨¡å¼</button>
    </div>
    <div id="editorContainer" class="hidden" style="border:1px solid #ccc;min-height:200px;padding:10px;background:#fff"></div>
    <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
    <input type="file" id="coverInput" accept="image/*"/>
    <div style="display:flex; gap:10px; flex-wrap:wrap; margin:10px 0;">
      <button id="submitBtn" class="btn">æäº¤</button>
      <button id="cancelEditBtn" class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
      <button id="generateStaticHtmlBtn" class="btn">ç”Ÿæˆé™æ€æ–‡ç« æ–‡ä»¶</button>
      <button id="aiBtn" class="btn">AI ç”Ÿæˆæ–‡ç« ç»“æ„+SEO</button>
    </div>

    <!-- åˆ—è¡¨ -->
    <div style="overflow-x:auto; width:100%;">
      <table id="articlesTable">
        <thead>
          <tr>
            <th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th>
            <th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- é¢„è§ˆå¼¹çª— -->
    <div id="previewModal" class="hidden">
      <h3 id="previewTitle"></h3>
      <img id="previewCover"/>
      <div id="markdownContent"></div>
      <button class="btn" onclick="closePreview()">å…³é—­</button>
    </div>
  </div>

  <script>
  (async ()=>{
    // â€”â€” å…¨å±€é…ç½® â€”â€” 
    const WORKER_BASE = 'https://oliverfr-articles-proxy.mefans.workers.dev';
    const ANON_KEY     = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
    const ADMIN_EMAIL  = 'oliveroogle@gmail.com';
    const supa = supabase.createClient(WORKER_BASE, ANON_KEY);

    // å·¥å…·å‡½æ•°
    const esc = s => (s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    const toBJ = ()=> new Date(Date.now()+8*3600*1000).toISOString().replace('Z','+08:00');
    const fmtTime = s=> new Date(s).toLocaleString('zh-CN',{hour12:false});
    const wk = s=> ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(s).getDay()];

    // DOM
    const authArea  = document.getElementById('authArea');
    const adminArea = document.getElementById('adminArea');
    const loginBtn  = document.getElementById('loginBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const submitBtn = document.getElementById('submitBtn');
    const cancelBtn = document.getElementById('cancelEditBtn');
    const searchBtn = document.getElementById('searchBtn');
    const genBtn    = document.getElementById('generateStaticHtmlBtn');
    const aiBtn     = document.getElementById('aiBtn');
    const tbBody    = document.querySelector('#articlesTable tbody');
    const btnE      = document.getElementById('toggleToEditor');
    const btnT      = document.getElementById('toggleToTextarea');
    const editorDiv = document.getElementById('editorContainer');
    const mdArea    = document.getElementById('newContent');
    const titleInp  = document.getElementById('newTitle');
    let editor=null, editingId=null, page=1, limit=5, busy=false;

    // åˆ‡æ¢åˆ°å¯è§†åŒ–
    btnE.onclick = async ()=>{
      if(editor) await editor.destroy();
      editorDiv.classList.remove('hidden'); mdArea.classList.add('hidden');
      btnE.classList.add('hidden'); btnT.classList.remove('hidden');
      editor = new EditorJS({
        holder: 'editorContainer',
        tools: {
          paragraph: { class: Paragraph, inlineToolbar: true },
          header:    { class: Header,    inlineToolbar: true },
        },
        data: { blocks: [{ type:'paragraph', data:{ text: mdArea.value }}] }
      });
    };
    // åˆ‡æ¢å› Markdown
    btnT.onclick = async ()=>{
      if(!editor) return;
      const saved = await editor.save();
      // æ‰‹åŠ¨æå–æ‰€æœ‰ blocks çš„ textï¼Œæœ€ç®€å•æ‹¼ Markdown
      const md = saved.blocks
        .map(b=>b.data.text||'')
        .filter(t=>t.trim())
        .join('\n\n');
      mdArea.value = md;
      await editor.destroy(); editor = null;
      editorDiv.classList.add('hidden'); mdArea.classList.remove('hidden');
      btnE.classList.remove('hidden'); btnT.classList.add('hidden');
    };
    btnE.click(); // é»˜è®¤æ‰“å¼€å¯è§†åŒ–

    // OAuth çŠ¶æ€æ£€æŸ¥
    const { data:{ session }} = await supa.auth.getSession();
    if(session?.user?.email===ADMIN_EMAIL){
      authArea.classList.add('hidden');
      adminArea.classList.remove('hidden');
      loadArticles();
    }
    loginBtn.onclick  = ()=> supa.auth.signInWithOAuth({ provider:'github', options:{ redirectTo:location.href }});
    logoutBtn.onclick = async ()=>{ await supa.auth.signOut(); location.reload(); };

    // æäº¤æˆ–æ›´æ–°
    submitBtn.onclick = async ()=>{
      const title = titleInp.value.trim();
      const content = editor
        ? (await editor.save()).blocks.map(b=>b.data.text||'').join('\n\n').trim()
        : mdArea.value.trim();
      if(!title||!content) return alert('æ ‡é¢˜æˆ–å†…å®¹ä¸èƒ½ä¸ºç©º');
      const { data:{ session }} = await supa.auth.getSession();
      if(!session) return alert('è¯·å…ˆç™»å½•');

      // ä¸Šä¼ å°é¢
      let coverUrl = '';
      const file = document.getElementById('coverInput').files[0];
      if(file){
        const { data, error } = await supa.storage.from('articles')
          .upload(`covers/${Date.now()}_${file.name}`, file);
        if(error) return alert('å°é¢ä¸Šä¼ å¤±è´¥ï¼š'+error.message);
        coverUrl = supa.storage.from('articles').getPublicUrl(data.path).data.publicUrl;
      }

      const now = toBJ();
      const row = { title, content, author_email: session.user.email, updated_at: now, ...(coverUrl&&{cover_url:coverUrl}) };
      const res = editingId
        ? await supa.from('articles').update(row).eq('id', editingId)
        : await supa.from('articles').insert([{ ...row, created_at: now }]);
      if(res.error) return alert('æäº¤å¤±è´¥ï¼š'+res.error.message);

      cancelBtn.click();
      loadArticles(true);
    };

    // å–æ¶ˆç¼–è¾‘
    cancelBtn.onclick = ()=>{
      titleInp.value = '';
      mdArea.value = '';
      document.getElementById('coverInput').value = '';
      editingId = null;
      cancelBtn.classList.add('hidden');
    };

    // åˆ é™¤
    window.deleteArticle = async id=>{
      if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
      const { error } = await supa.from('articles').delete().eq('id', id);
      if(error) return alert('åˆ é™¤å¤±è´¥ï¼š'+error.message);
      loadArticles(true);
    };

    // ç¼–è¾‘
    window.editArticle = row=>{
      titleInp.value = row.title;
      mdArea.value = row.content;
      editingId = row.id;
      cancelBtn.classList.remove('hidden');
      btnT.click();
      window.scrollTo(0,0);
    };

    // é¢„è§ˆ
    window.previewArticle = row=>{
      document.getElementById('previewTitle').textContent = row.title;
      document.getElementById('previewCover').src = row.cover_url||'';
      document.getElementById('markdownContent').innerHTML = marked.parse(row.content||'');
      document.getElementById('previewModal').classList.remove('hidden');
    };
    window.closePreview = ()=> document.getElementById('previewModal').classList.add('hidden');

    // æœç´¢ & æ»šåŠ¨
    searchBtn.onclick = ()=> loadArticles(true, document.getElementById('searchInput').value.trim());
    window.addEventListener('scroll', ()=>{
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 50) {
        loadArticles();
      }
    });

    // åŠ è½½æ–‡ç« åˆ—è¡¨
    async function loadArticles(reset=false, kw=''){
      if(busy) return;
      busy = true;
      if(reset){
        tbBody.innerHTML = '';
        page = 1;
      }
      let q = supa.from('articles').select('*').order('created_at',{ascending:false})
                .range((page-1)*limit, page*limit-1);
      if(kw) q = q.ilike('title','%'+kw+'%');
      const { data, error } = await q;
      if(error){ alert('åŠ è½½å¤±è´¥ï¼š'+error.message); busy=false; return; }
      data.forEach(r=>{
        const tr = document.createElement('tr');
        const coverTd = r.cover_url
          ? `<td data-label="å°é¢"><img src="${r.cover_url}" style="height:40px"></td>`
          : `<td data-label="å°é¢"></td>`;
        tr.innerHTML =
          `<td data-label="æ ‡é¢˜">${esc(r.title)}</td>
           <td data-label="ä½œè€…">${esc(r.author_email)}</td>
           <td data-label="å†…å®¹">${esc((r.content||'').slice(0,60))}â€¦</td>
           <td data-label="åˆ›å»ºæ—¶é—´">${fmtTime(r.created_at)}</td>
           <td data-label="æ›´æ–°æ—¶é—´">${fmtTime(r.updated_at)}</td>
           <td data-label="æ˜ŸæœŸ">æ˜ŸæœŸ${wk(r.created_at)}</td>
           ${coverTd}
           <td data-label="æ“ä½œ">
             <button class="btn" onclick='previewArticle(${JSON.stringify(r).replace(/'/g,"\\'")})'>é¢„è§ˆ</button>
             <button class="btn" onclick='editArticle(${JSON.stringify(r).replace(/'/g,"\\'")})'>ç¼–è¾‘</button>
             <button class="btn" onclick="deleteArticle('${r.id}')">åˆ é™¤</button>
           </td>`;
        tbBody.appendChild(tr);
      });
      busy = false;
      if(data.length === limit) page++;
    }

    // ç”Ÿæˆé™æ€ HTML
    genBtn.onclick = async ()=>{
      const title = titleInp.value.trim();
      const content = editor
        ? (await editor.save()).blocks.map(b=>b.data.text||'').join('\n\n').trim()
        : mdArea.value.trim();
      if(!title||!content) return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
      const createdAt = toBJ().split('T')[0];
      const slug = title.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
      const html = [
        '<!DOCTYPE html>',
        '<html lang="zh-CN"><head><meta charset="UTF-8"/>',
        `<title>${esc(title)} | MeFan æŠ€æœ¯åšå®¢</title>`,
        `<meta name="description" content="${esc(title)}"/>`,
        `<link rel="canonical" href="https://oliverfr.com/articles/${slug}.html"/>`,
        '<style>body{font-family:Arial,sans-serif;margin:40px auto;max-width:700px;line-height:1.6}</style>',
        '</head><body>',
        `<h1>${esc(title)}</h1>`,
        `<div class="meta">å‘å¸ƒæ—¥æœŸï¼š${createdAt} ï½œ ä½œè€…ï¼šOliverÂ F.</div>`,
        marked.parse(content),
        '</body></html>'
      ].join('\n');
      try{
        const r = await fetch(WORKER_BASE+'/', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ slug, html })
        }).then(r=>r.json());
        if(r.success) alert('âœ… å·²å‘å¸ƒä¸Šçº¿ï¼š'+r.url);
        else throw new Error(r.message||JSON.stringify(r));
      }catch(e){
        alert('âŒ å‘å¸ƒå¤±è´¥ï¼š'+e.message);
      }
    };

    // AI ç”Ÿæˆ
    aiBtn.onclick = async ()=>{
      const topic = titleInp.value.trim();
      if(!topic) return alert('è¯·å…ˆè¾“å…¥æ ‡é¢˜');
      try{
        const j = await fetch('https://gpt.mefans.workers.dev/gpt', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ topic })
        }).then(r=>r.json());
        if(!j.success) throw new Error(j.detail||j.message||'ç”Ÿæˆå¤±è´¥');
        mdArea.value = j.content;
        if(editor){
          await editor.blocks.clear();
          await editor.blocks.insert('paragraph',{ text:j.content });
        }
        alert('âœ… AI å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æ£€æŸ¥ç¼–è¾‘åŒºï¼');
      }catch(e){
        alert('âŒ GPT ç”Ÿæˆå¤±è´¥ï¼š'+e.message);
      }
    };

  })();
  </script>
</body>
</html>
