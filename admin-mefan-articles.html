<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ç« åå°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />

  <style>
    /* â€”â€” æ ·å¼ä¿æŒå®Œå…¨ä¸€è‡´ â€”â€” */
    body{font-family:Arial,Helvetica,sans-serif;background:#f8f8f8;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
    h1{font-size:24px;display:flex;align-items:center;gap:10px;margin-bottom:20px}
    .btn{padding:8px 16px;background:#333;color:#fff;border:none;cursor:pointer;margin:5px}
    .btn:hover{background:#555}
    .hidden{display:none}
    textarea,input[type="text"],input[type="file"]{width:100%;margin:5px 0}
    table{width:100%;max-width:960px;border-collapse:collapse;margin-top:20px;background:#fff}
    th,td{padding:10px;border:1px solid #ddd;text-align:left}
    th{background:#f0f0f0}
    .admin-bar{display:flex;justify-content:space-between;align-items:center;max-width:960px;width:100%;margin-bottom:20px;flex-wrap:wrap}
    .admin-bar>input{flex:1;min-width:200px;margin:5px}
    .admin-bar>div{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:5px}
    #editorContainer{width:100%;max-width:960px;border:1px solid #ccc;min-height:300px;padding:10px;background:#fff;margin-bottom:10px}
    #previewModal{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;max-width:700px;width:90%;z-index:999;overflow-y:auto;max-height:80vh}
    #previewModal h3{margin-top:0}
    #previewModal img{max-width:100%}
    #markdownContent{white-space:pre-wrap}
    @media(max-width:768px){
      .admin-bar{flex-direction:column;align-items:stretch}
      .btn,textarea{width:100%;margin:5px 0}
      table,thead,tbody,th,td,tr{display:block}
      thead{display:none}
      tbody tr{border:1px solid #ddd;margin-bottom:15px;background:#fff;padding:10px}
      tbody td{display:flex;justify-content:space-between;padding:8px 5px;border:none;border-bottom:1px solid #eee}
      tbody td::before{content:attr(data-label);font-weight:bold;margin-right:10px}
    }
  </style>
</head>
<body>
  <h1>ğŸ“°Â æ–‡ç« åå°ç®¡ç†</h1>

  <!-- ç™»å½•åŒºåŸŸ -->
  <div id="authArea">
    <button id="loginBtn" class="btn">ä½¿ç”¨Â GitHubÂ ç™»å½•</button>
  </div>

  <!-- åå°ä¸»ä½“ -->
  <div id="adminArea" class="hidden">
    <div class="admin-bar">
      <input id="searchInput" type="text" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦" />
      <div>
        <button id="searchBtn" class="btn">ğŸ”Â æœç´¢</button>
        <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <h2>ğŸ†•Â æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
    <input id="newTitle" type="text" placeholder="æ ‡é¢˜" />
    <div style="display:flex;gap:10px;margin:5px 0;">
      <button id="toggleToEditor" class="btn">ğŸ“Â å¯è§†åŒ–æ¨¡å¼</button>
      <button id="toggleToTextarea" class="btn hidden">ğŸ–ŠÂ MarkdownÂ æ¨¡å¼</button>
    </div>
    <div id="editorContainer" class="hidden"></div>
    <textarea id="newContent" placeholder="æ”¯æŒÂ MarkdownÂ æ ¼å¼çš„å†…å®¹"></textarea>
    <input id="coverInput" type="file" accept="image/*" />
    <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px;">
      <button id="submitBtn" class="btn">æäº¤</button>
      <button id="cancelEditBtn" class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
      <button id="generateStaticHtmlBtn" class="btn">ç”Ÿæˆé™æ€æ–‡ç« æ–‡ä»¶</button>
      <button id="aiBtn" class="btn">AIÂ ç”Ÿæˆæ–‡ç« ç»“æ„Â +Â SEO</button>
    </div>

    <div style="overflow-x:auto;width:100%;">
      <table id="articlesTable">
        <thead>
          <tr>
            <th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th>
            <th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="previewModal" class="hidden">
      <h3 id="previewTitle"></h3>
      <img id="previewCover" />
      <div id="markdownContent"></div>
      <button id="closePreviewBtn" class="btn">å…³é—­</button>
    </div>
  </div>

  <!-- â€”â€” â‘  å¿…é¡»æŒ‰é¡ºåºå¼•å…¥ UMD â€”â€” -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2/dist/editor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/editorjs-html@2.4.1/dist/bundle.min.js"></script>

  <!-- â€”â€” â‘¡ å®Œæ•´ä¸šåŠ¡é€»è¾‘ â€”â€” -->
  <script>
    // é…ç½®ï¼ˆç›´æ¥ç”¨ä½ çš„å®Œæ•´ anon keyï¼‰
    const WORKER_BASE = 'https://oliverfr-articles-proxy.mefans.workers.dev';
    const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
    const ADMIN_EMAIL = 'oliveroogle@gmail.com';
    const supa = window.supabase.createClient(WORKER_BASE, ANON_KEY);

    // Editor.js & çŠ¶æ€
    const edjsParser = window.edjsHTML();
    let editor = null, currentEditId = null, page = 1, limit = 5, loading = false;
    const $ = id => document.getElementById(id);

    async function initEditor(md = '') {
      if (editor) await editor.destroy();
      $('editorContainer').classList.remove('hidden');
      $('newContent').classList.add('hidden');
      $('toggleToEditor').classList.add('hidden');
      $('toggleToTextarea').classList.remove('hidden');
      const blocks = md.split(/\n{2,}/).filter(t => t).map(t => ({
        type: 'paragraph',
        data: { text: t.replace(/\n/g, '<br>') }
      }));
      editor = new EditorJS({
        holder: 'editorContainer',
        tools: {
          paragraph: { class: Paragraph, inlineToolbar: true },
          header:    { class: Header,    inlineToolbar: true }
        },
        data: { time: Date.now(), blocks }
      });
    }
    async function destroyEditor() {
      if (!editor) return;
      const out = await editor.save();
      $('newContent').value = edjsParser.parse(out).join('\n\n');
      await editor.destroy(); editor = null;
      $('editorContainer').classList.add('hidden');
      $('newContent').classList.remove('hidden');
      $('toggleToEditor').classList.remove('hidden');
      $('toggleToTextarea').classList.add('hidden');
    }
    async function getEditorMarkdown() {
      if (!editor) return $('newContent').value.trim();
      const out = await editor.save();
      return edjsParser.parse(out).join('\n\n').trim();
    }
    function getBeijingISOString(){ return new Date(Date.now()+8*3600*1000).toISOString().replace('Z','+08:00'); }
    function formatBeijingTime(s){ return new Date(s).toLocaleString('zh-CN',{hour12:false}); }
    function getWeekday(s){ return ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'][new Date(s).getDay()]; }
    function escapeHTML(s){ return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

    document.addEventListener('DOMContentLoaded', async () => {
      const loginBtn  = $('loginBtn'),
            logoutBtn = $('logoutBtn'),
            submitBtn = $('submitBtn'),
            cancelBtn = $('cancelEditBtn'),
            searchBtn = $('searchBtn'),
            genBtn    = $('generateStaticHtmlBtn'),
            aiBtn     = $('aiBtn'),
            searchIn  = $('searchInput'),
            tbody     = document.querySelector('#articlesTable tbody'),
            toggleE   = $('toggleToEditor'),
            toggleT   = $('toggleToTextarea'),
            authArea  = $('authArea'),
            adminArea = $('adminArea'),
            closePrev = $('closePreviewBtn');

      // Markdown â†” å¯è§†åŒ–
      toggleE.onclick = ()=>initEditor($('newContent').value);
      toggleT.onclick = destroyEditor;

      // ç™»å½•çŠ¶æ€æ£€æŸ¥
      const { data: { session }} = await supa.auth.getSession();
      if (session?.user?.email === ADMIN_EMAIL) {
        authArea.classList.add('hidden');
        adminArea.classList.remove('hidden');
        loadArticles();
      }

      loginBtn.onclick = () => supa.auth.signInWithOAuth({
        provider:'github', options:{redirectTo:location.href}
      });
      logoutBtn.onclick = async()=>{
        await supa.auth.signOut();
        location.reload();
      };

      // æäº¤/æ›´æ–°
      submitBtn.onclick = async()=>{
        const title = $('newTitle').value.trim();
        const content = await getEditorMarkdown();
        if(!title||!content) return alert('æ ‡é¢˜æˆ–å†…å®¹ä¸èƒ½ä¸ºç©º');
        const { data:{session}} = await supa.auth.getSession();
        if(!session) return alert('è¯·å…ˆç™»å½•');

        // ä¸Šä¼ å°é¢
        let coverUrl = '';
        const file = $('coverInput').files[0];
        if(file){
          const { data, error } = await supa.storage.from('articles').upload(`covers/${Date.now()}_${file.name}`, file);
          if(error) return alert('å°é¢ä¸Šä¼ å¤±è´¥ï¼š'+error.message);
          coverUrl = supa.storage.from('articles').getPublicUrl(data.path).data.publicUrl;
        }

        const now = getBeijingISOString();
        const row = {
          title, content,
          author_email: session.user.email,
          updated_at: now,
          ...(coverUrl&&{cover_url:coverUrl})
        };
        const res = currentEditId
          ? await supa.from('articles').update(row).eq('id',currentEditId)
          : await supa.from('articles').insert([{...row,created_at:now}]);
        if(res.error) return alert('æäº¤å¤±è´¥ï¼š'+res.error.message);

        cancelBtn.click();
        loadArticles(true);
      };

      // å–æ¶ˆç¼–è¾‘
      cancelBtn.onclick = ()=>{
        ['newTitle','newContent','coverInput'].forEach(id=>$(id).value='');
        currentEditId = null;
        cancelBtn.classList.add('hidden');
        destroyEditor();
      };

      // é¢„è§ˆ/å…³é—­
      window.previewArticle = a => {
        $('previewTitle').innerText = a.title;
        $('previewCover').src = a.cover_url||'';
        $('markdownContent').innerHTML = marked.parse(a.content||'');
        $('previewModal').classList.remove('hidden');
      };
      closePrev.onclick = ()=>$('previewModal').classList.add('hidden');

      // ç¼–è¾‘
      window.editArticle = a => {
        $('newTitle').value = a.title;
        $('newContent').value = a.content;
        currentEditId = a.id;
        cancelBtn.classList.remove('hidden');
        destroyEditor().then(()=>initEditor(a.content));
      };

      // åˆ é™¤
      window.deleteArticle = async id => {
        if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
        const { error } = await supa.from('articles').delete().eq('id',id);
        if(error) return alert('åˆ é™¤å¤±è´¥ï¼š'+error.message);
        loadArticles(true);
      };

      // æœç´¢ & æ— é™æ»šåŠ¨
      searchBtn.onclick = ()=>loadArticles(true,searchIn.value.trim());
      window.addEventListener('scroll', () => {
        if(window.innerHeight+window.scrollY >= document.body.offsetHeight-10) {
          loadArticles();
        }
      });

      // ç”Ÿæˆé™æ€ HTML
      genBtn.onclick = async()=>{
        const title = $('newTitle').value.trim();
        const content = await getEditorMarkdown();
        if(!title||!content) return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
        const published = getBeijingISOString().split('T')[0];
        const slug = title.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
        const html = `<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/><title>${escapeHTML(title)}</title></head><body><h1>${escapeHTML(title)}</h1>${marked.parse(content)}</body></html>`;
        const r = await fetch('https://upload-articlejs.mefans.workers.dev/',{
          method:'POST',headers:{'Content-Type':'application/json'},
          body:JSON.stringify({slug,html})
        }).then(r=>r.json());
        r.success?alert('âœ… å‘å¸ƒæˆåŠŸï¼š'+r.url):alert('âŒ å‘å¸ƒå¤±è´¥ï¼š'+JSON.stringify(r));
      };

      // AI ç”Ÿæˆ
      aiBtn.onclick = async()=>{
        const topic = $('newTitle').value.trim();
        if(!topic) return alert('è¯·å…ˆè¾“å…¥ä¸»é¢˜');
        try{
          const r = await fetch('https://gpt.mefans.workers.dev/gpt',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({topic})
          }).then(r=>r.json());
          if(!r.success) throw new Error('ç”Ÿæˆå¤±è´¥');
          if(editor){ await editor.blocks.clear(); editor.blocks.insert('paragraph',{text:r.content}); }
          else $('newContent').value = r.content;
          alert('âœ… AI å†…å®¹å·²ç”Ÿæˆ');
        }catch(e){
          alert('âŒ GPT ç”Ÿæˆå¤±è´¥ï¼š'+e.message);
        }
      };

      // åŠ è½½åˆ—è¡¨
      async function loadArticles(reset=false, keyword='') {
        if(loading) return;
        loading = true;
        if(reset){ tbody.innerHTML=''; page=1; }
        let q = supa.from('articles').select('*').order('created_at',{ascending:false})
                   .range((page-1)*limit, page*limit-1);
        if(keyword) q = q.ilike('title', `%${keyword}%`);
        const { data, error } = await q;
        if(error){ alert('åŠ è½½å¤±è´¥ï¼š'+error.message); loading=false; return; }
        data.forEach(a => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="æ ‡é¢˜">${escapeHTML(a.title)}</td>
            <td data-label="ä½œè€…">${escapeHTML(a.author_email||'')}</td>
            <td data-label="å†…å®¹">${escapeHTML((a.content||'').slice(0,60))}â€¦</td>
            <td data-label="åˆ›å»ºæ—¶é—´">${formatBeijingTime(a.created_at)}</td>
            <td data-label="æ›´æ–°æ—¶é—´">${formatBeijingTime(a.updated_at)}</td>
            <td data-label="æ˜ŸæœŸ">${getWeekday(a.created_at)}</td>
            <td data-label="å°é¢">${a.cover_url?`<img src="${a.cover_url}" style="max-width:60px">`:''}</td>
            <td data-label="æ“ä½œ">
              <button class="btn" onclick='previewArticle(${JSON.stringify(a)})'>é¢„è§ˆ</button>
              <button class="btn" onclick='editArticle(${JSON.stringify(a)})'>ç¼–è¾‘</button>
              <button class="btn" onclick="deleteArticle('${a.id}')">åˆ é™¤</button>
            </td>`;
          tbody.appendChild(tr);
        });
        loading=false;
        if(data.length===limit) page++;
      }
    });
  </script>
</body>
</html>
