
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文章后台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .btn { padding: 8px 16px; background: #333; color: #fff; border: none; cursor: pointer; margin: 5px 5px 5px 0; }
    .btn:hover { background: #555; }
    .hidden { display: none; }
    textarea, input[type="text"], input[type="file"] { width: 100%; margin: 5px 0; }
    table { width: 100%; max-width: 960px; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }
    .admin-bar { display: flex; justify-content: space-between; align-items: center; max-width: 960px; width: 100%; margin-bottom: 20px; flex-wrap: wrap; }
    .admin-bar > input { flex: 1; min-width: 200px; margin: 5px; }
    .admin-bar > div { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; min-width: 200px; margin: 5px; }
    #previewModal { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: #fff; padding: 20px; border: 1px solid #ccc; max-width: 700px; width: 90%; z-index: 999; overflow-y: auto; max-height: 80vh; }
    #previewModal h3 { margin-top: 0; }
    #previewModal img { max-width: 100%; }
    #markdownContent { white-space: pre-wrap; }
    #editorContainer { width: 100%; max-width: 960px; border: 1px solid #ccc; min-height: 300px; padding: 10px; background: #fff; margin-bottom: 10px; }

    @media (max-width: 768px) {
      .admin-bar { flex-direction: column; align-items: stretch; }
      .btn, textarea { width: 100%; margin: 5px 0; }
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tbody tr { border: 1px solid #ddd; margin-bottom: 15px; background: #fff; padding: 10px; }
      tbody td { display: flex; justify-content: space-between; padding: 8px 5px; border: none; border-bottom: 1px solid #eee; }
      tbody td::before { content: attr(data-label); font-weight: bold; color: #555; flex: 1; margin-right: 10px; }
    }
  </style>

  <!-- ✅ 插件 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2/dist/editor.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/editorjs-html@3.4.0/build/index.umd.js"></script>
</head>
<body>
  <h1>📰 文章后台管理</h1>
  <div id="authArea"><button id="loginBtn" class="btn">使用 GitHub 登录</button></div>
  <div id="adminArea" class="hidden">
    <div class="admin-bar">
      <input type="text" id="searchInput" placeholder="搜索标题关键词…" />
      <div><button id="searchBtn" class="btn">🔍 搜索</button><button id="logoutBtn" class="btn">退出登录</button></div>
    </div>

    <h2>🆕 新增/编辑文章</h2>
    <input type="text" id="newTitle" placeholder="标题" />
    <div style="display:flex;gap:10px;margin:5px 0;">
      <button class="btn" id="toggleToEditor">📐 可视化模式</button>
      <button class="btn hidden" id="toggleToTextarea">🖊 Markdown 模式</button>
    </div>
    <div id="editorContainer" class="hidden"></div>
    <textarea id="newContent" placeholder="支持 Markdown 格式的内容"></textarea>
    <input type="file" id="coverInput" accept="image/*" />
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button id="submitBtn" class="btn">提交</button>
      <button id="cancelEditBtn" class="btn hidden">取消编辑</button>
      <button id="generateStaticHtmlBtn" class="btn">生成静态文章文件</button>
      <button onclick="generateWithGPT()" class="btn">AI生成文章结构 + SEO</button>
    </div>

    <table id="articlesTable"><thead><tr><th>标题</th><th>作者</th><th>内容</th><th>创建时间</th><th>更新时间</th><th>星期</th><th>封面</th><th>操作</th></tr></thead><tbody></tbody></table>

    <div id="previewModal" class="hidden">
      <h3 id="previewTitle"></h3><img id="previewCover" /><div id="markdownContent"></div><button class="btn" onclick="closePreview()">关闭</button>
    </div>
  </div>

  <!-- ✅ 主脚本逻辑 -->
  <script>
    const WORKER_BASE = 'https://oliverfr-articles-proxy.mefans.workers.dev';
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg'; // 你自己的 Supabase Key
    const ADMIN_EMAIL = 'oliveroogle@gmail.com';
    const client = supabase.createClient(WORKER_BASE, ANON_KEY);
    let editor, currentEditId = null;
   // 接下来就可以用 supa.auth.signInWithOAuth 等接口了
    document.getElementById('loginBtn').onclick = () => {
      supa.auth.signInWithOAuth({
        provider: 'github',
        options: { redirectTo: location.href }
      });
    };
    function getBeijingISOString() {
      const utcMs = Date.now();
      const bjMs = utcMs + 8 * 3600 * 1000;
      return new Date(bjMs).toISOString().replace('Z', '+08:00');
    }
    async function getEditorMarkdown() {
      if (!editor) return document.getElementById("newContent").value;
      const output = await editor.save();
      return edjsHTML().parse(output).join("\\n\\n");
    }

    async function initEditor(data = null) {
      if (editor) await editor.destroy();
      editorContainer.classList.remove("hidden");
      textarea.classList.add("hidden");
      toggleToEditor.classList.add("hidden");
      toggleToTextarea.classList.remove("hidden");
      editor = new EditorJS({ holder: "editorContainer", tools: { paragraph: { class: Paragraph }, header: { class: Header } }, data });
    }
    async function destroyEditor() {
      if (!editor) return;
      const output = await editor.save();
      textarea.value = edjsHTML().parse(output).join("\\n\\n");
      await editor.destroy();
      editor = null;
      editorContainer.classList.add("hidden");
      textarea.classList.remove("hidden");
      toggleToEditor.classList.remove("hidden");
      toggleToTextarea.classList.add("hidden");
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const toggleToEditor = document.getElementById("toggleToEditor");
      const toggleToTextarea = document.getElementById("toggleToTextarea");
      const editorContainer = document.getElementById("editorContainer");
      const textarea = document.getElementById("newContent");

      toggleToEditor.onclick = () => initEditor({ blocks: [{ type: "paragraph", data: { text: textarea.value.replace(/\\n/g, "<br>") } }] });
      toggleToTextarea.onclick = () => destroyEditor();
      toggleToEditor.click();

      const { data: { session } } = await client.auth.getSession();
      if (session?.user?.email === ADMIN_EMAIL) {
        document.getElementById("authArea").classList.add("hidden");
        document.getElementById("adminArea").classList.remove("hidden");
        // TODO: 你可以把 loadArticles、submit、delete、AI、静态生成、预览、编辑 等函数接上
      }
      document.getElementById("loginBtn").onclick = () => client.auth.signInWithOAuth({ provider: 'github', options: { redirectTo: location.href } });
      document.getElementById("logoutBtn").onclick = async () => { await client.auth.signOut(); location.reload(); };
    });

    async function generateWithGPT() {
      const topic = document.getElementById("newTitle").value.trim();
      if (!topic) return alert("请先输入标题");
      const res = await fetch("https://gpt.mefans.workers.dev/gpt", {
        method: "POST", headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ topic })
      });
      const result = await res.json();
      if (result.success && editor) {
        await editor.blocks.clear();
        await editor.blocks.insert("paragraph", { text: result.content });
        alert("✅ AI 内容已生成！");
      } else {
        alert("❌ GPT 内容生成失败");
      }
    }

    function closePreview() {
      document.getElementById("previewModal").classList.add("hidden");
    }
  </script>
</body>
</html>
