<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ç« åå°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* â€”â€” å®Œå…¨æ²¿ç”¨ä½ åŸæ¥çš„æ‰€æœ‰æ ·å¼ â€”â€” */
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .btn { padding: 8px 16px; background: #333; color: #fff; border: none; cursor: pointer; margin-right: 5px; }
    .btn:hover { background: #555; }
    .hidden { display: none; }
    textarea, input[type="text"], input[type="file"] { width: 100%; margin: 5px 0; }
    table { width: 100%; max-width: 960px; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }
    .admin-bar { display: flex; justify-content: space-between; align-items: center; max-width: 960px; width: 100%; margin-bottom: 20px; flex-wrap: wrap; }
    .admin-bar > input { flex: 1; min-width: 200px; margin: 5px; }
    .admin-bar > div { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; min-width: 200px; margin: 5px; }
    #previewModal { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: white; padding: 20px; border: 1px solid #ccc; max-width: 700px; width: 90%; z-index: 999; overflow-y: auto; max-height: 80vh; }
    #previewModal h3 { margin-top: 0; }
    #previewModal img { max-width: 100%; }
    #markdownContent { white-space: pre-wrap; }
    @media (max-width: 768px) {
      .admin-bar { flex-direction: column; align-items: stretch; }
      .btn, textarea { width: 100%; margin: 5px 0; }
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tbody tr { border: 1px solid #ddd; margin-bottom: 15px; background: #fff; padding: 10px; }
      tbody td { display: flex; justify-content: space-between; padding: 8px 5px; border: none; border-bottom: 1px solid #eee; }
      tbody td::before { content: attr(data-label); font-weight: bold; color: #555; flex: 1; margin-right: 10px; }
      #submitBtn, #cancelEditBtn { width: 100%; }
    }
  </style>
</head>
<body>

<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<div id="authArea"><button id="loginBtn" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button></div>

<div id="adminArea" class="hidden">
  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦" />
    <div>
      <button id="searchBtn" class="btn">ğŸ” æœç´¢</button>
      <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
  <input type="text" id="newTitle" placeholder="æ ‡é¢˜" />
  <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
  <input type="file" id="coverInput" accept="image/*" />
  <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
    <button id="submitBtn" class="btn">æäº¤</button>
    <button id="cancelEditBtn" class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
    <!-- âœ… å°±åœ¨è¿™é‡Œæ’å…¥æŒ‰é’® -->
  <button id="exportStaticBtn" class="btn">å¯¼å‡ºé™æ€ HTML</button>
  </div>

  <div style="overflow-x: auto; width: 100%;">
    <table id="articlesTable">
      <thead>
        <tr>
          <th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="previewModal" class="hidden">
    <h3 id="previewTitle"></h3>
    <img id="previewCover" />
    <div id="markdownContent"></div>
    <button class="btn" onclick="closePreview()">å…³é—­</button>
  </div>
</div>

<!-- Supabaseâ€‘JS & marked -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // â€”â€” åªæ”¹è¿™å‡ è¡Œï¼ŒæŒ‡å‘ä½ çš„ Worker â€”â€” 
  const WORKER_BASE = 'https://oliverfr-articles-proxy.mefans.workers.dev';
  const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
  const ADMIN_EMAIL = 'oliveroogle@gmail.com';
  const client      = supabase.createClient(WORKER_BASE, ANON_KEY);

  /**
   * â¶ è¿”å›å½¢å¦‚ "2025-04-20T10:20:30+08:00" çš„åŒ—äº¬æ—¶é—´å­—ç¬¦ä¸²
   * ç”¨äºä¿è¯åœ¨æ•°æ®åº“é‡Œå­˜çš„ created_at / updated_at å¸¦ +08:00 æ—¶åŒºæ ‡è®°
   */
  function getBeijingISOString() {
    // è·å–å½“å‰å®é™… UTC æ—¶é—´
    const now = new Date();
    // åŠ  8 å°æ—¶
    const beijingTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);
    // å°† ISOString æœ«å°¾çš„ "Z" æ›¿æ¢ä¸º "+08:00"
    return beijingTime.toISOString().replace('Z', '+08:00');
  }

  // â€”â€” æ›¿æ¢ä¸ºä¸‹é¢çš„åŒ—äº¬æ—¶é—´ + æ˜ŸæœŸ è®¡ç®—é€»è¾‘ â€”â€” 
  function formatBeijingTime(dateString) {
    // å…ˆæŠŠæ•°æ®åº“ä¸­å¸¦ +08:00 çš„æ—¶é—´è§£ææˆ Date å¯¹è±¡
    const date = new Date(dateString);
    // ä¾æ—§åŠ  8 å°æ—¶åç§»ï¼Œè®©å‰ç«¯æ˜¾ç¤ºç¬¦åˆåŒ—äº¬æ—¶é—´ï¼ˆç›¸å½“äºå†å¾€å‰æ 8 å°æ—¶ï¼‰
    const beijingOffsetMinutes = 8 * 60;
    const localTime = new Date(date.getTime() + beijingOffsetMinutes * 60000);
    return localTime.toLocaleString('zh-CN', { hour12: false });
  }

  function getWeekday(dateString) {
    const weekdayMap = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
    const d = new Date(dateString);
    return weekdayMap[d.getDay()];
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const authArea      = document.getElementById('authArea');
    const adminArea     = document.getElementById('adminArea');
    const loginBtn      = document.getElementById('loginBtn');
    const logoutBtn     = document.getElementById('logoutBtn');
    const submitBtn     = document.getElementById('submitBtn');
    const cancelBtn     = document.getElementById('cancelEditBtn');
    const searchBtn     = document.getElementById('searchBtn');
    const searchInput   = document.getElementById('searchInput');
    const articlesTable = document.querySelector('#articlesTable tbody');

    let currentEditId = null, currentPage = 1, limit = 5, loading = false;

    // 1. ä¼šè¯æ£€æŸ¥
    const { data:{ session } } = await client.auth.getSession();
    const user = session?.user;
    if (user?.email === ADMIN_EMAIL) {
      authArea.classList.add('hidden');
      adminArea.classList.remove('hidden');
      loadArticles();
    }

    // 2. ç™»å½•
    loginBtn.onclick = () => {
      client.auth.signInWithOAuth({
        provider: 'github',
        options: { redirectTo: location.href }
      });
    };

    // 3. ç™»å‡º
    logoutBtn.onclick = async () => {
      await client.auth.signOut();
      location.reload();
    };

    // 4. æäº¤æ–‡ç« ï¼ˆæ–°å¢ / ç¼–è¾‘ï¼‰
    submitBtn.onclick = async () => {
      const title   = document.getElementById('newTitle').value.trim();
      const content = document.getElementById('newContent').value.trim();
      if (!title || !content) return alert('æ ‡é¢˜æˆ–å†…å®¹ä¸èƒ½ä¸ºç©º');

      // â€”â€” å–å½“å‰ç”¨æˆ· â€”â€” 
      const { data: { session } } = await client.auth.getSession();
      const user = session?.user;
      if (!user) return alert('è¯·å…ˆç™»å½•');

      // â€”â€” ä¸Šä¼ å°é¢ï¼ˆå¯é€‰ï¼‰ â€”â€” 
      let coverUrl = '';
      const file = document.getElementById('coverInput').files[0];
      if (file) {
        const { data, error } = await client.storage
          .from('articles')
          .upload(`covers/${Date.now()}_${file.name}`, file);
        if (error) return alert('å°é¢ä¸Šä¼ å¤±è´¥ï¼š' + error.message);
        coverUrl = client
          .storage
          .from('articles')
          .getPublicUrl(data.path)
          .data
          .publicUrl;
      }

      // â· ä½¿ç”¨ç»Ÿä¸€çš„ getBeijingISOString(), ä¿è¯ created_at â‰¤ updated_at
      const now = getBeijingISOString();
      const row = {
        title,
        content,
        author_email: user.email,
        updated_at: now,           // æ¯æ¬¡æ“ä½œéƒ½æ›´æ–° "æ›´æ–°æ—¶é—´"
        cover_url: coverUrl || undefined
      };

      let res;
      if (currentEditId) {
        // â€”â€” ç¼–è¾‘æ¨¡å¼ï¼šç”¨ update â€”â€” 
        res = await client
          .from('articles')
          .update(row)
          .eq('id', currentEditId);
      } else {
        // â€”â€” æ–°å¢æ¨¡å¼ï¼šç”¨ insert â€”â€” 
        res = await client
          .from('articles')
          .insert([{
            ...row,
            created_at: now        // æ–°å¢æ—¶ "åˆ›å»ºæ—¶é—´" å’Œ "æ›´æ–°æ—¶é—´" éƒ½è®¾ç½®ä¸º now
          }]);
      }

      if (res.error) {
        return alert('æäº¤å¤±è´¥ï¼š' + res.error.message);
      }

      // â€”â€” é‡ç½® & åˆ·æ–°åˆ—è¡¨ â€”â€” 
      cancelBtn.click();
      loadArticles(true);
    };

    // 5. å–æ¶ˆç¼–è¾‘
    cancelBtn.onclick = () => {
      document.getElementById('newTitle').value   = '';
      document.getElementById('newContent').value = '';
      document.getElementById('coverInput').value = '';
      currentEditId = null;
      cancelBtn.classList.add('hidden');
    };

    // 6. åˆ é™¤ / ç¼–è¾‘ / é¢„è§ˆ
    window.deleteArticle = async id => {
      if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
      const { error } = await client.from('articles').delete().eq('id', id);
      if (error) return alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
      loadArticles(true);
    };

    window.editArticle = row => {
      document.getElementById('newTitle').value   = row.title;
      document.getElementById('newContent').value = row.content;
      currentEditId = row.id;
      cancelBtn.classList.remove('hidden');
      window.scrollTo(0,0);
    };

    window.previewArticle = row => {
      document.getElementById('previewTitle').textContent  = row.title;
      document.getElementById('previewCover').src          = row.cover_url || '';
      document.getElementById('markdownContent').innerHTML = marked.parse(row.content || '');
      document.getElementById('previewModal').classList.remove('hidden');
    };

    window.closePreview = () => document.getElementById('previewModal').classList.add('hidden');

    // 7. æœç´¢ & æ»šåŠ¨åŠ è½½
    searchBtn.onclick = () => loadArticles(true, searchInput.value.trim());
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
        loadArticles();
      }
    });


    
// â€”â€” ç‹¬ç«‹ï¼šç”Ÿæˆé™æ€ HTML æ–‡ä»¶ â€”â€” 





    
    // 8. åŠ è½½æ–‡ç« åˆ—è¡¨ï¼Œæ¸²æŸ“æ—¶ç”¨æ–°çš„æ ¼å¼åŒ–å‡½æ•°
    async function loadArticles(reset = false, keyword = '') {
      if (loading) return;
      loading = true;
      if (reset) {
        articlesTable.innerHTML = '';
        currentPage = 1;
      }
      let q = client.from('articles')
        .select('*')
        .order('created_at', { ascending: false })
        .range((currentPage-1)*limit, currentPage*limit-1);
      if (keyword) q = q.ilike('title', `%${keyword}%`);
      const { data, error } = await q;
      if (error) return alert('åŠ è½½å¤±è´¥ï¼š' + error.message);

      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="æ ‡é¢˜">${row.title}</td>
          <td data-label="ä½œè€…">${row.author_email}</td>
          <td data-label="å†…å®¹">${row.content?.slice(0,60)}...</td>
          <td data-label="åˆ›å»ºæ—¶é—´">${formatBeijingTime(row.created_at)}</td>
          <td data-label="æ›´æ–°æ—¶é—´">${formatBeijingTime(row.updated_at)}</td>
          <td data-label="æ˜ŸæœŸ">${getWeekday(row.created_at)}</td>
          <td data-label="å°é¢">${row.cover_url ? `<img src="${row.cover_url}" style="height:40px;">` : ''}</td>
          <td data-label="æ“ä½œ">
            <button class="btn" onclick='previewArticle(${JSON.stringify(row)})'>é¢„è§ˆ</button>
            <button class="btn" onclick='editArticle(${JSON.stringify(row)})'>ç¼–è¾‘</button>
            <button class="btn" onclick='deleteArticle("${row.id}")'>åˆ é™¤</button>
          </td>`;
        articlesTable.appendChild(tr);
      });

      loading = false;
      if (data.length === limit) currentPage++;
    }
  });
/* ===== IIFEï¼šä¸å…¶å®ƒè„šæœ¬éš”ç¦»ï¼ˆæºç é‡Œç»æ—  '</script>'ï¼‰ ===== */
(function(){

  /* ç®€æ˜“ HTML å®ä½“è½¬ä¹‰ï¼ˆæ ‡é¢˜é˜² XSSï¼‰ */
  const esc = s => s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  /* é¢„æ„é€ ä¸€ä¸ªå­—ç¬¦ä¸²å¸¸é‡ï¼Œç”¨ä½œâ€œç»“æŸæ ‡ç­¾â€æ¨¡å¼ï¼Œä½†æºç é‡Œçœ‹ä¸åˆ°å®Œæ•´å…³é”®å­— */
  const END_TAG = '<\\/scr' + 'ipt>';   // => "<\/script>"

  /* åŠ¨æ€ç”ŸæˆåŒ¹é… <\/script> çš„æ­£åˆ™ï¼Œé¿å…å­—é¢é‡å†™æ­» */
  const endTagRe = new RegExp(END_TAG.replace('\\/','/'), 'gi');

  document.getElementById('exportStaticBtn').addEventListener('click', () => {
    const tRaw = document.getElementById('newTitle').value.trim();
    const md   = document.getElementById('newContent').value.trim();
    if (!tRaw || !md) { alert('è¯·å…ˆå¡«å†™æ ‡é¢˜å’Œå†…å®¹'); return; }

    const slug = tRaw.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
    const day  = new Date().toISOString().split('T')[0];
    const file = document.getElementById('coverInput').files[0];
    const img  = file ? `https://oliverfr.com/assets/images/${encodeURIComponent(file.name)}` : '';

    /* ---------- 1. ç”Ÿæˆ JSONâ€‘LD å­—ç¬¦ä¸² ---------- */
    let json = JSON.stringify({
      "@context":"https://schema.org",
      "@type":"Article",
      "headline": tRaw,
      "author":   { "@type":"Person","name":"Oliver F." },
      "publisher":{ "@type":"Organization","name":"MeFan Solutions" },
      "datePublished": day,
      "dateModified":  day,
      "mainEntityOfPage":{ "@type":"WebPage","@id":`https://oliverfr.com/articles/${slug}.html` },
      ...(file ? { image: img } : {})
    }, null, 2);

    /* æŠŠ <\/script> â†’ <\\/script>ï¼Œé¿å…åœ¨ç”Ÿæˆåçš„ HTML ä¸­å†è§¦å‘ç»“æŸ */
    json = json.replace(endTagRe, '<\\\\script>');

    /* ---------- 2. çº¯å­—ç¬¦ä¸²æ‹¼æ¥å®Œæ•´ HTML ---------- */
    let html = '';
    html += '<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8">';
    html += '<title>'+esc(tRaw)+' | MeFan æŠ€æœ¯åšå®¢</title>';
    html += '<meta name="description" content="'+esc(tRaw)+'">';
    html += '<meta name="keywords" content="PoE, ç½‘ç»œè®¾å¤‡, MeFan">';
    html += '<meta name="viewport" content="width=device-width, initial-scale=1.0">';
    html += '<meta name="robots" content="index, follow">';
    html += '<link rel="canonical" href="https://oliverfr.com/articles/'+slug+'.html">';
    /* è¿™é‡Œçš„ <script> ç»“å°¾ç”¨ END_TAGï¼ˆ<\\/script>ï¼‰æ‹†å†™ï¼Œæºç å®‰å…¨ */
    html += '<script type="application/ld+json">\n'+json+'\n'+END_TAG;
    html += '<style>body{font-family:Arial,sans-serif;margin:40px auto;max-width:700px;line-height:1.6;}h1{font-size:28px;margin-bottom:20px;}img{max-width:100%;margin:20px 0}.meta{color:#888;font-size:14px;margin-bottom:20px}</style>';
    html += '</head><body>';
    html += '<h1>'+esc(tRaw)+'</h1>';
    html += '<div class="meta">å‘å¸ƒæ—¥æœŸï¼š'+day+' ï½œ ä½œè€…ï¼šOliver F.</div>';
    html += marked.parse(md);   /* Markdown â†’ HTML */
    html += '</body></html>';

    /* ---------- 3. è§¦å‘ä¸‹è½½ ---------- */
    const blob = new Blob([html], { type:'text/html' });
    const a = Object.assign(document.createElement('a'), {
      href: URL.createObjectURL(blob),
      download: slug+'.html'
    });
    a.click();
  });

})();   /* IIFE end */
</script>
</body>
</html>
