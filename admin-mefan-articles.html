<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ç« åå°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* â€”â€” æ ·å¼ä¿æŒä¸å˜ â€”â€” */
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .btn { padding: 8px 16px; background: #333; color: #fff; border: none; cursor: pointer; margin-right: 5px; }
    .btn:hover { background: #555; }
    .hidden { display: none; }
    textarea, input[type="text"], input[type="file"] { width: 100%; margin: 5px 0; }
    table { width: 100%; max-width: 960px; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }
    .admin-bar { display: flex; justify-content: space-between; align-items: center; max-width: 960px; width: 100%; margin-bottom: 20px; flex-wrap: wrap; }
    .admin-bar > input { flex: 1; min-width: 200px; margin: 5px; }
    .admin-bar > div { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; min-width: 200px; margin: 5px; }
    #previewModal { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: white; padding: 20px; border: 1px solid #ccc; max-width: 700px; width: 90%; z-index: 999; overflow-y: auto; max-height: 80vh; }
    #previewModal h3 { margin-top: 0; }
    #previewModal img { max-width: 100%; }
    #markdownContent { white-space: pre-wrap; }
    @media (max-width: 768px) {
      .admin-bar { flex-direction: column; align-items: stretch; }
      .btn, textarea { width: 100%; margin: 5px 0; }
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tbody tr { border: 1px solid #ddd; margin-bottom: 15px; background: #fff; padding: 10px; }
      tbody td { display: flex; justify-content: space-between; padding: 8px 5px; border: none; border-bottom: 1px solid #eee; }
      tbody td::before { content: attr(data-label); font-weight: bold; color: #555; flex: 1; margin-right: 10px; }
      #submitBtn, #cancelEditBtn { width: 100%; }
    }
  </style>
</head>
<body>

<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<div id="authArea">
  <button id="loginBtn" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button>
</div>

<div id="adminArea" class="hidden">
  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦" />
    <div>
      <button id="searchBtn" class="btn">ğŸ” æœç´¢</button>
      <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
  <input type="text" id="newTitle" placeholder="æ ‡é¢˜" />
  <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
  <input type="file" id="coverInput" accept="image/*" />
  <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
    <button id="submitBtn" class="btn">æäº¤</button>
    <button id="cancelEditBtn" class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
  </div>

  <div style="overflow-x: auto; width: 100%;">
    <table id="articlesTable">
      <thead>
        <tr>
          <th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="previewModal" class="hidden">
    <h3 id="previewTitle"></h3>
    <img id="previewCover" />
    <div id="markdownContent"></div>
    <button class="btn" onclick="closePreview()">å…³é—­</button>
  </div>
</div>

<!-- Supabaseâ€‘JS & marked -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  const WORKER_BASE = window.location.origin;
  const ANON_KEY    = 'ä½ çš„ Supabase anon å…¬åŒ™';
  const ADMIN_EMAIL = 'oliveroogle@gmail.com';
  const client      = supabase.createClient(WORKER_BASE, ANON_KEY);

  // â€”â€” å·¥å…·ï¼šç»Ÿä¸€ç”¨åŒ—äº¬æ—¶é—´æ˜¾ç¤º â€”â€” 
  function formatBeijingTime(dateString) {
    return new Date(dateString)
      .toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
  }
  function getWeekday(dateString) {
    const days = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
    return days[new Date(dateString).getDay()];
  }

  document.addEventListener('DOMContentLoaded', async () => {
    const authArea    = document.getElementById('authArea');
    const adminArea   = document.getElementById('adminArea');
    const loginBtn    = document.getElementById('loginBtn');
    const logoutBtn   = document.getElementById('logoutBtn');
    const submitBtn   = document.getElementById('submitBtn');
    const cancelBtn   = document.getElementById('cancelEditBtn');
    const searchBtn   = document.getElementById('searchBtn');
    const searchInput = document.getElementById('searchInput');
    const articlesTb  = document.querySelector('#articlesTable tbody');

    let currentEditId = null, currentPage = 1, limit = 5, loading = false;

    // 1. ä¼šè¯æ£€æŸ¥
    const { data:{ session } } = await client.auth.getSession();
    const user = session?.user;
    if (user?.email === ADMIN_EMAIL) {
      authArea.classList.add('hidden');
      adminArea.classList.remove('hidden');
      loadArticles();
    }

    // 2. ç™»å½•
    loginBtn.addEventListener('click', () => {
      client.auth.signInWithOAuth({ provider:'github', options:{ redirectTo: location.href } });
    });

    // 3. ç™»å‡º
    logoutBtn.addEventListener('click', async () => {
      await client.auth.signOut();
      location.reload();
    });

    // 4. æäº¤æ–‡ç« ï¼ˆä¿æŒä½ ä¸Šä¸€æ­¥æ”¹å¥½çš„é€»è¾‘ä¸å˜ï¼‰ â€¦
    submitBtn.addEventListener('click', async () => {
      /* â€¦ çœç•¥ä¸Šä¸€æ­¥å·²ç»ä¼˜åŒ–å¥½çš„æäº¤ä»£ç  â€¦ */
    });

    // 5. å–æ¶ˆç¼–è¾‘
    cancelBtn.addEventListener('click', () => {
      currentEditId = null;
      cancelBtn.classList.add('hidden');
      document.getElementById('newTitle').value   = '';
      document.getElementById('newContent').value = '';
      document.getElementById('coverInput').value = '';
    });

    // 6. å…¶å®ƒæŒ‰é’®ï¼ˆåˆ é™¤/ç¼–è¾‘/é¢„è§ˆï¼‰ çœç•¥ â€¦

    // 7. æœç´¢ & æ»šåŠ¨åŠ è½½
    searchBtn.addEventListener('click', () => {
      currentPage = 1;
      loadArticles(true, searchInput.value.trim());
    });
    window.addEventListener('scroll', () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
        loadArticles();
      }
    });

    // 8. åŠ è½½æ–‡ç« åˆ—è¡¨ï¼Œå…³é”®åœ¨è¿™é‡Œä½¿ç”¨åŒ—äº¬æ—¶é—´æ ¼å¼åŒ–
    async function loadArticles(reset = false, keyword = '') {
      if (loading) return;
      loading = true;
      if (reset) {
        articlesTb.innerHTML = '';
        currentPage = 1;
      }
      const from = (currentPage - 1) * limit;
      const to   = from + limit - 1;
      let q = client.from('articles')
        .select('*')
        .order('created_at',{ ascending:false })
        .range(from, to);
      if (keyword) q = q.ilike('title', `%${keyword}%`);
      const { data, error } = await q;
      if (error) return alert('åŠ è½½å¤±è´¥ï¼š' + error.message);

      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td data-label="æ ‡é¢˜">${row.title}</td>
          <td data-label="ä½œè€…">${row.author_email}</td>
          <td data-label="å†…å®¹">${(row.content||'').slice(0,60)}...</td>
          <td data-label="åˆ›å»ºæ—¶é—´">${formatBeijingTime(row.created_at)}</td>
          <td data-label="æ›´æ–°æ—¶é—´">${formatBeijingTime(row.updated_at)}</td>
          <td data-label="æ˜ŸæœŸ">${getWeekday(row.created_at)}</td>
          <td data-label="å°é¢">${row.cover_url?`<img src="${row.cover_url}" style="height:40px;">`:''}</td>
          <td data-label="æ“ä½œ">
            <button class="btn preview-btn">é¢„è§ˆ</button>
            <button class="btn edit-btn">ç¼–è¾‘</button>
            <button class="btn delete-btn">åˆ é™¤</button>
          </td>`;
        // â€¦ ç»‘å®šé¢„è§ˆ/ç¼–è¾‘/åˆ é™¤äº‹ä»¶ â€¦
        articlesTb.appendChild(tr);
      });

      loading = false;
      if (data.length === limit) currentPage++;
    }
  });
</script>
</body>
</html>
