<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文章后台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    body { font-family: Arial; background: #f8f8f8; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .btn { padding: 8px 16px; background: #333; color: #fff; border: none; cursor: pointer; margin-right: 5px; }
    .btn:hover { background: #555; }
    .hidden { display: none; }
    textarea, input[type="text"], input[type="file"] { width: 100%; margin: 5px 0; }
    table { width: 100%; max-width: 960px; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }
  </style>
</head>
<body>

<h1>📰 文章后台管理</h1>

<div class="admin-bar">
  <input type="text" id="searchInput" placeholder="搜索标题关键词…" />
  <button id="searchBtn" class="btn">🔍 搜索</button>
</div>

<h2>🆕 新增/编辑文章</h2>
<input type="text" id="newTitle" placeholder="标题" />
<textarea id="newContent" placeholder="支持 Markdown 格式的内容"></textarea>
<input type="file" id="coverInput" accept="image/*" />
<div>
  <button id="submitBtn" class="btn">提交</button>
  <button id="cancelEditBtn" class="btn hidden">取消编辑</button>
</div>

<table>
  <thead>
    <tr><th>标题</th><th>作者</th><th>内容</th><th>创建时间</th><th>更新时间</th><th>星期</th><th>封面</th><th>操作</th></tr>
  </thead>
  <tbody id="articlesTable"></tbody>
</table>

<div id="previewModal" class="hidden" style="position: fixed; top: 10%; background: #fff; border: 1px solid #ccc; padding: 20px;">
  <h3 id="previewTitle"></h3>
  <img id="previewCover" style="max-width: 100%;" />
  <div id="markdownContent"></div>
  <button onclick="document.getElementById('previewModal').classList.add('hidden')" class="btn">关闭</button>
</div>

<script>
const WORKER_ENDPOINT = 'https://oliverfr-articles-proxy.mefans.workers.dev/';
const ADMIN_EMAIL = 'oliveroogle@gmail.com';
let currentPage = 1, currentEditId = null, loading = false;
const limit = 5;
const articlesTable = document.getElementById("articlesTable");

function format(dateStr) {
  const date = new Date(dateStr);
  return new Date(date.getTime() + 8 * 60 * 60000).toLocaleString('zh-CN', { hour12: false });
}
function weekday(d) {
  return ['日','一','二','三','四','五','六'][new Date(d).getDay()];
}

async function loadArticles(reset = false, keyword = "") {
  if (loading) return;
  loading = true;
  const params = new URLSearchParams({ page: currentPage, limit, q: keyword });
  const res = await fetch(`${WORKER_ENDPOINT}?${params}`);
  const { articles } = await res.json();
  if (reset) articlesTable.innerHTML = "";
  articles.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.title}</td>
      <td>${row.author_email}</td>
      <td>${row.content?.slice(0, 60)}...</td>
      <td>${format(row.created_at)}</td>
      <td>${format(row.updated_at)}</td>
      <td>星期${weekday(row.created_at)}</td>
      <td>${row.cover_url ? `<img src="${row.cover_url}" style="height:40px;" />` : ''}</td>
      <td>
        <button class="btn" onclick='previewArticle(${JSON.stringify(row)})'>预览</button>
        <button class="btn" onclick='editArticle(${JSON.stringify(row)})'>编辑</button>
        <button class="btn" onclick='deleteArticle("${row.id}")'>删除</button>
      </td>`;
    articlesTable.appendChild(tr);
  });
  loading = false;
}

document.getElementById("submitBtn").onclick = async () => {
  const title = newTitle.value.trim(), content = newContent.value.trim();
  if (!title || !content) return alert("标题或内容不能为空");

  const formData = {
    title, content,
    author_email: ADMIN_EMAIL,
    updated_at: new Date().toISOString()
  };
  if (!currentEditId) formData.created_at = new Date().toISOString();
  if (coverInput.files[0]) formData.cover_url = '[封面上传需另配 Supabase Storage]';

  const res = await fetch(WORKER_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(currentEditId ? { ...formData, id: currentEditId } : formData)
  });

  if (!res.ok) return alert("提交失败");
  newTitle.value = newContent.value = "";
  coverInput.value = "";
  currentEditId = null;
  cancelEditBtn.classList.add("hidden");
  loadArticles(true);
};

document.getElementById("cancelEditBtn").onclick = () => {
  newTitle.value = newContent.value = "";
  coverInput.value = "";
  currentEditId = null;
  cancelEditBtn.classList.add("hidden");
};

document.getElementById("searchBtn").onclick = () => {
  currentPage = 1;
  loadArticles(true, searchInput.value.trim());
};

window.previewArticle = (row) => {
  document.getElementById("previewTitle").textContent = row.title;
  document.getElementById("previewCover").src = row.cover_url || '';
  document.getElementById("markdownContent").innerHTML = marked.parse(row.content || '');
  document.getElementById("previewModal").classList.remove("hidden");
};

window.editArticle = (row) => {
  newTitle.value = row.title;
  newContent.value = row.content;
  currentEditId = row.id;
  cancelEditBtn.classList.remove("hidden");
  window.scrollTo(0, 0);
};

window.deleteArticle = async (id) => {
  if (!confirm("确定要删除该文章？")) return;
  const res = await fetch(`${WORKER_ENDPOINT}?id=${id}`, { method: 'DELETE' });
  if (!res.ok) return alert("删除失败");
  loadArticles(true);
};

window.addEventListener("scroll", () => {
  if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
    currentPage++;
    loadArticles();
  }
});

document.addEventListener("DOMContentLoaded", () => {
  loadArticles();
});
</script>
</body>
</html>
