<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ç« åå°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .btn { padding: 8px 16px; background: #333; color: #fff; border: none; cursor: pointer; margin-right: 5px; }
    .btn:hover { background: #555; }
    .hidden { display: none; }
    textarea, input[type="text"], input[type="file"] { width: 100%; margin: 5px 0; }
    table { width: 100%; max-width: 960px; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }

    .admin-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 960px;
      width: 100%;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .admin-bar > input {
      flex: 1;
      min-width: 200px;
      margin: 5px;
    }

    .admin-bar > div {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      min-width: 200px;
      margin: 5px;
    }

    #previewModal { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: white; padding: 20px; border: 1px solid #ccc; max-width: 700px; width: 90%; z-index: 999; overflow-y: auto; max-height: 80vh; }
    #previewModal h3 { margin-top: 0; }
    #previewModal img { max-width: 100%; }
    #markdownContent { white-space: pre-wrap; }

    /* âœ… å“åº”å¼æ ·å¼è¡¥å…… */
    @media (max-width: 768px) {
      .admin-bar { flex-direction: column; align-items: stretch; }
      .btn, textarea { width: 100%; margin: 5px 0; }

      table, thead, tbody, th, td, tr {
        display: block;
      }

      thead {
        display: none;
      }

      tbody tr {
        border: 1px solid #ddd;
        margin-bottom: 15px;
        background: #fff;
        padding: 10px;
      }

      tbody td {
        display: flex;
        justify-content: space-between;
        padding: 8px 5px;
        border: none;
        border-bottom: 1px solid #eee;
      }

      tbody td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #555;
        flex: 1;
        margin-right: 10px;
      }

      #submitBtn, #cancelEditBtn {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<div id="authArea">
  <button id="loginBtn" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button>
</div>

<div id="adminArea" class="hidden">
  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦" />
    <div>
      <button id="searchBtn" class="btn">ğŸ” æœç´¢</button>
      <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
  <input type="text" id="newTitle" placeholder="æ ‡é¢˜" />
  <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
  <input type="file" id="coverInput" accept="image/*" />
  <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
    <button id="submitBtn" class="btn">æäº¤</button>
    <button id="cancelEditBtn" class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
  </div>

  <div style="overflow-x: auto; width: 100%;">
    <table id="articlesTable">
      <thead>
        <tr>
          <th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="previewModal" class="hidden">
    <h3 id="previewTitle"></h3>
    <img id="previewCover" />
    <div id="markdownContent"></div>
    <button class="btn" onclick="document.getElementById('previewModal').classList.add('hidden')">å…³é—­</button>
  </div>
</div>

<!-- ä»…ä¿ç•™ Markdown æ¸²æŸ“åº“ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // â€”â€” å…¨éƒ¨é€šè¿‡ Worker ä¸­è½¬çš„åŸºç¡€åœ°å€ â€”â€” 
  const apiBase = 'https://oliverfr-articles-proxy.mefans.workers.dev/';
  const ADMIN_EMAIL = 'oliveroogle@gmail.com';
  let currentPage = 1, limit = 5, loading = false;

  // åŒ—äº¬æ—¶é—´ & æ˜ŸæœŸæ ¼å¼åŒ–
  function formatBeijingTime(dateString) {
    return new Date(dateString).toLocaleString('zh-CN', { timeZone: 'Asia/Shanghai', hour12: false });
  }
  function getWeekday(dateString) {
    const map = ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'];
    return map[new Date(dateString).getDay()];
  }

  document.addEventListener("DOMContentLoaded", async () => {
    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const submitBtn = document.getElementById("submitBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const authArea = document.getElementById("authArea");
    const adminArea = document.getElementById("adminArea");
    const newTitle = document.getElementById("newTitle");
    const newContent = document.getElementById("newContent");
    const coverInput = document.getElementById("coverInput");
    const searchBtn = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchInput");
    const articlesTable = document.querySelector("#articlesTable tbody");

    let currentEditId = null;

    // â€”â€” ç™»å½• & é€€å‡º â€”â€” 
    loginBtn.onclick = () => {
      // Worker éœ€å®ç° /auth/github é‡å®šå‘åˆ° Supabase OAuth
      window.location.href = apiBase + 'auth/github?redirect=' + encodeURIComponent(location.href);
    };
    logoutBtn.onclick = async () => {
      await fetch(apiBase + 'auth/logout', { method: 'POST', credentials: 'include' });
      location.reload();
    };

    // â€”â€” ä¼šè¯æ£€æŸ¥ â€”â€” 
    const sessionRes = await fetch(apiBase + 'session', { credentials: 'include' });
    const { user } = await sessionRes.json();
    if (user?.email === ADMIN_EMAIL) {
      authArea.classList.add("hidden");
      adminArea.classList.remove("hidden");
      loadArticles();
    }

    // â€”â€” æäº¤æ–°å¢/ç¼–è¾‘ â€”â€” 
    submitBtn.onclick = async () => {
      const title = newTitle.value.trim();
      const content = newContent.value.trim();
      if (!title || !content) return alert("æ ‡é¢˜æˆ–å†…å®¹ä¸èƒ½ä¸ºç©º");

      // â€”â€” å°é¢ä¸Šä¼ ï¼ˆWorker éœ€å®ç° /uploadCoverï¼‰ â€”â€” 
      let coverUrl = '';
      if (coverInput.files[0]) {
        const formData = new FormData();
        formData.append('file', coverInput.files[0]);
        const up = await fetch(apiBase + 'uploadCover', {
          method: 'POST',
          credentials: 'include',
          body: formData
        });
        const { publicUrl } = await up.json();
        coverUrl = publicUrl;
      }

      // â€”â€” å†™å…¥æ–‡ç« è¡¨ â€”â€” 
      const payload = {
        title, content,
        author_email: user.email,
        created_at: currentEditId ? undefined : new Date().toISOString(),
        updated_at: new Date().toISOString(),
        cover_url: coverUrl || undefined,
        id: currentEditId
      };
      const res = await fetch(apiBase, {
        method: 'POST',
        credentials: 'include',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      const { success } = await res.json();
      if (!success) return alert("æäº¤å¤±è´¥");
      // é‡ç½®è¡¨å•
      newTitle.value = '';
      newContent.value = '';
      coverInput.value = '';
      currentEditId = null;
      cancelEditBtn.classList.add("hidden");
      loadArticles(true);
    };

    cancelEditBtn.onclick = () => {
      newTitle.value = '';
      newContent.value = '';
      coverInput.value = '';
      currentEditId = null;
      cancelEditBtn.classList.add("hidden");
    };

    // â€”â€” åŠ è½½æ–‡ç« åˆ—è¡¨ï¼ˆåˆ†é¡µ + æœç´¢ï¼‰ â€”â€” 
    async function loadArticles(reset = false, keyword = '') {
      if (loading) return;
      loading = true;
      if (reset) {
        articlesTable.innerHTML = '';
        currentPage = 1;
      }
      const url = new URL(apiBase);
      url.searchParams.set('page', currentPage);
      url.searchParams.set('limit', limit);
      if (keyword) url.searchParams.set('q', keyword);

      const res = await fetch(url, { credentials: 'include' });
      const { articles, totalPages } = await res.json();

      articles.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-label="æ ‡é¢˜">${row.title}</td>
          <td data-label="ä½œè€…">${row.author_email}</td>
          <td data-label="å†…å®¹">${row.content?.slice(0,60) + '...'}</td>
          <td data-label="åˆ›å»ºæ—¶é—´">${formatBeijingTime(row.created_at)}</td>
          <td data-label="æ›´æ–°æ—¶é—´">${formatBeijingTime(row.updated_at)}</td>
          <td data-label="æ˜ŸæœŸ">${getWeekday(row.created_at)}</td>
          <td data-label="å°é¢">${row.cover_url ? `<img src="${row.cover_url}" style="height:40px;">` : ''}</td>
          <td data-label="æ“ä½œ">
            <button class="btn" onclick='previewArticle(${JSON.stringify(row)})'>é¢„è§ˆ</button>
            <button class="btn" onclick='editArticle(${JSON.stringify(row)})'>ç¼–è¾‘</button>
            <button class="btn" onclick='deleteArticle("${row.id}")'>åˆ é™¤</button>
          </td>`;
        articlesTable.appendChild(tr);
      });

      loading = false;
      // å¦‚æœè¿˜æœ‰ä¸‹ä¸€é¡µï¼Œå½“å‰é¡µ++
      if (currentPage < totalPages) currentPage++;
    }

    // â€”â€” é¢„è§ˆ / ç¼–è¾‘ / åˆ é™¤ â€”â€” 
    window.previewArticle = row => {
      document.getElementById("previewTitle").textContent = row.title;
      document.getElementById("previewCover").src = row.cover_url || '';
      document.getElementById("markdownContent").innerHTML = marked.parse(row.content || '');
      document.getElementById("previewModal").classList.remove("hidden");
    };
    window.editArticle = row => {
      newTitle.value = row.title;
      newContent.value = row.content;
      currentEditId = row.id;
      cancelEditBtn.classList.remove("hidden");
      window.scrollTo(0,0);
    };
    window.deleteArticle = async id => {
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥æ–‡ç« ï¼Ÿ")) return;
      const url = new URL(apiBase);
      url.searchParams.set('id', id);
      const res = await fetch(url, { method: 'DELETE', credentials: 'include' });
      const { success } = await res.json();
      if (!success) return alert("åˆ é™¤å¤±è´¥");
      loadArticles(true);
    };

    // â€”â€” æœç´¢ & æ— é™æ»šåŠ¨åŠ è½½ â€”â€” 
    searchBtn.onclick = () => loadArticles(true, searchInput.value.trim());
    window.addEventListener("scroll", () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
        loadArticles();
      }
    });
  });
</script>
</body>
</html>
