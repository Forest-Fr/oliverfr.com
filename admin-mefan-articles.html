<!-- admin-mefan-articles.html â€•â€• 2025â€‘04â€‘22 æœ€ç»ˆæ•´åˆç‰ˆ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>æ–‡ç« åå°ç®¡ç†</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<link rel="icon" href="MeFan-Logo.png" type="image/png" />

<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f8f8f8;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
h1{font-size:24px;margin-bottom:10px}
.btn{padding:8px 16px;background:#333;color:#fff;border:none;cursor:pointer;margin:5px;width:100%}
.btn:hover{background:#555}
.hidden{display:none}
textarea,input[type="text"],input[type="file"]{width:100%;margin:5px 0}
table{width:100%;max-width:960px;border-collapse:collapse;margin-top:20px;background:#fff;table-layout:fixed}
th,td{padding:10px;border:1px solid #ddd;text-align:left}
th{background:#f0f0f0}
td.author,td.content{word-break:break-all;overflow:hidden;text-overflow:ellipsis;max-width:340px}
.admin-bar{display:flex;justify-content:space-between;align-items:center;max-width:960px;width:100%;margin-bottom:20px;flex-wrap:wrap}
.admin-bar>input{flex:1;min-width:200px;margin:5px}
.admin-bar>div{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:5px}
#previewModal{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;max-width:700px;width:90%;z-index:999;overflow-y:auto;max-height:80vh}
#markdownContent{white-space:pre-wrap}
@media(max-width:768px){
 .admin-bar{flex-direction:column}
 .btn,textarea{width:100%}
 table,thead,tbody,th,td,tr{display:block}
 thead{display:none}
 tbody tr{margin-bottom:15px;padding:10px;border:1px solid #ddd;background:#fff}
 tbody td{display:flex;justify-content:space-between;padding:8px 5px;border-bottom:1px solid #eee}
 tbody td::before{content:attr(data-label);font-weight:bold;margin-right:10px}
}
</style>

<!-- ä¾èµ– -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
</head>
<body>
<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<div id="authArea"><button id="loginBtn" class="btn">ä½¿ç”¨Â GitHubÂ ç™»å½•</button></div>

<div id="adminArea" class="hidden">

  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦">
    <div>
      <button id="searchBtn" class="btn" style="width:auto">ğŸ” æœç´¢</button>
      <button id="logoutBtn" class="btn" style="width:auto">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
  <input type="text" id="newTitle" placeholder="æ ‡é¢˜">
  <div style="display:flex;gap:10px;margin:5px 0">
    <button id="toggleToEditor"   class="btn" style="width:auto">ğŸ“ å¯è§†åŒ–æ¨¡å¼</button>
    <button id="toggleToTextarea" class="btn hidden" style="width:auto">ğŸ–Š Markdown æ¨¡å¼</button>
  </div>
  <div id="editorContainer" class="hidden" style="border:1px solid #ccc;min-height:200px;padding:10px;background:#fff"></div>
  <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
  <input type="file" id="coverInput" accept="image/*">
   <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0">
    <button id="submitBtn"               class="btn">æäº¤</button>
    <button id="cancelEditBtn"           class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
    <button id="generateStaticHtmlBtn"   class="btn">ç”Ÿæˆé™æ€æ–‡ç« æ–‡ä»¶</button>
    <button id="aiBtn"                   class="btn">AI ç”Ÿæˆæ–‡ç« ç»“æ„+SEO</button>
  </div>

  <div style="overflow-x:auto;width:100%">
    <table id="articlesTable">
      <thead><tr><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="previewModal" class="hidden">
    <h3 id="previewTitle"></h3><img id="previewCover"><div id="markdownContent"></div>
    <button class="btn" onclick="closePreview()">å…³é—­</button>
  </div>
</div>

<!-- ========= å¼•å¯¼å™¨ç¡®ä¿ EditorJS å·²å°±ç»ª ========= -->
<script>
(function loadEditorJS(run){
  if(window.EditorJS){run();return;}
  const s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2';
  s.onload=run;document.head.appendChild(s);
})(function main(){

/* -- é…ç½® / å·¥å…· ----------------------- */
const WORKER_BASE='https://oliverfr-articles-proxy.mefans.workers.dev';
const ANON_KEY   ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
const ADMIN_EMAIL='oliveroogle@gmail.com';
const supa=supabase.createClient(WORKER_BASE,ANON_KEY);

const $=id=>document.getElementById(id);
const toBJ=()=>new Date(Date.now()+288e5).toISOString().replace('Z','+08:00');
const fmt=s=>new Date(s).toLocaleString('zh-CN',{hour12:false});
const wk =s=>['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][new Date(s).getDay()];
const esc=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* -- DOM refs -------------------------- */
const btnE=$('toggleToEditor'), btnT=$('toggleToTextarea');
const editorDiv=$('editorContainer'), mdArea=$('newContent'), titleInp=$('newTitle');
const tbBody=document.querySelector('#articlesTable tbody');
const aiBtn=$('aiBtn'), genBtn=$('generateStaticHtmlBtn');
let editor=null, editingId=null, page=1, limit=5, loading=false;

/* -- å¯è§†åŒ– / Markdown åˆ‡æ¢ ------------ */
btnE.onclick=async()=>{
  if(editor) await editor.destroy();
  editorDiv.classList.remove('hidden'); mdArea.classList.add('hidden');
  btnE.classList.add('hidden'); btnT.classList.remove('hidden');
  const tools={};
  const P=window.ParagraphTool||window.Paragraph; if(P) tools.paragraph={class:P,inlineToolbar:true};
  const H=window.Header||window.HeaderTool;     if(H) tools.header   ={class:H,inlineToolbar:true};
  editor=new window.EditorJS({
    holder:'editorContainer',tools,
    data:{blocks:[{type:'paragraph',data:{text:mdArea.value.replace(/\n/g,'<br>')}}]}
  });
};
btnT.onclick=destroyEditor;
async function destroyEditor(){
  if(!editor) return;
  try{const s=await editor.save();mdArea.value=s.blocks.map(b=>b.data.text||'').join('\n\n');await editor.destroy();}
  catch(e){console.warn(e);}
  editor=null;editorDiv.classList.add('hidden');mdArea.classList.remove('hidden');
  btnE.classList.remove('hidden');btnT.classList.add('hidden');
}

/* -- ç™»å½• ------------------------------ */
(async()=>{
  const {data:{session}}=await supa.auth.getSession();
  if(session?.user?.email===ADMIN_EMAIL){
    $('authArea').classList.add('hidden');$('adminArea').classList.remove('hidden');
    loadArticles(true);
  }
})();
$('loginBtn').onclick =()=>supa.auth.signInWithOAuth({provider:'github',options:{redirectTo:location.href}});
$('logoutBtn').onclick=async()=>{await supa.auth.signOut();location.reload();};

/* -- æäº¤ / æ›´æ–° ----------------------- */
$('submitBtn').onclick=async()=>{
  const title=titleInp.value.trim();
  const content=editor?(await editor.save()).blocks.map(b=>b.data.text||'').join('\n\n').trim():mdArea.value.trim();
  if(!title||!content) return alert('æ ‡é¢˜/å†…å®¹ä¸èƒ½ä¸ºç©º');
  const row={title,content,updated_at:toBJ()};
  let err;
  if(editingId){({error:err}=await supa.from('articles').update(row).eq('id',editingId));}
  else {row.created_at=row.updated_at;({error:err}=await supa.from('articles').insert([row]));}
  if(err) return alert(err.message);
  $('cancelEditBtn').click();loadArticles(true);
};
$('cancelEditBtn').onclick=()=>{titleInp.value='';mdArea.value='';editingId=null;destroyEditor();$('cancelEditBtn').classList.add('hidden');};

/* -- åˆ—è¡¨æ“ä½œ ------------------------- */
window.editArticle=r=>{titleInp.value=r.title;mdArea.value=r.content;editingId=r.id;$('cancelEditBtn').classList.remove('hidden');destroyEditor();window.scrollTo(0,0);};
window.deleteArticle=async id=>{if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;const{error}=await supa.from('articles').delete().eq('id',id);if(error)alert(error.message);else loadArticles(true);};
window.previewArticle=r=>{$('previewTitle').textContent=r.title;$('previewCover').src=r.cover_url||'';$('markdownContent').innerHTML=marked.parse(r.content||'');$('previewModal').classList.remove('hidden');};
window.closePreview=()=>$('previewModal').classList.add('hidden');

/* -- åˆ—è¡¨åŠ è½½ ------------------------- */
$('searchBtn').onclick=()=>loadArticles(true,$('searchInput').value.trim());
window.addEventListener('scroll',()=>{if(!loading && window.innerHeight+window.scrollY>document.body.offsetHeight-80)loadArticles();});
async function loadArticles(reset=false,kw=''){
  if(loading)return;loading=true;if(reset){tbBody.innerHTML='';page=1;}
  let q=supa.from('articles').select('*').order('created_at',{ascending:false}).range((page-1)*limit,page*limit-1);
  if(kw) q=q.ilike('title','%'+kw+'%');
  const {data=[],error}=await q;if(error){alert(error.message);loading=false;return;}
  data.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td data-label="æ ‡é¢˜">${esc(r.title)}</td>
      <td class="author"  data-label="ä½œè€…">${esc(r.author_email||'')}</td>
      <td class="content" data-label="å†…å®¹">${esc((r.content||'').slice(0,60))}â€¦</td>
      <td data-label="åˆ›å»ºæ—¶é—´">${fmt(r.created_at)}</td>
      <td data-label="æ›´æ–°æ—¶é—´">${fmt(r.updated_at)}</td>
      <td data-label="æ˜ŸæœŸ">æ˜ŸæœŸ${wk(r.created_at)}</td>
      <td data-label="å°é¢">${r.cover_url?`<img src="${r.cover_url}" style="height:40px">`:''}</td>
      <td data-label="æ“ä½œ">
        <button class="btn" onclick='previewArticle(${JSON.stringify(r).replace(/'/g,'&#39;')})'>é¢„è§ˆ</button>
        <button class="btn" onclick='editArticle(${JSON.stringify(r).replace(/'/g,'&#39;')})'>ç¼–è¾‘</button>
        <button class="btn" onclick="deleteArticle('${r.id}')">åˆ é™¤</button>
      </td>`;tbBody.appendChild(tr);
  });
  if(data.length===limit)page++;loading=false;
}

/* -- AI ç”Ÿæˆ ------------------------- */
  aiBtn.onclick = async ()=>{
      const topic = titleInp.value.trim();
      if(!topic) return alert('è¯·å…ˆè¾“å…¥æ ‡é¢˜');
      try{
        const j = await fetch('https://gpt.mefans.workers.dev/gpt', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ topic })
        }).then(r=>r.json());
        if(!j.success) throw new Error(j.detail||j.message||'ç”Ÿæˆå¤±è´¥');
        mdArea.value = j.content;
        if(editor){
          await editor.blocks.clear();
          await editor.blocks.insert('paragraph',{ text:j.content });
        }
        alert('âœ… AI å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æ£€æŸ¥ç¼–è¾‘åŒºï¼');
      }catch(e){
        alert('âŒ GPT ç”Ÿæˆå¤±è´¥ï¼š'+e.message);
      }
    };

/* -- ç”Ÿæˆé™æ€ HTML ------------------- */
genBtn.onclick=async()=>{
  const title=titleInp.value.trim();
  const content=editor?(await editor.save()).blocks.map(b=>b.data.text||'').join('\n\n').trim():mdArea.value.trim();
  if(!title||!content)return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
  const createdAt=toBJ().split('T')[0];
  const slug=title.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
  const html=[
    '<!DOCTYPE html>',
    '<html lang="zh-CN"><head><meta charset="UTF-8"/>',
    `<title>${esc(title)} | MeFan æŠ€æœ¯åšå®¢</title>`,
    `<meta name="description" content="${esc(title)}"/>`,
    `<link rel="canonical" href="https://oliverfr.com/articles/${slug}.html"/>`,
    '<style>body{font-family:Arial,sans-serif;margin:40px auto;max-width:700px;line-height:1.6}</style>',
    '</head><body>',
    `<h1>${esc(title)}</h1>`,
    `<div class="meta">å‘å¸ƒæ—¥æœŸï¼š${createdAt} ï½œ ä½œè€…ï¼šOliverÂ F.</div>`,
    marked.parse(content),
    '</body></html>'
  ].join('\n');
  try{
    const j=await fetch(WORKER_BASE+'/',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({slug,html})}).then(r=>r.json());
    if(j.success)alert('âœ… å·²å‘å¸ƒä¸Šçº¿ï¼š'+j.url);else throw new Error(j.message||JSON.stringify(j));
  }catch(e){alert('âŒ å‘å¸ƒå¤±è´¥ï¼š'+e.message);}
};

}); /* main */
</script>
</body>
</html>
