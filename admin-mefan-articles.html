  <!-- … 上面保持不变 … -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ——— 关键：用相对路径，让 Cloudflare Route 生效 ———
    const WORKER_BASE = window.location.origin;
    const ANON_KEY    = 'YOUR_SUPABASE_ANON_KEY';
    const ADMIN_EMAIL = 'oliveroogle@gmail.com';
    const client      = supabase.createClient(WORKER_BASE, ANON_KEY);

    function formatBeijingTime(d) {
      return new Date(d).toLocaleString('zh-CN',{ timeZone:'Asia/Shanghai', hour12:false });
    }
    function getWeekday(d) {
      return ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'][new Date(d).getDay()];
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const authArea      = document.getElementById('authArea');
      const adminArea     = document.getElementById('adminArea');
      const loginBtn      = document.getElementById('loginBtn');
      const logoutBtn     = document.getElementById('logoutBtn');
      const submitBtn     = document.getElementById('submitBtn');
      const cancelBtn     = document.getElementById('cancelEditBtn');
      const searchBtn     = document.getElementById('searchBtn');
      const searchInput   = document.getElementById('searchInput');
      const articlesTable = document.querySelector('#articlesTable tbody');

      let currentEditId = null, currentPage = 1, limit = 5, loading = false;

      // 1. 用 supabase-js 拿本地 Session
      const { data:{ session } } = await client.auth.getSession();
      const user = session?.user;
      if (user?.email === ADMIN_EMAIL) {
        authArea.classList.add('hidden');
        adminArea.classList.remove('hidden');
        loadArticles();
      }

      // 2. 登录：supabase-js 会访问 /auth/v1/authorize
      loginBtn.onclick = () => {
        client.auth.signInWithOAuth({
          provider: 'github',
          options: { redirectTo: location.href }
        });
      };

      // 3. 登出
      logoutBtn.onclick = async () => {
        await client.auth.signOut();
        location.reload();
      };

      // 4. 提交文章
      submitBtn.onclick = async () => {
        const title   = document.getElementById('newTitle').value.trim();
        const content = document.getElementById('newContent').value.trim();
        if (!title || !content) return alert('标题或内容不能为空');

        // 上传封面
        let coverUrl = '';
        const file = document.getElementById('coverInput').files[0];
        if (file) {
          const { data, error } = await client.storage
            .from('articles')
            .upload(`covers/${Date.now()}_${file.name}`, file);
          if (error) return alert('封面上传失败：' + error.message);
          coverUrl = client.storage.from('articles').getPublicUrl(data.path).data.publicUrl;
        }

        // upsert
        const payload = {
          title, content,
          author_email: user.email,
          updated_at:   new Date().toISOString(),
          cover_url:    coverUrl || undefined,
          id:           currentEditId
        };
        const { error } = await client
          .from('articles')
          .upsert(
            currentEditId
              ? { ...payload, id: undefined }
              : { ...payload, created_at: new Date().toISOString() }
          );
        if (error) return alert('提交失败：' + error.message);

        cancelEdit();
        loadArticles(true);
      };

      cancelBtn.onclick = cancelEdit;
      function cancelEdit() {
        document.getElementById('newTitle').value   = '';
        document.getElementById('newContent').value = '';
        document.getElementById('coverInput').value = '';
        currentEditId = null;
        cancelBtn.classList.add('hidden');
      }

      // 删除 / 编辑 / 预览（同你原来代码）
      window.deleteArticle = async id => {
        if (!confirm('确定删除？')) return;
        const { error } = await client.from('articles').delete().eq('id', id);
        if (error) return alert('删除失败：' + error.message);
        loadArticles(true);
      };
      window.editArticle = row => {
        document.getElementById('newTitle').value   = row.title;
        document.getElementById('newContent').value = row.content;
        currentEditId = row.id;
        cancelBtn.classList.remove('hidden');
        window.scrollTo(0,0);
      };
      window.previewArticle = row => {
        document.getElementById('previewTitle').textContent  = row.title;
        document.getElementById('previewCover').src          = row.cover_url || '';
        document.getElementById('markdownContent').innerHTML = marked.parse(row.content || '');
        document.getElementById('previewModal').classList.remove('hidden');
      };
      window.closePreview = () => document.getElementById('previewModal').classList.add('hidden');

      // 搜索 & 滚动加载
      searchBtn.onclick = () => loadArticles(true, searchInput.value.trim());
      window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
          loadArticles();
        }
      });

      // 加载文章列表
      async function loadArticles(reset = false, keyword = '') {
        if (loading) return;
        loading = true;
        if (reset) {
          articlesTable.innerHTML = '';
          currentPage = 1;
        }
        let q = client.from('articles')
          .select('*')
          .order('created_at', { ascending: false })
          .range((currentPage-1)*limit, currentPage*limit-1);
        if (keyword) q = q.ilike('title', `%${keyword}%`);
        const { data, error } = await q;
        if (error) return alert('加载失败：' + error.message);

        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="标题">${row.title}</td>
            <td data-label="作者">${row.author_email}</td>
            <td data-label="内容">${row.content?.slice(0,60)}...</td>
            <td data-label="创建时间">${formatBeijingTime(row.created_at)}</td>
            <td data-label="更新时间">${formatBeijingTime(row.updated_at)}</td>
            <td data-label="星期">${getWeekday(row.created_at)}</td>
            <td data-label="封面">${row.cover_url?`<img src="${row.cover_url}" style="height:40px;">`:''}</td>
            <td data-label="操作">
              <button class="btn" onclick='previewArticle(${JSON.stringify(row)})'>预览</button>
              <button class="btn" onclick='editArticle(${JSON.stringify(row)})'>编辑</button>
              <button class="btn" onclick='deleteArticle("${row.id}")'>删除</button>
            </td>`;
          articlesTable.appendChild(tr);
        });

        loading = false;
        if (data.length === limit) currentPage++;
      }
    });
  </script>
</body>
</html>
