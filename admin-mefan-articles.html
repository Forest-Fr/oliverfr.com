<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>文章后台管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* —— 保留你现有的所有样式 —— */
    body { font-family: Arial, sans-serif; background: #f8f8f8; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
    h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .btn { padding: 8px 16px; background: #333; color: #fff; border: none; cursor: pointer; margin-right: 5px; }
    .btn:hover { background: #555; }
    .hidden { display: none; }
    textarea, input[type="text"], input[type="file"] { width: 100%; margin: 5px 0; }
    table { width: 100%; max-width: 960px; border-collapse: collapse; margin-top: 20px; background: #fff; }
    th, td { padding: 10px; border: 1px solid #ddd; text-align: left; }
    th { background: #f0f0f0; }
    .admin-bar { display: flex; justify-content: space-between; align-items: center; max-width: 960px; width: 100%; margin-bottom: 20px; flex-wrap: wrap; }
    .admin-bar > input { flex: 1; min-width: 200px; margin: 5px; }
    .admin-bar > div { display: flex; gap: 8px; flex-wrap: wrap; justify-content: flex-end; min-width: 200px; margin: 5px; }
    #previewModal { position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: white; padding: 20px; border: 1px solid #ccc; max-width: 700px; width: 90%; z-index: 999; overflow-y: auto; max-height: 80vh; }
    #previewModal h3 { margin-top: 0; }
    #previewModal img { max-width: 100%; }
    #markdownContent { white-space: pre-wrap; }
    @media (max-width: 768px) {
      .admin-bar { flex-direction: column; align-items: stretch; }
      .btn, textarea { width: 100%; margin: 5px 0; }
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tbody tr { border: 1px solid #ddd; margin-bottom: 15px; background: #fff; padding: 10px; }
      tbody td { display: flex; justify-content: space-between; padding: 8px 5px; border: none; border-bottom: 1px solid #eee; }
      tbody td::before { content: attr(data-label); font-weight: bold; color: #555; flex: 1; margin-right: 10px; }
      #submitBtn, #cancelEditBtn { width: 100%; }
    }
  </style>
</head>
<body>

  <h1>📰 文章后台管理</h1>

  <div id="authArea">
    <button id="loginBtn" class="btn">使用 GitHub 登录</button>
  </div>

  <div id="adminArea" class="hidden">
    <div class="admin-bar">
      <input type="text" id="searchInput" placeholder="搜索标题关键词…" />
      <div>
        <button id="searchBtn" class="btn">🔍 搜索</button>
        <button id="logoutBtn" class="btn">退出登录</button>
      </div>
    </div>

    <h2>🆕 新增/编辑文章</h2>
    <input type="text" id="newTitle" placeholder="标题" />
    <textarea id="newContent" placeholder="支持 Markdown 格式的内容"></textarea>
    <input type="file" id="coverInput" accept="image/*" />
    <div style="display: flex; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
      <button id="submitBtn" class="btn">提交</button>
      <button id="cancelEditBtn" class="btn hidden">取消编辑</button>
    </div>

    <div style="overflow-x: auto; width: 100%;">
      <table id="articlesTable">
        <thead>
          <tr>
            <th>标题</th><th>作者</th><th>内容</th><th>创建时间</th><th>更新时间</th><th>星期</th><th>封面</th><th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div id="previewModal" class="hidden">
      <h3 id="previewTitle"></h3>
      <img id="previewCover" />
      <div id="markdownContent"></div>
      <button class="btn" id="closePreviewBtn">关闭</button>
    </div>
  </div>

  <!-- Supabase‑JS & marked -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    // ← 这里指向你的 Worker 域名（最推荐用 origin）
    const WORKER_BASE = window.location.origin;
    const ANON_KEY    = '你的 Supabase anon 公匙';
    const ADMIN_EMAIL = 'oliveroogle@gmail.com';
    const client      = supabase.createClient(WORKER_BASE, ANON_KEY);

    // 工具函数
    function formatBeijingTime(d) {
      return new Date(d).toLocaleString('zh-CN',{ timeZone:'Asia/Shanghai', hour12:false });
    }
    function getWeekday(d) {
      return ['星期日','星期一','星期二','星期三','星期四','星期五','星期六'][new Date(d).getDay()];
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // DOM
      const authArea    = document.getElementById('authArea');
      const adminArea   = document.getElementById('adminArea');
      const loginBtn    = document.getElementById('loginBtn');
      const logoutBtn   = document.getElementById('logoutBtn');
      const submitBtn   = document.getElementById('submitBtn');
      const cancelBtn   = document.getElementById('cancelEditBtn');
      const searchBtn   = document.getElementById('searchBtn');
      const searchInput = document.getElementById('searchInput');
      const articlesTb  = document.querySelector('#articlesTable tbody');
      const closePrev   = document.getElementById('closePreviewBtn');
      const prevModal   = document.getElementById('previewModal');
      const prevTitle   = document.getElementById('previewTitle');
      const prevCover   = document.getElementById('previewCover');
      const prevMd      = document.getElementById('markdownContent');

      let currentEditId = null, currentPage = 1, limit = 5, loading = false;

      // 会话检查
      const { data:{ session } } = await client.auth.getSession();
      const user = session?.user;
      if (user?.email === ADMIN_EMAIL) {
        authArea.classList.add('hidden');
        adminArea.classList.remove('hidden');
        loadArticles();
      }

      // 登录
      loginBtn.addEventListener('click', () => {
        client.auth.signInWithOAuth({ provider:'github', options:{ redirectTo: location.href } });
      });

      // 登出
      logoutBtn.addEventListener('click', async () => {
        await client.auth.signOut();
        location.reload();
      });

      // 取消编辑
      cancelBtn.addEventListener('click', () => {
        currentEditId = null;
        cancelBtn.classList.add('hidden');
        document.getElementById('newTitle').value = '';
        document.getElementById('newContent').value = '';
        document.getElementById('coverInput').value  = '';
      });

      // 关闭预览
      closePrev.addEventListener('click', () => prevModal.classList.add('hidden'));

      // 提交文章
      submitBtn.addEventListener('click', async () => {
        const title   = document.getElementById('newTitle').value.trim();
        const content = document.getElementById('newContent').value.trim();
        if (!title || !content) return alert('标题或内容不能为空');

        // 上传封面
        let coverUrl = '';
        const file = document.getElementById('coverInput').files[0];
        if (file) {
          const { data, error } = await client.storage
            .from('articles')
            .upload(`covers/${Date.now()}_${file.name}`, file);
          if (error) return alert('封面上传失败：' + error.message);
          coverUrl = client.storage.from('articles').getPublicUrl(data.path).data.publicUrl;
        }

        // upsert
        const payload = {
          title, content,
          author_email: user.email,
          updated_at:   new Date().toISOString(),
          cover_url:    coverUrl || undefined,
          id:           currentEditId
        };
        const { error } = await client
          .from('articles')
          .upsert(
            currentEditId
              ? { ...payload, id: undefined }
              : { ...payload, created_at: new Date().toISOString() }
          );
        if (error) return alert('提交失败：' + error.message);

        // 重置 & 刷新
        cancelBtn.click();
        loadArticles(true);
      });

      // 搜索
      searchBtn.addEventListener('click', () => {
        currentPage = 1;
        loadArticles(true, searchInput.value.trim());
      });

      // 无限滚动
      window.addEventListener('scroll', () => {
        if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
          loadArticles();
        }
      });

      // 加载文章
      async function loadArticles(reset = false, keyword = '') {
        if (loading) return;
        loading = true;
        if (reset) {
          articlesTb.innerHTML = '';
          currentPage = 1;
        }
        const from = (currentPage - 1) * limit;
        const to   = from + limit - 1;
        let q = client.from('articles')
          .select('*')
          .order('created_at',{ ascending:false })
          .range(from, to);
        if (keyword) q = q.ilike('title', `%${keyword}%`);
        const { data, error } = await q;
        if (error) return alert('加载失败：' + error.message);

        data.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td data-label="标题">${row.title}</td>
            <td data-label="作者">${row.author_email}</td>
            <td data-label="内容">${(row.content||'').slice(0,60)}...</td>
            <td data-label="创建时间">${formatBeijingTime(row.created_at)}</td>
            <td data-label="更新时间">${formatBeijingTime(row.updated_at)}</td>
            <td data-label="星期">${getWeekday(row.created_at)}</td>
            <td data-label="封面">${row.cover_url?`<img src="${row.cover_url}" style="height:40px;">`:''}</td>
            <td data-label="操作">
              <button class="btn preview-btn">预览</button>
              <button class="btn edit-btn">编辑</button>
              <button class="btn delete-btn">删除</button>
            </td>`;
          // 绑定事件
          tr.querySelector('.preview-btn').addEventListener('click', ()=> {
            prevTitle.textContent = row.title;
            prevCover.src         = row.cover_url||'';
            prevMd.innerHTML      = marked.parse(row.content||'');
            prevModal.classList.remove('hidden');
          });
          tr.querySelector('.edit-btn').addEventListener('click', ()=> {
            document.getElementById('newTitle').value   = row.title;
            document.getElementById('newContent').value = row.content;
            currentEditId = row.id;
            cancelBtn.classList.remove('hidden');
            window.scrollTo(0,0);
          });
          tr.querySelector('.delete-btn').addEventListener('click', async ()=> {
            if (!confirm('确定删除？')) return;
            const { error } = await client.from('articles').delete().eq('id', row.id);
            if (error) return alert('删除失败：' + error.message);
            loadArticles(true);
          });
          articlesTb.appendChild(tr);
        });

        loading = false;
        if (data.length === limit) currentPage++;
      }
    });
  </script>
</body>
</html>
