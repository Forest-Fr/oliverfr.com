<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ç« åå°ç®¡ç†</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* ï¼ˆè¿™é‡Œçœç•¥å‰é¢è´´è¿‡çš„æ‰€æœ‰ CSSï¼Œä¿æŒä¸å˜ï¼‰ */
  </style>
</head>
<body>

<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<div id="authArea">
  <button id="loginBtn" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button>
</div>

<div id="adminArea" class="hidden">
  <!-- ï¼ˆä¿æŒä¹‹å‰çš„ç®¡ç† UI ç»“æ„ä¸å˜ï¼‰ -->
</div>

<!-- âœ… é‡æ–°å¼•å…¥ Supabase-JSï¼Œè®©å®ƒèµ° Worker ä»£ç† -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
  // â€”â€” æŒ‡å‘åŒåŸŸå Worker â€”â€” 
  const WORKER_BASE = location.origin;
  // è¿™é‡Œç”¨å…¬å¼€çš„ anon Keyï¼ŒWorker ä¼šæ›¿ä½ åŠ ä¸ŠçœŸæ­£çš„ apikey
  const PUBLIC_ANON_KEY = 'ä½ çš„ public anon key';
  // Supabase å®¢æˆ·ç«¯ï¼Œæ‰€æœ‰ /auth/v1ã€/rest/v1ã€/storage/v1 è¯·æ±‚éƒ½ä¼šèµ° Worker
  const supabase = supabase.createClient(WORKER_BASE, PUBLIC_ANON_KEY, {
    auth: {
      detectSessionInUrl: true,   // è®©å®ƒè‡ªåŠ¨è§£æ #access_token
      persistSession: true       // å¹¶å­˜åˆ° localStorage
    }
  });

  const ADMIN_EMAIL = 'oliveroogle@gmail.com';
  let currentPage = 1, limit = 5, loading = false;

  // æ ¼å¼åŒ–å‡½æ•°åŒä¸Š
  function formatBeijingTime(d){ return new Date(d).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai',hour12:false}); }
  function getWeekday(d){ return ['æ˜ŸæœŸæ—¥','æ˜ŸæœŸä¸€','æ˜ŸæœŸäºŒ','æ˜ŸæœŸä¸‰','æ˜ŸæœŸå››','æ˜ŸæœŸäº”','æ˜ŸæœŸå…­'][new Date(d).getDay()]; }

  document.addEventListener("DOMContentLoaded", async () => {
    const loginBtn      = document.getElementById("loginBtn");
    const logoutBtn     = document.getElementById("logoutBtn");
    const authArea      = document.getElementById("authArea");
    const adminArea     = document.getElementById("adminArea");
    const searchBtn     = document.getElementById("searchBtn");
    const searchInput   = document.getElementById("searchInput");
    const newTitle      = document.getElementById("newTitle");
    const newContent    = document.getElementById("newContent");
    const coverInput    = document.getElementById("coverInput");
    const submitBtn     = document.getElementById("submitBtn");
    const cancelEditBtn = document.getElementById("cancelEditBtn");
    const articlesTable = document.querySelector("#articlesTable tbody");

    // â€”â€” ç™»å½• â€”â€” 
    loginBtn.onclick = () => {
      supabase.auth.signInWithOAuth({ provider: 'github' });
    };

    // â€”â€” ç™»å‡º â€”â€” 
    logoutBtn.onclick = async () => {
      await supabase.auth.signOut();
      location.reload();
    };

    // â€”â€” ä¼šè¯æ£€æŸ¥ â€”â€” 
    const { data: { session } } = await supabase.auth.getSession();
    const user = session?.user;
    if (user?.email === ADMIN_EMAIL) {
      authArea.classList.add("hidden");
      adminArea.classList.remove("hidden");
      loadArticles();
    }

    // â€”â€” æ–°å¢/ç¼–è¾‘ æäº¤ â€”â€” 
    submitBtn.onclick = async () => {
      const title   = newTitle.value.trim();
      const content = newContent.value.trim();
      if (!title || !content) return alert("æ ‡é¢˜æˆ–å†…å®¹ä¸èƒ½ä¸ºç©º");

      let coverUrl = '';
      if (coverInput.files[0]) {
        const { data, error } = await supabase
          .storage
          .from('articles')
          .upload(`covers/${Date.now()}_${coverInput.files[0].name}`, coverInput.files[0], { upsert: true });
        if (error) return alert("å°é¢ä¸Šä¼ å¤±è´¥ï¼š" + error.message);
        coverUrl = supabase
          .storage
          .from('articles')
          .getPublicUrl(data.path)
          .data.publicUrl;
      }

      const payload = {
        title, content,
        author_email: user.email,
        created_at:   currentEditId ? undefined : new Date().toISOString(),
        updated_at:   new Date().toISOString(),
        cover_url:    coverUrl || undefined,
      };
      let res;
      if (currentEditId) {
        res = await supabase
          .from('articles')
          .update(payload)
          .eq('id', currentEditId);
      } else {
        res = await supabase
          .from('articles')
          .insert([{ ...payload, created_at: new Date().toISOString() }]);
      }
      if (res.error) return alert("æäº¤å¤±è´¥ï¼š" + res.error.message);

      newTitle.value = '';
      newContent.value = '';
      coverInput.value = '';
      currentEditId = null;
      cancelEditBtn.classList.add("hidden");
      loadArticles(true);
    };

    // â€”â€” å–æ¶ˆç¼–è¾‘ â€”â€” 
    cancelEditBtn.onclick = () => {
      newTitle.value = '';
      newContent.value = '';
      coverInput.value = '';
      currentEditId = null;
      cancelEditBtn.classList.add("hidden");
    };

    // â€”â€” åŠ è½½æ–‡ç« åˆ—è¡¨ â€”â€” 
    async function loadArticles(reset = false, keyword = '') {
      if (loading) return;
      loading = true;
      if (reset) {
        articlesTable.innerHTML = '';
        currentPage = 1;
      }

      let query = supabase
        .from('articles')
        .select('*')
        .order('created_at', { ascending: false })
        .range((currentPage - 1) * limit, currentPage * limit - 1);

      if (keyword) {
        query = query.ilike('title', `%${keyword}%`);
      }

      const { data, error } = await query;
      if (error) return alert("åŠ è½½å¤±è´¥ï¼š" + error.message);

      data.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td data-label="æ ‡é¢˜">${row.title}</td>
          <td data-label="ä½œè€…">${row.author_email}</td>
          <td data-label="å†…å®¹">${row.content?.slice(0,60)}...</td>
          <td data-label="åˆ›å»ºæ—¶é—´">${formatBeijingTime(row.created_at)}</td>
          <td data-label="æ›´æ–°æ—¶é—´">${formatBeijingTime(row.updated_at)}</td>
          <td data-label="æ˜ŸæœŸ">${getWeekday(row.created_at)}</td>
          <td data-label="å°é¢">${row.cover_url?`<img src="${row.cover_url}" style="height:40px;">`:''}</td>
          <td data-label="æ“ä½œ">
            <button class="btn" onclick='previewArticle(${JSON.stringify(row)})'>é¢„è§ˆ</button>
            <button class="btn" onclick='editArticle(${JSON.stringify(row)})'>ç¼–è¾‘</button>
            <button class="btn" onclick='deleteArticle("${row.id}")'>åˆ é™¤</button>
          </td>`;
        articlesTable.appendChild(tr);
      });

      loading = false;
      if (data.length === limit) currentPage++;
    }

    // â€”â€” é¢„è§ˆ / ç¼–è¾‘ / åˆ é™¤ â€”â€” 
    window.previewArticle = row => {
      document.getElementById("previewTitle").textContent = row.title;
      document.getElementById("previewCover").src         = row.cover_url || '';
      document.getElementById("markdownContent").innerHTML = marked.parse(row.content || '');
      document.getElementById("previewModal").classList.remove("hidden");
    };
    window.editArticle = row => {
      newTitle.value      = row.title;
      newContent.value    = row.content;
      currentEditId       = row.id;
      cancelEditBtn.classList.remove("hidden");
      window.scrollTo(0,0);
    };
    window.deleteArticle = async id => {
      if (!confirm("ç¡®å®šè¦åˆ é™¤è¯¥æ–‡ç« ï¼Ÿ")) return;
      const { error } = await supabase.from('articles').delete().eq('id', id);
      if (error) return alert("åˆ é™¤å¤±è´¥ï¼š" + error.message);
      loadArticles(true);
    };

    // â€”â€” æœç´¢ & æ— é™æ»šåŠ¨ â€”â€” 
    searchBtn.onclick = () => loadArticles(true, searchInput.value.trim());
    window.addEventListener("scroll", () => {
      if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
        loadArticles();
      }
    });
  });
</script>
</body>
</html>
