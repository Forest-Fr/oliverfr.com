<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workflow Ops Console</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1120;
      --card:#0f172a;
      --border:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --btn:#111827;
      --btn2:#0b1224;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    body{ margin:0; background:var(--bg); color:var(--text); font-family:var(--sans); }
    .wrap{ max-width:1080px; margin:0 auto; padding:18px 14px 40px; }
    h1{ margin:6px 0 6px; font-size:18px; font-weight:700; }
    .hint{ color:var(--muted); font-size:13px; line-height:1.6; margin:0 0 14px; }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--border);
      border-radius:14px;
      padding:14px;
      margin:12px 0;
    }
    .row{ display:flex; gap:10px; flex-wrap:wrap; }
    .col{ flex:1 1 240px; min-width:240px; }
    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      background:rgba(15,23,42,.6);
      border:1px solid var(--border);
      color:var(--text);
      border-radius:10px;
      padding:10px 10px;
      font-family:var(--mono);
      font-size:12.5px;
      outline:none;
    }
    textarea{ min-height:120px; resize:vertical; line-height:1.5; }
    .btns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; }
    button{
      background:var(--btn);
      color:var(--text);
      border:1px solid var(--border);
      border-radius:999px;
      padding:10px 14px;
      font-size:13px;
      cursor:pointer;
    }
    button.secondary{ background:var(--btn2); }
    button.danger{ border-color:rgba(239,68,68,.35); }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      border:1px solid var(--border);
      background:rgba(2,6,23,.35);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      margin:2px 0 0;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--muted); }
    .dot.ok{ background:var(--ok); }
    .dot.bad{ background:var(--bad); }
    .dot.warn{ background:var(--warn); }
    pre{
      margin:10px 0 0;
      background:rgba(2,6,23,.35);
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      overflow:auto;
      font-family:var(--mono);
      font-size:12px;
      line-height:1.55;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .small{ color:var(--muted); font-size:12px; margin-top:8px; line-height:1.6; }
    .warnbox{
      margin-top:10px;
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.08);
      color:rgba(245,158,11,.95);
      border-radius:12px;
      padding:10px 12px;
      font-size:12.5px;
      line-height:1.6;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Workflow Ops Console</h1>
    <p class="hint">
      目标：用最小“真实请求”验证 Gateway → Worker/Temporal → Grafana Tempo 的联动（Service Graph / Span 树 / Waterfall）。<br/>
      本页面不包含密钥、不触碰数据库、不承接管理能力；仅用于触发与验收。
    </p>

    <div class="card">
      <div class="pill" id="statusPill">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Idle</span>
      </div>

      <div class="row">
        <div class="col">
          <label>连接模式</label>
          <select id="mode">
            <option value="proxy">Proxy（同源 /wf/*，推荐：不吃 CORS）</option>
            <option value="direct">Direct（直连 Cloud Run：需要 CORS）</option>
          </select>
          <div class="small">
            Proxy 模式会把请求打到：<span style="font-family:var(--mono)">${location.origin}/wf/...</span><br/>
            Direct 模式会把请求打到：你填写的 Gateway Base + Path
          </div>
        </div>

        <div class="col">
          <label>Gateway Base（Direct 模式使用）</label>
          <input id="gatewayBase" placeholder="https://workflow-gateway-xxxx.us-central1.run.app" />
          <div class="small">不要填到 path 里；这里才是 base。</div>
        </div>

        <div class="col">
          <label>Proxy Base（Proxy 模式使用）</label>
          <input id="proxyBase" placeholder="https://doc.mefans.workers.dev/wf" />
          <div class="small">通常就是当前站点 + <span style="font-family:var(--mono)">/wf</span></div>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label>Ready Path（默认 /readyz）</label>
          <input id="readyPath" placeholder="/readyz" />
        </div>
        <div class="col">
          <label>Health Path（默认 /health）</label>
          <input id="healthPath" placeholder="/health" />
        </div>
        <div class="col">
          <label>Grafana URL（可选）</label>
          <input id="grafanaBase" placeholder="https://oliverfr.grafana.net" />
          <div class="small">仅用于一键打开 Grafana（不做鉴权）。</div>
        </div>
      </div>

      <div class="btns">
        <button id="btnCheck">Check（ready + health）</button>
        <button id="btnSave" class="secondary">Save Settings</button>
        <button id="btnReset" class="danger">Reset</button>
        <button id="btnOpenGrafana" class="secondary">Open Grafana</button>
      </div>

      <div class="warnbox" id="fileWarn" style="display:none"></div>

      <pre id="checkOut">尚未执行检查。</pre>
    </div>

    <div class="card">
      <h1 style="font-size:14px;margin:0 0 6px;">Request Runner（用于触发真实链路/Trace）</h1>
      <p class="hint" style="margin:0 0 8px;">
        你可以在这里手工打你真实的 workflow 触发接口（例如启动 EchoWorkflow / DocWorkflow），以便 Tempo 里出现 span。
      </p>

      <div class="row">
        <div class="col" style="flex:0 0 180px;min-width:180px;">
          <label>Method</label>
          <select id="reqMethod">
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>DELETE</option>
          </select>
        </div>
        <div class="col">
          <label>Path（只填 path，例如 /api/echo 或 /workflows/echo）</label>
          <input id="reqPath" placeholder="/api/echo" />
        </div>
      </div>

      <label>JSON Body（GET 可留空）</label>
      <textarea id="reqBody" placeholder='{"ping":"from console"}'></textarea>

      <div class="btns">
        <button id="btnSend">Send Request</button>
      </div>

      <pre id="reqOut">尚未发送请求。</pre>
    </div>

  </div>

<script>
(() => {
  const $ = (id) => document.getElementById(id);

  const STORAGE_KEY = "wf_console_settings_v2";

  const defaults = {
    mode: "proxy",
    gatewayBase: "https://workflow-gateway-233489274446.us-central1.run.app",
    proxyBase: (location.protocol === "file:") ? "" : (location.origin.replace(/\/+$/,"") + "/wf"),
    readyPath: "/readyz",
    healthPath: "/health",
    grafanaBase: "https://oliverfr.grafana.net",
    reqMethod: "POST",
    reqPath: "/",
    reqBody: '{"ping":"from console"}'
  };

  function setPill(kind, text){
    const dot = $("statusDot");
    dot.classList.remove("ok","bad","warn");
    if (kind) dot.classList.add(kind);
    $("statusText").textContent = text;
  }

  function normalizeBase(base){
    return String(base || "").trim().replace(/\/+$/,"");
  }

  function normalizePath(path){
    const p = String(path || "").trim();
    if (!p) return "/";
    // 如果用户填了完整 URL，就直接用（但不推荐）
    if (/^https?:\/\//i.test(p)) return p;
    return p.startsWith("/") ? p : ("/" + p);
  }

  function buildUrl(base, path){
    const p = normalizePath(path);
    if (/^https?:\/\//i.test(p)) return p;
    const b = normalizeBase(base);
    return b + p;
  }

  function currentBase(){
    const mode = $("mode").value;
    if (mode === "direct") return normalizeBase($("gatewayBase").value);
    return normalizeBase($("proxyBase").value);
  }

  function safeJsonParse(text){
    try { return JSON.parse(text); } catch (_) { return null; }
  }

  async function fetchText(url, opts){
    const t0 = performance.now();
    try{
      const res = await fetch(url, Object.assign({
        method: "GET",
        headers: {
          "accept": "application/json",
          "x-wf-console": "1"
        }
      }, opts || {}));
      const text = await res.text();
      return {
        ok: res.ok,
        status: res.status,
        ms: Math.round(performance.now() - t0),
        text,
        json: safeJsonParse(text)
      };
    }catch(err){
      return {
        ok: false,
        status: "FETCH_ERR",
        ms: Math.round(performance.now() - t0),
        error: String(err)
      };
    }
  }

  function load(){
    let cfg = null;
    try{
      cfg = JSON.parse(localStorage.getItem(STORAGE_KEY) || "null");
    }catch(_){ cfg = null; }
    const c = Object.assign({}, defaults, cfg || {});

    $("mode").value = c.mode;
    $("gatewayBase").value = c.gatewayBase;
    $("proxyBase").value = c.proxyBase;
    $("readyPath").value = c.readyPath;
    $("healthPath").value = c.healthPath;
    $("grafanaBase").value = c.grafanaBase;

    $("reqMethod").value = c.reqMethod;
    $("reqPath").value = c.reqPath;
    $("reqBody").value = c.reqBody;

    if (location.protocol === "file:") {
      $("fileWarn").style.display = "block";
      $("fileWarn").textContent =
        "你当前是 file:// 打开页面。Proxy 模式无法使用 location.origin（为 null）。" +
        "请改用 Direct 模式，或把页面托管到任意静态站点后再用 Proxy 模式。";
    } else {
      $("fileWarn").style.display = "none";
      $("fileWarn").textContent = "";
    }
  }

  function save(){
    const c = {
      mode: $("mode").value,
      gatewayBase: $("gatewayBase").value,
      proxyBase: $("proxyBase").value,
      readyPath: $("readyPath").value,
      healthPath: $("healthPath").value,
      grafanaBase: $("grafanaBase").value,
      reqMethod: $("reqMethod").value,
      reqPath: $("reqPath").value,
      reqBody: $("reqBody").value
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(c));
  }

  function reset(){
    localStorage.removeItem(STORAGE_KEY);
    load();
    setPill(null, "Reset done");
    $("checkOut").textContent = "已重置配置。";
    $("reqOut").textContent = "已重置配置。";
  }

  async function check(){
    setPill("warn", "Checking...");
    const base = currentBase();

    const readyUrl = buildUrl(base, $("readyPath").value);
    const healthUrl = buildUrl(base, $("healthPath").value);

    const lines = [];
    lines.push("== Effective Requests ==");
    lines.push("mode      : " + $("mode").value);
    lines.push("base      : " + base);
    lines.push("readyUrl  : " + readyUrl);
    lines.push("healthUrl : " + healthUrl);
    lines.push("");

    const r1 = await fetchText(readyUrl, { method: "GET" });
    const r2 = await fetchText(healthUrl, { method: "GET" });

    lines.push("== Ready ==");
    lines.push(JSON.stringify(r1, null, 2));
    lines.push("");
    lines.push("== Health ==");
    lines.push(JSON.stringify(r2, null, 2));

    $("checkOut").textContent = lines.join("\n");

    if (r1.ok && r2.ok) setPill("ok", "Check OK");
    else setPill("bad", `Check failed (ready=${r1.status}, health=${r2.status})`);
  }

  async function sendRequest(){
    setPill("warn", "Sending request...");
    const base = currentBase();
    const method = $("reqMethod").value;
    const path = $("reqPath").value || "/";
    const url = buildUrl(base, path);

    let body = null;
    let headers = { "accept":"application/json", "x-wf-console":"1" };

    const raw = String($("reqBody").value || "").trim();
    if (method !== "GET" && method !== "DELETE") {
      if (raw) {
        try{
          JSON.parse(raw);
          body = raw;
          headers["content-type"] = "application/json";
        }catch(err){
          $("reqOut").textContent =
            "Body 不是合法 JSON，已阻止发送。\n\n" +
            "error: " + String(err) + "\n\n" +
            "raw:\n" + raw;
          setPill("bad", "Body JSON invalid");
          return;
        }
      }
    }

    const result = await fetchText(url, { method, headers, body });

    const lines = [];
    lines.push("== Effective Request ==");
    lines.push("mode   : " + $("mode").value);
    lines.push("url    : " + url);
    lines.push("method : " + method);
    lines.push("");
    lines.push("== Response ==");
    lines.push(JSON.stringify(result, null, 2));

    $("reqOut").textContent = lines.join("\n");

    if (result.ok) setPill("ok", "Request OK");
    else setPill("bad", "Request failed");
  }

  $("btnCheck").addEventListener("click", check);
  $("btnSave").addEventListener("click", () => { save(); setPill("ok","Saved"); });
  $("btnReset").addEventListener("click", reset);
  $("btnSend").addEventListener("click", sendRequest);
  $("btnOpenGrafana").addEventListener("click", () => {
    const g = normalizeBase($("grafanaBase").value);
    if (!g) return;
    window.open(g, "_blank", "noopener,noreferrer");
  });

  load();
  setPill(null, "Idle");
})();
</script>
</body>
</html>
