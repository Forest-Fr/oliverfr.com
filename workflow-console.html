<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Workflow Console</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon">
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0b1120;
      --card:#0f172a;
      --card2:#0b1224;
      --border:rgba(148,163,184,.22);
      --text:#e5e7eb;
      --muted:#94a3b8;
      --muted2:#64748b;
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --accent:#38bdf8;
      --accent2:#0ea5e9;
      --shadow:0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 15% 10%, rgba(56,189,248,.18), transparent 60%),
                  radial-gradient(1000px 500px at 85% 20%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:28px 18px 60px}
    h1{margin:0 0 8px;font-size:28px;letter-spacing:.2px}
    .sub{margin:0 0 22px;color:var(--muted);line-height:1.5}
    .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:16px}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr} }
    .card{
      background:linear-gradient(180deg, rgba(15,23,42,.92), rgba(11,18,36,.92));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
    }
    .card h2{margin:0 0 12px;font-size:16px;color:#f8fafc}
    .row{display:grid;grid-template-columns: 1fr;gap:10px}
    .row2{display:grid;grid-template-columns: 1fr 1fr;gap:10px}
    @media (max-width: 680px){ .row2{grid-template-columns:1fr} }
    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input, textarea, select{
      width:100%;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.55);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:120px;font-family:var(--mono);font-size:12.5px;line-height:1.5;resize:vertical}
    .mono{font-family:var(--mono)}
    .btns{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px}
    button{
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.45);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
    }
    button:hover{border-color:rgba(56,189,248,.55); background:rgba(56,189,248,.10)}
    button:active{transform: translateY(1px)}
    .primary{background:rgba(14,165,233,.20); border-color:rgba(14,165,233,.45)}
    .danger{background:rgba(239,68,68,.14); border-color:rgba(239,68,68,.35)}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      border:1px solid rgba(148,163,184,.25);
      background:rgba(2,6,23,.35);
      font-size:12px;color:var(--muted);
    }
    .dot{width:10px;height:10px;border-radius:50%}
    .ok{background:var(--ok)}
    .bad{background:var(--bad)}
    .warn{background:var(--warn)}
    .kv{
      display:grid;
      grid-template-columns: 150px 1fr;
      gap:8px 10px;
      align-items:center;
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(148,163,184,.22);
    }
    .k{color:var(--muted);font-size:12px}
    .v{font-family:var(--mono);font-size:12.5px;color:#e2e8f0;word-break:break-all}
    .hint{
      margin-top:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.28);
      color:var(--muted);
      line-height:1.55;
      font-size:12.5px;
    }
    .log{
      margin-top:10px;
      border:1px solid rgba(148,163,184,.18);
      background:rgba(2,6,23,.35);
      border-radius:14px;
      padding:10px 12px;
      font-family:var(--mono);
      font-size:12.2px;
      line-height:1.55;
      white-space:pre-wrap;
      word-break:break-word;
      min-height:140px;
    }
    .small{font-size:12px;color:var(--muted2)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:12px;flex-wrap:wrap">
      <div>
        <h1>Workflow Console</h1>
        <p class="sub">
          目标：以“真实请求 + 真实 Trace 注入”为主线，联动 Gateway → Temporal/Worker → Grafana Tempo（Service Graph / Span 树 / Waterfall）。
          本页面不包含密钥，不触碰数据库，不承担管理能力；仅用于触发与验收。
        </p>
      </div>
      <div class="pill" id="statusPill">
        <span class="dot warn" id="statusDot"></span>
        <span id="statusText">Not checked</span>
      </div>
    </div>

    <div class="grid">
      <!-- Left -->
      <div class="card">
        <h2>1) Connection</h2>
        <div class="row">
          <!-- ===== [PATCH INSERT] mode + proxy base (non-breaking) ===== -->
          <div class="row2">
            <div>
              <label>Connection mode</label>
              <select id="connMode">
                <option value="direct">Direct（直连 gatewayBase，可能受 CORS 影响）</option>
                <option value="proxy">Proxy（同源 /wf 代理，不吃 CORS；需 Worker 提供 /wf）</option>
              </select>
              <div class="small" style="margin-top:6px">
                说明：你截图里出现 <span class="mono">/wf/readyz</span> 404，典型是“页面在打 Proxy，但同域没有 /wf 路由”。
              </div>
            </div>
            <div>
              <label>Proxy Base (mode=Proxy)</label>
              <input id="proxyBase" class="mono" placeholder="https://doc.mefans.workers.dev/wf" />
              <div class="small" style="margin-top:6px">
                可选：URL 参数也支持：<span class="mono">?proxy_base=https://doc.mefans.workers.dev/wf</span>
              </div>
            </div>
          </div>
          <!-- ===== [PATCH END] ===== -->

          <div>
            <label>Gateway URL (base)</label>
            <input id="gatewayBase" class="mono" placeholder="https://workflow-gateway-xxxx.us-central1.run.app" />
            <div class="small" style="margin-top:6px">
              说明：Direct 模式下浏览器调用可能受 CORS 影响；若“地址栏访问 OK，但这里失败”，优先判断 CORS。
            </div>
          </div>

          <div class="row2">
            <div>
              <label>Ready path (default /readyz)</label>
              <input id="readyPath" class="mono" value="/readyz" />
            </div>
            <div>
              <label>Health path (default /health)</label>
              <input id="healthPath" class="mono" value="/health" />
            </div>
          </div>

          <div>
            <label>Grafana URL (optional)</label>
            <input id="grafanaBase" class="mono" placeholder="https://oliverfr.grafana.net" />
            <div class="small" style="margin-top:6px">
              仅用于一键打开 Grafana 首页；Tempo Explore 的 URL 版本差异大，本页改为输出可复制的 TraceQL/检索条件。
            </div>
          </div>

          <!-- ===== [PATCH INSERT] effective base preview (non-breaking) ===== -->
          <div class="kv">
            <div class="k">Page origin</div><div class="v" id="pageOrigin"></div>
            <div class="k">Effective base</div><div class="v" id="effectiveBase"></div>
          </div>
          <!-- ===== [PATCH END] ===== -->

          <div class="btns">
            <button class="primary" id="btnCheck">Check (ready + health)</button>
            <button id="btnSave">Save Settings</button>
            <button class="danger" id="btnReset">Reset</button>
            <button id="btnOpenGrafana">Open Grafana</button>
          </div>

          <div class="hint" id="checkHint">
            建议验收顺序：先 Check 通过（ready/health），再去 2) 生成 IDs，最后用 3) 发起一次真实 POST 请求并在 Tempo 中检索到同一条 Trace。
          </div>
        </div>
      </div>

      <!-- Right -->
      <div class="card">
        <h2>2) Trace Context (generate & inject)</h2>

        <div class="row2">
          <div>
            <label>workflow_id</label>
            <input id="workflowId" class="mono" />
          </div>
          <div>
            <label>job_id</label>
            <input id="jobId" class="mono" />
          </div>
        </div>

        <div class="row2" style="margin-top:10px">
          <div>
            <label>x-request-id</label>
            <input id="requestId" class="mono" />
          </div>
          <div>
            <label>traceparent (W3C)</label>
            <input id="traceparent" class="mono" />
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="btnGenIds">Generate New IDs</button>
          <button id="btnCopyHeaders">Copy Injected Headers</button>
          <button id="btnCopyTempoHints">Copy Tempo Search Hints</button>
        </div>

        <div class="hint">
          <div style="margin-bottom:6px;color:#e2e8f0">Tempo 检索建议（复制到 Grafana Explore / Tempo）：</div>
          <div class="mono" id="tempoHints" style="font-size:12.5px;line-height:1.6"></div>
        </div>

        <div class="kv">
          <div class="k">Inject headers</div><div class="v" id="injectHeadersPreview"></div>
          <div class="k">Note</div><div class="v" style="color:var(--muted)">后端若未把这些字段写入 span attributes，请在 Gateway/Worker 的 OTEL middleware 中补充 attribute 绑定（稍后你下指令我再动代码）。</div>
        </div>
      </div>

      <!-- Left bottom: Request Builder -->
      <div class="card">
        <h2>3) Trigger a real request (configurable)</h2>

        <div class="row2">
          <div>
            <label>Method</label>
            <select id="method">
              <option>POST</option>
              <option>GET</option>
              <option>PUT</option>
              <option>DELETE</option>
            </select>
          </div>
          <div>
            <label>Path (relative to base)</label>
            <input id="path" class="mono" value="/api/trigger" />
          </div>
        </div>

        <div style="margin-top:10px">
          <label>JSON Body (optional; ignored for GET)</label>
          <textarea id="body" spellcheck="false">{
  "workflow_id": "{{workflow_id}}",
  "job_id": "{{job_id}}",
  "note": "console demo request"
}</textarea>
          <div class="small" style="margin-top:6px">
            支持模板变量：<span class="mono">{{workflow_id}}</span>、<span class="mono">{{job_id}}</span>、<span class="mono">{{x_request_id}}</span>、<span class="mono">{{traceparent}}</span>
          </div>
        </div>

        <div class="row2" style="margin-top:10px">
          <div>
            <label>Optional: Status poll path (e.g. /api/jobs/{{job_id}})</label>
            <input id="pollPath" class="mono" placeholder="" />
            <div class="small" style="margin-top:6px">
              如果你的系统是异步队列：填一个可查询 job 状态的接口路径；本页会轮询并展示状态。
            </div>
          </div>
          <div>
            <label>Poll interval (ms)</label>
            <input id="pollInterval" class="mono" value="1500" />
          </div>
        </div>

        <!-- ===== [PATCH INSERT] poll headers toggle (non-breaking) ===== -->
        <div style="margin-top:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
          <label style="margin:0;display:flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)">
            <input id="pollWithHeaders" type="checkbox" style="width:auto;transform:translateY(1px)">
            Poll 时附带 trace headers（会触发 CORS preflight；默认关闭更稳）
          </label>
        </div>
        <!-- ===== [PATCH END] ===== -->

        <div class="btns">
          <button class="primary" id="btnSend">Send Request</button>
          <button id="btnStopPoll">Stop Poll</button>
          <button id="btnCopyCurl">Copy as curl</button>
        </div>

        <div class="hint" id="sendHint">
          提示：如果 Send 结果显示 “Failed to fetch / CORS”，但你在浏览器地址栏直接访问该 URL 是 OK 的，则几乎必然是后端未允许本页面 Origin。
        </div>
      </div>

      <!-- Right bottom: Result -->
      <div class="card">
        <h2>4) Result & Diagnostics</h2>
        <div class="row">
          <div class="pill">
            <span class="dot warn" id="reqDot"></span>
            <span id="reqText" class="mono">Idle</span>
          </div>
          <div class="log" id="log"></div>
          <div class="small">
            诊断规则：能读到 HTTP status/body ⇒ 说明请求到达服务；读不到（Failed to fetch） ⇒ 多数是 CORS / 网络层阻断。
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = (id) => document.getElementById(id);

  const els = {
    statusPill: $("statusPill"),
    statusDot: $("statusDot"),
    statusText: $("statusText"),

    // ===== [PATCH INSERT] conn mode + proxy base (non-breaking) =====
    connMode: $("connMode"),
    proxyBase: $("proxyBase"),
    pageOrigin: $("pageOrigin"),
    effectiveBase: $("effectiveBase"),
    // ===== [PATCH END] =====

    gatewayBase: $("gatewayBase"),
    readyPath: $("readyPath"),
    healthPath: $("healthPath"),
    grafanaBase: $("grafanaBase"),

    workflowId: $("workflowId"),
    jobId: $("jobId"),
    requestId: $("requestId"),
    traceparent: $("traceparent"),

    tempoHints: $("tempoHints"),
    injectHeadersPreview: $("injectHeadersPreview"),

    method: $("method"),
    path: $("path"),
    body: $("body"),
    pollPath: $("pollPath"),
    pollInterval: $("pollInterval"),
    // ===== [PATCH INSERT] poll headers toggle (non-breaking) =====
    pollWithHeaders: $("pollWithHeaders"),
    // ===== [PATCH END] =====

    reqDot: $("reqDot"),
    reqText: $("reqText"),
    log: $("log"),

    btnCheck: $("btnCheck"),
    btnSave: $("btnSave"),
    btnReset: $("btnReset"),
    btnOpenGrafana: $("btnOpenGrafana"),

    btnGenIds: $("btnGenIds"),
    btnCopyHeaders: $("btnCopyHeaders"),
    btnCopyTempoHints: $("btnCopyTempoHints"),

    btnSend: $("btnSend"),
    btnStopPoll: $("btnStopPoll"),
    btnCopyCurl: $("btnCopyCurl"),
  };

  let pollTimer = null;

  function setStatus(state, text){
    // state: ok / bad / warn
    els.statusDot.className = "dot " + (state === "ok" ? "ok" : state === "bad" ? "bad" : "warn");
    els.statusText.textContent = text;
  }
  function setReqState(state, text){
    els.reqDot.className = "dot " + (state === "ok" ? "ok" : state === "bad" ? "bad" : "warn");
    els.reqText.textContent = text;
  }

  function normalizeBaseUrl(u){
    u = (u || "").trim();
    if (!u) return "";
    return u.replace(/\/+$/, "");
  }

  // ===== [PATCH REPLACE] robust path normalize (non-breaking) =====
  function normalizePathInput(input, fallback){
    const v = String(input || "").trim();
    if (!v) return fallback || "";

    // If user pasted full URL, extract pathname + search
    if (/^https?:\/\//i.test(v)){
      try{
        const u = new URL(v);
        const ps = (u.pathname || "/") + (u.search || "");
        return ps || (fallback || "/");
      }catch(e){
        return fallback || "/";
      }
    }

    // Ensure it is a relative path
    return v.startsWith("/") ? v : "/" + v;
  }
  // ===== [PATCH END] =====

  // ===== [PATCH INSERT] proxy base resolver (non-breaking) =====
  function resolveProxyBase(){
    // 优先：输入框
    const input = normalizeBaseUrl(els.proxyBase.value);
    if (input) return input;

    // 次级：URL 参数
    const sp = new URLSearchParams(location.search);
    const qpBase = normalizeBaseUrl(sp.get("proxy_base") || "");
    if (qpBase) {
      try { localStorage.setItem("wf_console_proxy_base", qpBase); } catch(e){}
      return qpBase;
    }

    // 兜底：localStorage
    let lsBase = "";
    try { lsBase = normalizeBaseUrl(localStorage.getItem("wf_console_proxy_base") || ""); } catch(e){}
    if (lsBase) return lsBase;

    // 再兜底：同源 /wf（file:// 无 origin）
    if (location.protocol !== "file:" && location.origin) {
      return normalizeBaseUrl(location.origin) + "/wf";
    }
    return "";
  }

  function resolveEffectiveBase(){
    const mode = (els.connMode.value || "direct").trim();

    if (mode === "proxy"){
      const pb = resolveProxyBase();
      return { mode, base: pb };
    }

    // direct
    const gb = normalizeBaseUrl(els.gatewayBase.value);
    return { mode, base: gb };
  }

  function refreshEffectivePreview(){
    const po = (location.protocol === "file:") ? "file:// (no origin)" : (location.origin || "");
    els.pageOrigin.textContent = po;

    const eff = resolveEffectiveBase();
    els.effectiveBase.textContent = eff.base ? `${eff.base}  (mode=${eff.mode})` : `EMPTY (mode=${eff.mode})`;
  }
  // ===== [PATCH END] =====

  function joinUrl(base, path){
    base = normalizeBaseUrl(base);
    path = String(path || "").trim();

    // If path is absolute url, use it as-is
    if (/^https?:\/\//i.test(path)) return path;

    if (!path.startsWith("/")) path = "/" + path;
    return base + path;
  }

  function hex(bytes){
    return Array.from(bytes).map(b => b.toString(16).padStart(2,"0")).join("");
  }
  function randBytes(n){
    const b = new Uint8Array(n);
    crypto.getRandomValues(b);
    return b;
  }
  function genId(prefix){
    return (prefix || "id") + "-" + hex(randBytes(9));
  }
  function genTraceparent(){
    const traceId = hex(randBytes(16));
    const spanId  = hex(randBytes(8));
    return `00-${traceId}-${spanId}-01`;
  }

  function buildInjectedHeaders(method){
    const m = String(method || "").toUpperCase();
    const hdr = {
      "x-request-id": els.requestId.value.trim(),
      "traceparent": els.traceparent.value.trim(),
      "x-workflow-id": els.workflowId.value.trim(),
      "x-job-id": els.jobId.value.trim(),
      "accept": "application/json, text/plain, */*"
    };
    // Only add content-type for methods with body to reduce noise
    if (m !== "GET" && m !== "HEAD" && m !== "DELETE"){
      hdr["content-type"] = "application/json";
    }
    return hdr;
  }

  function renderTempoHints(){
    const wf = els.workflowId.value.trim();
    const job = els.jobId.value.trim();
    const req = els.requestId.value.trim();
    const tp = els.traceparent.value.trim();
    const traceId = (tp.split("-")[1] || "").trim();

    const lines = [
      `service.name="workflow-gateway"`,
      wf ? `workflow_id="${wf}" (若你把 workflow_id 写入 span attributes)` : `workflow_id="<workflow_id>"`,
      job ? `job_id="${job}" (同上)` : `job_id="<job_id>"`,
      req ? `x_request_id="${req}" (同上)` : `x_request_id="<x-request-id>"`,
      traceId ? `trace_id=${traceId}  (最稳：直接按 trace_id 查)` : `trace_id=<from traceparent>`,
      ``,
      `建议做法：先在网关发一次请求 → 从返回/日志里拿 trace_id → Tempo 里用 trace_id 直查 span 树。`
    ];
    els.tempoHints.textContent = lines.join("\n");

    const hdr = buildInjectedHeaders(els.method.value || "POST");
    // 预览中不强制显示空值
    els.injectHeadersPreview.textContent =
      Object.entries(hdr)
        .filter(([_,v]) => String(v || "").trim().length > 0)
        .map(([k,v]) => `${k}: ${v}`).join("\n");
  }

  function applyTemplate(str){
    const map = {
      "{{workflow_id}}": els.workflowId.value.trim(),
      "{{job_id}}": els.jobId.value.trim(),
      "{{x_request_id}}": els.requestId.value.trim(),
      "{{traceparent}}": els.traceparent.value.trim(),
    };
    let out = String(str || "");
    for (const [k,v] of Object.entries(map)){
      out = out.split(k).join(v || "");
    }
    return out;
  }

  async function safeReadText(resp){
    try { return await resp.text(); } catch(e){ return ""; }
  }

  function logLine(s){
    const now = new Date().toISOString();
    els.log.textContent = `[${now}] ${s}\n` + els.log.textContent;
  }

  function truncate(s, n){
    s = String(s || "");
    if (s.length <= n) return s;
    return s.slice(0, n) + " ...<truncated>";
  }

  async function apiCall({method, url, headers, bodyText}){
    const init = {
      method,
      headers: headers || {},
      mode: "cors",
      credentials: "omit",
    };
    if (method !== "GET" && method !== "HEAD" && bodyText != null){
      init.body = bodyText;
    }

    const t0 = performance.now();
    try{
      const resp = await fetch(url, init);
      const ms = Math.round(performance.now() - t0);
      const text = await safeReadText(resp);
      return { ok: resp.ok, status: resp.status, ms, text };
    }catch(err){
      const ms = Math.round(performance.now() - t0);
      return { ok: false, status: 0, ms, text: "", error: String(err && err.message ? err.message : err) };
    }
  }

  async function check(){
    const eff = resolveEffectiveBase();
    refreshEffectivePreview();

    const base = eff.base;
    if (!base){
      setStatus("bad", eff.mode === "proxy" ? "Missing Proxy Base" : "Missing Gateway URL");
      logLine(`Check aborted: effective base is empty (mode=${eff.mode})`);
      if (eff.mode === "proxy" && location.protocol === "file:"){
        logLine(`DIAG: file:// 打开时没有 origin，Proxy 模式必须手填 Proxy Base（例如 https://doc.mefans.workers.dev/wf）`);
      }
      return;
    }

    setStatus("warn", "Checking...");
    logLine(`Check started: mode=${eff.mode} base=${base}`);

    const readyUrl  = joinUrl(base, normalizePathInput(els.readyPath.value, "/readyz"));
    const healthUrl = joinUrl(base, normalizePathInput(els.healthPath.value, "/health"));

    logLine(`Effective URLs: ready=${readyUrl}  health=${healthUrl}`);

    // 尽量减少 preflight：不带自定义 header
    const r1 = await apiCall({ method:"GET", url: readyUrl, headers:{ "accept":"application/json, text/plain, */*" }, bodyText:null });
    logLine(`GET ${readyUrl} -> status=${r1.status || "fetch_error"} time=${r1.ms}ms ${r1.error ? " err=" + r1.error : ""}`);
    if (r1.status) logLine(`ready body: ${truncate(r1.text, 800)}`);

    const r2 = await apiCall({ method:"GET", url: healthUrl, headers:{ "accept":"application/json, text/plain, */*" }, bodyText:null });
    logLine(`GET ${healthUrl} -> status=${r2.status || "fetch_error"} time=${r2.ms}ms ${r2.error ? " err=" + r2.error : ""}`);
    if (r2.status) logLine(`health body: ${truncate(r2.text, 800)}`);

    if (r1.status === 0 || r2.status === 0){
      setStatus("bad", "Failed to fetch (likely CORS/network)");
      if (eff.mode === "proxy"){
        logLine("DIAG(proxy): 如果是 404，多数是当前域/Proxy Base 并没有实现 /wf/* 路由。");
      } else {
        logLine("DIAG(direct): 若地址栏访问 OK 但这里 Failed to fetch，几乎必然是 CORS 未允许本页面 Origin。");
      }
      return;
    }

    if (r1.status >= 200 && r1.status < 300 && r2.status >= 200 && r2.status < 300){
      setStatus("ok", `Ready + Health OK (${eff.mode})`);
      return;
    }
    setStatus("bad", `Check failed (ready=${r1.status}, health=${r2.status})`);
  }

  function stopPoll(){
    if (pollTimer){
      clearInterval(pollTimer);
      pollTimer = null;
      logLine("Polling stopped.");
    }
  }

  async function send(){
    stopPoll();

    const eff = resolveEffectiveBase();
    refreshEffectivePreview();

    const base = eff.base;
    if (!base){
      setReqState("bad", eff.mode === "proxy" ? "Missing Proxy Base" : "Missing base");
      logLine(`Send aborted: effective base is empty (mode=${eff.mode})`);
      return;
    }

    const method = (els.method.value || "POST").toUpperCase();
    const path = normalizePathInput(els.path.value, "/");
    const url = joinUrl(base, path);

    // Build headers with trace injection
    const hdr = buildInjectedHeaders(method);

    // Body templating
    let bodyText = null;
    if (method !== "GET" && method !== "HEAD"){
      const raw = applyTemplate(els.body.value);
      bodyText = raw;
      try { JSON.parse(raw); } catch(e){
        logLine("WARN: Body is not valid JSON; request will still be sent as text.");
      }
    }

    setReqState("warn", "Sending...");
    logLine(`SEND mode=${eff.mode} ${method} ${url}`);
    logLine(`headers:\n${Object.entries(hdr).filter(([_,v])=>String(v||"").trim()).map(([k,v])=>`${k}: ${v}`).join("\n")}`);
    if (bodyText) logLine(`body:\n${truncate(bodyText, 1200)}`);

    const r = await apiCall({ method, url, headers: hdr, bodyText });
    if (r.status === 0){
      setReqState("bad", "Failed to fetch (CORS/network)");
      logLine(`ERROR: fetch failed after ${r.ms}ms; err=${r.error || "unknown"}`);
      if (eff.mode === "proxy"){
        logLine("DIAG(proxy): 若你看到 404/Not Found，说明 Proxy Base 没有 /wf 或没有转发到目标 gateway。");
      } else {
        logLine("DIAG(direct): 若 URL 地址栏访问 OK 但这里失败，几乎必然是 CORS 未允许本页面 Origin。");
      }
      return;
    }

    setReqState(r.ok ? "ok" : "bad", `HTTP ${r.status} (${r.ms}ms)`);
    logLine(`RESP status=${r.status} time=${r.ms}ms`);
    logLine(`RESP body:\n${truncate(r.text, 3000)}`);

    // Optional polling
    const poll = String(els.pollPath.value || "").trim();
    if (poll){
      const interval = parseInt(els.pollInterval.value, 10);
      const ms = Number.isFinite(interval) && interval > 300 ? interval : 1500;

      const pollResolved = normalizePathInput(applyTemplate(poll), "/");
      const pollUrl = joinUrl(base, pollResolved);

      const includeHeaders = !!els.pollWithHeaders.checked;

      logLine(`Polling enabled: ${pollUrl} every ${ms}ms (withHeaders=${includeHeaders})`);
      pollTimer = setInterval(async () => {
        const pr = await apiCall({
          method:"GET",
          url: pollUrl,
          headers: includeHeaders ? buildInjectedHeaders("GET") : { "accept":"application/json, text/plain, */*" },
          bodyText: null
        });

        if (pr.status === 0){
          logLine(`POLL fetch blocked; err=${pr.error || "unknown"}`);
          return;
        }
        logLine(`POLL ${pollUrl} -> ${pr.status} ${truncate(pr.text, 600)}`);
      }, ms);
    }
  }

  async function copy(text){
    try{
      await navigator.clipboard.writeText(text);
      logLine("Copied to clipboard.");
    }catch(e){
      logLine("Clipboard copy failed (browser permissions).");
    }
  }

  function shellQuote(s){
    s = String(s || "");
    return "'" + s.replace(/'/g, `'\\''`) + "'";
  }

  function buildCurl(){
    const eff = resolveEffectiveBase();
    const base = eff.base;

    const method = (els.method.value || "POST").toUpperCase();
    const url = joinUrl(base, normalizePathInput(els.path.value, "/"));

    const hdr = buildInjectedHeaders(method);
    const headerArgs = Object.entries(hdr)
      .filter(([_,v]) => String(v || "").trim().length > 0)
      .map(([k,v]) => `-H ${shellQuote(`${k}: ${v}`)}`)
      .join(" ");

    let dataArg = "";
    if (method !== "GET" && method !== "HEAD"){
      const raw = applyTemplate(els.body.value);
      dataArg = `--data ${shellQuote(raw)}`;
    }

    const note = `# mode=${eff.mode}\n`;
    return (note + `curl -i -X ${method} ${headerArgs} ${dataArg} ${shellQuote(url)}`).replace(/\s+/g, " ").trim();
  }

  function loadSettings(){
    try{
      const raw = localStorage.getItem("wf_console_settings_v1");
      if (!raw) return;
      const s = JSON.parse(raw);

      // ===== [PATCH INSERT] load mode/proxy base (non-breaking) =====
      els.connMode.value = s.connMode || "direct";
      els.proxyBase.value = s.proxyBase || "";
      // ===== [PATCH END] =====

      els.gatewayBase.value = s.gatewayBase || "";
      els.readyPath.value = s.readyPath || "/readyz";
      els.healthPath.value = s.healthPath || "/health";
      els.grafanaBase.value = s.grafanaBase || "";
      els.method.value = s.method || "POST";
      els.path.value = s.path || "/api/trigger";
      els.body.value = s.body || els.body.value;
      els.pollPath.value = s.pollPath || "";
      els.pollInterval.value = s.pollInterval || "1500";
      // ===== [PATCH INSERT] poll headers default (non-breaking) =====
      els.pollWithHeaders.checked = !!s.pollWithHeaders;
      // ===== [PATCH END] =====
    }catch(e){}
  }

  function saveSettings(){
    const s = {
      // ===== [PATCH INSERT] persist mode/proxy base (non-breaking) =====
      connMode: els.connMode.value,
      proxyBase: els.proxyBase.value.trim(),
      pollWithHeaders: !!els.pollWithHeaders.checked,
      // ===== [PATCH END] =====

      gatewayBase: els.gatewayBase.value.trim(),
      readyPath: els.readyPath.value.trim(),
      healthPath: els.healthPath.value.trim(),
      grafanaBase: els.grafanaBase.value.trim(),
      method: els.method.value,
      path: els.path.value.trim(),
      body: els.body.value,
      pollPath: els.pollPath.value.trim(),
      pollInterval: els.pollInterval.value.trim(),
    };
    localStorage.setItem("wf_console_settings_v1", JSON.stringify(s));
    logLine("Settings saved.");
    refreshEffectivePreview();
  }

  function resetAll(){
    stopPoll();
    localStorage.removeItem("wf_console_settings_v1");

    // ===== [PATCH INSERT] reset defaults (non-breaking) =====
    els.connMode.value = "direct";
    els.proxyBase.value = "";
    els.pollWithHeaders.checked = false;
    // ===== [PATCH END] =====

    els.gatewayBase.value = "";
    els.readyPath.value = "/readyz";
    els.healthPath.value = "/health";
    els.grafanaBase.value = "";
    els.method.value = "POST";
    els.path.value = "/api/trigger";
    els.body.value = `{
  "workflow_id": "{{workflow_id}}",
  "job_id": "{{job_id}}",
  "note": "console demo request"
}`;
    els.pollPath.value = "";
    els.pollInterval.value = "1500";
    els.log.textContent = "";
    setStatus("warn", "Not checked");
    setReqState("warn", "Idle");
    genIds();
    refreshEffectivePreview();
    logLine("Reset done.");
  }

  function genIds(){
    const wf = genId("wf");
    els.workflowId.value = wf;
    els.jobId.value = wf;
    els.requestId.value = genId("req");
    els.traceparent.value = genTraceparent();
    renderTempoHints();
  }

  function openGrafana(){
    const u = normalizeBaseUrl(els.grafanaBase.value);
    if (!u){
      logLine("Grafana URL not set.");
      return;
    }
    window.open(u, "_blank", "noopener");
  }

  // Events
  els.btnCheck.addEventListener("click", check);
  els.btnSave.addEventListener("click", () => { saveSettings(); });
  els.btnReset.addEventListener("click", resetAll);
  els.btnOpenGrafana.addEventListener("click", openGrafana);

  els.btnGenIds.addEventListener("click", genIds);
  els.btnCopyHeaders.addEventListener("click", () => {
    const hdr = buildInjectedHeaders(els.method.value || "POST");
    copy(Object.entries(hdr).filter(([_,v])=>String(v||"").trim()).map(([k,v]) => `${k}: ${v}`).join("\n"));
  });
  els.btnCopyTempoHints.addEventListener("click", () => copy(els.tempoHints.textContent));

  els.btnSend.addEventListener("click", send);
  els.btnStopPoll.addEventListener("click", stopPoll);
  els.btnCopyCurl.addEventListener("click", () => copy(buildCurl()));

  // Live updates
  ["workflowId","jobId","requestId","traceparent"].forEach(id=>{
    $(id).addEventListener("input", renderTempoHints);
  });

  // ===== [PATCH INSERT] live preview refresh (non-breaking) =====
  ["connMode","proxyBase","gatewayBase","readyPath","healthPath"].forEach(id=>{
    $(id).addEventListener("input", refreshEffectivePreview);
    $(id).addEventListener("change", refreshEffectivePreview);
  });
  // ===== [PATCH END] =====

  // Boot
  loadSettings();

  // ===== [PATCH INSERT] default gateway base if empty (non-breaking) =====
  if (!String(els.gatewayBase.value || "").trim()) {
    els.gatewayBase.value = "https://workflow-gateway-233489274446.us-central1.run.app";
  }
  // ===== [PATCH END] =====

  genIds();
  setReqState("warn", "Idle");
  refreshEffectivePreview();
})();
</script>
</body>
</html>
