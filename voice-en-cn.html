<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>双模式语音助手</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI',sans-serif;
      background:#f0f2f5; color:#333;
      min-height:100vh;
      display:flex; justify-content:center; align-items:center;
      padding:1rem;
    }
    #main {
      width:100%;max-width:500px;
      background:#fff;border-radius:12px;
      padding:1.5rem;box-shadow:0 8px 24px rgba(0,0,0,0.1);
      position:relative; z-index:1;
    }
    h1 { font-size:1.25rem; margin-bottom:1rem; }
    .mode-switch { display:flex;gap:1rem;margin-bottom:1rem; }
    .mode-switch label { cursor:pointer; user-select:none; }
    .mode-switch input { margin-right:.3rem; }

    /* 录音按钮 */
    #recBtn {
      width:100%;padding:.75rem;font-size:1rem;
      background:#3b82f6;color:#fff;border:none;
      border-radius:6px;cursor:pointer;transition:background .2s;
      margin-bottom:1rem;
    }
    #recBtn.recording { background:#dc2626; }
    #recBtn:disabled { background:#aac4f7; cursor:not-allowed; }

    #chat {
      height:240px;overflow-y:auto;
      border:1px solid #ddd;border-radius:6px;
      padding:.5rem;background:#fafafa;
    }
    .msg { margin-bottom:.5rem; }
    .msg.user { color:#1f2937; }
    .msg.bot  { color:#374151; }

    /* 授权弹窗：透明遮罩可见主界面 */
    #authModal {
      position:fixed;inset:0;
      display:flex;justify-content:center;align-items:center;
      background:rgba(0,0,0,0);
      z-index:1000;
    }
    #authModal .box {
      background:rgba(255,255,255,0.95);
      border-radius:12px;padding:24px 32px;
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
      text-align:center;min-width:320px;
    }
    #authModal h2 {font-size:1.5rem;margin-bottom:1rem;}
    #authModal input {
      width:100%;padding:.75rem;font-size:1rem;
      border:1px solid #ccc;border-radius:6px;
      margin-bottom:1rem;
    }
    #authModal button {
      width:100%;padding:.75rem;font-size:1rem;
      border:none;border-radius:6px;
      background:#3b82f6;color:#fff;cursor:pointer;
      transition:background .2s;
    }
    #authModal button:disabled {
      background:#8fbefc;cursor:not-allowed;
    }
    #authErr {
      color:#d9534f;margin-top:.5rem;font-size:.9rem;
      display:none;
    }
  </style>
</head>
<body>
  <div id="main">
    <h1>语音助手</h1>
    <div class="mode-switch">
      <label><input type="radio" name="mode" value="chat" checked/> 对话模式</label>
      <label><input type="radio" name="mode" value="trans"/> 同传模式</label>
    </div>
    <button id="recBtn" disabled>🎤 按住说话</button>
    <div id="chat"></div>
  </div>

  <div id="authModal">
    <div class="box">
      <h2>请输入授权码</h2>
      <input id="authInput" type="password" placeholder="授权码"/>
      <button id="authBtn" disabled>确认</button>
      <div id="authErr"></div>
    </div>
  </div>

  <script>
// 在页面最上方插入 DEBUG 标记
    document.body.insertAdjacentHTML('afterbegin',
      '<div style="position:fixed;top:0;left:0;background:red;color:white;padding:4px;font-size:12px;z-index:9999;">[DEBUG BUILD]</div>'
    );
    console.log('--- DEBUG BUILD LOADED ---');

    (function(){
      const BASE    = 'https://translate-assistant.mefans.workers.dev';
      const AUTH    = BASE + '/admin-api/validate-code';
      const WS_BASE = BASE.replace(/^http/,'ws') + '/admin-api/ws';

      const authModal = document.getElementById('authModal');
      const authInput = document.getElementById('authInput');
      const authBtn   = document.getElementById('authBtn');
      const authErr   = document.getElementById('authErr');
      const recBtn    = document.getElementById('recBtn');
      const chatEl    = document.getElementById('chat');
      const modes     = document.getElementsByName('mode');

      let socket, recorder;
      let sessionId, authCode;

      window.addEventListener('DOMContentLoaded', () => recBtn.disabled = true);

      // —————— 授权流程 ——————
      authInput.addEventListener('input', () => {
        authBtn.disabled = !authInput.value.trim();
        authErr.style.display = 'none';
      });
      authBtn.addEventListener('click', async () => {
        authBtn.disabled = true;
        try {
          const r = await fetch(AUTH, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ code: authInput.value.trim() })
          });
          const j = await r.json();
          if (r.ok && j.ok) {
            sessionId = crypto.randomUUID();
            authCode  = authInput.value.trim();
            authModal.style.display = 'none';
            recBtn.disabled = false;
            initSession();
          } else {
            throw new Error(j.error || '授权失败');
          }
        } catch(e) {
          authErr.textContent = e.message || '网络错误';
          authErr.style.display = '';
        } finally {
          authBtn.disabled = false;
        }
      });

      // —————— WS + 录音逻辑 ——————
      function initSession(){
        chatEl.innerHTML = '';
        if (socket) socket.close();

        const mode = [...modes].find(r=>r.checked).value;
        const url  = `${WS_BASE}?mode=${mode}&session=${sessionId}&auth=${authCode}`;
        console.log('Attempting WS connect to:', url);
        socket = new WebSocket(url);
        socket.binaryType = 'arraybuffer';

        socket.onopen  = () => {
          console.log('WS readyState onopen:', socket.readyState);
          append('bot','🤖 [已连接]');
        };
        socket.onerror = e => {
          console.error('WS.onerror:', e);
          append('bot','🤖 [服务异常]');
        };
        socket.onclose = e => {
          console.log('WS.onclose, code:', e.code, 'reason:', e.reason);
          append('bot','🤖 [已断开]');
        };

        socket.onmessage = async evt => {
          console.log('WS 收到 raw evt:', evt);
          if (typeof evt.data === 'string') {
            const msg = JSON.parse(evt.data);
            if (msg.who === '_meta') {
              console.log('收到文本/_meta：', msg);
            } else {
              console.log('收到文本消息：', msg);
              append(msg.who, msg.text);
            }
          }
          else if (evt.data instanceof ArrayBuffer) {
            console.log('  音频帧长度(bytes):', evt.data.byteLength);
            const blob = new Blob([evt.data], { type: 'audio/webm; codecs=opus' });
            const audioURL = URL.createObjectURL(blob);
            const audio = new Audio(audioURL);
            audio.onerror   = e => console.error('  audio.onerror', e);
            audio.play()
                 .then(()=> console.log('  play() success'))
                 .catch(err=> console.error('  play() failed:', err));
          }
        };

        [...modes].forEach(r=>r.onchange = initSession);

        // ———— 核心改动：一次性录完整段再发 ————
        let chunks = [];
        const startRec = async () => {
          recBtn.classList.add('recording');
          recBtn.textContent = '🛑 录音中...';
          try {
            const s = await navigator.mediaDevices.getUserMedia({audio:true});
            recorder = new MediaRecorder(s);
            chunks = [];
            recorder.ondataavailable = e => chunks.push(e.data);
            recorder.onstop = () => {
              const blob = new Blob(chunks, { type:'audio/webm' });
              if (socket.readyState === 1) socket.send(blob);
            };
            recorder.start();  // 直到 stop 时才结束
            append('user','👤 [开始录音]');
          } catch {
            alert('请允许麦克风');
          }
        };
        const stopRec = () => {
          recBtn.classList.remove('recording');
          recBtn.textContent = '🎤 按住说话';
          if (recorder && recorder.state !== 'inactive') {
            recorder.stop();
            append('user','👤 [结束录音]');
          }
        };
        recBtn.addEventListener('pointerdown', startRec);
        recBtn.addEventListener('pointerup',   stopRec);
        recBtn.addEventListener('touchstart',  startRec);
        recBtn.addEventListener('touchend',    stopRec);
      }

      // —————— 在对话框里追加一条记录 ——————
      function append(who, txt){
        const d = document.createElement('div');
        d.className = 'msg ' + who;
        d.textContent = txt;
        chatEl.appendChild(d);
        chatEl.scrollTop = chatEl.scrollHeight;
      }
    })();
  </script>
</body>
</html>
