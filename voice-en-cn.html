<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>双模式语音助手</title>
  <style>
    body {font-family:sans-serif;background:#f0f2f5;margin:0;padding:1rem;}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.3);display:flex;
           align-items:center;justify-content:center;z-index:100;}
    .modal-box{background:#fff;padding:2rem;border-radius:8px;max-width:400px;width:100%;}
    button,select{padding:0.5rem 1rem;margin:0.5rem 0;}
    #main{display:none;max-width:500px;margin:auto;background:#fff;
          padding:1rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    #chat{height:200px;overflow:auto;border:1px solid #ddd;padding:0.5rem;}
  </style>
</head>
<body>
  <!-- 授权登录弹窗（保持不变） -->
  <div class="modal" id="authModal">
    <div class="modal-box">
      <h2>请输入授权码</h2>
      <input type="password" id="authInput" placeholder="授权码" style="width:100%;"/>
      <button id="authBtn" disabled>确认</button>
      <p id="authErr" style="color:red;display:none;"></p>
    </div>
  </div>

  <!-- 主界面 -->
  <div id="main">
    <h1>语音助手</h1>
    <!-- 模式切换 -->
    <label>
      模式：
      <select id="modeSelect">
        <option value="chat">对话模式</option>
        <option value="trans">同传模式</option>
      </select>
    </label>
    <!-- 长按录音按钮 -->
    <button id="recBtn">🎤 按住说话</button>
    <div id="chat"></div>
  </div>

  <script>
  (async()=>{
    const AUTH_API   = 'https://translate-assistant.mefans.workers.dev/admin-api/validate-code';
    const START_API  = 'https://translate-assistant.mefans.workers.dev/admin-api/start-session';
    const WS_ENDPOINT= 'wss://translate-assistant.mefans.workers.dev/admin-api/ws';

    // 元素
    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modeSel   = document.getElementById('modeSelect');

    let sessionId, ws, recorder;

    // —— 授权流程（不变） ——
    authInput.addEventListener('input',_=> authBtn.disabled=!authInput.value.trim());
    authBtn.onclick = async () => {
      authBtn.disabled = true;
      try {
        let r = await fetch(AUTH_API,
          {method:'POST',headers:{'Content-Type':'application/json'},
           body:JSON.stringify({code:authInput.value.trim()})});
        let j = await r.json();
        if(r.ok && j.ok){
          authModal.style.display='none';
          main.style.display='';
          init();
        } else {
          authErr.textContent='授权失败'; authErr.style.display='';
        }
      } catch {
        authErr.textContent='网络错误'; authErr.style.display='';
      } finally { authBtn.disabled=false; }
    };

    // —— 初始化会话 & WS & 录音 ——  
    async function init(){
      // 1) 开启新会话
      let mode = modeSel.value;
      let r = await fetch(START_API,{method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({mode})});
      sessionId = (await r.json()).session_id;

      // 2) WebSocket
      ws = new WebSocket(`${WS_ENDPOINT}?session_id=${sessionId}&mode=${mode}`);
      ws.binaryType = 'arraybuffer';
      ws.onmessage = async evt => {
        // 收到二进制音频直接播放
        const blob = new Blob([evt.data],{type:'audio/webm'});
        const url  = URL.createObjectURL(blob);
        new Audio(url).play();
        // 也可显示文本（若另传文本字段）
      };

      // 3) 录音
      recBtn.addEventListener('pointerdown', async ()=>{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = e => ws.send(e.data);
        recorder.start();
      });
      recBtn.addEventListener('pointerup', ()=>{
        if(recorder && recorder.state!=='inactive') recorder.stop();
      });

      // 4) 切换模式后重启
      modeSel.onchange = ()=>{
        ws.close();
        init();
      };
    }
  })();
  </script>
</body>
</html>
