<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>双模式语音助手</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:'Segoe UI',sans-serif;
      background:#f0f2f5; color:#333;
      min-height:100vh;
      display:flex; justify-content:center; align-items:center;
      padding:1rem;
    }
    #main {
      width:100%;max-width:500px;
      background:#fff;border-radius:12px;
      padding:1.5rem;box-shadow:0 8px 24px rgba(0,0,0,0.1);
      position:relative; z-index:1;
    }
    h1 { font-size:1.25rem; margin-bottom:1rem; }
    .mode-switch { display:flex;gap:1rem;margin-bottom:1rem; }
    .mode-switch label { cursor:pointer; user-select:none; }
    .mode-switch input { margin-right:.3rem; }

    /* 录音按钮 */
    #recBtn {
      width:100%;padding:.75rem;font-size:1rem;
      background:#3b82f6;color:#fff;border:none;
      border-radius:6px;cursor:pointer;transition:background .2s;
      margin-bottom:1rem;
    }
    #recBtn.recording { background:#dc2626; }
    #recBtn:disabled { background:#aac4f7; cursor:not-allowed; }

    #chat {
      height:240px;overflow-y:auto;
      border:1px solid #ddd;border-radius:6px;
      padding:.5rem;background:#fafafa;
    }
    .msg { margin-bottom:.5rem; }
    .msg.user { color:#1f2937; }
    .msg.bot  { color:#374151; }

    /* 授权弹窗：透明遮罩可见主界面 */
    #authModal {
      position:fixed;inset:0;
      display:flex;justify-content:center;align-items:center;
      background:rgba(0,0,0,0); /* 不遮盖背景 */ 
      z-index:1000;
    }
    #authModal .box {
      background:rgba(255,255,255,0.95);
      border-radius:12px;padding:24px 32px;
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
      text-align:center;min-width:320px;
    }
    #authModal h2 {font-size:1.5rem;margin-bottom:1rem;}
    #authModal input {
      width:100%;padding:.75rem;font-size:1rem;
      border:1px solid #ccc;border-radius:6px;
      margin-bottom:1rem;
    }
    #authModal button {
      width:100%;padding:.75rem;font-size:1rem;
      border:none;border-radius:6px;
      background:#3b82f6;color:#fff;cursor:pointer;
      transition:background .2s;
    }
    #authModal button:disabled {
      background:#8fbefc;cursor:not-allowed;
    }
    #authErr {
      color:#d9534f;margin-top:.5rem;font-size:.9rem;
      display:none;
    }
  </style>
</head>
<body>
  <div id="main">
    <h1>语音助手</h1>
    <div class="mode-switch">
      <label><input type="radio" name="mode" value="chat" checked/> 对话模式</label>
      <label><input type="radio" name="mode" value="trans"/> 同传模式</label>
    </div>
    <button id="recBtn" disabled>🎤 按住说话</button>
    <div id="chat"></div>
  </div>

  <div id="authModal">
    <div class="box">
      <h2>请输入授权码</h2>
      <input id="authInput" type="password" placeholder="授权码"/>
      <button id="authBtn" disabled>确认</button>
      <div id="authErr"></div>
    </div>
  </div>

  <script>
  (function(){
    const BASE   = 'https://translate-assistant.mefans.workers.dev';
    const AUTH   = BASE + '/admin-api/validate-code';
    const WS_BASE= BASE.replace(/^http/,'ws') + '/admin-api/ws';

    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modes     = document.getElementsByName('mode');

    let socket, recorder;

    // 授权
    authInput.addEventListener('input', ()=> {
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });
    authBtn.addEventListener('click', async ()=>{
      authBtn.disabled = true;
      try {
        let r = await fetch(AUTH, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({code:authInput.value.trim()})
        });
        let j = await r.json();
        if(r.ok && j.ok) {
          authModal.style.display = 'none';
          recBtn.disabled = false;
          initSession();
        } else {
          throw new Error('授权失败');
        }
      } catch(e) {
        authErr.textContent = e.message||'网络错误';
        authErr.style.display = '';
      } finally {
        authBtn.disabled = false;
      }
    });

    // 建立会话 & WS & 录音
    function initSession(){
      chatEl.innerHTML = '';
      if(socket) socket.close();

      const mode = [...modes].find(r=>r.checked).value;
      socket = new WebSocket(WS_BASE + '?mode=' + mode);
      socket.binaryType = 'arraybuffer';

      socket.onopen    = ()=> append('bot','🤖 [已连接]');
      socket.onerror   = ()=> append('bot','🤖 [服务异常]');
      socket.onclose   = ()=> append('bot','🤖 [已断开]');
      socket.onmessage = async evt => {
        if(mode==='chat' && typeof evt.data==='string'){
          let {user,bot} = JSON.parse(evt.data);
          user && append('user', user);
          if(bot){
            // 内置 TTS
            await speak(bot);
            append('bot', bot);
          }
        }
        else if(mode==='trans' && evt.data instanceof ArrayBuffer){
          await play(new Blob([evt.data],{type:'audio/webm'}));
        }
      };

      // 切换模式
      [...modes].forEach(r=>r.onchange = initSession);

      // 录音手势——兼容 pointer+touch
      const startRec = async ()=>{
        recBtn.classList.add('recording');
        recBtn.textContent = '🛑 录音中...';
        try {
          const s = await navigator.mediaDevices.getUserMedia({audio:true});
          recorder = new MediaRecorder(s);
          recorder.ondataavailable = e=>{
            if(socket.readyState===1) socket.send(e.data);
          };
          recorder.start(250);
          append('user','👤 [开始录音]');
        } catch {
          alert('请允许麦克风');
        }
      };
      const stopRec = ()=>{
        recBtn.classList.remove('recording');
        recBtn.textContent = '🎤 按住说话';
        if(recorder && recorder.state!=='inactive'){
          recorder.stop();
          append('user','👤 [结束录音]');
        }
      };
      recBtn.addEventListener('pointerdown', startRec);
      recBtn.addEventListener('pointerup',   stopRec);
      recBtn.addEventListener('touchstart',  startRec);
      recBtn.addEventListener('touchend',    stopRec);
    }

    // 显示文字
    function append(who,txt){
      const d = document.createElement('div');
      d.className = 'msg ' + who;
      d.textContent = txt;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // 浏览器内置 TTS
    function speak(text){
      return new Promise(res=>{
        const u = new SpeechSynthesisUtterance(text);
        u.onend = ()=> res();
        speechSynthesis.speak(u);
      });
    }
    // 播放二进制
    function play(blob){
      return new Promise(res=>{
        const url = URL.createObjectURL(blob);
        const a   = new Audio(url);
        a.onended = ()=> { URL.revokeObjectURL(url); res(); };
        a.play();
      });
    }

    // 初始锁定录音
    window.addEventListener('DOMContentLoaded', ()=>{
      recBtn.disabled = true;
    });
  })();
  </script>
</body>
</html>
