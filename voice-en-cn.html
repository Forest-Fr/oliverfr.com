<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    /* ---------- å…¨å±€ ---------- */
    * { box-sizing: border-box; margin:0; padding:0; }
    body {
      font-family: 'Segoe UI','Helvetica Neue',Arial,sans-serif;
      background: #f0f2f5;
      color: #333;
      min-height: 100vh;
      overflow: auto;
    }

    /* ---------- æˆæƒå¼¹çª— ---------- */
    #authModal {
      position: fixed;
      inset: 0;
      background: rgba(255,255,255,0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    #authModal .modal-box {
      width: 90%;
      max-width: 400px;
      background: #fff;
      border-radius: 12px;
      padding: 2rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    #authModal h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    #authModal input {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    #authModal button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background .2s;
    }
    #authModal button:disabled {
      background: #8fbefc;
      cursor: not-allowed;
    }
    #authModal button:not(:disabled):hover {
      background: #2563eb;
    }
    #authErr {
      color: #d9534f;
      font-size: 0.9rem;
      margin-top: 0.5rem;
      display: none;
    }

    /* ---------- ä¸»ç•Œé¢ ---------- */
    #main {
      display: none;
      max-width: 500px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
    }
    #main h1 {
      text-align: center;
      margin-bottom: 1rem;
      font-size: 1.5rem;
    }

    /* ä¸‹æ‹‰ + æ ‡ç­¾ æ ·å¼ */
    .field {
      display: flex;
      align-items: center;
      margin-bottom: 1rem;
    }
    .field label {
      flex: 0 0 4rem;
      font-size: 1rem;
    }
    .field select {
      flex: 1;
      padding: 0.5rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      background: #fff url("data:image/svg+xml;charset=US-ASCII,%3Csvg width='10' height='6' viewBox='0 0 10 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M0 0l5 6 5-6' fill='%23999'/%3E%3C/svg%3E") no-repeat right 0.75rem center;
      background-size: 10px 6px;
      -webkit-appearance: none;
      appearance: none;
    }

    /* å½•éŸ³æŒ‰é’® */
    #recBtn {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      user-select: none;
      margin-bottom: 1rem;
      transition: background .2s;
    }
    #recBtn:active {
      background: #2563eb;
    }

    /* èŠå¤©è¾“å‡ºåŒº */
    #chat {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.75rem;
      background: #fafafa;
      font-size: 0.95rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    #chat::-webkit-scrollbar { width:4px; }
    #chat::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,0.1);
      border-radius: 2px;
    }
  </style>
</head>
<body>
  <!-- æˆæƒå¼¹çª— -->
  <div id="authModal">
    <div class="modal-box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input type="password" id="authInput" placeholder="æˆæƒç "/>
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <div id="authErr"></div>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>

    <!-- æ¨¡å¼é€‰æ‹© -->
    <div class="field">
      <label for="modeSelect">æ¨¡å¼ï¼š</label>
      <select id="modeSelect">
        <option value="chat">å¯¹è¯æ¨¡å¼</option>
        <option value="trans">åŒä¼ æ¨¡å¼</option>
      </select>
    </div>

    <!-- é•¿æŒ‰å½•éŸ³ -->
    <button id="recBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>

    <!-- è¾“å‡ºåŒº -->
    <div id="chat"></div>
  </div>

  <script>
  (function(){
    const AUTH_API    = 'https://translate-assistant.mefans.workers.dev/admin-api/validate-code';
    const START_API   = 'https://translate-assistant.mefans.workers.dev/admin-api/start-session';
    const WS_ENDPOINT = 'wss://translate-assistant.mefans.workers.dev/admin-api/ws';

    // å…ƒç´ 
    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const modeSel   = document.getElementById('modeSelect');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');

    let sessionId, ws, recorder;

    // â€”â€” æˆæƒæµç¨‹ â€”â€”  
    authInput.addEventListener('input', () => {
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });

    authBtn.addEventListener('click', async () => {
      authBtn.disabled = true;
      try {
        const resp = await fetch(AUTH_API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ code: authInput.value.trim() })
        });
        const j = await resp.json();
        if (resp.ok && j.ok) {
          authModal.style.display = 'none';
          main.style.display      = 'block';
          startSession();
        } else {
          authErr.textContent = 'æˆæƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æˆæƒç ';
          authErr.style.display = '';
        }
      } catch {
        authErr.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        authErr.style.display = '';
      } finally {
        authBtn.disabled = false;
      }
    });

    // â€”â€” ä¼šè¯ã€WSã€å½•éŸ³ åˆå§‹åŒ– â€”â€”  
    async function startSession(){
      // æ¸…ç©ºä»¥å‰è¾“å‡º
      chatEl.textContent = '';

      // 1) å¼€ä¼šè¯
      const mode = modeSel.value;
      const r1 = await fetch(START_API, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ mode })
      });
      const d1 = await r1.json();
      sessionId = d1.session_id;

      // 2) å¼€ WS
      if (ws) ws.close();
      ws = new WebSocket(`${WS_ENDPOINT}?session_id=${sessionId}&mode=${mode}`);
      ws.binaryType = 'arraybuffer';
      ws.onmessage = evt => {
        if (evt.data instanceof ArrayBuffer) {
          // æ’­æ”¾éŸ³é¢‘
          const blob = new Blob([evt.data],{type:'audio/webm'});
          new Audio(URL.createObjectURL(blob)).play();
        } else {
          // å¦‚æœåç«¯å‘æ–‡æœ¬å­—æ®µï¼Œå¯æ˜¾ç¤º
          try {
            const msg = JSON.parse(evt.data);
            if (msg.text) {
              chatEl.textContent += msg.text + '\n';
              chatEl.scrollTop = chatEl.scrollHeight;
            }
          } catch {}
        }
      };
      ws.onopen  = ()=>console.log('WS open');
      ws.onclose = ()=>console.log('WS close');
      ws.onerror = e=>console.error(e);

      // 3) å½•éŸ³åˆå§‹åŒ–
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = e => {
          if (ws.readyState===WebSocket.OPEN && e.data.size>0) {
            ws.send(e.data);
          }
        };
      } catch {
        alert('æ— æ³•è·å–éº¦å…‹é£æƒé™');
      }

      // 4) æŒ‰ä½å½•éŸ³
      recBtn.onpointerdown = ()=>{ if (recorder && recorder.state==='inactive') recorder.start(); };
      recBtn.onpointerup   = ()=>{ if (recorder && recorder.state==='recording') recorder.stop(); };

      // 5) åˆ‡æ¢æ¨¡å¼ => é‡å¯
      modeSel.onchange = startSession;
    }
  })();
  </script>
</body>
</html>
