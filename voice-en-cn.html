<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body {
      font-family:'Segoe UI',Arial,sans-serif;
      background:#f0f2f5;
      display:flex;justify-content:center;align-items:center;
      height:100vh;padding:1rem;
    }
    /* æˆæƒå¼¹çª— */
    #authModal {
      position:fixed;inset:0;
      background:rgba(255,255,255,0.25);
      backdrop-filter:blur(4px);
      display:flex;align-items:center;justify-content:center;
      z-index:100;
    }
    #authModal .box {
      background:#fff;border-radius:12px;
      padding:2rem;max-width:400px;width:90%;
      text-align:center;box-shadow:0 8px 24px rgba(0,0,0,0.15);
    }
    #authModal input{
      width:100%;padding:.75rem;font-size:1rem;
      border:1px solid #ccc;border-radius:6px;
      margin-bottom:1rem;
    }
    #authBtn {
      width:100%;padding:.75rem;font-size:1rem;
      background:#3b82f6;color:#fff;border:none;
      border-radius:6px;cursor:pointer;transition:background .2s;
    }
    #authBtn:disabled { background:#8fbefc;cursor:not-allowed }
    #authBtn:not(:disabled):hover { background:#2563eb }
    #authErr {
      color:#d9534f;font-size:.9rem;margin-top:.5rem;
      display:none;
    }
    /* ä¸»ç•Œé¢ */
    #main {
      display:none;
      background:#fff;border-radius:12px;
      padding:1.5rem;
      box-shadow:0 8px 24px rgba(0,0,0,0.1);
      width:100%;max-width:500px;
      position:relative;z-index:1;
    }
    h1{font-size:1.25rem;margin-bottom:1rem}
    .mode-switch{display:flex;gap:1rem;margin-bottom:1rem;font-size:.95rem}
    .mode-switch label{cursor:pointer;user-select:none}
    .mode-switch input{margin-right:.25rem}
    #recBtn{
      width:100%;padding:.75rem;font-size:1rem;
      background:#3b82f6;color:#fff;border:none;
      border-radius:6px;cursor:pointer;transition:background .2s;
      margin-bottom:1rem;
    }
    #recBtn:active{background:#2563eb}
    #chat{
      height:250px;overflow-y:auto;
      background:#fafafa;border:1px solid #ddd;
      border-radius:6px;padding:.5rem;
    }
    .msg{margin-bottom:.5rem}
    .msg.user{color:#1f2937}
    .msg.bot{color:#374151}
  </style>
</head>
<body>

  <!-- æˆæƒ -->
  <div id="authModal">
    <div class="box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input type="password" id="authInput" placeholder="demo-key"/>
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <div id="authErr"></div>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>

    <div class="mode-switch">
      <label><input type="radio" name="mode" value="chat" checked/>å¯¹è¯æ¨¡å¼</label>
      <label><input type="radio" name="mode" value="trans"/>åŒä¼ æ¨¡å¼</label>
    </div>

    <button id="recBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>
    <div id="chat"></div>
  </div>

  <script>
  (()=>{
    const BASE     = 'https://translate-assistant.mefans.workers.dev';
    const AUTH_API = BASE + '/admin-api/validate-code';
    const WS_URL   = BASE.replace(/^http/,'ws') + '/admin-api/ws';

    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modes     = Array.from(document.getElementsByName('mode'));

    let socket, recorder;

    // â€”â€” æˆæƒ â€”â€” 
    authInput.addEventListener('input',()=>{
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });
    authBtn.addEventListener('click',async()=>{
      authBtn.disabled = true;
      try {
        const r = await fetch(AUTH_API,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({code:authInput.value.trim()})
        });
        const j = await r.json();
        if (r.ok && j.ok) {
          authModal.style.display='none';
          main.style.display='block';
          startSession();
        } else {
          throw new Error('æˆæƒå¤±è´¥');
        }
      } catch(err) {
        authErr.textContent = err.message||'ç½‘ç»œé”™è¯¯';
        authErr.style.display='block';
      } finally {
        authBtn.disabled = false;
      }
    });

    // â€”â€” å½•éŸ³äº‹ä»¶ åªç»‘å®šä¸€æ¬¡ â€”â€” 
    recBtn.addEventListener('pointerdown',startRec);
    recBtn.addEventListener('pointerup',  stopRec);
    // iOS ä¸å…¨æ”¯æŒ pointerdown/upï¼Œå¯åŠ ï¼š
    recBtn.addEventListener('touchstart',startRec);
    recBtn.addEventListener('touchend',  stopRec);

    function startRec(){
      if (!socket || socket.readyState!==1) {
        appendMsg('bot','[å°šæœªè¿æ¥]');
        return;
      }
      navigator.mediaDevices.getUserMedia({audio:true})
        .then(stream=>{
          recorder = new MediaRecorder(stream);
          recorder.ondataavailable = e=>{
            if (socket.readyState===1) socket.send(e.data);
          };
          recorder.start(250);
          appendMsg('bot','[å½•éŸ³ä¸­â€¦]');
        })
        .catch(_=>{
          alert('è¯·å…è®¸éº¦å…‹é£æƒé™');
        });
    }

    function stopRec(){
      if (recorder && recorder.state!=='inactive') {
        recorder.stop();
        appendMsg('bot','[å‘é€éŸ³é¢‘ç‰‡æ®µ]');
      }
    }

    // â€”â€” WS ä¼šè¯ â€”â€” 
    function startSession(){
      chatEl.innerHTML='';
      const mode = modes.find(r=>r.checked).value;
      // å…³æ‰æ—§çš„
      if (socket) socket.close();

      socket = new WebSocket(WS_URL+'?mode='+mode);
      socket.binaryType='arraybuffer';
      socket.onopen    = ()=> appendMsg('bot','[å·²è¿æ¥]');
      socket.onclose   = ()=> appendMsg('bot','[å·²æ–­å¼€]');
      socket.onerror   = ()=> appendMsg('bot','[ç½‘ç»œ/æœåŠ¡å™¨é”™è¯¯]');
      socket.onmessage = evt=>{
        if (typeof evt.data==='string') {
          const m = JSON.parse(evt.data);
          appendMsg(m.who, m.text);
        } else {
          // æ”¶åˆ°äºŒè¿›åˆ¶éŸ³é¢‘ï¼ˆæš‚æ—¶æ— ç”¨ï¼ŒTTS å·²å»æ‰ï¼‰
        }
      };
      // æ¨¡å¼åˆ‡æ¢é‡è¿
      modes.forEach(r=>r.onchange = startSession);
    }

    function appendMsg(who,txt){
      const d = document.createElement('div');
      d.className='msg '+who;
      d.textContent = (who==='user'?'ğŸ‘¤ ':'ğŸ¤– ')+txt;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    window.addEventListener('DOMContentLoaded',()=>{
      main.style.display='none';
      authModal.style.display='flex';
    });
  })();
  </script>
</body>
</html>
