<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    /* â€”â€” 0. å…¨å±€é‡ç½® & å¸ƒå±€ â€”â€” */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI','Helvetica Neue',Arial,sans-serif;
      background:#f0f2f5;
      color:#333;
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:1rem;
    }

    /* â€”â€” 1. æˆæƒå¼¹çª— â€”â€” */
    #authModal {
      position:fixed;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      /* **èƒŒæ™¯å…¨é€æ˜**ï¼Œä¸åšæ¨¡ç³Š */
      background:transparent;
      backdrop-filter:none;
      -webkit-backdrop-filter:none;
      z-index: 1000;
    }
    #authModal .box {
      width:90%; max-width:400px;
      background: rgba(255,255,255,0.95); /* ç¨å¾®åŠé€æ˜ï¼Œçªå‡ºå¼¹çª— */
      border-radius:12px;
      padding:24px 32px;
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
      text-align:center;
    }
    #authModal h2 {
      font-size:1.5rem;
      margin-bottom:1rem;
    }
    #authModal input {
      width:100%;
      padding:.75rem;
      font-size:1rem;
      border:1px solid #ccc;
      border-radius:6px;
      margin-bottom:1rem;
    }
    #authModal button {
      width:100%;
      padding:.75rem;
      font-size:1rem;
      border:none;
      border-radius:6px;
      background:#3b82f6;
      color:#fff;
      cursor:pointer;
      transition:background .2s;
    }
    #authModal button:disabled {
      background:#8fbefc;
      cursor:not-allowed;
    }
    #authModal button:not(:disabled):hover {
      background:#2563eb;
    }
    #authErr {
      display:none;
      color:#d9534f;
      margin-top:.5rem;
      font-size:.9rem;
    }

    /* â€”â€” 2. ä¸»ç•Œé¢ â€”â€” */
    #main {
      display:none;
      width:100%; max-width:500px;
      background:#fff;
      border-radius:12px;
      padding:1.5rem;
      box-shadow:0 8px 24px rgba(0,0,0,0.1);
      position:relative;
      z-index:1;
    }
    h1 {
      font-size:1.25rem;
      margin-bottom:1rem;
    }

    /* â€”â€” æ¨¡å¼åˆ‡æ¢ â€”â€” */
    .mode-switch {
      display:flex; gap:1rem;
      margin-bottom:1rem;
      font-size:.95rem;
    }
    .mode-switch label {
      cursor:pointer;
      user-select:none;
    }
    .mode-switch input {
      margin-right:.25rem;
    }

    /* â€”â€” å½•éŸ³æŒ‰é’® â€”â€” */
    #recBtn {
      width:100%;
      padding:.75rem;
      font-size:1rem;
      background:#3b82f6;
      color:#fff;
      border:none;
      border-radius:6px;
      cursor:pointer;
      transition:background .2s;
      margin-bottom:1rem;
    }
    #recBtn:active {
      background:#2563eb;
    }

    /* â€”â€” èŠå¤©åŒºåŸŸ â€”â€” */
    #chat {
      height:200px;
      overflow-y:auto;
      border:1px solid #ddd;
      border-radius:6px;
      padding:.5rem;
      background:#fafafa;
    }
    .msg {
      margin-bottom:.5rem;
      line-height:1.4;
    }
    .msg.user { color:#1f2937; }
    .msg.bot  { color:#374151; }
  </style>
</head>
<body>
  <!-- æˆæƒå¼¹çª— -->
  <div id="authModal">
    <div class="box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input type="password" id="authInput" placeholder="æˆæƒç " />
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <div id="authErr"></div>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>
    <div class="mode-switch">
      <label><input type="radio" name="mode" value="chat" checked /> å¯¹è¯æ¨¡å¼</label>
      <label><input type="radio" name="mode" value="trans" /> åŒä¼ æ¨¡å¼</label>
    </div>
    <button id="recBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>
    <div id="chat"></div>
  </div>

  <script>
  (function(){
    const BASE     = 'https://translate-assistant.mefans.workers.dev';
    const AUTH_API = BASE + '/admin-api/validate-code';
    const WS_URL   = BASE.replace(/^http/, 'ws') + '/admin-api/ws';

    // DOM
    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modeRadios= document.getElementsByName('mode');

    let socket, recorder;

    // â€”â€” 1. æˆæƒ â€”â€” 
    authInput.addEventListener('input', () => {
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });
    authBtn.addEventListener('click', async () => {
      authBtn.disabled = true;
      authErr.style.display = 'none';
      try {
        const res = await fetch(AUTH_API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ code: authInput.value.trim() })
        });
        const j = await res.json();
        if (res.ok && j.ok) {
          authModal.style.display = 'none';
          main.style.display      = 'block';
          initSession();
        } else {
          throw new Error('æˆæƒå¤±è´¥');
        }
      } catch (err) {
        authErr.textContent = err.message || 'ç½‘ç»œé”™è¯¯';
        authErr.style.display = '';
      } finally {
        authBtn.disabled = false;
      }
    });

    // â€”â€” 2. å»º WS & å½•éŸ³ â€”â€” 
    function initSession(){
      // æ¸…èŠå¤©
      chatEl.innerHTML = '';

      // å½“å‰æ¨¡å¼
      const mode = Array.from(modeRadios).find(r=>r.checked).value;

      // 2.1 å»º WS
      if (socket) socket.close();
      socket = new WebSocket(WS_URL + '?mode=' + mode);
      socket.binaryType = 'arraybuffer';
      socket.onopen    = ()=> appendMsg('bot','ğŸ¤– [å·²è¿æ¥]');
      socket.onmessage = evt => {
        if (typeof evt.data === 'string') {
          const { user, bot } = JSON.parse(evt.data);
          if (user) appendMsg('user', user);
          if (bot ) appendMsg('bot',  bot );
        } else {
          // ç›´æ¥æ’­æ”¾éŸ³é¢‘
          const url = URL.createObjectURL(new Blob([evt.data],{type:'audio/webm'}));
          new Audio(url).play();
        }
      };
      socket.onerror   = ()=> appendMsg('bot','ğŸ¤– [ç½‘ç»œ/æœåŠ¡å™¨é”™è¯¯]');
      socket.onclose   = ()=> appendMsg('bot','ğŸ¤– [å·²æ–­å¼€æœåŠ¡å™¨]');

      // 2.2 ç‚¹æ¨¡å¼åˆ‡æ¢æ—¶é‡å¯ WS
      Array.from(modeRadios).forEach(r=>{
        r.onchange = initSession;
      });

      // 2.3 å½•éŸ³ï¼šæŒ‰ä½ startï¼Œæ¾å¼€ stop
      recBtn.onpointerdown = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
          recorder = new MediaRecorder(stream);
          recorder.ondataavailable = e => {
            if (socket.readyState === WebSocket.OPEN) {
              socket.send(e.data);
              appendMsg('user','ğŸ‘¤ [å½•éŸ³ä¸­â€¦]');
            }
          };
          recorder.start(250);
        } catch {
          alert('è¯·å…è®¸éº¦å…‹é£æƒé™');
        }
      };
      recBtn.onpointerup = () => {
        if (recorder && recorder.state !== 'inactive') {
          recorder.stop();
        }
      };
    }

    // â€”â€” 3. èŠå¤©æ¡† â€”â€” 
    function appendMsg(who, txt){
      const div = document.createElement('div');
      div.className = 'msg ' + who;
      div.textContent = txt;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // åˆå§‹ï¼šåªéœ²å‡ºæˆæƒ
    window.addEventListener('DOMContentLoaded', ()=>{
      main.style.display = 'none';
      authModal.style.display = 'flex';
    });
  })();
  </script>
</body>
</html>
