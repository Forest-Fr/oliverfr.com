<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    body {font-family:sans-serif;background:#f0f2f5;margin:0;padding:1rem;}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.3);display:flex;
           align-items:center;justify-content:center;z-index:100;}
    .modal-box{background:#fff;padding:2rem;border-radius:8px;max-width:400px;width:100%;}
    button,select{padding:0.5rem 1rem;margin:0.5rem 0;}
    #main{display:none;max-width:500px;margin:auto;background:#fff;
          padding:1rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.1);}
    #chat{height:200px;overflow:auto;border:1px solid #ddd;padding:0.5rem;}
  </style>
</head>
<body>
  <!-- æˆæƒç™»å½•å¼¹çª—ï¼ˆä¿æŒä¸å˜ï¼‰ -->
  <div class="modal" id="authModal">
    <div class="modal-box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input type="password" id="authInput" placeholder="æˆæƒç " style="width:100%;"/>
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <p id="authErr" style="color:red;display:none;"></p>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>
    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <label>
      æ¨¡å¼ï¼š
      <select id="modeSelect">
        <option value="chat">å¯¹è¯æ¨¡å¼</option>
        <option value="trans">åŒä¼ æ¨¡å¼</option>
      </select>
    </label>
    <!-- é•¿æŒ‰å½•éŸ³æŒ‰é’® -->
    <button id="recBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>
    <div id="chat"></div>
  </div>

  <script>
  (async()=>{
    const AUTH_API   = 'https://translate-assistant.mefans.workers.dev/admin-api/validate-code';
    const START_API  = 'https://translate-assistant.mefans.workers.dev/admin-api/start-session';
    const WS_ENDPOINT= 'wss://translate-assistant.mefans.workers.dev/admin-api/ws';

    // å…ƒç´ 
    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modeSel   = document.getElementById('modeSelect');

    let sessionId, ws, recorder;

    // â€”â€” æˆæƒæµç¨‹ï¼ˆä¸å˜ï¼‰ â€”â€”
    authInput.addEventListener('input',_=> authBtn.disabled=!authInput.value.trim());
    authBtn.onclick = async () => {
      authBtn.disabled = true;
      try {
        let r = await fetch(AUTH_API,
          {method:'POST',headers:{'Content-Type':'application/json'},
           body:JSON.stringify({code:authInput.value.trim()})});
        let j = await r.json();
        if(r.ok && j.ok){
          authModal.style.display='none';
          main.style.display='';
          init();
        } else {
          authErr.textContent='æˆæƒå¤±è´¥'; authErr.style.display='';
        }
      } catch {
        authErr.textContent='ç½‘ç»œé”™è¯¯'; authErr.style.display='';
      } finally { authBtn.disabled=false; }
    };

    // â€”â€” åˆå§‹åŒ–ä¼šè¯ & WS & å½•éŸ³ â€”â€”  
    async function init(){
      // 1) å¼€å¯æ–°ä¼šè¯
      let mode = modeSel.value;
      let r = await fetch(START_API,{method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({mode})});
      sessionId = (await r.json()).session_id;

      // 2) WebSocket
      ws = new WebSocket(`${WS_ENDPOINT}?session_id=${sessionId}&mode=${mode}`);
      ws.binaryType = 'arraybuffer';
      ws.onmessage = async evt => {
        // æ”¶åˆ°äºŒè¿›åˆ¶éŸ³é¢‘ç›´æ¥æ’­æ”¾
        const blob = new Blob([evt.data],{type:'audio/webm'});
        const url  = URL.createObjectURL(blob);
        new Audio(url).play();
        // ä¹Ÿå¯æ˜¾ç¤ºæ–‡æœ¬ï¼ˆè‹¥å¦ä¼ æ–‡æœ¬å­—æ®µï¼‰
      };

      // 3) å½•éŸ³
      recBtn.addEventListener('pointerdown', async ()=>{
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = e => ws.send(e.data);
        recorder.start();
      });
      recBtn.addEventListener('pointerup', ()=>{
        if(recorder && recorder.state!=='inactive') recorder.stop();
      });

      // 4) åˆ‡æ¢æ¨¡å¼åé‡å¯
      modeSel.onchange = ()=>{
        ws.close();
        init();
      };
    }
  })();
  </script>
</body>
</html>
