<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    /* â€”â€” å…¨å±€ & é‡ç½® â€”â€” */
    *{margin:0;padding:0;box-sizing:border-box}
    body {
      font-family:'Segoe UI',Arial,sans-serif;
      background:#f0f2f5;
      min-height:100vh;
      display:flex;align-items:center;justify-content:center;
      padding:1rem;
    }

    /* â€”â€” æˆæƒå¼¹çª— â€”â€” */
    #authModal {
      position:fixed; inset:0;
      background: rgba(255,255,255,0.05);
      backdrop-filter: blur(2px);
      z-index:100;
      display:flex; align-items:center; justify-content:center;
    }
    #authModal .box {
      width:90%; max-width:400px;
      background:#fff; border-radius:12px;
      padding:2rem; text-align:center;
      box-shadow:0 8px 24px rgba(0,0,0,0.1);
    }
    #authModal h2 { font-size:1.5rem; margin-bottom:1rem }
    #authModal input {
      width:100%; padding:.75rem; font-size:1rem;
      border:1px solid #ccc; border-radius:6px;
      margin-bottom:1rem;
    }
    #authBtn {
      width:100%; padding:.75rem; font-size:1rem;
      background:#3b82f6; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
      transition:background .2s;
    }
    #authBtn:disabled { background:#8fbefc; cursor:not-allowed }
    #authBtn:not(:disabled):hover { background:#2563eb }
    #authErr {
      color:#d9534f; font-size:.9rem; margin-top:.5rem;
      display:none;
    }

    /* â€”â€” ä¸»ç•Œé¢ â€”â€” */
    #main {
      display:none;
      width:100%; max-width:500px;
      background:#fff; border-radius:12px;
      padding:1.5rem;
      box-shadow:0 8px 24px rgba(0,0,0,0.1);
      position:relative; z-index:1;
    }
    h1 { font-size:1.25rem; margin-bottom:1rem }

    /* â€”â€” æ¨¡å¼å¼€å…³ â€”â€” */
    .switch-wrapper {
      display:flex; align-items:center; margin-bottom:1rem;
    }
    .switch {
      position:relative; margin-right:.75rem;
      width:50px; height:26px;
    }
    .switch input {
      opacity:0;width:0;height:0;
    }
    .slider{
      position:absolute; top:0; left:0; right:0; bottom:0;
      background:#ccc; border-radius:26px; transition:.2s;
    }
    .slider:before{
      content:""; position:absolute;
      height:20px; width:20px; left:3px; bottom:3px;
      background:#fff; border-radius:50%; transition:.2s;
    }
    input:checked+.slider{ background:#3b82f6 }
    input:checked+.slider:before{ transform:translateX(24px) }
    .mode-label{ font-size:.95rem }

    /* â€”â€” å½•éŸ³æŒ‰é’® â€”â€” */
    #recBtn {
      width:100%; padding:.75rem; font-size:1rem;
      background:#3b82f6; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
      transition:background .2s; margin-bottom:1rem;
    }
    #recBtn:active { background:#2563eb }

    /* â€”â€” èŠå¤©åŒº â€”â€” */
    #chat {
      height:240px; overflow-y:auto;
      border:1px solid #ddd; border-radius:6px;
      background:#fafafa; padding:.75rem;
    }
    .msg { margin-bottom:.5rem }
    .msg.user{ color:#1f2937 }
    .msg.bot { color:#374151 }
  </style>
</head>
<body>

  <!-- æˆæƒå¼¹çª— -->
  <div id="authModal">
    <div class="box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input type="password" id="authInput" placeholder="demo-key"/>
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <div id="authErr"></div>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>

    <!-- æ¨¡å¼å¼€å…³ -->
    <div class="switch-wrapper">
      <label class="switch">
        <input type="checkbox" id="modeToggle"/>
        <span class="slider"></span>
      </label>
      <span class="mode-label" id="modeLabel">å¯¹è¯æ¨¡å¼</span>
    </div>

    <!-- å½•éŸ³æŒ‰é’® -->
    <button id="recBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>

    <!-- èŠå¤©åŒº -->
    <div id="chat"></div>
  </div>

  <script>
  (()=>{
    const BASE     = 'https://translate-assistant.mefans.workers.dev';
    const AUTH_API = BASE + '/admin-api/validate-code';
    const WS_URL   = BASE.replace(/^http/,'ws') + '/admin-api/ws';
    const authModal  = document.getElementById('authModal');
    const authInput  = document.getElementById('authInput');
    const authBtn    = document.getElementById('authBtn');
    const authErr    = document.getElementById('authErr');
    const main       = document.getElementById('main');
    const recBtn     = document.getElementById('recBtn');
    const chatEl     = document.getElementById('chat');
    const modeToggle = document.getElementById('modeToggle');
    const modeLabel  = document.getElementById('modeLabel');
    let socket, recorder, isRecording=false;

    // â€”â€” æˆæƒæµç¨‹ â€”â€” 
    authInput.addEventListener('input',()=>{
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display='none';
    });
    authBtn.addEventListener('click',async()=>{
      authBtn.disabled=true;
      try{
        const res = await fetch(AUTH_API,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({code:authInput.value.trim()})
        });
        const j = await res.json();
        if(res.ok && j.ok){
          authModal.style.display='none';
          main.style.display='block';
          startSession();
        } else {
          throw new Error('æˆæƒå¤±è´¥');
        }
      }catch(e){
        authErr.textContent=e.message;
        authErr.style.display='block';
      }finally{
        authBtn.disabled=false;
      }
    });

    // â€”â€” åˆ‡æ¢æ¨¡å¼ â€”â€” 
    modeToggle.addEventListener('change',()=>{
      modeLabel.textContent = modeToggle.checked?'åŒä¼ æ¨¡å¼':'å¯¹è¯æ¨¡å¼';
      startSession();
    });

    // â€”â€” å»ºç«‹ WS ä¼šè¯ & ç›‘å¬ â€”â€” 
    function startSession(){
      chatEl.innerHTML = '';
      if(socket) socket.close();
      const mode = modeToggle.checked ? 'trans' : 'chat';
      socket = new WebSocket(`${WS_URL}?mode=${mode}`);
      socket.binaryType = 'arraybuffer';

      socket.onopen = ()=> appendMsg('bot', '[å·²è¿æ¥]');
      socket.onerror = ()=> appendMsg('bot', '[ç½‘ç»œ/æœåŠ¡å™¨é”™è¯¯]');
      socket.onclose = ()=> appendMsg('bot', '[å·²æ–­å¼€]');

      socket.onmessage = evt => {
        // åŒä¼ æ¨¡å¼ï¼šåç«¯æ¨éŸ³é¢‘æµ
        if (evt.data instanceof ArrayBuffer) {
          const blob = new Blob([evt.data], { type: 'audio/webm' });
          const url  = URL.createObjectURL(blob);
          new Audio(url).play();
          // ï¼ˆå¯é€‰ï¼‰å¦‚æœåç«¯åŒæ—¶å‘æ–‡æœ¬ï¼šè¿™é‡Œä¹Ÿèƒ½ parse JSON
        } else {
          // å¯¹è¯æ¨¡å¼ï¼šåç«¯ä»¥ JSON{"who":"bot","text":"..."} å‘é€
          try {
            const msg = JSON.parse(evt.data);
            appendMsg(msg.who, msg.text);
          } catch {}
        }
      };
    }

    // â€”â€” å½•éŸ³ â€”â€” 
    function startRec(e){
      e.preventDefault();
      if(isRecording) return;
      if(!socket || socket.readyState!==1){
        appendMsg('bot','[å°šæœªè¿æ¥]');
        return;
      }
      isRecording = true;
      navigator.mediaDevices.getUserMedia({audio:true})
        .then(stream=>{
          recorder = new MediaRecorder(stream);
          recorder.ondataavailable = ev => {
            if(socket.readyState===1) socket.send(ev.data);
          };
          recorder.start(250);
          appendMsg('bot','[å½•éŸ³ä¸­â€¦]');
        })
        .catch(_=>{
          alert('è¯·å…è®¸éº¦å…‹é£æƒé™');
          isRecording = false;
        });
    }
    function stopRec(e){
      e.preventDefault();
      if(!isRecording) return;
      isRecording = false;
      if(recorder && recorder.state!=='inactive') recorder.stop();
      appendMsg('bot','[å·²å‘é€éŸ³é¢‘]');
    }
    recBtn.addEventListener('mousedown', startRec);
    recBtn.addEventListener('mouseup',   stopRec);
    recBtn.addEventListener('touchstart', startRec);
    recBtn.addEventListener('touchend',   stopRec);

    // â€”â€” æ˜¾ç¤ºæ¶ˆæ¯ â€”â€” 
    function appendMsg(who, text){
      const d = document.createElement('div');
      d.className = 'msg ' + who;
      d.textContent = (who==='user'?'ğŸ‘¤ ':'ğŸ¤– ') + text;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // åˆå§‹
    window.addEventListener('DOMContentLoaded',()=>{
      authModal.style.display='flex';
      main.style.display='none';
    });
  })();
  </script>
</body>
</html>
