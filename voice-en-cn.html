<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    * {margin:0; padding:0; box-sizing:border-box;}
    body {
      font-family:'Segoe UI','Arial',sans-serif;
      background:#f0f2f5; color:#333;
      min-height:100vh;
      display:flex; justify-content:center; align-items:center;
      padding:1rem;
    }
    /* ä¸»ç•Œé¢ */
    #main {
      width:100%; max-width:500px;
      background:#fff; border-radius:12px;
      padding:1.5rem; box-shadow:0 8px 24px rgba(0,0,0,0.1);
      position:relative; z-index:1;
    }
    h1 {font-size:1.25rem; margin-bottom:1rem;}
    .mode-switch {display:flex; gap:1rem; margin-bottom:1rem;}
    .mode-switch label {cursor:pointer; user-select:none;}
    .mode-switch input {margin-right:.3rem;}
    #recBtn {
      width:100%; padding:.75rem; font-size:1rem;
      background:#3b82f6; color:#fff; border:none;
      border-radius:6px; cursor:pointer; transition:background .2s;
      margin-bottom:1rem;
    }
    #recBtn:disabled {background:#aac4f7; cursor:not-allowed;}
    #recBtn:active:not(:disabled) {background:#2563eb;}
    #chat {
      height:240px; overflow-y:auto;
      border:1px solid #ddd; border-radius:6px;
      background:#fafafa; padding:.5rem;
    }
    .msg {margin-bottom:.5rem; line-height:1.4;}
    .msg.user {color:#1f2937;}
    .msg.bot  {color:#374151;}
    /* æˆæƒå¼¹çª— */
    #authModal {
      position:fixed; inset:0;
      display:flex; justify-content:center; align-items:center;
      /* é€æ˜é®ç½©ï¼Œä¿è¯èƒ½çœ‹åˆ°é¡µé¢ */
      background:rgba(0,0,0,0);
      z-index:1000;
    }
    #authModal .box {
      background:rgba(255,255,255,0.95);
      border-radius:12px; padding:24px 32px;
      box-shadow:0 8px 24px rgba(0,0,0,0.15);
      text-align:center; min-width:320px;
    }
    #authModal h2 {font-size:1.5rem; margin-bottom:1rem;}
    #authModal input {
      width:100%; padding:.75rem; font-size:1rem;
      border:1px solid #ccc; border-radius:6px;
      margin-bottom:1rem;
    }
    #authModal button {
      width:100%; padding:.75rem; font-size:1rem;
      border:none; border-radius:6px;
      background:#3b82f6; color:#fff; cursor:pointer;
      transition:background .2s;
    }
    #authModal button:disabled {background:#8fbefc; cursor:not-allowed;}
    #authErr {
      display:none; margin-top:.5rem;
      color:#d9534f; font-size:.9rem;
    }
  </style>
</head>
<body>
  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>
    <div class="mode-switch">
      <label>
        <input type="radio" name="mode" value="chat" checked/> å¯¹è¯æ¨¡å¼
      </label>
      <label>
        <input type="radio" name="mode" value="trans"/> åŒä¼ æ¨¡å¼
      </label>
    </div>
    <button id="recBtn" disabled>ğŸ¤ æŒ‰ä½è¯´è¯</button>
    <div id="chat"></div>
  </div>

  <!-- æˆæƒå¼¹çª— -->
  <div id="authModal">
    <div class="box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input id="authInput" type="password" placeholder="æˆæƒç "/>
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <div id="authErr"></div>
    </div>
  </div>

  <script>
  (function(){
    const BASE     = 'https://translate-assistant.mefans.workers.dev';
    const AUTH_URL = BASE + '/admin-api/validate-code';
    const WS_URL   = BASE.replace(/^http/,'ws') + '/admin-api/ws';
    // å¦‚æœä½ å·²æœ‰ TTS æœåŠ¡ï¼ŒæŠŠ URL å¡«åœ¨ä¸‹é¢ï¼š
    const TTS_URL  = 'https://your-tts-provider.example.com/tts';

    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modeEls   = document.getElementsByName('mode');

    let socket, recorder;

    // â€”â€” æˆæƒé€»è¾‘ â€”â€” 
    authInput.addEventListener('input', () => {
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });
    authBtn.addEventListener('click', async () => {
      authBtn.disabled = true;
      try {
        const r = await fetch(AUTH_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ code:authInput.value.trim() })
        });
        const j = await r.json();
        if (r.ok && j.ok) {
          authModal.style.display = 'none';
          recBtn.disabled = false;
          initSession();
        } else {
          throw new Error('æˆæƒå¤±è´¥');
        }
      } catch (e) {
        authErr.textContent = e.message||'ç½‘ç»œé”™è¯¯';
        authErr.style.display = '';
      } finally {
        authBtn.disabled = false;
      }
    });

    // â€”â€” ä¼šè¯ & WS & å½•éŸ³ â€”â€” 
    function initSession(){
      // æ¸…ç©ºèŠå¤©è®°å½•
      chatEl.innerHTML = '';
      // å…³é—­æ—§ WS
      if (socket) socket.close();

      const mode = [...modeEls].find(r=>r.checked).value;
      socket = new WebSocket(WS_URL + '?mode=' + mode);
      socket.binaryType = 'arraybuffer';

      socket.onopen = () => appendMsg('bot','ğŸ¤– [å·²è¿æ¥]');
      socket.onclose= () => appendMsg('bot','ğŸ¤– [å·²æ–­å¼€]');
      socket.onerror= ()=> appendMsg('bot','ğŸ¤– [æœåŠ¡å¼‚å¸¸]');
      socket.onmessage = async evt => {
        // å¯¹è¯æ¨¡å¼ï¼šå…ˆ text å† TTS
        if (mode==='chat' && typeof evt.data === 'string') {
          const { user, bot } = JSON.parse(evt.data);
          if (user) appendMsg('user', user);
          if (bot) {
            // 1) æ’­æ”¾ TTS
            try {
              const ttsResp = await fetch(TTS_URL, {
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({ text:bot })
              });
              const audioBlob = await ttsResp.blob();
              await playAudio(audioBlob);
            } catch {
              // å¦‚æœ TTS å¤±è´¥ï¼Œç›´æ¥è´´æ–‡å­—
            }
            // 2) å†æ˜¾ç¤ºæ–‡å­—
            appendMsg('bot', bot);
          }
        }
        // åŒä¼ æ¨¡å¼ï¼šç›´æ¥éŸ³é¢‘æµ
        else if (mode==='trans' && evt.data instanceof ArrayBuffer) {
          await playAudio(new Blob([evt.data],{type:'audio/webm'}));
        }
      };

      // åˆ‡æ¢æ¨¡å¼æ—¶é‡è¿
      [...modeEls].forEach(r=>r.onchange = initSession);

      // å½•éŸ³
      recBtn.onpointerdown = async () => {
        try {
          const s = await navigator.mediaDevices.getUserMedia({ audio:true });
          recorder = new MediaRecorder(s);
          recorder.ondataavailable = e => {
            if (socket.readyState===1) socket.send(e.data);
          };
          recorder.start(250);
          appendMsg('user','ğŸ‘¤ [å¼€å§‹å½•éŸ³]');
        } catch {
          alert('è¯·å…è®¸éº¦å…‹é£æƒé™');
        }
      };
      recBtn.onpointerup = () => {
        if (recorder && recorder.state!=='inactive') {
          recorder.stop();
          appendMsg('user','ğŸ‘¤ [ç»“æŸå½•éŸ³]');
        }
      };
    }

    // æ’­æ”¾éŸ³é¢‘
    function playAudio(blob){
      return new Promise(res=>{
        const url = URL.createObjectURL(blob);
        const a   = new Audio(url);
        a.onended = ()=> { URL.revokeObjectURL(url); res(); };
        a.play();
      });
    }

    // è¿½åŠ æ¶ˆæ¯
    function appendMsg(by, txt){
      const d = document.createElement('div');
      d.className = 'msg ' + by;
      d.textContent = txt;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // åˆå§‹ï¼šé¡µé¢å¯è§ä½†å½•éŸ³é”ä½
    window.addEventListener('DOMContentLoaded', ()=>{
      recBtn.disabled = true;
    });
  })();
  </script>
</body>
</html>
