<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>双模式语音助手</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box }
    body { font-family:'Segoe UI',sans-serif; background:#f0f2f5; color:#333;
      min-height:100vh; display:flex; justify-content:center; align-items:center; padding:1rem;
    }
    #main {
      width:100%; max-width:500px; background:#fff; border-radius:12px;
      padding:1.5rem; box-shadow:0 8px 24px rgba(0,0,0,0.1); position:relative; z-index:1;
    }
    h1 { font-size:1.25rem; margin-bottom:1rem }
    .mode-switch { display:flex; gap:1rem; margin-bottom:1rem }
    .mode-switch input { margin-right:.3rem }
    #recBtn {
      width:100%; padding:.75rem; font-size:1rem; background:#3b82f6; color:#fff;
      border:none; border-radius:6px; cursor:pointer; transition:background .2s;
      margin-bottom:1rem;
    }
    #recBtn.recording { background:#dc2626 }
    #recBtn:disabled { background:#aac4f7; cursor:not-allowed }
    #chat {
      height:240px; overflow-y:auto; border:1px solid #ddd; border-radius:6px;
      padding:.5rem; background:#fafafa;
    }
    .msg { margin-bottom:.5rem }
    .msg.user { color:#1f2937 }
    .msg.bot  { color:#374151 }
    #authModal {
      position:fixed; inset:0; display:flex; justify-content:center; align-items:center;
      background:rgba(0,0,0,0); z-index:1000;
    }
    #authModal .box {
      background:rgba(255,255,255,0.95); border-radius:12px; padding:24px 32px;
      box-shadow:0 8px 24px rgba(0,0,0,0.15); text-align:center; min-width:320px;
    }
    #authModal input, #authModal button {
      width:100%; padding:.75rem; font-size:1rem; border-radius:6px; border:1px solid #ccc;
      margin-bottom:1rem;
    }
    #authModal button { background:#3b82f6; color:#fff; border:none; transition:background .2s }
    #authModal button:disabled { background:#8fbefc; cursor:not-allowed }
    #authErr { color:#d9534f; margin-top:.5rem; font-size:.9rem; display:none }
  </style>
</head>
<body>
  <div id="main">
    <h1>语音助手</h1>
    <div class="mode-switch">
      <label><input type="radio" name="mode" value="chat" checked/> 对话模式</label>
      <label><input type="radio" name="mode" value="trans"/> 同传模式</label>
    </div>
    <button id="recBtn" disabled>🎤 按住说话</button>
    <div id="chat"></div>
  </div>

  <div id="authModal">
    <div class="box">
      <h2>请输入授权码</h2>
      <input id="authInput" type="password" placeholder="授权码"/>
      <button id="authBtn" disabled>确认</button>
      <div id="authErr"></div>
    </div>
  </div>

  <script>
    // DEBUG 横幅
    document.body.insertAdjacentHTML('afterbegin',
      '<div style="position:fixed;top:0;left:0;background:red;color:white;padding:4px;font-size:12px;z-index:9999;">[DEBUG BUILD]</div>'
    );
    console.log('--- DEBUG BUILD LOADED ---');

    (function(){
      const BASE    = 'https://translate-assistant.mefans.workers.dev';
      const AUTH    = BASE + '/admin-api/validate-code';
      const WS_BASE = BASE.replace(/^http/,'ws') + '/admin-api/ws';

      const authModal = document.getElementById('authModal');
      const authInput = document.getElementById('authInput');
      const authBtn   = document.getElementById('authBtn');
      const authErr   = document.getElementById('authErr');
      const recBtn    = document.getElementById('recBtn');
      const chatEl    = document.getElementById('chat');
      const modes     = document.getElementsByName('mode');

      let socket, recorder, sessionId, authCode;

      window.addEventListener('DOMContentLoaded', ()=> recBtn.disabled = true);

      authInput.addEventListener('input', ()=> {
        authBtn.disabled = !authInput.value.trim();
        authErr.style.display = 'none';
      });
      authBtn.addEventListener('click', async ()=> {
        authBtn.disabled = true;
        try {
          const r = await fetch(AUTH, {
            method:'POST',
            headers:{ 'Content-Type':'application/json' },
            body: JSON.stringify({ code: authInput.value.trim() })
          });
          const j = await r.json();
          if (r.ok && j.ok) {
            sessionId = crypto.randomUUID();
            authCode  = authInput.value.trim();
            authModal.style.display = 'none';
            recBtn.disabled = false;
            initSession();
          } else {
            throw new Error(j.error||'授权失败');
          }
        } catch(e) {
          authErr.textContent = e.message||'网络错误';
          authErr.style.display = '';
        } finally {
          authBtn.disabled = false;
        }
      });

      function initSession(){
        chatEl.innerHTML = '';
        if (socket) socket.close();

        const mode = [...modes].find(r=>r.checked).value;
        const url  = `${WS_BASE}?mode=${mode}&session=${sessionId}&auth=${authCode}`;
        console.log('Attempting WS connect to:', url);
        socket = new WebSocket(url);
        socket.binaryType = 'arraybuffer';

        socket.onopen = ()=> {
          console.log('WS readyState onopen:', socket.readyState);
          append('bot','🤖 [已连接]');
        };
        socket.onerror = e=>{
          console.error('WS.onerror:', e);
          append('bot','🤖 [服务异常]');
        };
        socket.onclose = e=>{
          console.log('WS.onclose code=', e.code, 'reason=', e.reason);
          append('bot','🤖 [已断开]');
        };

        // —— 重点：优先处理二进制，再处理文本 —— 
        socket.onmessage = async evt => {
          console.log('WS 收到 raw evt:', evt);
          if (evt.data instanceof ArrayBuffer) {
            console.log('收到 ArrayBuffer，长度', evt.data.byteLength);
            // ElevenLabs 返回 MP3
            const blob = new Blob([evt.data], { type:'audio/mpeg' });
            const url  = URL.createObjectURL(blob);
            const a    = new Audio(url);
            a.onended = ()=> URL.revokeObjectURL(url);
            try {
              await a.play();
              console.log('✅ 播放成功');
            } catch(err) {
              console.error('❌ 播放失败', err);
            }
            return;
          }

          if (typeof evt.data === 'string') {
            const msg = JSON.parse(evt.data);
            console.log('收到文本/_meta：', msg);
            if (msg.who === '_meta') {
              // 用来调试 Worker 是否真的发了 TTS 缓冲区长度
              console.log('📐 Meta 帧：', msg.text);
            } else {
              append(msg.who, msg.text);
            }
            return;
          }

          console.warn('未知消息类型，忽略', evt.data);
        };

        [...modes].forEach(r=>r.onchange = initSession);

        const startRec = async ()=>{
          recBtn.classList.add('recording');
          recBtn.textContent = '🛑 录音中...';
          try {
            const s = await navigator.mediaDevices.getUserMedia({ audio:true });
            recorder = new MediaRecorder(s);
            recorder.ondataavailable = e=>{
              if (socket.readyState===1) socket.send(e.data);
            };
            recorder.start(250);
            append('user','👤 [开始录音]');
          } catch {
            alert('请允许麦克风');
          }
        };
        const stopRec = ()=>{
          recBtn.classList.remove('recording');
          recBtn.textContent = '🎤 按住说话';
          if (recorder && recorder.state!=='inactive') {
            recorder.stop();
            append('user','👤 [结束录音]');
          }
        };
        recBtn.addEventListener('pointerdown', startRec);
        recBtn.addEventListener('pointerup',   stopRec);
        recBtn.addEventListener('touchstart',  startRec);
        recBtn.addEventListener('touchend',    stopRec);
      }

      function append(who, txt){
        const d = document.createElement('div');
        d.className = 'msg ' + who;
        d.textContent = txt;
        chatEl.appendChild(d);
        chatEl.scrollTop = chatEl.scrollHeight;
      }
    })();
  </script>
</body>
</html>
