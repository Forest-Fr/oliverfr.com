<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    /* â€”â€” 0. å…¨å±€ & é‡ç½® â€”â€” */
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f0f2f5;
      color: #333;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
    }

    /* â€”â€” 1. æˆæƒå¼¹çª— â€”â€” */
    #authModal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      /* æ›´æµ…çš„é®ç½© + è½»åº¦æ¨¡ç³Šï¼Œèƒ½çœ‹åˆ°èƒŒåå†…å®¹è½®å»“ */
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
      z-index: 100;
    }
    #authModal .box {
      width: 90%;
      max-width: 400px;
      background: #fff;
      border-radius: 12px;
      padding: 24px 32px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      text-align: center;
    }
    #authModal h2 {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }
    #authModal input {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 1rem;
    }
    #authModal button {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      background: #3b82f6;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }
    #authModal button:disabled {
      background: #8fbefc;
      cursor: not-allowed;
    }
    #authModal button:not(:disabled):hover {
      background: #2563eb;
    }
    #authErr {
      color: #d9534f;
      margin-top: 0.5rem;
      font-size: 0.9rem;
      display: none;
    }

    /* â€”â€” 2. ä¸»ç•Œé¢ â€”â€” */
    #main {
      display: none;
      width: 100%;
      max-width: 500px;
      background: #fff;
      border-radius: 12px;
      padding: 1.5rem;
      box-shadow: 0 8px 24px rgba(0,0,0,0.1);
    }
    h1 { font-size: 1.25rem; margin-bottom: 1rem; }

    /* â€”â€” æ¨¡å¼åˆ‡æ¢ â€”â€” */
    .mode-switch {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      font-size: 0.95rem;
    }
    .mode-switch label {
      cursor: pointer;
      user-select: none;
    }
    .mode-switch input {
      margin-right: 0.25rem;
    }

    /* â€”â€” å½•éŸ³æŒ‰é’® & åŒº â€”â€” */
    #recBtn {
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.2s;
      margin-bottom: 1rem;
      user-select: none;
    }
    #recBtn:active { background: #2563eb; }

    /* â€”â€” èŠå¤©æ˜¾ç¤º â€”â€” */
    #chat {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 0.5rem;
      background: #fafafa;
    }
    .msg { margin-bottom: 0.5rem; }
    .msg.user { color: #1f2937; }
    .msg.bot  { color: #374151; }
  </style>
</head>
<body>

  <!-- æˆæƒå¼¹çª— -->
  <div id="authModal">
    <div class="box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input type="password" id="authInput" placeholder="æˆæƒç "/>
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <div id="authErr"></div>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>

    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <div class="mode-switch">
      <label><input type="radio" name="mode" value="chat" checked/> å¯¹è¯æ¨¡å¼</label>
      <label><input type="radio" name="mode" value="trans"/> åŒä¼ æ¨¡å¼</label>
    </div>

    <!-- å½•éŸ³æŒ‰é’® -->
    <button id="recBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>

    <!-- èŠå¤©/åŒä¼  æ˜¾ç¤ºåŒº -->
    <div id="chat"></div>
  </div>

  <script>
  (function(){
    const BASE     = 'https://translate-assistant.mefans.workers.dev';
    const AUTH_API = BASE + '/admin-api/validate-code';
    const WS_URL   = BASE.replace(/^http/, 'ws') + '/';

    // DOM
    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modes     = document.getElementsByName('mode');

    let socket, recorder;

    // â€”â€” æˆæƒ â€”â€” 
    authInput.addEventListener('input', () => {
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });
    authBtn.addEventListener('click', async () => {
      authBtn.disabled = true;
      authErr.style.display = 'none';
      try {
        const resp = await fetch(AUTH_API, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ code: authInput.value.trim() })
        });
        const j = await resp.json();
        if (resp.ok && j.ok) {
          // æˆæƒé€šè¿‡ï¼Œæ˜¾ç¤ºä¸»ç•Œé¢
          authModal.style.display = 'none';
          main.style.display      = 'block';
          initWS();
        } else {
          throw new Error('æˆæƒå¤±è´¥');
        }
      } catch (e) {
        authErr.textContent = e.message || 'ç½‘ç»œé”™è¯¯';
        authErr.style.display = '';
      } finally {
        authBtn.disabled = false;
      }
    });

    // â€”â€” åˆå§‹åŒ– WebSocket â€”â€” 
    function initWS(){
      // æ¸…å†å²
      chatEl.innerHTML = '';

      // ä¾æ® mode è®¾ç½® query å‚æ•°
      const mode = Array.from(modes).find(r=>r.checked).value;
      const url  = WS_URL + '?mode=' + mode;

      if (socket) socket.close();
      socket = new WebSocket(url);
      socket.binaryType = 'arraybuffer';

      socket.onopen    = ()=> append('bot','[å·²è¿æ¥æœåŠ¡å™¨]');
      socket.onclose   = ()=> append('bot','[å·²æ–­å¼€æœåŠ¡å™¨]');
      socket.onerror   = ()=> append('bot','[ç½‘ç»œ/æœåŠ¡å™¨é”™è¯¯]');

      socket.onmessage = evt => {
        // å¦‚æœæ˜¯æ–‡æœ¬ JSON
        if (typeof evt.data === 'string') {
          const msg = JSON.parse(evt.data);
          if (msg.user) append('user', msg.user);
          if (msg.bot ) append('bot',  msg.bot );
        } else {
          // äºŒè¿›åˆ¶ï¼šéŸ³é¢‘æµ
          const blob = new Blob([evt.data], { type:'audio/webm' });
          new Audio(URL.createObjectURL(blob)).play();
        }
      };
    }

    // â€”â€” æŒ‰ä½å½•éŸ³ â€”â€” 
    async function startRec(){
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        recorder = new MediaRecorder(stream, { mimeType:'audio/webm' });
        recorder.ondataavailable = e => {
          if (socket && socket.readyState === 1 && e.data.size>0) {
            socket.send(e.data);
          }
        };
        recorder.start(250);
        recBtn.textContent = 'ğŸ¤ å½•éŸ³ä¸­...';
      } catch {
        alert('è¯·å…è®¸éº¦å…‹é£æƒé™');
      }
    }
    function stopRec(){
      if (recorder && recorder.state!=='inactive') recorder.stop();
      recBtn.textContent = 'ğŸ¤ æŒ‰ä½è¯´è¯';
    }

    recBtn.addEventListener('pointerdown', startRec);
    recBtn.addEventListener('pointerup',   stopRec);
    recBtn.addEventListener('pointerleave',stopRec);
    recBtn.addEventListener('touchstart',  startRec);
    recBtn.addEventListener('touchend',    stopRec);

    // â€”â€” åˆ‡æ¨¡å¼æ—¶é‡è¿ â€”â€” 
    modes.forEach(r=>r.addEventListener('change', initWS));

    // â€”â€” èŠå¤©è¾“å‡ºå¸®åŠ© â€”â€” 
    function append(who,text){
      const d = document.createElement('div');
      d.className = 'msg ' + who;
      d.textContent = (who==='user'?'ğŸ‘¤ ':'ğŸ¤– ') + text;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    // é¡µé¢åŠ è½½æ—¶
    window.addEventListener('DOMContentLoaded', ()=>{
      main.style.display = 'none';
      authModal.style.display = 'flex';
    });
  })();
  </script>
</body>
</html>
