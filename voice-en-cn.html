<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>双模式语音助手</title>
  <style>
    /* —— 重置 & 布局 —— */
    * { margin:0; padding:0; box-sizing:border-box }
    body {
      font-family:'Segoe UI',Arial,sans-serif;
      background:#f0f2f5; color:#333;
      display:flex; align-items:center; justify-content:center;
      min-height:100vh; padding:1rem;
    }
    /* —— 授权弹窗 —— */
    #authModal {
      position:fixed; inset:0;
      background:rgba(255,255,255,0.15);
      backdrop-filter:blur(4px);
      display:flex; align-items:center; justify-content:center;
      z-index:100;
    }
    #authModal .box {
      background:#fff; padding:24px 32px;
      border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.15);
      text-align:center; width:90%; max-width:400px;
    }
    #authModal h2 { font-size:1.5rem; margin-bottom:1rem }
    #authModal input {
      width:100%; padding:.75rem; font-size:1rem;
      border:1px solid #ccc; border-radius:6px;
      margin-bottom:1rem;
    }
    #authModal button {
      width:100%; padding:.75rem; font-size:1rem;
      border:none; border-radius:6px;
      background:#3b82f6; color:#fff;
      cursor:pointer; transition:background .2s;
    }
    #authModal button:disabled {
      background:#8fbefc; cursor:not-allowed;
    }
    #authErr {
      color:#d9534f; margin-top:.5rem;
      font-size:.9rem; display:none;
    }
    /* —— 主界面 —— */
    #main {
      display:none; width:100%; max-width:500px;
      background:#fff; padding:1.5rem;
      border-radius:12px; box-shadow:0 8px 24px rgba(0,0,0,0.1);
      z-index:1;
    }
    h1 { font-size:1.25rem; margin-bottom:1rem }
    .mode-switch {
      display:flex; gap:1rem; margin-bottom:1rem;
      font-size:.95rem;
    }
    .mode-switch label { cursor:pointer; user-select:none }
    .mode-switch input { margin-right:.25rem }
    /* —— 录音按钮 & 聊天区 —— */
    #recBtn {
      width:100%; padding:.75rem; font-size:1rem;
      background:#3b82f6; color:#fff; border:none;
      border-radius:6px; cursor:pointer; transition:background .2s;
      margin-bottom:1rem; user-select:none;
    }
    #recBtn:active { background:#2563eb }
    #chat {
      height:200px; overflow-y:auto;
      border:1px solid #ddd; border-radius:6px;
      background:#fafafa; padding:.5rem;
    }
    .msg { margin-bottom:.5rem }
    .msg.user { color:#1f2937 }
    .msg.bot  { color:#374151 }
  </style>
</head>
<body>

  <!-- 授权 -->
  <div id="authModal">
    <div class="box">
      <h2>请输入授权码</h2>
      <input type="password" id="authInput" placeholder="授权码" />
      <button id="authBtn" disabled>确认</button>
      <div id="authErr"></div>
    </div>
  </div>

  <!-- 主界面 -->
  <div id="main">
    <h1>语音助手</h1>
    <div class="mode-switch">
      <label><input type="radio" name="mode" value="chat" checked/> 对话模式</label>
      <label><input type="radio" name="mode" value="trans"/> 同传模式</label>
    </div>
    <button id="recBtn">🎤 按住说话</button>
    <div id="chat"></div>
  </div>

  <script>
  (function(){
    const BASE     = 'https://translate-assistant.mefans.workers.dev';
    const AUTH_API = BASE + '/admin-api/validate-code';
    const WS_API   = BASE.replace(/^http/, 'ws') + '/admin-api/ws';

    // 元素
    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modes     = document.getElementsByName('mode');

    let socket, recorder;

    // —— 授权 —— 
    authInput.addEventListener('input', ()=>{
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });
    authBtn.addEventListener('click', async ()=>{
      authBtn.disabled = true;
      try {
        const r = await fetch(AUTH_API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ code: authInput.value.trim() })
        });
        const j = await r.json();
        if (r.ok && j.ok) {
          authModal.style.display = 'none';
          main.style.display      = 'block';
          initWS();
        } else {
          throw new Error('授权失败');
        }
      } catch (e) {
        authErr.textContent = e.message || '网络错误';
        authErr.style.display = '';
      } finally {
        authBtn.disabled = false;
      }
    });

    // —— 建 WS —— 
    function initWS(){
      chatEl.innerHTML = '';
      if (socket) socket.close();

      const mode = Array.from(modes).find(r=>r.checked).value;
      socket = new WebSocket(WS_API + '?mode=' + mode);
      socket.binaryType = 'arraybuffer';

      socket.onopen    = ()=> append('bot','[已连接]');
      socket.onclose   = ()=> append('bot','[已断开]');
      socket.onerror   = ()=> append('bot','[网络/服务器错误]');
      socket.onmessage = e=>{
        if (typeof e.data === 'string') {
          const msg = JSON.parse(e.data);
          // 后端返回 {en, zh}
          if (msg.en) append('bot','EN → '+ msg.en);
          if (msg.zh) append('bot','ZH → '+ msg.zh);
        } else {
          // 音频流
          const blob = new Blob([e.data],{type:'audio/webm'});
          new Audio(URL.createObjectURL(blob)).play();
        }
      };
    }

    // —— 录音 —— 
    async function startRec(e){
      e.preventDefault();  // 一定要阻止默认滚动/长按菜单
      try {
        const stream = await navigator.mediaDevices.getUserMedia({audio:true});
        const opts = MediaRecorder.isTypeSupported('audio/webm;codecs=opus')
                   ? {mimeType:'audio/webm;codecs=opus'}
                   : {};
        recorder = new MediaRecorder(stream, opts);
        recorder.ondataavailable = ev=>{
          if (socket && socket.readyState===1 && ev.data.size>0) {
            socket.send(ev.data);
            append('user','[发送音频片段]');
          }
        };
        recorder.start(250);
        recBtn.textContent = '🎤 录音中…';
      } catch {
        alert('请允许麦克风权限');
      }
    }
    function stopRec(e){
      e.preventDefault();
      if (recorder && recorder.state!=='inactive') recorder.stop();
      recBtn.textContent = '🎤 按住说话';
    }

    // 手机 + 桌面都绑上
    ['pointerdown','touchstart','mousedown'].forEach(ev=>
      recBtn.addEventListener(ev, startRec, {passive:false})
    );
    ['pointerup','pointerleave','touchend','mouseup'].forEach(ev=>
      recBtn.addEventListener(ev, stopRec, {passive:false})
    );

    // 切模式
    modes.forEach(r=> r.addEventListener('change', initWS));

    function append(who, txt){
      const d = document.createElement('div');
      d.className = 'msg ' + who;
      d.textContent = (who==='user'?'👤 ':'🤖 ') + txt;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      main.style.display = 'none';
      authModal.style.display = 'flex';
    });
  })();
  </script>
</body>
</html>
