<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    /* æ ·å¼åŒå‰ï¼Œä¸å˜ */
  </style>
</head>
<body>
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>
    <div class="mode-switch">
      <label><input type="radio" name="mode" value="chat" checked/> å¯¹è¯æ¨¡å¼</label>
      <label><input type="radio" name="mode" value="trans"/> åŒä¼ æ¨¡å¼</label>
    </div>
    <button id="recBtn" disabled>ğŸ¤ æŒ‰ä½è¯´è¯</button>
    <div id="chat"></div>
  </div>

  <div id="authModal">
    <div class="box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input id="authInput" type="password" placeholder="æˆæƒç "/>
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <div id="authErr"></div>
    </div>
  </div>

  <script>
  (function(){
    const BASE      = 'https://translate-assistant.mefans.workers.dev';
    const AUTH_URL  = BASE + '/admin-api/validate-code';
    const WS_BASE   = BASE.replace(/^http/,'ws') + '/admin-api/ws';
    const WRITE_URL = BASE + '/admin-api/records';

    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modes     = document.getElementsByName('mode');

    let socket, recorder;
    let sessionId = '', authCode = '';
    let lastOriginal = '';
    let seq = 0;

    // æˆæƒæµç¨‹ï¼ˆä¸å˜ï¼‰
    authInput.addEventListener('input', () => {
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });
    authBtn.addEventListener('click', async () => {
      authBtn.disabled = true;
      try {
        const r = await fetch(AUTH_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ code: authInput.value.trim() })
        });
        const j = await r.json();
        if (r.ok && j.ok) {
          sessionId = crypto.randomUUID();
          authCode  = authInput.value.trim();
          authModal.style.display = 'none';
          recBtn.disabled = false;  // æˆæƒé€šè¿‡åç«‹å³å¯ç”¨å½•éŸ³
          initSession();
        } else {
          throw new Error(j.error || 'æˆæƒå¤±è´¥');
        }
      } catch(e) {
        authErr.textContent = e.message || 'ç½‘ç»œé”™è¯¯';
        authErr.style.display = '';
      } finally {
        authBtn.disabled = false;
      }
    });

    // å½•éŸ³æŒ‰é’®äº‹ä»¶ï¼ˆä¸å˜ï¼‰
    ['pointerdown','touchstart'].forEach(ev => recBtn.addEventListener(ev, onPointerDown));
    ['pointerup','touchend'  ].forEach(ev => recBtn.addEventListener(ev, onPointerUp));

    function initSession(){
      chatEl.innerHTML = '';
      if (socket) socket.close();
      socket = null;
      // â€”â€” è¿™ä¸€è¡Œå»æ‰ï¼Œé¿å…æ¯æ¬¡é‡è¿éƒ½æŠŠæŒ‰é’®å…³äº† â€”â€” 
      // recBtn.disabled = true;

      const mode = [...modes].find(r=>r.checked).value;
      const url  = `${WS_BASE}?mode=${mode}&session=${sessionId}&auth=${authCode}`;
      socket = new WebSocket(url);
      socket.binaryType = 'arraybuffer';

      socket.onopen = () => {
        append('bot','ğŸ¤– [å·²è¿æ¥]');
        // å¯ä»¥åœ¨è¿™é‡Œå†æ¬¡ç¡®è®¤æŒ‰é’®æ˜¯å¯ç”¨çš„
        recBtn.disabled = false;
      };
      socket.onerror = e => {
        console.error(e);
        append('bot','ğŸ¤– [æœåŠ¡å¼‚å¸¸]');
      };
      socket.onclose = () => {
        append('bot','ğŸ¤– [å·²æ–­å¼€ï¼Œ5såé‡è¿]');
        setTimeout(initSession,5000);
      };

      socket.onmessage = async evt => {
        if (typeof evt.data === 'string') {
          const msg = JSON.parse(evt.data);
          if (msg.who === 'user') {
            lastOriginal = msg.text;
            append('user', msg.text);
          }
          else if (msg.who === 'bot') {
            append('bot', msg.text);
            // å†™å…¥ Supabase
            try {
              await fetch(WRITE_URL, {
                method: 'POST',
                headers: { 'Content-Type':'application/json' },
                body: JSON.stringify([{
                  session_id:    sessionId,
                  auth_code:     authCode,
                  mode:          [...modes].find(r=>r.checked).value,
                  kind:          'text',
                  lang_from:     'auto',
                  lang_to:       'auto',
                  original:      lastOriginal,
                  translated_en: msg.text,
                  translated_zh: null,
                  audio_url:     null,
                  tokens:        msg.tokens||0,
                  cost:          0,
                  seq:           ++seq
                }])
              });
            } catch(e) {
              console.error('å†™å…¥å¤±è´¥', e);
            }
          }
          else if (msg.who === '_meta') {
            console.log('_meta', msg);
          }
        }
        else if (evt.data instanceof ArrayBuffer) {
          const blob = new Blob([evt.data], { type:'audio/webm; codecs=opus' });
          new Audio(URL.createObjectURL(blob)).play().catch(console.error);
        }
      };

      // åˆ‡æ¢æ¨¡å¼é‡è¿
      [...modes].forEach(r=>r.onchange = initSession);
    }

    // å½•éŸ³é€»è¾‘ï¼ˆä¸å˜ï¼‰
    let chunks = [];
    async function onPointerDown() {
      if (recBtn.disabled) return;
      recBtn.classList.add('recording');
      recBtn.textContent = 'ğŸ›‘ å½•éŸ³ä¸­...';
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        recorder = new MediaRecorder(stream);
        chunks = [];
        recorder.ondataavailable = e => chunks.push(e.data);
        recorder.onstop = () => socket?.send(new Blob(chunks, { type:'audio/webm' }));
        recorder.start();
        append('user','ğŸ‘¤ [å¼€å§‹å½•éŸ³]');
      } catch(err) {
        console.error(err);
        alert('è¯·å…è®¸éº¦å…‹é£');
        recBtn.classList.remove('recording');
        recBtn.textContent = 'ğŸ¤ æŒ‰ä½è¯´è¯';
      }
    }
    function onPointerUp() {
      if (recorder && recorder.state!=='inactive') recorder.stop();
      recBtn.classList.remove('recording');
      recBtn.textContent = 'ğŸ¤ æŒ‰ä½è¯´è¯';
      append('user','ğŸ‘¤ [ç»“æŸå½•éŸ³]');
    }

    // è¾…åŠ©ï¼šè¿½åŠ æ¶ˆæ¯
    function append(who, txt){
      const d = document.createElement('div');
      d.className = 'msg ' + who;
      d.textContent = txt;
      chatEl.appendChild(d);
      chatEl.scrollTop = chatEl.scrollHeight;
    }
  })();
  </script>
</body>
</html>
