<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    /* â€”â€”â€” å…¨å±€ â€”â€”â€” */
    * { box-sizing:border-box; margin:0; padding:0 }
    body {
      font-family: 'Segoe UI','Helvetica Neue',Arial,sans-serif;
      background: #f0f2f5;
      color: #333;
      min-height: 100vh;
      overflow: auto;
    }

    /* â€”â€”â€” æˆæƒå¼¹çª— & é®ç½© â€”â€”â€” */
    #authModal {
      position:fixed; inset:0;
      background: rgba(255,255,255,0.2);
      backdrop-filter: blur(2px);
      display:flex; align-items:center; justify-content:center;
      z-index:1000;
    }
    #authModal .modal-box {
      width:90%; max-width:400px;
      background:#fff; border-radius:12px;
      padding:2rem; box-shadow:0 8px 24px rgba(0,0,0,0.1);
    }
    #authModal h2 { font-size:1.5rem; margin-bottom:1rem }
    #authModal input {
      width:100%; padding:.75rem; font-size:1rem;
      border:1px solid #ccc; border-radius:6px;
      margin-bottom:1rem;
    }
    #authModal button {
      width:100%; padding:.75rem; font-size:1rem;
      background:#3b82f6; color:#fff; border:none;
      border-radius:6px; cursor:pointer;
      transition:background .2s;
    }
    #authModal button:disabled {
      background:#8fbefc; cursor:not-allowed;
    }
    #authModal button:not(:disabled):hover {
      background:#2563eb;
    }
    #authErr {
      color:#d9534f; font-size:.9rem;
      margin-top:.5rem; display:none;
    }

    /* â€”â€”â€” ä¸»ç•Œé¢å¡ç‰‡ â€”â€”â€” */
    #main {
      display:none;
      max-width:500px; margin:2rem auto;
      background:#fff; border-radius:12px;
      padding:1.5rem; box-shadow:0 4px 20px rgba(0,0,0,0.05);
    }
    #main h1 {
      text-align:center;
      font-size:1.5rem;
      margin-bottom:1rem;
    }

    /* â€”â€”â€” æ¨¡å¼åˆ‡æ¢æŒ‰é’® â€”â€”â€” */
    .mode-switch {
      display:flex; gap:.5rem; margin-bottom:1rem;
      justify-content:center;
    }
    .mode-switch button {
      flex:1; padding:.6rem 0;
      font-size:1rem; border:1px solid #ccc;
      background:#f9f9f9; color:#333;
      border-radius:6px; cursor:pointer;
      transition:background .2s, border-color .2s;
    }
    .mode-switch button.active {
      background:#3b82f6; border-color:#3b82f6;
      color:#fff;
    }
    .mode-switch button:not(.active):hover {
      background:#e6e6e6;
    }

    /* â€”â€”â€” å½•éŸ³æŒ‰é’® â€”â€”â€” */
    #recBtn {
      width:100%; padding:.75rem;
      font-size:1rem; background:#3b82f6;
      color:#fff; border:none; border-radius:6px;
      cursor:pointer; user-select:none;
      transition:background .2s;
      margin-bottom:1rem;
    }
    #recBtn:active { background:#2563eb }

    /* â€”â€”â€” è¾“å‡ºåŒº â€”â€”â€” */
    #chat {
      height:200px; overflow-y:auto;
      border:1px solid #ddd; border-radius:6px;
      padding:.75rem; background:#fafafa;
      font-size:.95rem; line-height:1.4;
      white-space:pre-wrap;
    }
    #chat::-webkit-scrollbar { width:4px }
    #chat::-webkit-scrollbar-thumb {
      background:rgba(0,0,0,0.1); border-radius:2px;
    }
  </style>
</head>
<body>
  <!-- æˆæƒå¼¹çª— -->
  <div id="authModal">
    <div class="modal-box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input type="password" id="authInput" placeholder="æˆæƒç "/>
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <div id="authErr"></div>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>

    <!-- æ¨¡å¼åˆ‡æ¢ -->
    <div class="mode-switch">
      <button id="modeChat" class="active">å¯¹è¯æ¨¡å¼</button>
      <button id="modeTrans">åŒä¼ æ¨¡å¼</button>
    </div>

    <!-- å½•éŸ³æŒ‰é’® -->
    <button id="recBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>

    <!-- æ–‡æœ¬è¾“å‡º -->
    <div id="chat"></div>
  </div>

  <script>
  (function(){
    const AUTH_API     = 'https://translate-assistant.mefans.workers.dev/admin-api/validate-code';
    const START_API    = 'https://translate-assistant.mefans.workers.dev/admin-api/start-session';
    const WS_ENDPOINT  = 'wss://translate-assistant.mefans.workers.dev/admin-api/ws';

    // å…ƒç´ 
    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const chatEl    = document.getElementById('chat');
    const recBtn    = document.getElementById('recBtn');
    const btnChat   = document.getElementById('modeChat');
    const btnTrans  = document.getElementById('modeTrans');

    let sessionId, ws, recorder;
    let mode = 'chat'; // é»˜è®¤å¯¹è¯æ¨¡å¼

    // â€”â€” æˆæƒæµç¨‹ â€”â€”  
    authInput.addEventListener('input', ()=> {
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });
    authBtn.addEventListener('click', async ()=>{
      authBtn.disabled = true;
      try {
        const resp = await fetch(AUTH_API, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ code: authInput.value.trim() })
        });
        const j = await resp.json();
        if (resp.ok && j.ok) {
          authModal.style.display='none';
          main.style.display='block';
          startSession();
        } else {
          authErr.textContent='æˆæƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æˆæƒç ';
          authErr.style.display='';
        }
      } catch {
        authErr.textContent='ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        authErr.style.display='';
      } finally {
        authBtn.disabled=false;
      }
    });

    // â€”â€” æ¨¡å¼åˆ‡æ¢ â€”â€”  
    btnChat.addEventListener('click', ()=>{
      mode='chat';
      btnChat.classList.add('active');
      btnTrans.classList.remove('active');
      restartSession();
    });
    btnTrans.addEventListener('click', ()=>{
      mode='trans';
      btnTrans.classList.add('active');
      btnChat.classList.remove('active');
      restartSession();
    });

    // â€”â€” å¯åŠ¨/é‡å¯ ä¼šè¯ â€”â€”  
    async function startSession(){
      chatEl.textContent = '';
      // 1) è¯·æ±‚ session_id
      const r1 = await fetch(START_API, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ mode })
      });
      const d1 = await r1.json();
      sessionId = d1.session_id;

      // 2) å»º WS
      if (ws) ws.close();
      ws = new WebSocket(`${WS_ENDPOINT}?session_id=${sessionId}&mode=${mode}`);
      ws.binaryType = 'arraybuffer';
      ws.onmessage = evt=>{
        if (evt.data instanceof ArrayBuffer) {
          // æ’­æ”¾æ”¶åˆ°çš„è¯­éŸ³
          const blob = new Blob([evt.data],{type:'audio/webm'});
          new Audio(URL.createObjectURL(blob)).play();
        } else {
          // æ˜¾ç¤ºæ”¶åˆ°çš„æ–‡æœ¬
          try {
            const msg = JSON.parse(evt.data);
            if (msg.text) {
              chatEl.textContent += msg.text + '\n';
              chatEl.scrollTop = chatEl.scrollHeight;
            }
          } catch {}
        }
      };

      // 3) æ„é€  recorder
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
        recorder = new MediaRecorder(stream);
        recorder.ondataavailable = e=>{
          if (ws.readyState===WebSocket.OPEN && e.data.size>0) {
            ws.send(e.data);
          }
        };
      } catch {
        alert('æ— æ³•è·å–éº¦å…‹é£æƒé™');
      }

      // 4) ç»‘å®šé•¿æŒ‰å½•éŸ³
      recBtn.onpointerdown = ()=> recorder?.state==='inactive' && recorder.start();
      recBtn.onpointerup   = ()=> recorder?.state==='recording' && recorder.stop();
    }

    function restartSession(){
      if (!sessionId) return;
      startSession();
    }
  })();
  </script>
</body>
</html>
