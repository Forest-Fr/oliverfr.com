<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>åŒæ¨¡å¼è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    /* å…¨å±€ & æˆæƒå¼¹çª—ï¼ˆä¿æŒä¸å˜ï¼‰ */
    body {
      font-family: sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 1rem;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .modal-box {
      background: #fff;
      padding: 2rem;
      border-radius: 8px;
      max-width: 400px;
      width: 100%;
    }
    .modal-box input {
      width: 100%;
      padding: 0.5rem;
      margin-top: 1rem;
      box-sizing: border-box;
    }
    .modal-box button {
      padding: 0.5rem 1rem;
      margin-top: 1rem;
      width: 100%;
    }
    .modal-box p {
      color: red;
      margin-top: 0.5rem;
      display: none;
    }

    /* ä¸»ç•Œé¢ï¼ˆæˆæƒåæ˜¾ç¤ºï¼‰ */
    #main {
      display: none; /* åˆå§‹éšè— */
      max-width: 500px;
      margin: 2rem auto;
      background: #fff;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    #main h1 {
      margin-top: 0;
      font-size: 1.5rem;
      text-align: center;
    }
    /* æ¨¡å¼ä¸‹æ‹‰ */
    #modeSelect {
      padding: 0.5rem;
      margin-bottom: 1rem;
      width: 100%;
      box-sizing: border-box;
    }
    /* å½•éŸ³æŒ‰é’® */
    #recBtn {
      display: block;
      width: 100%;
      padding: 0.75rem;
      font-size: 1rem;
      background: #3b82f6;
      color: #fff;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 1rem;
      user-select: none;
      touch-action: none;
    }
    #recBtn:active {
      background: #2563eb;
    }
    /* èŠå¤©/è¾“å‡ºåŒº */
    #chat {
      height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 0.5rem;
      border-radius: 4px;
      background: #f9fafb;
      font-size: 0.95rem;
      line-height: 1.4;
      white-space: pre-wrap;
    }
    /* éšè—æ»šåŠ¨æ¡åœ¨ iOS ä¸Š */
    #chat::-webkit-scrollbar { width: 4px; }
    #chat::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 2px; }
  </style>
</head>
<body>
  <!-- æˆæƒç™»å½•å¼¹çª— -->
  <div class="modal" id="authModal">
    <div class="modal-box">
      <h2>è¯·è¾“å…¥æˆæƒç </h2>
      <input type="password" id="authInput" placeholder="æˆæƒç " />
      <button id="authBtn" disabled>ç¡®è®¤</button>
      <p id="authErr"></p>
    </div>
  </div>

  <!-- ä¸»ç•Œé¢ -->
  <div id="main">
    <h1>è¯­éŸ³åŠ©æ‰‹</h1>
    <label>
      æ¨¡å¼ï¼š
      <select id="modeSelect">
        <option value="chat">å¯¹è¯æ¨¡å¼</option>
        <option value="trans">åŒä¼ æ¨¡å¼</option>
      </select>
    </label>
    <button id="recBtn">ğŸ¤ æŒ‰ä½è¯´è¯</button>
    <div id="chat"></div>
  </div>

  <script>
  (function(){
    // API & WS
    const AUTH_API    = 'https://translate-assistant.mefans.workers.dev/admin-api/validate-code';
    const START_API   = 'https://translate-assistant.mefans.workers.dev/admin-api/start-session';
    const WS_ENDPOINT = 'wss://translate-assistant.mefans.workers.dev/admin-api/ws';

    // å…ƒç´ 
    const authModal = document.getElementById('authModal');
    const authInput = document.getElementById('authInput');
    const authBtn   = document.getElementById('authBtn');
    const authErr   = document.getElementById('authErr');
    const main      = document.getElementById('main');
    const recBtn    = document.getElementById('recBtn');
    const chatEl    = document.getElementById('chat');
    const modeSel   = document.getElementById('modeSelect');

    let sessionId, ws, recorder;

    // â€”â€” æˆæƒæµç¨‹ â€”â€” 
    authInput.addEventListener('input', () => {
      authBtn.disabled = !authInput.value.trim();
      authErr.style.display = 'none';
    });

    authBtn.addEventListener('click', async () => {
      authBtn.disabled = true;
      try {
        const resp = await fetch(AUTH_API, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ code: authInput.value.trim() })
        });
        const j = await resp.json();
        if (resp.ok && j.ok) {
          authModal.style.display = 'none';
          main.style.display      = 'block';
          startSession();
        } else {
          authErr.textContent = 'æˆæƒå¤±è´¥ï¼Œè¯·æ£€æŸ¥æˆæƒç ';
          authErr.style.display = '';
        }
      } catch (e) {
        console.error(e);
        authErr.textContent = 'ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•';
        authErr.style.display = '';
      } finally {
        authBtn.disabled = false;
      }
    });

    // â€”â€” å¯åŠ¨ä¼šè¯ & WS & å½•éŸ³ â€”â€” 
    async function startSession(){
      // 1) å¼€æ–°ä¼šè¯
      const mode = modeSel.value;
      let res = await fetch(START_API, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ mode })
      });
      let data = await res.json();
      sessionId = data.session_id;

      // 2) å»º WS
      if (ws) ws.close();
      ws = new WebSocket(`${WS_ENDPOINT}?session_id=${sessionId}&mode=${mode}`);
      ws.binaryType = 'arraybuffer';
      ws.onmessage = evt => {
        // äºŒè¿›åˆ¶éŸ³é¢‘ï¼šæ’­æ”¾
        if (evt.data instanceof ArrayBuffer) {
          const blob = new Blob([evt.data], { type:'audio/webm' });
          new Audio(URL.createObjectURL(blob)).play();
        }
        // æ–‡æœ¬ä¹Ÿå¯ä»¥ä¸€èµ·è¿”å›ï¼ˆå¯é€‰ï¼‰
        else {
          try {
            let msg = JSON.parse(evt.data);
            if (msg.text) {
              chatEl.innerText += msg.text + '\n';
              chatEl.scrollTop = chatEl.scrollHeight;
            }
          } catch{}
        }
      };
      ws.onopen    = ()=>console.log('WS å·²è¿æ¥');
      ws.onclose   = ()=>console.log('WS å·²å…³é—­');
      ws.onerror   = e=>console.error('WS é”™è¯¯',e);

      // 3) é•¿æŒ‰å½•éŸ³
      navigator.mediaDevices.getUserMedia({audio:true})
        .then(stream => {
          recorder = new MediaRecorder(stream);
          recorder.ondataavailable = e => {
            if (ws.readyState === WebSocket.OPEN && e.data.size>0) {
              ws.send(e.data);
            }
          };
        })
        .catch(() => alert('æ— æ³•è·å–éº¦å…‹é£æƒé™'));

      recBtn.addEventListener('pointerdown', ()=> {
        if (recorder && recorder.state==='inactive') recorder.start();
      });
      recBtn.addEventListener('pointerup', ()=> {
        if (recorder && recorder.state==='recording') recorder.stop();
      });

      // 4) æ¨¡å¼åˆ‡æ¢é‡å¯
      modeSel.onchange = startSession;
    }

  })();
  </script>
</body>
</html>
