<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>CV ç®¡ç†åå°</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- åªä¿ç•™ Markdown æ¸²æŸ“åº“ -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
  /* åŸºç¡€é‡ç½®ä¸å­—ä½“ */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: #f5f7fa;
    color: #333;
    line-height: 1.6;
    padding: 1rem;
  }
  h1 {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 1rem;
  }

  /* å®¹å™¨ */
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* ç™»å½•/ç™»å‡º åŒºåŸŸï¼šå±…ä¸­ */
  #auth {
    display: flex;
    justify-content: center;
    margin-bottom: 1rem;
  }
  #auth button {
    background: #24292e;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
  }
  #auth button + button {
    margin-left: 0.5rem;
  }

  /* æœç´¢æ¡† */
  #search {
    width: 100%;
    padding: 0.5rem;
    font-size: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  /* ä¸»ä½“å¸ƒå±€ï¼šç§»åŠ¨ç«¯å‚ç›´ï¼Œæ¡Œé¢ç«¯å·¦å³å¹¶åˆ— */
  .main {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  @media (min-width: 768px) {
    .main { flex-direction: row; }
    .table-wrapper { flex: 2; }
    .preview-wrapper { flex: 1; }
  }

  /* è¡¨æ ¼ä¸é¢„è§ˆé€šç”¨æ ·å¼ */
  .table-wrapper,
  .preview-wrapper {
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1rem;
    overflow-x: auto;
  }

  /* è¡¨æ ¼ */
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 0.6rem 0.8rem;
    text-align: left;
    border-bottom: 1px solid #eee;
  }
  th {
    background: #fafafa;
    font-weight: 600;
  }

  /* åˆ†é¡µ */
  #pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 0.75rem;
  }
  #pagination button {
    background: #0366d6;
    color: #fff;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    margin: 0 0.5rem;
  }
  #pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Markdown é¢„è§ˆ */
  #preview h2 {
    margin-bottom: 0.5rem;
  }
  #markdownPreview {
    line-height: 1.8;
  }

  /* ç¼–è¾‘æµ®å±‚ & é®ç½© */
  #modalOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    z-index: 900;
  }
  #editorModal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 600px;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 1.5rem;
    display: none;
    z-index: 1000;
  }
  #editorModal h2 {
    margin-bottom: 1rem;
    font-size: 1.25rem;
  }
  #editorModal textarea {
    width: 100%;
    height: 8rem;
    margin-bottom: 1rem;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
  }
  #editorModal button {
    background: #0366d6;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 0.5rem;
  }

  /* Responsive typography & spacing on small screens */
  @media (max-width: 480px) {
    h1 { font-size: 1.5rem; }
    #search { font-size: 0.9rem; }
    th, td { font-size: 0.85rem; padding: 0.5rem; }
    #pagination button { padding: 0.3rem 0.6rem; }
  }
</style>

</head>
<body>
  <h1>CV ç®¡ç†åå°</h1>

 <!-- Google ç™»å½•/ç™»å‡º -->
  <div id="auth">
    <button id="loginBtn">Google ç™»å½•</button>
    <button id="logoutBtn" style="display:none">ç™»å‡º</button>
  </div>

  <div id="content" class="container" style="display:none">
    <!-- æœç´¢ -->
    <input type="text" id="search" placeholder="æœç´¢åŸå§‹ç®€å†å†…å®¹â€¦ (å›è½¦æœç´¢)" />

    <div class="main">
      <!-- å·¦ä¾§ï¼šè¡¨æ ¼ + åˆ†é¡µ -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>ç”¨æˆ·</th>
              <th>åˆ›å»ºæ—¶é—´</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>

        <div id="pagination">
          <button id="prevPage">ä¸Šä¸€é¡µ</button>
          <span id="pageInfo"></span>
          <button id="nextPage">ä¸‹ä¸€é¡µ</button>
        </div>
      </div>

      <!-- å³ä¾§ï¼šMarkdown é¢„è§ˆ -->
      <div class="preview-wrapper" id="preview">
        <h2>é¢„è§ˆ (Markdown æ¸²æŸ“)</h2>
        <div id="markdownPreview">ç‚¹å‡»â€œé¢„è§ˆâ€æŒ‰é’®æŸ¥çœ‹ç®€å†å†…å®¹</div>
      </div>
    </div>
  </div>

  <div id="modalOverlay"></div>
  <div id="editorModal">
    <h2>ç¼–è¾‘ç®€å†</h2>
    <textarea id="editOriginal" placeholder="åŸå§‹ç®€å† (Markdown)"></textarea>
    <textarea id="editEdited"   placeholder="ä¼˜åŒ–åç®€å† (Markdown)"></textarea>
    <button id="saveEdit">ä¿å­˜</button>
    <button id="cancelEdit">å–æ¶ˆ</button>
  </div>

  <script>
  // â€”â€” å¦‚æœä½ æŠŠ Worker éƒ¨ç½²åœ¨ https://oliverfr.comï¼Œé‚£ä¹ˆ API_BASE å°±ç•™ç©º
    //    å¦‚æœå¦ä¸€ä¸ªå­åŸŸï¼Œæ¯”å¦‚ https://api.oliverfr.comï¼Œå¡« "/api" æˆ–å®Œæ•´åŸŸå
  const API_BASE = 'https://cv-edit-worker.mefans.workers.dev';
    // â€”â€” Helper: åŒ—äº¬æ—¶é—´æ ¼å¼ â€”â€” 
    function formatBeijing(iso) {
      if (!iso) return 'â€”';
      return new Intl.DateTimeFormat('zh-CN', {
        timeZone: 'Asia/Shanghai',
        year:   'numeric',
        month:  '2-digit',
        day:    '2-digit',
        hour:   '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).format(new Date(iso));
    }

    // â€”â€” ç™»å½•/ç™»å‡º æŒ‰é’® â€”â€” 
    const loginBtn   = document.getElementById("loginBtn");
    const logoutBtn  = document.getElementById("logoutBtn");
    const contentEl  = document.getElementById("content");

    // ç™»å½•ï¼šè·³åˆ° Worker çš„ /loginï¼Œç”± Worker å‘èµ· Google OAuth Code Flow
    loginBtn.onclick = () => {
    location.href = `${API_BASE}/g-login`;
  };
    // ç™»å‡ºï¼šPOST /logoutï¼Œå† reload æ¸…ç†ä¼šè¯
     logoutBtn.onclick = async () => {
    await fetch(`${API_BASE}/logout`, { method: 'POST', credentials: 'include' });
    location.reload();
  };

    // â€”â€” æƒé™æ£€æŸ¥ â€”â€” 
    async function checkAuth() {
      console.log("ğŸ” å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€â€¦");
      const resp = await fetch(`${API_BASE}/session`, {
        credentials: "include"
      });
      console.log("ğŸ” /session status:", resp.status);

      if (!resp.ok) {
        // æœªç™»å½•
        loginBtn.style.display  = "";
        logoutBtn.style.display = "none";
        contentEl.style.display = "none";
        return;
      }

      const { authenticated, user } = await resp.json();
      console.log("ğŸ” /session body:", { authenticated, user });

      if (authenticated && user.email === "oliveroogle@gmail.com") {
        // ç®¡ç†å‘˜ä¸“ç”¨
        loginBtn.style.display  = "none";
        logoutBtn.style.display = "";
        contentEl.style.display = "";
        initPage();
      } else {
        alert("åªæœ‰ç®¡ç†å‘˜å¯è®¿é—®æ­¤é¡µé¢");
        loginBtn.style.display  = "";
        logoutBtn.style.display = "none";
        contentEl.style.display = "none";
      }
    }

    // â€”â€” åˆ†é¡µ & æœç´¢ & æ¸²æŸ“ â€”â€”ï¼ˆä¸ä½ å·²æœ‰çš„å®Œå…¨ä¸€è‡´ï¼‰ 
    let currentPage = 1, pageSize = 10, totalCount = 0, lastSearch = "";
    const searchEl    = document.getElementById("search");
    const tableBody   = document.getElementById("tableBody");
    const prevPageBtn = document.getElementById("prevPage");
    const nextPageBtn = document.getElementById("nextPage");
    const pageInfoEl  = document.getElementById("pageInfo");
    const markdownPrv = document.getElementById("markdownPreview");
    const editorModal = document.getElementById("editorModal");
    const editOrigEl  = document.getElementById("editOriginal");
    const editEditEl  = document.getElementById("editEdited");
    const saveEditBtn = document.getElementById("saveEdit");
    const cancelBtn   = document.getElementById("cancelEdit");
    let editingId     = null;

    function initPage() {
      bindEvents();
      fetchAndRender();
    }

    function bindEvents() {
      searchEl.onkeypress = e => {
        if (e.key === "Enter") {
          lastSearch  = searchEl.value.trim();
          currentPage = 1;
          fetchAndRender();
        }
      };
      prevPageBtn.onclick = () => {
        if (currentPage > 1) {
          currentPage--;
          fetchAndRender();
        }
      };
      nextPageBtn.onclick = () => {
        if (currentPage * pageSize < totalCount) {
          currentPage++;
          fetchAndRender();
        }
      };
      cancelBtn.onclick = () => {
        editingId = null;
        editorModal.style.display = "none";
      };
      saveEditBtn.onclick = async () => {
        await fetch(`${API_BASE}/update-resume`, {
          method:      "PATCH",
          credentials: "include",
          headers:     { "Content-Type": "application/json" },
          body: JSON.stringify({
            id:            editingId,
            original_text: editOrigEl.value.trim(),
            edited_text:   editEditEl.value.trim()
          })
        });
        editorModal.style.display = "none";
        fetchAndRender();
      };
    }

    async function fetchAndRender() {
      const resp = await fetch(
        `${API_BASE}/list-resumes?page=${currentPage}&size=${pageSize}&search=${encodeURIComponent(lastSearch)}`,
        { credentials: "include" }
      );
      const { total, data } = await resp.json();
      totalCount = total;

      pageInfoEl.textContent       = `${currentPage} / ${Math.ceil(totalCount / pageSize) || 1}`;
      prevPageBtn.disabled         = currentPage <= 1;
      nextPageBtn.disabled         = currentPage * pageSize >= totalCount;

      tableBody.innerHTML = "";
      data.forEach(r => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.id.slice(0,8)}</td>
          <td>${r.user_id}</td>
          <td>${formatBeijing(r.created_at)}</td>
          <td>
            <button class="btn-preview" data-text="${encodeURIComponent(r.original_text)}">é¢„è§ˆ</button>
            <button class="btn-edit"    data-id="${r.id}">ç¼–è¾‘</button>
            <button class="btn-delete"  data-id="${r.id}">åˆ é™¤</button>
          </td>`;
        tableBody.append(tr);
      });

      document.querySelectorAll(".btn-preview").forEach(el =>
        el.onclick = () => {
          markdownPrv.innerHTML = marked.parse(decodeURIComponent(el.dataset.text));
          window.scrollTo({ top: markdownPrv.offsetTop, behavior: "smooth" });
        }
      );
      document.querySelectorAll(".btn-edit").forEach(el =>
        el.onclick = async () => {
          editingId = el.dataset.id;
          const res = await fetch(`${API_BASE}/get-resume?id=${editingId}`, { credentials: "include" });
          const obj = await res.json();
          editOrigEl.value = obj.original_text;
          editEditEl.value = obj.edited_text || "";
          editorModal.style.display = "";
          window.scrollTo({ top: editorModal.offsetTop, behavior: "smooth" });
        }
      );
      document.querySelectorAll(".btn-delete").forEach(el =>
        el.onclick = async () => {
          if (!confirm("ç¡®è®¤åˆ é™¤è¿™æ¡è®°å½•ï¼Ÿ")) return;
          await fetch(`${API_BASE}/delete-resume?id=${el.dataset.id}`, {
            method:      "DELETE",
            credentials: "include"
          });
          fetchAndRender();
        }
      );
    }

    // â€”â€” é¡µé¢åŠ è½½æ—¶é©¬ä¸Šæ£€æŸ¥æˆæƒ â€”â€” 
    checkAuth();
  </script>
</body>
</html>
