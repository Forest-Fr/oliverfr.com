<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>AI管理后台 — 职业助理</n  </title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;background:#f5f7fa;color:#333;line-height:1.6;padding:1rem}
    h1{font-size:2rem;text-align:center;margin-bottom:1rem}
    .container{max-width:1200px;margin:0 auto}
    #search{width:100%;padding:.5rem;font-size:1rem;margin-bottom:1rem;border:1px solid #ccc;border-radius:4px}
    .main{display:flex;flex-direction:column;gap:1rem}
    @media (min-width:768px){.main{flex-direction:row}.table-wrapper{flex:2}.preview-wrapper{flex:1}}
    .table-wrapper,.preview-wrapper{background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);padding:1rem;overflow-x:auto}
    table{width:100%;border-collapse:collapse}
    th,td{padding:.6rem .8rem;border-bottom:1px solid #eee;text-align:left}
    th{background:#fafafa;font-weight:600}
    #pagination{display:flex;justify-content:center;align-items:center;margin-top:.75rem}
    #pagination button{background:#0366d6;color:#fff;border:0;padding:.4rem .8rem;border-radius:4px;cursor:pointer;margin:0 .5rem}
    #pagination button:disabled{opacity:.5;cursor:not-allowed}
    #preview h2{margin-bottom:.5rem}
    #markdownPreview{line-height:1.8}
    #modalOverlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
    #editorModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:90%;max-width:600px;background:#fff;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);padding:1.5rem;display:none;z-index:1000}
    #editorModal textarea, #editorModal select{width:100%;margin-bottom:0.75rem;padding:.5rem;border:1px solid #ccc;border-radius:4px;font-family:inherit}
    #editorModal .tag-container{display:flex;flex-wrap:wrap;gap:.5rem;margin-bottom:1rem}
    #editorModal .tag{padding:.3rem .6rem;border:1px solid #0366d6;border-radius:4px;color:#0366d6;cursor:pointer}
    #editorModal .tag.selected{background:#0366d6;color:#fff}
    #editorModal button{background:#0366d6;color:#fff;border:0;padding:.5rem 1rem;border-radius:4px;cursor:pointer;margin-right:.5rem}
    #editorModal button:disabled{opacity:.6;cursor:not-allowed}
    #previewModal{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);max-height:80vh;overflow:auto;z-index:1000;width:90%;max-width:700px;background:#fff;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);padding:1.5rem;display:none}
    #previewModal button{float:right;background:#e2e8f0;border:0;border-radius:4px;padding:0 8px;font-size:22px;line-height:24px;cursor:pointer}
    @media (max-width:480px){h1{font-size:1.5rem} #search{font-size:.9rem} th,td{font-size:.85rem;padding:.5rem} #pagination button{padding:.3rem .6rem}}
  </style>
</head>
<body>
  <h1>AI管理后台 — 职业助理</h1>
  <div class="container">
    <input type="text" id="search" placeholder="搜索简历或配置… (回车搜索)" />
    <div class="main">
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>ID</th><th>用户</th><th>创建时间</th>
              <th>Modules</th><th>Style</th><th>Length</th>
              <th>PromptTok</th><th>CompTok</th><th>TotalTok</th><th>成本</th><th>IP</th><th>操作</th>
            </tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div id="pagination">
          <button id="prevPage">上一页</button><span id="pageInfo"></span><button id="nextPage">下一页</button>
        </div>
      </div>
      <div class="preview-wrapper" id="preview">
        <h2>预览 (Markdown 渲染)</h2>
        <div id="markdownPreview">点击预览</div>
      </div>
    </div>
  </div>
  <div id="previewModal"><button id="closePreview">×</button><h2 style="margin-top:0">预览</h2><div id="previewContent" style="line-height:1.8"></div></div>
  <div id="modalOverlay"></div>
  <div id="editorModal">
    <h2>编辑 & 配置</h2>
    <textarea id="editOriginal" placeholder="原始 Markdown"></textarea>
    <textarea id="editEdited" placeholder="优化后 Markdown"></textarea>
    <div class="tag-container" id="moduleTags">
      <span class="tag" data-value="Deep Analysis">深度剖析</span>
      <span class="tag" data-value="Charts">图表</span>
      <span class="tag" data-value="Priority">优先级</span>
      <span class="tag" data-value="Timing">时间估算</span>
    </div>
    <select id="style"><option value="">选择风格</option><option value="Professional">专业</option><option value="Succinct">简洁</option><option value="Data-Driven">数据驱动</option><option value="Storytelling">故事化</option></select>
    <select id="length"><option value="">选择长度</option><option value="≤200 words">≤200 字</option><option value="≤500 words">≤500 字</option><option value="No limit">无限制</option></select>
    <button id="saveEdit">保存</button><button id="cancelEdit">取消</button>
  </div>
<script>
const API_BASE="",pageSize=10;
let currentPage=1,totalCount=0,lastSearch="",editingId=null,selectedModules=[];
const searchEl=document.getElementById('search'),tableBody=document.getElementById('tableBody'),prevPageBtn=document.getElementById('prevPage'),nextPageBtn=document.getElementById('nextPage'),pageInfoEl=document.getElementById('pageInfo');
const modalOverlay=document.getElementById('modalOverlay'),editorModal=document.getElementById('editorModal'),editOrigEl=document.getElementById('editOriginal'),editEditEl=document.getElementById('editEdited'),saveEditBtn=document.getElementById('saveEdit'),cancelBtn=document.getElementById('cancelEdit');
const previewModal=document.getElementById('previewModal'),closePreview=document.getElementById('closePreview'),previewContent=document.getElementById('previewContent'),markdownPrv=document.getElementById('markdownPreview');
const moduleTags=document.querySelectorAll('#moduleTags .tag'),styleEl=document.getElementById('style'),lengthEl=document.getElementById('length');
const fmt=n=>n<10?'0'+n:n;function formatBeijing(iso){const d=new Date(iso);d.setHours(d.getHours()+8);return`${d.getFullYear()}-${fmt(d.getMonth()+1)}-${fmt(d.getDate())} ${fmt(d.getHours())}:${fmt(d.getMinutes())}`;}
function bindEvents(){searchEl.onkeypress=e=>{if(e.key==='Enter'){lastSearch=searchEl.value.trim();currentPage=1;fetchAndRender();}};prevPageBtn.onclick=()=>{if(currentPage>1){currentPage--;fetchAndRender();}};nextPageBtn.onclick=()=>{if(currentPage*pageSize<totalCount){currentPage++;fetchAndRender();}};cancelBtn.onclick=closeEditor;modalOverlay.onclick=e=>{if(e.target===modalOverlay){closeEditor();closePreviewModal();}};saveEditBtn.onclick=saveEdit;closePreview.onclick=closePreviewModal;moduleTags.forEach(tag=>tag.onclick=()=>{tag.classList.toggle('selected');const v=tag.dataset.value;if(tag.classList.contains('selected'))selectedModules.push(v);else selectedModules=selectedModules.filter(x=>x!==v);});}
async function fetchAndRender(){try{const r=await fetch(`${API_BASE}/list-resumes?page=${currentPage}&size=${pageSize}&search=${encodeURIComponent(lastSearch)}`,{credentials:'include'});if(!r.ok)throw'';const{total,data}=await r.json();totalCount=total;pageInfoEl.textContent=`${currentPage}/${Math.ceil(totalCount/pageSize)||1}`;prevPageBtn.disabled=currentPage<=1;nextPageBtn.disabled=currentPage*pageSize>=totalCount;tableBody.innerHTML=data.length?data.map((row,i)=>`<tr><td>${row.id.slice(0,8)}</td><td>${row.user_id}</td><td>${formatBeijing(row.created_at)}</td><td>${(row.modules||[]).join(', ')}</td><td>${row.style||''}</td><td>${row.length||''}</td><td>${row.prompt_tokens||0}</td><td>${row.completion_tokens||0}</td><td>${row.total_tokens||0}</td><td>$${(row.billing_cost||0).toFixed(4)}</td><td>${row.ip_address||''}</td><td><button class="btn-preview" data-index="${i}">预览</button><button class="btn-edit" data-id="${row.id}">编辑</button><button class="btn-delete" data-id="${row.id}">删除</button></td></tr>`).join(''):'<tr><td colspan="12" style="text-align:center;color:#888">暂无数据</td></tr>';}catch(e){alert('加载失败')}document.querySelectorAll('.btn-preview').forEach(b=>b.onclick=()=>{const rec=data[+b.dataset.index];markdownPrv.innerHTML=marked.parse(rec.original_text||'');openPreviewModal();});document.querySelectorAll('.btn-edit').forEach(b=>b.onclick=()=>openEditor(b.dataset.id));document.querySelectorAll('.btn-delete').forEach(b=>b.onclick=()=>delResume(b.dataset.id));}
async function openEditor(id){const r=await fetch(`${API_BASE}/get-resume?id=${id}`,{credentials:'include'}),rec=await r.json();editingId=rec.id;editOrigEl.value=rec.original_text||'';editEditEl.value=rec.edited_text||'';selectedModules=rec.modules||[];moduleTags.forEach(tag=>tag.classList.toggle('selected',selectedModules.includes(tag.dataset.value)));styleEl.value=rec.style||'';lengthEl.value=rec.length||'';modalOverlay.style.display='block';editorModal.style.display='block';}
function closeEditor(){editingId=null;editorModal.style.display='none';modalOverlay.style.display='none';}
async function saveEdit(){saveEditBtn.disabled=true;try{const body={user_id:'admin',resume_id:editingId,text:editEditEl.value.trim(),extras:{modules:selectedModules,style:styleEl.value,length:lengthEl.value}};const r=await fetch(`${API_BASE}/edit-resume`,{method:'POST',credentials:'include',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});if(!r.ok)throw await r.text();closeEditor();fetchAndRender();}catch(e){alert('保存失败:'+e);}finally{saveEditBtn.disabled=false;}}
async function delResume(id){if(!confirm('确认删除？'))return;await fetch(`${API_BASE}/delete-resume?id=${id}`,{method:'DELETE',credentials:'include'});fetchAndRender();}
function openPreviewModal(){modalOverlay.style.display='block';previewModal.style.display='block';}
function closePreviewModal(){previewModal.style.display='none';modalOverlay.style.display='none';}
bindEvents();fetchAndRender();
</script>
</body>
</html>
