<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>CV 管理后台</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- Markdown 渲染库 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
  /* ========= 全局样式 / 布局 ========= */
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial,sans-serif;
    background:#f5f7fa;color:#333;line-height:1.6;padding:1rem
  }
  h1{font-size:2rem;text-align:center;margin-bottom:1rem}
  .container{max-width:1200px;margin:0 auto}
  /* 搜索框 */
  #search{width:100%;padding:.5rem;font-size:1rem;margin-bottom:1rem;
          border:1px solid #ccc;border-radius:4px}
  /* 主体布局：移动端垂直，桌面左右 */
  .main{display:flex;flex-direction:column;gap:1rem}
  @media (min-width:768px){.main{flex-direction:row}
                            .table-wrapper{flex:2}.preview-wrapper{flex:1}}
  /* 盒子通用 */
  .table-wrapper,.preview-wrapper{
    background:#fff;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.1);
    padding:1rem;overflow-x:auto
  }
  /* 表格 */
  table{width:100%;border-collapse:collapse}
  th,td{padding:.6rem .8rem;border-bottom:1px solid #eee;text-align:left}
  th{background:#fafafa;font-weight:600}
  /* 分页 */
  #pagination{display:flex;justify-content:center;align-items:center;margin-top:.75rem}
  #pagination button{background:#0366d6;color:#fff;border:0;padding:.4rem .8rem;
                     border-radius:4px;cursor:pointer;margin:0 .5rem}
  #pagination button:disabled{opacity:.5;cursor:not-allowed}
  /* Markdown 预览 */
  #preview h2{margin-bottom:.5rem}
  #markdownPreview{line-height:1.8}
  /* 弹窗 & 遮罩 */
  #modalOverlay{
    position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;z-index:900}
  #editorModal{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    width:90%;max-width:600px;background:#fff;border-radius:6px;
    box-shadow:0 4px 12px rgba(0,0,0,.15);padding:1.5rem;display:none;z-index:1000}
  #editorModal textarea{width:100%;height:8rem;margin-bottom:1rem;padding:.5rem;
                        border:1px solid #ccc;border-radius:4px;font-family:inherit}
  #editorModal button{background:#0366d6;color:#fff;border:0;padding:.5rem 1rem;
                      border-radius:4px;cursor:pointer;margin-right:.5rem}
  #editorModal button:disabled{opacity:.6;cursor:not-allowed}

  /* 预览弹窗 */
  #previewModal{
    position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
    max-height:80vh;overflow:auto;z-index:1000;width:90%;max-width:700px;
    background:#fff;border-radius:6px;box-shadow:0 4px 12px rgba(0,0,0,.15);
    padding:1.5rem;display:none}
  #previewModal button{float:right;background:#e2e8f0;border:0;border-radius:4px;
                       padding:0 8px;font-size:22px;line-height:24px;cursor:pointer}

  /* 响应式文字 */
  @media (max-width:480px){
    h1{font-size:1.5rem} #search{font-size:.9rem}
    th,td{font-size:.85rem;padding:.5rem}
    #pagination button{padding:.3rem .6rem}
  }
  </style>
</head>

<body>
  <h1>CV 管理后台</h1>

  <!-- 主内容 -->
  <div id="content" class="container">
    <!-- 搜索 -->
    <input type="text" id="search" placeholder="搜索原始简历内容… (回车搜索)" />

    <div class="main">
      <!-- 表格 + 分页 -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>ID</th><th>用户</th><th>创建时间</th><th>操作</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>
        <div id="pagination">
          <button id="prevPage">上一页</button>
          <span id="pageInfo"></span>
          <button id="nextPage">下一页</button>
        </div>
      </div>

      <!-- Markdown 预览侧栏 -->
      <div class="preview-wrapper" id="preview">
        <h2>预览 (Markdown 渲染)</h2>
        <div id="markdownPreview">点击“预览”按钮查看简历内容</div>
      </div>
    </div>
  </div>

  <!-- 预览弹窗 -->
  <div id="previewModal">
    <button id="closePreview">×</button>
    <h2 style="margin-top:0">简历预览</h2>
    <div id="previewContent" style="line-height:1.8"></div>
  </div>

  <!-- 编辑弹窗 & 遮罩 -->
  <div id="modalOverlay"></div>
  <div id="editorModal">
    <h2>编辑简历</h2>
    <textarea id="editOriginal" placeholder="原始简历 (Markdown)"></textarea>
    <textarea id="editEdited"   placeholder="优化后简历 (Markdown)"></textarea>
    <button id="saveEdit">保存</button>
    <button id="cancelEdit">取消</button>
  </div>

<script>
/* ========= 全局常量 ========= */
const API_BASE   = "";          // 同域 Worker，无需加前缀
const pageSize   = 10;

/* ========= DOM ========= */
const searchEl      = document.getElementById('search');
const tableBody     = document.getElementById('tableBody');
const prevPageBtn   = document.getElementById('prevPage');
const nextPageBtn   = document.getElementById('nextPage');
const pageInfoEl    = document.getElementById('pageInfo');

const modalOverlay  = document.getElementById('modalOverlay');
const editorModal   = document.getElementById('editorModal');
const editOrigEl    = document.getElementById('editOriginal');
const editEditEl    = document.getElementById('editEdited');
const saveEditBtn   = document.getElementById('saveEdit');
const cancelBtn     = document.getElementById('cancelEdit');

const previewModal  = document.getElementById('previewModal');
const closePreview  = document.getElementById('closePreview');
const previewContent= document.getElementById('previewContent');
const markdownPrv   = document.getElementById('markdownPreview');

/* ========= 状态 ========= */
let currentPage = 1, totalCount = 0, lastSearch = '', editingId = null;

/* ========= 工具 ========= */
const fmt = n => n<10? '0'+n : n;
function formatBeijing(iso){
  const d = new Date(iso);
  d.setHours(d.getHours()+8);                     // ISO → 北京
  return `${d.getFullYear()}-${fmt(d.getMonth()+1)}-${fmt(d.getDate())} `
       + `${fmt(d.getHours())}:${fmt(d.getMinutes())}`;
}

/* ========= 初始化 ========= */
function initPage(){
  bindEvents();
  fetchAndRender();
}

/* ========= 事件绑定 ========= */
function bindEvents(){
  searchEl.onkeypress = e=>{
    if(e.key==='Enter'){
      lastSearch = searchEl.value.trim();
      currentPage = 1;
      fetchAndRender();
    }
  };
  prevPageBtn.onclick = ()=>{ if(currentPage>1){currentPage--;fetchAndRender();} };
  nextPageBtn.onclick = ()=>{ if(currentPage*pageSize<totalCount){currentPage++;fetchAndRender();} };

  cancelBtn.onclick   = closeEditor;
  modalOverlay.onclick= e=>{
    if(e.target===modalOverlay){ closeEditor(); closePreviewModal(); }
  };
  saveEditBtn.onclick = saveEdit;
  closePreview.onclick= closePreviewModal;
}

/* ========= 列表渲染 ========= */
async function fetchAndRender(){
  try{
    const r = await fetch(`${API_BASE}/list-resumes?page=${currentPage}&size=${pageSize}&search=${encodeURIComponent(lastSearch)}`,
                          { credentials:'include' });
    if(!r.ok) throw new Error(r.status);
    const { total,data } = await r.json();
    totalCount = total;

    pageInfoEl.textContent = `${currentPage}/${Math.ceil(totalCount/pageSize)||1}`;
    prevPageBtn.disabled = currentPage<=1;
    nextPageBtn.disabled = currentPage*pageSize>=totalCount;

    tableBody.innerHTML = data.length
      ? data.map(row=>`
        <tr>
          <td>${row.id.slice(0,8)}</td>
          <td>${row.user_id}</td>
          <td>${formatBeijing(row.created_at)}</td>
          <td>
            <button class="btn-preview" data-text="${encodeURIComponent(row.original_text)}">预览</button>
            <button class="btn-edit" data-id="${row.id}">编辑</button>
            <button class="btn-delete" data-id="${row.id}">删除</button>
          </td>
        </tr>`).join('')
      : '<tr><td colspan="4" style="text-align:center;color:#888">暂无数据</td></tr>';

    /* 行内事件绑定 */
    document.querySelectorAll('.btn-preview').forEach(b=>b.onclick=()=>{
      const html = marked.parse(decodeURIComponent(b.dataset.text));
      markdownPrv.innerHTML = html;
      openPreviewModal(html);
    });
    document.querySelectorAll('.btn-edit').forEach(b=>b.onclick=()=>openEditor(b.dataset.id));
    document.querySelectorAll('.btn-delete').forEach(b=>b.onclick=()=>delResume(b.dataset.id));
  }catch(e){
    alert('加载失败'); console.error(e);
  }
}

/* ========= 编辑 ========= */
async function openEditor(id){
  const r   = await fetch(`${API_BASE}/get-resume?id=${id}`, { credentials:'include' });
  const rec = await r.json();
  editingId        = rec.id;
  editOrigEl.value = rec.original_text||'';
  editEditEl.value = rec.edited_text||'';

  modalOverlay.style.display = 'block';
  editorModal.style.display  = 'block';
}
function closeEditor(){
  editingId=null;
  editorModal.style.display='none';
  modalOverlay.style.display='none';
}
async function saveEdit(){
  saveEditBtn.disabled=true;
  try{
    const body = {
      resume_id: editingId,                      // 已有则更新
      user_id:   'admin',                        // 新增时需要；可改后台逻辑
      text:      editEditEl.value.trim()
    };
    const r = await fetch(`${API_BASE}/edit-resume`, {
      method: 'POST',
      credentials:'include',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });
    if(!r.ok) throw new Error(await r.text());
    closeEditor(); fetchAndRender();
  }catch(e){
    alert('保存失败: '+e.message);
  }finally{
    saveEditBtn.disabled=false;
  }
}

/* ========= 删除 ========= */
async function delResume(id){
  if(!confirm('确认删除？')) return;
  await fetch(`${API_BASE}/delete-resume?id=${id}`,{method:'DELETE',credentials:'include'});
  fetchAndRender();
}

/* ========= 预览弹窗 ========= */
function openPreviewModal(html){
  previewContent.innerHTML=html;
  modalOverlay.style.display='block';
  previewModal.style.display='block';
}
function closePreviewModal(){
  previewModal.style.display='none';
  modalOverlay.style.display='none';
}

/* ========= 启动 ========= */
initPage();
</script>
</body>
</html>
