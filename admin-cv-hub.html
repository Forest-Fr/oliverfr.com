<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>CV 管理后台</title>
  <script>
    if (location.hash.includes("access_token")) {
      const query = location.hash.slice(1);
      location.replace("https://oliverfr.com/callback?" + query);
    }
  </script>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <!-- 只保留 Markdown 渲染库 -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
  /* 基础重置与字体 */
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
    background: #f5f7fa;
    color: #333;
    line-height: 1.6;
    padding: 1rem;
  }
  h1 {
    text-align: center;
    font-size: 2rem;
    margin-bottom: 1rem;
  }

  /* 容器 */
  .container {
    max-width: 1200px;
    margin: 0 auto;
  }

  /* 登录/登出 区域：居中 */
  #auth {
    display: flex;
    justify-content: center;
    margin-bottom: 1rem;
  }
  #auth button {
    background: #24292e;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
  }
  #auth button + button {
    margin-left: 0.5rem;
  }

  /* 搜索框 */
  #search {
    width: 100%;
    padding: 0.5rem;
    font-size: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #ccc;
    border-radius: 4px;
  }

  /* 主体布局：移动端垂直，桌面端左右并列 */
  .main {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }
  @media (min-width: 768px) {
    .main { flex-direction: row; }
    .table-wrapper { flex: 2; }
    .preview-wrapper { flex: 1; }
  }

  /* 表格与预览通用样式 */
  .table-wrapper,
  .preview-wrapper {
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    padding: 1rem;
    overflow-x: auto;
  }

  /* 表格 */
  table {
    width: 100%;
    border-collapse: collapse;
  }
  th, td {
    padding: 0.6rem 0.8rem;
    text-align: left;
    border-bottom: 1px solid #eee;
  }
  th {
    background: #fafafa;
    font-weight: 600;
  }

  /* 分页 */
  #pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    margin-top: 0.75rem;
  }
  #pagination button {
    background: #0366d6;
    color: #fff;
    border: none;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    margin: 0 0.5rem;
  }
  #pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Markdown 预览 */
  #preview h2 {
    margin-bottom: 0.5rem;
  }
  #markdownPreview {
    line-height: 1.8;
  }

  /* 编辑浮层 & 遮罩 */
  #modalOverlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.4);
    display: none;
    z-index: 900;
  }
  #editorModal {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 600px;
    background: #fff;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    padding: 1.5rem;
    display: none;
    z-index: 1000;
  }
  #editorModal h2 {
    margin-bottom: 1rem;
    font-size: 1.25rem;
  }
  #editorModal textarea {
    width: 100%;
    height: 8rem;
    margin-bottom: 1rem;
    padding: 0.5rem;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-family: inherit;
  }
  #editorModal button {
    background: #0366d6;
    color: #fff;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    margin-right: 0.5rem;
  }

  /* Responsive typography & spacing on small screens */
  @media (max-width: 480px) {
    h1 { font-size: 1.5rem; }
    #search { font-size: 0.9rem; }
    th, td { font-size: 0.85rem; padding: 0.5rem; }
    #pagination button { padding: 0.3rem 0.6rem; }
  }
</style>

</head>
<body>
 <body>
   <h1>CV 管理后台</h1>

  <!-- GitHub 登录/登出 不用动 -->
  <div id="auth">
    <button id="loginBtn">GitHub 登录</button>
    <button id="logoutBtn" style="display:none">登出</button>
  </div>

  <!-- 把下面这层加上 id="content"，并且初始隐藏 -->
  <div id="content" class="container" style="display:none">
    <!-- 搜索 -->
    <input type="text" id="search" placeholder="搜索原始简历内容… (回车搜索)" />

    <!-- 主体：左右两栏 -->
    <div class="main">

      <!-- 左侧：表格 + 分页 -->
      <div class="table-wrapper">
        <table>
          <thead>
            <tr><th>ID</th><th>用户</th><th>创建时间</th><th>操作</th></tr>
          </thead>
          <tbody id="tableBody"></tbody>
        </table>

        <div id="pagination">
          <button id="prevPage">上一页</button>
          <span id="pageInfo"></span>
          <button id="nextPage">下一页</button>
        </div>
      </div>

      <!-- 右侧：Markdown 预览 -->
      <div class="preview-wrapper" id="preview">
        <h2>预览 (Markdown 渲染)</h2>
        <div id="markdownPreview">点击“预览”按钮查看简历内容</div>
      </div>
    </div>
  </div>

  <!-- 编辑模态 & 遮罩 -->
  <div id="modalOverlay" style="display:none"></div>
  <div id="editorModal" style="display:none">
    <h2>编辑简历</h2>
    <textarea id="editOriginal" placeholder="原始简历 (Markdown)"></textarea>
    <textarea id="editEdited"   placeholder="优化后简历 (Markdown)"></textarea>
    <button id="saveEdit">保存</button>
    <button id="cancelEdit">取消</button>
  </div>
</body>


  <script>
  const API_BASE = "https://cv-edit-worker.mefans.workers.dev";




// ---- 登录 / 登出 ----
const loginBtn  = document.getElementById("loginBtn");
const logoutBtn = document.getElementById("logoutBtn");
const contentEl = document.getElementById("content");

loginBtn.onclick = () => {
  location.href = `${API_BASE}/login`;
};
logoutBtn.onclick = async () => {
  await fetch(`${API_BASE}/logout`, { method: "POST", credentials: "include" });
  location.reload();
};

// ---- 鉴权 ----
async function checkAuth() {
  const resp = await fetch(`${API_BASE}/session`, { credentials: "include" });
  if (!resp.ok) {
    loginBtn.style.display = "";
    logoutBtn.style.display = "none";
    contentEl.style.display = "none";
    return;
  }
  const { authenticated, user } = await resp.json();
  if (authenticated && user.email === "oliveroogle@gmail.com") {
    loginBtn.style.display = "none";
    logoutBtn.style.display = "";
    contentEl.style.display = "";
    initPage();
  } else {
    alert("只有管理员 (oliveroogle@gmail.com) 可访问此页面");
    loginBtn.style.display = "";
    logoutBtn.style.display = "none";
    contentEl.style.display = "none";
  }
}

// ---- 主流程状态 ----
let currentPage = 1,
    pageSize    = 10,
    totalCount  = 0,
    lastSearch  = "";

const searchEl      = document.getElementById("search");
const tableBody     = document.getElementById("tableBody");
const prevPageBtn   = document.getElementById("prevPage");
const nextPageBtn   = document.getElementById("nextPage");
const pageInfoEl    = document.getElementById("pageInfo");
const markdownPrv   = document.getElementById("markdownPreview");
const editorModal   = document.getElementById("editorModal");
const editOrigEl    = document.getElementById("editOriginal");
const editEditEl    = document.getElementById("editEdited");
const saveEditBtn   = document.getElementById("saveEdit");
const cancelEditBtn = document.getElementById("cancelEdit");
let editingId = null;

function initPage() {
  bindEvents();
  fetchAndRender();
}

function bindEvents() {
  // 搜索
  searchEl.onkeypress = e => {
    if (e.key === "Enter") {
      lastSearch = searchEl.value.trim();
      currentPage = 1;
      fetchAndRender();
    }
  };
  // 分页按钮
  prevPageBtn.onclick = () => {
    if (currentPage > 1) {
      currentPage--;
      fetchAndRender();
    }
  };
  nextPageBtn.onclick = () => {
    if (currentPage * pageSize < totalCount) {
      currentPage++;
      fetchAndRender();
    }
  };
  // 取消编辑
  cancelEditBtn.onclick = () => {
    editingId = null;
    editorModal.style.display = "none";
  };
  // 保存编辑
  saveEditBtn.onclick = async () => {
    await fetch(`${API_BASE}/update-resume`, {
      method: "PATCH",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        id:           editingId,
        original_text: editOrigEl.value.trim(),
        edited_text:   editEditEl.value.trim()
      })
    });
    editorModal.style.display = "none";
    fetchAndRender();
  };
}

// ---- 获取列表 & 渲染 ----
async function fetchAndRender() {
  const resp = await fetch(
    `${API_BASE}/list-resumes?page=${currentPage}&size=${pageSize}&search=${encodeURIComponent(lastSearch)}`,
    { credentials: "include" }
  );
  const { total, data } = await resp.json();
  totalCount = total;

  // —— 关键三行：更新页码显示 & 按钮禁用 —— 
  pageInfoEl.textContent        = `${currentPage} / ${Math.ceil(totalCount/pageSize)||1}`;
  prevPageBtn.disabled          = currentPage <= 1;
  nextPageBtn.disabled          = currentPage * pageSize >= totalCount;

  // 渲染表格
  tableBody.innerHTML = "";
  data.forEach(row => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.id.slice(0,8)}</td>
      <td>${row.user_id}</td>
      <td>${new Date(row.created_at).toLocaleString()}</td>
      <td>
        <button class="btn-preview" data-text="${encodeURIComponent(row.original_text)}">预览</button>
        <button class="btn-edit"    data-id="${row.id}">编辑</button>
        <button class="btn-delete"  data-id="${row.id}">删除</button>
      </td>`;
    tableBody.append(tr);
  });

  // 绑定行内按钮
  document.querySelectorAll(".btn-preview").forEach(el =>
    el.onclick = () => showPreview(decodeURIComponent(el.dataset.text))
  );
  document.querySelectorAll(".btn-edit").forEach(el =>
    el.onclick = () => openEditor(el.dataset.id)
  );
  document.querySelectorAll(".btn-delete").forEach(el =>
    el.onclick = () => deleteRecord(el.dataset.id)
  );
}

// ---- 预览 / 编辑 / 删除 (unchanged) ----
function showPreview(md) {
  markdownPrv.innerHTML = marked.parse(md);
  window.scrollTo({ top: markdownPrv.offsetTop, behavior: "smooth" });
}

async function openEditor(id) {
  editingId = id;
  const resp = await fetch(`${API_BASE}/get-resume?id=${id}`, { credentials: "include" });
  const obj  = await resp.json();
  editOrigEl.value = obj.original_text;
  editEditEl.value = obj.edited_text || "";
  editorModal.style.display = "";
  window.scrollTo({ top: editorModal.offsetTop, behavior: "smooth" });
}

async function deleteRecord(id) {
  if (!confirm("确认删除这条记录？")) return;
  await fetch(`${API_BASE}/delete-resume?id=${id}`, {
    method: "DELETE",
    credentials: "include"
  });
  fetchAndRender();
}

// ---- 启动鉴权 ----
checkAuth();

  </script>
</body>
</html>
