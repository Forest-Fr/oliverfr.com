<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>æ–‡ç« åå°ç®¡ç†</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />

<!-- ===== â‘  ç»Ÿä¸€é…è‰² / å“åº”å¼ ===== -->
<style>
:root{
  --bg:#f8f8f8;--txt:#111;--card:#fff;--border:#ccc;
  --btn:#333;--btn-h:#555
}
@media(prefers-color-scheme:dark){
  :root{--bg:#1e1e1e;--txt:#eee;--card:#2a2a2a;--border:#444;--btn:#444;--btn-h:#666}
}
*{box-sizing:border-box;margin:0}
body{
  padding:20px;font:16px/1.5 Arial,Helvetica,sans-serif;
  background:var(--bg);color:var(--txt);
  display:flex;flex-direction:column;align-items:center
}
h1{margin:0 0 12px;font-size:26px}
h2{margin:20px 0 10px;font-size:22px}

.btn{
  padding:10px 22px;margin:5px;border:none;cursor:pointer;
  background:var(--btn);color:#fff;border-radius:4px
}
.btn:hover{background:var(--btn-h)}
.btn[disabled]{opacity:.4;cursor:not-allowed}

.hidden{display:none!important}
input[type="text"],textarea{width:100%;margin:6px 0;padding:8px;border:1px solid var(--border);border-radius:4px}
textarea{resize:vertical;min-height:140px}

table{
  width:100%;max-width:960px;border-collapse:collapse;margin-top:20px;background:var(--card)
}
th,td{border:1px solid var(--border);padding:8px;text-align:left}
th{background:rgba(0,0,0,.06)}
td.content,td.author{
  max-width:340px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap
}

.admin-bar{max-width:960px;width:100%;display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;gap:10px}
.admin-bar>div{display:flex;gap:10px;flex-wrap:wrap}

#editorContainer{
  border:1px solid var(--border);min-height:200px;padding:10px;background:var(--card);border-radius:4px
}

/* --- é¢„è§ˆå¼¹çª— + é®ç½© --- */
#previewModal{
  position:fixed;inset:0;display:flex;align-items:flex-start;justify-content:center;
  padding:8vh 16px;z-index:999;background:rgba(0,0,0,.45);cursor:pointer
}
#previewModal>div{
  max-width:760px;width:100%;background:var(--card);color:var(--txt);
  border:1px solid var(--border);border-radius:8px;padding:24px;cursor:auto
}
#markdownContent img{max-width:100%}

@media(max-width:768px){
  .admin-bar{flex-direction:column}
  table,thead,tbody,tr,td,th{display:block}
  thead{display:none}
  tbody tr{border:1px solid var(--border);margin-bottom:15px;background:var(--card)}
  tbody td{border:none;border-bottom:1px solid var(--border);
    display:flex;justify-content:space-between;padding:6px 8px}
  tbody td::before{content:attr(data-label);font-weight:bold;margin-right:6px}
  #submitBtn,#cancelEditBtn,#generateStaticHtmlBtn,#aiBtn{flex:1}
}
</style>

<!-- ===== â‘¡ å¤–éƒ¨ä¾èµ– ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
</head>

<body>
<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<!-- =========== â‘¢ ç™»å½•åŒº =========== -->
<div id="authArea">
  <button id="loginBtn" class="btn">ä½¿ç”¨Â GitHubÂ ç™»å½•</button>
</div>

<!-- =========== â‘£ ç®¡ç†åŒº =========== -->
<div id="adminArea" class="hidden">

  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦">
    <div>
      <button id="searchBtn" class="btn" disabled>ğŸ” æœç´¢</button>
      <button id="logoutBtn" class="btn" disabled>é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
  <input type="text" id="newTitle" placeholder="æ ‡é¢˜">

  <div style="display:flex;gap:10px;flex-wrap:wrap">
    <button id="toggleToEditor"  class="btn" disabled>ğŸ“ å¯è§†åŒ–æ¨¡å¼</button>
    <button id="toggleToTextarea" class="btn hidden" disabled>âœï¸Â MarkdownÂ æ¨¡å¼</button>
  </div>

  <div id="editorContainer" class="hidden"></div>
  <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>

  <input type="file" id="coverInput" accept="image/*">

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0">
    <button id="submitBtn"             class="btn" disabled>æäº¤</button>
    <button id="cancelEditBtn"         class="btn hidden" disabled>å–æ¶ˆç¼–è¾‘</button>
    <button id="generateStaticHtmlBtn" class="btn" disabled>ç”Ÿæˆé™æ€æ–‡ç« æ–‡ä»¶</button>
    <button id="aiBtn"                 class="btn" disabled>AI ç”Ÿæˆæ–‡ç« ç»“æ„+SEO</button>
  </div>

  <div style="overflow-x:auto;width:100%">
    <table id="articlesTable">
      <thead>
        <tr><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- é¢„è§ˆå¼¹çª— -->
  <div id="previewModal" class="hidden">
    <div>
      <h3 id="previewTitle"></h3>
      <img id="previewCover" style="max-width:100%;margin:10px 0">
      <div id="markdownContent"></div>
    </div>
  </div>
</div>

<!-- =========== â‘¤ ä¸»è„šæœ¬ =========== -->
<script>
/* ---------- é€šç”¨å·¥å…· ---------- */
const $ = id => document.getElementById(id);
const esc = s => (s||'').replace(/[&<>"']/g,
              c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const fmt = s => new Date(s).toLocaleString('zh-CN',{
  hour12:false,timeZone:'Asia/Shanghai'
});
const wk  = s => 'æ—¥ä¸€äºŒä¸‰å››äº”å…­'[ new Date(s).getDay() ];
const toBJ = () => new Date().toLocaleString('sv-SE',{
  timeZone:'Asia/Shanghai'
}).replace(' ','T')+':00+08:00';

/* ---------- Supabase ---------- */
const ENDPOINT   = 'https://copilot-router.mefans.workers.dev';
const ANON_KEY   = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';
const ADMIN_EMAIL = 'oliveroogle@gmail.com';
const supa = supabase.createClient(ENDPOINT, ANON_KEY);

/* ---------- EditorJS æ‡’åŠ è½½ ---------- */
const loadEditorCore = () => new Promise(res=>{
  if(window.EditorJS) return res();
  const s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2';
  s.onload=res; document.head.appendChild(s);
});

/* ---------- å…¨å±€çŠ¶æ€ ---------- */
let editor=null, editingId=null, page=1, limit=6, loading=false;

/* ---------- safeSaveï¼šä»»ä½•åœºæ™¯éƒ½èƒ½æ‹¿åˆ° Markdown ---------- */
async function safeSave(){
  if(!editor) return $('newContent').value.trim();
  try{
    const d=await editor.save();
    return d.blocks.map(b=>b.data.text||'').join('\n\n').trim();
  }catch(e){
    console.warn('[EditorJS save]',e);
    return $('newContent').value.trim();
  }
}

/* ============= â… . ç™»å½• / ç™»å‡º / Session ============= */
window.addEventListener('DOMContentLoaded',async()=>{
  $('loginBtn').onclick=()=>supa.auth.signInWithOAuth({
    provider:'github',options:{redirectTo:location.origin+location.pathname}
  });
  $('logoutBtn').onclick=async()=>{await supa.auth.signOut();location.reload();};

  const {data:{session}}=await supa.auth.getSession();
  if(session?.user?.email===ADMIN_EMAIL){
    $('authArea').classList.add('hidden');
    $('adminArea').classList.remove('hidden');
    document.querySelectorAll('.btn').forEach(b=>b.removeAttribute('disabled'));
    loadArticles(true);
  }
});

/* ============= â…¡. Markdown â†” å¯è§†åŒ– ============= */
$('toggleToEditor').onclick=async()=>{
  await loadEditorCore();
  if(editor) await editor.destroy();

  $('toggleToEditor').classList.add('hidden');
  $('toggleToTextarea').classList.remove('hidden');
  $('newContent').classList.add('hidden');
  $('editorContainer').classList.remove('hidden');

  const holder=$('editorContainer').cloneNode(false);
  $('editorContainer').replaceWith(holder); holder.id='editorContainer';

  editor=new EditorJS({
    holder,
    tools:(()=>{
      const P=window.ParagraphTool||window.Paragraph;
      const H=window.HeaderTool    ||window.Header;
      const t={};
      if(P) t.paragraph={class:P,inlineToolbar:true};
      if(H) t.header   ={class:H,inlineToolbar:true};
      return t;
    })(),
    data:{blocks:[{
      type:'paragraph',
      data:{text:$('newContent').value.replace(/\n/g,'<br>')}
    }]}
  });
};

$('toggleToTextarea').onclick=async()=>{
  $('toggleToTextarea').classList.add('hidden');
  $('toggleToEditor').classList.remove('hidden');
  $('editorContainer').classList.add('hidden');
  $('newContent').classList.remove('hidden');
  $('newContent').value=await safeSave();
  if(editor){await editor.destroy();editor=null;}
  $('editorContainer').innerHTML='';
};

/* ============= â…¢. æ–‡ç« åˆ—è¡¨ ============= */
const tb=$('#articlesTable tbody');

async function loadArticles(reset=false,kw=''){
  if(loading) return; loading=true;
  if(reset){tb.innerHTML='';page=1;}

  let q=supa.from('articles').select('*').order('created_at',{ascending:false})
           .range((page-1)*limit,page*limit-1);
  if(kw) q=q.ilike('title',`%${kw}%`);
  const {data,error}=await q; loading=false;
  if(error) return alert(error.message);

  data.forEach(r=>{
    const tr=document.createElement('tr'); tr.innerHTML=`
      <td data-label="æ ‡é¢˜">${esc(r.title)}</td>
      <td data-label="ä½œè€…" class="author">${esc(r.author_email||'')}</td>
      <td data-label="å†…å®¹" class="content">${esc((r.content||'').slice(0,60))}â€¦</td>
      <td data-label="åˆ›å»ºæ—¶é—´">${fmt(r.created_at)}</td>
      <td data-label="æ›´æ–°æ—¶é—´">${fmt(r.updated_at)}</td>
      <td data-label="æ˜ŸæœŸ">æ˜ŸæœŸ${wk(r.created_at)}</td>
      <td data-label="å°é¢">${r.cover_url?`<img src="${r.cover_url}" height="40">`:''}</td>
      <td data-label="æ“ä½œ">
        <button class="btn" onclick='previewArticle(${JSON.stringify(r)})'>é¢„è§ˆ</button>
        <button class="btn" onclick='editArticle(${JSON.stringify(r)})'>ç¼–è¾‘</button>
        <button class="btn" onclick='deleteArticle("${r.id}")'>åˆ é™¤</button>
      </td>`;
    tb.appendChild(tr);
  });
  if(data.length===limit) page++;
}

$('searchBtn').onclick=()=>loadArticles(true,$('searchInput').value.trim());
window.addEventListener('scroll',()=>{if(!loading&&innerHeight+scrollY>document.body.offsetHeight-100)loadArticles();});

/* ===== é¢„è§ˆå¼¹çª— ===== */
function previewArticle(r){
  $('previewTitle').textContent=r.title;
  $('previewCover').src=r.cover_url||'';
  $('markdownContent').innerHTML=marked.parse(r.content||'');
  $('previewModal').classList.remove('hidden');
}
function closePreview(){ $('previewModal').classList.add('hidden'); }
$('previewModal').addEventListener('click',e=>{
  if(e.target.id==='previewModal') closePreview();
});
window.addEventListener('keyup',e=>{ if(e.key==='Escape') closePreview(); });

window.deleteArticle=async id=>{
  if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;
  const{error}=await supa.from('articles').delete().eq('id',id);
  if(error) alert(error.message);
  else loadArticles(true);
};

window.editArticle=r=>{
  editingId=r.id;
  $('newTitle').value=r.title;
  $('newContent').value=r.content;
  $('cancelEditBtn').classList.remove('hidden');
  if(editor){editor.destroy();editor=null;}
  $('toggleToTextarea').click();
  scrollTo({top:0,behavior:'smooth'});
};

/* ============= â…£. å–æ¶ˆç¼–è¾‘ ============= */
$('cancelEditBtn').onclick=()=>{
  editingId=null;
  $('newTitle').value='';
  $('newContent').value='';
  $('cancelEditBtn').classList.add('hidden');
  if(editor){editor.destroy();editor=null;}
  $('toggleToTextarea').click();
};

/* ============= â…¤. æäº¤ ============= */
$('submitBtn').onclick=async()=>{
  const title=$('newTitle').value.trim();
  const content=await safeSave();
  if(!title||!content) return alert('æ ‡é¢˜/å†…å®¹ä¸èƒ½ä¸ºç©º');

  const {data:{user}}=await supa.auth.getUser();
  const row={
    title,content,
    author_email:user?.email||'',
    updated_at:toBJ()
  };

  /* å°é¢ä¸Šä¼  */
  if(coverInput.files[0]){
    const f=coverInput.files[0];
    const {data:ret,error}=await supa.storage.from('articles')
      .upload(`covers/${Date.now()}_${f.name}`,f,{upsert:true});
    if(error) return alert('å°é¢ä¸Šä¼ å¤±è´¥ï¼š'+error.message);
    row.cover_url=supa.storage.from('articles').getPublicUrl(ret.path).data.publicUrl;
  }

  let err;
  if(editingId){
    ({error:err}=await supa.from('articles').update(row).eq('id',editingId));
  }else{
    row.created_at=row.updated_at;
    ({error:err}=await supa.from('articles').insert([row]));
  }
  if(err) return alert('Supabaseï¼š'+err.message);

  $('cancelEditBtn').click(); loadArticles(true);
};

/* ============= â…¥. AI ç”Ÿæˆ ============= */
$('aiBtn').onclick=async()=>{
  const topic=$('newTitle').value.trim();
  if(!topic) return alert('è¯·å…ˆå¡«å†™æ ‡é¢˜');
  $('aiBtn').disabled=true; $('aiBtn').textContent='â³ GPT ç”Ÿæˆä¸­â€¦';
  try{
    const j=await fetch(`${ENDPOINT}/gpt`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({topic})
    }).then(r=>r.json());
    if(!j.success) throw new Error(j.message||'ç”Ÿæˆå¤±è´¥');
    $('newContent').value=j.article_body||'';
    if(editor){
      await editor.blocks.clear();
      await editor.blocks.insert('paragraph',{text:j.article_body});
    }
  }catch(e){alert(e.message);}
  finally{$('aiBtn').disabled=false;$('aiBtn').textContent='AI ç”Ÿæˆæ–‡ç« ç»“æ„+SEO';}
};

/* ============= â…¦. ç”Ÿæˆé™æ€ HTML ============= */
$('generateStaticHtmlBtn').onclick=async()=>{
  const title=$('newTitle').value.trim();
  const content=await safeSave();
  if(!title||!content) return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');

  const slug=title.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
  const createdAt=toBJ().split('T')[0];
  const logoUrl='https://oliverfr.com/assets/logo.png';

  const html=`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/>
<title>${esc(title)} | MeFan æŠ€æœ¯åšå®¢</title>
<meta name="description" content="${esc(title)}"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<link rel="canonical" href="https://oliverfr.com/articles/${slug}.html"/>
<style>body{font-family:Arial,Helvetica,sans-serif;max-width:700px;margin:40px auto;line-height:1.6}h1{font-size:28px}</style>
</head><body>
<img src="${logoUrl}" alt="logo" style="display:block;margin:0 auto 20px;height:60px">
<h1>${esc(title)}</h1>
<div style="color:#888;font-size:14px;margin-bottom:20px">å‘å¸ƒæ—¥æœŸï¼š${createdAt}</div>
${marked.parse(content)}
</body></html>`;

  $('generateStaticHtmlBtn').disabled=true;
  try{
    const res=await fetch(`${ENDPOINT}/`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({slug,html})
    }).then(r=>r.json());
    if(!res.success) throw new Error(res.message);
    alert('âœ… å·²å‘å¸ƒï¼š'+res.url);
  }catch(e){alert('å‘å¸ƒå¤±è´¥ï¼š'+e.message);}
  finally{$('generateStaticHtmlBtn').disabled=false;}
};
</script>
</body>
</html>
