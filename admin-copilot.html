<!-- admin-mefan-articles.html â€•â€• 2025-06-10 å½»åº•ä¿®å¤ç‰ˆ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>æ–‡ç« åå°ç®¡ç†</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />

  <!-- æ ·å¼éƒ¨åˆ†ï¼ˆä¸ä¹‹å‰çš„ A ç‰ˆä¿æŒä¸€è‡´ï¼Œåªåšæ ¼å¼è°ƒæ•´ï¼‰ -->
  <style>
    body {
      font-family: Arial,Helvetica,sans-serif;
      background: #f8f8f8;
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 10px;
    }
    .btn {
      padding: 8px 16px;
      background: #333;
      color: #fff;
      border: none;
      cursor: pointer;
      margin: 5px;
    }
    .btn:hover {
      background: #555;
    }
    .hidden {
      display: none;
    }
    textarea,
    input[type="text"],
    input[type="file"] {
      width: 100%;
      margin: 5px 0;
    }
    /* è¡¨æ ¼æ ·å¼ */
    table {
      width: 100%;
      max-width: 960px;
      border-collapse: collapse;
      margin-top: 20px;
      background: #fff;
      table-layout: fixed;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ddd;
      text-align: left;
    }
    th {
      background: #f0f0f0;
    }
    td.author,
    td.content {
      word-break: break-all;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 340px;
    }
    /* ç®¡ç†å·¥å…·æ¡ */
    .admin-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 960px;
      width: 100%;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    .admin-bar > input {
      flex: 1;
      min-width: 200px;
      margin: 5px;
    }
    .admin-bar > div {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      margin: 5px;
    }
    /* é¢„è§ˆå¼¹çª— */
    #previewModal {
      position: fixed;
      top: 10%;
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      padding: 20px;
      border: 1px solid #ccc;
      max-width: 700px;
      width: 90%;
      z-index: 999;
      overflow-y: auto;
      max-height: 80vh;
    }
    #markdownContent {
      white-space: pre-wrap;
    }
    /* ç§»åŠ¨ç«¯å“åº”å¼ */
    @media (max-width: 768px) {
      .admin-bar {
        flex-direction: column;
        align-items: stretch;
      }
      .btn, textarea {
        width: 100%;
        margin: 5px 0;
      }
      table, thead, tbody, th, td, tr {
        display: block;
      }
      thead {
        display: none;
      }
      tbody tr {
        border: 1px solid #ddd;
        margin-bottom: 15px;
        background: #fff;
        padding: 10px;
      }
      tbody td {
        display: flex;
        justify-content: space-between;
        padding: 8px 5px;
        border: none;
        border-bottom: 1px solid #eee;
      }
      tbody td::before {
        content: attr(data-label);
        font-weight: bold;
        color: #555;
        flex: 1;
        margin-right: 10px;
      }
      #submitBtn, #cancelEditBtn {
        width: 100%;
      }
    }
  </style>

  <!-- åªåŠ è½½ä¸€æ¬¡ Supabaseã€markedã€Editor.js çš„ç›¸å…³è„šæœ¬ -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
</head>
<body>
  <h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

  <!-- ç™»å½•åŒº -->
  <div id="authArea">
    <button id="loginBtn" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button>
  </div>

  <!-- ç®¡ç†åŒºï¼ˆåˆå§‹éšè—ï¼‰ -->
  <div id="adminArea" class="hidden">
    <!-- æœç´¢ + é€€å‡º -->
    <div class="admin-bar">
      <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦">
      <div>
        <button id="searchBtn" class="btn">ğŸ” æœç´¢</button>
        <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <!-- æ–°å¢/ç¼–è¾‘åŒºåŸŸ -->
    <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
    <input type="text" id="newTitle" placeholder="æ ‡é¢˜">
    <!-- ï¼ˆå¦‚æœä½ ä¿ç•™ SEO æè¿°/å…³é”®è¯ çš„è¾“å…¥æ¡†ï¼Œè¯·è§£é™¤ä¸‹é¢ä¸¤è¡Œæ³¨é‡Šï¼‰ -->
    <!-- <textarea id="seoDescriptionInput" placeholder="SEO æè¿° (å¯é€‰)"></textarea> -->
    <!-- <input type="text" id="keywordsInput" placeholder="SEO å…³é”®è¯ (ç”¨é€—å·åˆ†éš”, å¯é€‰)"> -->
    <div style="display: flex; gap: 10px; margin: 5px 0">
      <button id="toggleToEditor"   class="btn">ğŸ“ å¯è§†åŒ–æ¨¡å¼</button>
      <button id="toggleToTextarea" class="btn hidden">ğŸ–Š Markdown æ¨¡å¼</button>
    </div>
    <div id="editorContainer" class="hidden" style="border:1px solid #ccc; min-height:200px; padding:10px; background:#fff"></div>
    <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
    <input type="file" id="coverInput" accept="image/*">
    <div style="display: flex; gap: 10px; flex-wrap: wrap; margin: 10px 0">
      <button id="submitBtn"             class="btn">æäº¤</button>
      <button id="cancelEditBtn"         class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
      <button id="generateStaticHtmlBtn" class="btn">ç”Ÿæˆé™æ€æ–‡ç« æ–‡ä»¶</button>
      <button id="aiBtn"                 class="btn">AI ç”Ÿæˆæ–‡ç« ç»“æ„+SEO</button>
    </div>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    <div style="overflow-x: auto; width: 100%">
      <table id="articlesTable">
        <thead>
          <tr>
            <th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th>
            <th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- é¢„è§ˆå¼¹çª— -->
    <div id="previewModal" class="hidden">
      <h3 id="previewTitle"></h3>
      <img id="previewCover">
      <div id="markdownContent"></div>
      <button class="btn" onclick="closePreview()">å…³é—­</button>
    </div>
  </div>

  <!-- ============================================================
       å¼•å¯¼å™¨ï¼šåŠ¨æ€åŠ è½½ Editor.jsï¼ˆå¦‚æœå°šæœªåŠ è½½ï¼‰ï¼ŒåŠ è½½å®Œæˆåå†æ‰§è¡Œ main() ä¸­çš„æ‰€æœ‰é€»è¾‘
  ============================================================ -->
  <script>
    (function loadEditorJS(runCallback) {
      // å¦‚æœ window.EditorJS å·²ç»å­˜åœ¨ï¼Œå°±ç›´æ¥æ‰§è¡Œå›è°ƒ
      if (window.EditorJS) {
        runCallback();
        return;
      }
      // å¦åˆ™åŠ¨æ€åˆ›å»º <script> å¼•å…¥ EditorJS
      const s = document.createElement('script');
      s.src = 'https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2';
      s.onload = runCallback;
      s.onerror = () => console.error('EditorJS ä¸»åŒ…åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– CDN');
      document.head.appendChild(s);
    })(function main() {
      /********************************************************
       * 1. å¸¸é‡ & å·¥å…·å‡½æ•°
       ********************************************************/
      // è¯·åŠ¡å¿…æ›¿æ¢æˆä½ è‡ªå·±çš„ Supabase URL å’Œ Anon Key
      const WORKER_BASE = 'https://oliverfr-articles-proxy.mefans.workers.dev';
      const ANON_KEY    = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6â€¦ï¼ˆçœç•¥ï¼‰';
      const ADMIN_EMAIL = 'oliveroogle@gmail.com';

      // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
      const supa = supabase.createClient(WORKER_BASE, ANON_KEY);

      // ç®€å•çš„ DOM å·¥å…·
      const $ = id => document.getElementById(id);
      const toBJ = () => new Date(Date.now() + 288e5).toISOString().replace('Z','+08:00');
      const fmt = s => new Date(s).toLocaleString('zh-CN',{hour12:false});
      const wk  = s => ['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'][ new Date(s).getDay() ];
      const esc = str => (str||'').replace(/[&<>"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
      })[c]);

      /********************************************************
       * 2. DOM å¼•ç”¨ & å…¨å±€çŠ¶æ€å˜é‡
       ********************************************************/
      const loginBtn   = $('loginBtn');
      const logoutBtn  = $('logoutBtn');
      const authArea   = $('authArea');
      const adminArea  = $('adminArea');
      const searchBtn  = $('searchBtn');
      const searchInput= $('searchInput');
      const titleInp   = $('newTitle');
      // const seoDescInp = $('seoDescriptionInput'); // å¦‚æœä½¿ç”¨ SEO æè¿°
      // const keywordsInp= $('keywordsInput');       // å¦‚æœä½¿ç”¨ SEO å…³é”®è¯
      const btnE       = $('toggleToEditor');
      const btnT       = $('toggleToTextarea');
      const editorDiv  = $('editorContainer');
      const submitBtn  = $('submitBtn');
      const cancelEditBtn = $('cancelEditBtn');
      const aiBtn      = $('aiBtn');
      const genBtn     = $('generateStaticHtmlBtn');
      const coverInput = $('coverInput');
      const tbBody     = document.querySelector('#articlesTable tbody');

      let editor      = null;      // Editor.js å®ä¾‹
      let editingId   = null;      // æ­£åœ¨ç¼–è¾‘çš„æ–‡ç«  ID
      let page        = 1;         // å½“å‰é¡µç ï¼ˆç”¨äºæ— é™æ»šåŠ¨åˆ†é¡µï¼‰
      let limit       = 5;         // æ¯æ¬¡åŠ è½½æ¡æ•°
      let loading     = false;     // æ•°æ®æ˜¯å¦åœ¨åŠ è½½ä¸­
      let authJwt     = '';        // Supabase JWTï¼ˆç™»å½•åä¼šå¡«å……ï¼‰

      /********************************************************
       * 3. å…ˆæŠŠâ€œç™»å½•/ç™»å‡ºâ€æŒ‰é’®çš„äº‹ä»¶ç«‹åˆ»ç»‘å®šä¸Šå»ï¼Œä¿è¯æŒ‰é’®å¯ç«‹å³ç‚¹å‡»
       ********************************************************/
      loginBtn.onclick = () => {
        supa.auth.signInWithOAuth({
          provider: 'github',
          options: { redirectTo: location.href }
        });
      };
      logoutBtn.onclick = async () => {
        await supa.auth.signOut();
        location.reload();
      };

      /********************************************************
       * 4. DOMContentLoadedï¼šç­‰ DOM å…ƒç´ æ¸²æŸ“å®Œï¼Œæ£€æŸ¥ç™»å½•çŠ¶æ€
       ********************************************************/
      document.addEventListener('DOMContentLoaded', async () => {
        // 4.1 å…ˆè¯•ç€ä» URL ä¸­è§£æ OAuth å›è°ƒï¼ˆå¦‚æœåˆšåˆš GitHub æˆæƒå›æ¥ï¼‰
        try {
          const { data, error } = await supa.auth.getSessionFromUrl({ storeSession: true });
          if (error) console.warn('OAuth å›è°ƒè§£æå¤±è´¥', error);
          if (data?.session) {
            // å¦‚æœæˆåŠŸæ‹¿åˆ° sessionï¼Œå°±æŠŠ URL ä¸Šçš„ ?code=... å’Œ å…¶å®ƒ query å»æ‰
            history.replaceState(null, '', location.pathname);
          }
        } catch(e) {
          console.error('OAuth è§£ææ—¶å‡ºé”™', e);
        }

        // 4.2 å†å–ä¸€æ¬¡å½“å‰ sessionï¼Œåˆ¤æ–­æ˜¯å¦ç®¡ç†å‘˜å·²ç™»å½•
        const { data: { session } } = await supa.auth.getSession();
        if (session?.user?.email === ADMIN_EMAIL) {
          // ç®¡ç†å‘˜å·²ç™»å½•ï¼Œéšè—ç™»å½•åŒºï¼Œæ˜¾ç¤ºç®¡ç†åŒº
          authArea.classList.add('hidden');
          adminArea.classList.remove('hidden');
          // ä¿å­˜ JWT ä»¥å¤‡åç»­å‘é‡åŒæ­¥æ—¶ä½¿ç”¨
          authJwt = session.access_token;
          // ç»‘å®šç™»å½•åæ‰èƒ½çœ‹åˆ°çš„æ‰€æœ‰ä¸šåŠ¡é€»è¾‘
          bindAfterLoginLogic();
        }
        // å¦‚æœæ²¡æœ‰ç™»å½•ï¼Œåˆ™é¡µé¢ä¿ç•™â€œç™»å½•åŒºâ€ï¼Œç‚¹å‡» loginBtn å°±ä¼šè§¦å‘ OAuth
      });

      /********************************************************
       * 5. ç®¡ç†å‘˜ç™»å½•åï¼Œç»‘å®šâ€œæ–°å¢/ç¼–è¾‘/åˆ é™¤/åˆ—è¡¨åŠ è½½/AI/ç”Ÿæˆé™æ€â€çš„æ‰€æœ‰é€»è¾‘
       ********************************************************/
      function bindAfterLoginLogic() {
        /********** 5.1 å¯è§†åŒ– Editor.js vs Markdown åˆ‡æ¢ **********/
        btnE.onclick = async () => {
          if (!window.EditorJS) {
            alert('Editor.js å°šæœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ– CDN è¿æ¥');
            return;
          }
          if (editor) {
            await editor.destroy();
          }
          editorDiv.classList.remove('hidden');
          $('newContent').classList.add('hidden');
          btnE.classList.add('hidden');
          btnT.classList.remove('hidden');

          // åˆ¤æ–­æ˜¯å¦åŠ è½½äº†å·¥å…·åŒ…
          const tools = {};
          if (window.ParagraphTool) {
            tools.paragraph = { class: window.ParagraphTool, inlineToolbar: true };
          }
          if (window.HeaderTool) {
            tools.header = { class: window.HeaderTool, inlineToolbar: true };
          }

          editor = new window.EditorJS({
            holder: 'editorContainer',
            tools,
            data: {
              blocks: [
                { type: 'paragraph', data: { text: $('newContent').value.replace(/\n/g,'<br>') } }
              ]
            }
          });
        };

        btnT.onclick = async () => {
          if (!editor) return;
          try {
            const savedData = await editor.save();
            $('newContent').value = savedData.blocks.map(b => b.data.text || '').join('\n\n');
            await editor.destroy();
          } catch(e) {
            console.warn(e);
          }
          editor = null;
          editorDiv.classList.add('hidden');
          $('newContent').classList.remove('hidden');
          btnE.classList.remove('hidden');
          btnT.classList.add('hidden');
        };

        /********** 5.2 æ–°å¢ / æ›´æ–° æ–‡ç«  **********/
        submitBtn.onclick = async () => {
          const title = $('newTitle').value.trim();
          const content = editor
            ? (await editor.save()).blocks.map(b=>b.data.text || '').join('\n\n').trim()
            : $('newContent').value.trim();
          if (!title || !content) {
            return alert('æ ‡é¢˜ / å†…å®¹ ä¸èƒ½ä¸ºç©º');
          }

          const { data: { user } } = await supa.auth.getUser();
          const row = {
            title,
            content,
            author_email: user?.email || '',
            updated_at: toBJ()
            // å¦‚æœä¿ç•™ SEO æè¿° / å…³é”®è¯ï¼Œè¿™é‡Œä¹Ÿè¦ä¸€å¹¶èµ‹å€¼ï¼š
            // seo_description: $('seoDescriptionInput').value.trim(),
            // keywords: $('keywordsInput').value.trim()
          };

          // ä¸Šä¼ å°é¢å›¾ç‰‡
          if ($('coverInput').files[0]) {
            const file = $('coverInput').files[0];
            const { data: upRes, error: upErr } = await supa.storage
              .from('articles')
              .upload(`covers/${Date.now()}_${file.name}`, file, { upsert: true });
            if (upErr) {
              return alert('å°é¢ä¸Šä¼ å¤±è´¥ï¼š' + upErr.message);
            }
            row.cover_url = supa.storage.from('articles').getPublicUrl(upRes.path).data.publicUrl;
          }

          let err;
          if (editingId) {
            // ç¼–è¾‘æ—¶ä½¿ç”¨ update
            ({ error: err } = await supa.from('articles').update(row).eq('id', editingId));
          } else {
            // æ–°å¢æ—¶ä½¿ç”¨ insert
            row.created_at = row.updated_at;
            ({ error: err } = await supa.from('articles').insert([row]));
          }
          if (err) {
            return alert(err.message);
          }

          // æ¸…ç©ºç¼–è¾‘çŠ¶æ€
          $('cancelEditBtn').click();
          // é‡æ–°åŠ è½½æ–‡ç« åˆ—è¡¨
          loadArticles(true);
        };

        cancelEditBtn.onclick = () => {
          $('newTitle').value = '';
          $('newContent').value = '';
          editingId = null;
          // å¦‚æœå½“å‰æ­£å¤„åœ¨ Editor.js æ¨¡å¼ï¼Œé”€æ¯å®ä¾‹
          if (editor) {
            btnT.onclick();
          }
          cancelEditBtn.classList.add('hidden');
        };

        /********** 5.3 ç¼–è¾‘ / åˆ é™¤ / é¢„è§ˆ **********/
        window.editArticle = r => {
          $('newTitle').value = r.title;
          $('newContent').value = r.content;
          editingId = r.id;
          cancelEditBtn.classList.remove('hidden');
          // å¦‚æœå½“å‰æ˜¯ Editor.js æ¨¡å¼ï¼Œå…ˆé”€æ¯
          if (editor) {
            btnT.onclick();
          }
          window.scrollTo(0, 0);
        };

        window.deleteArticle = async id => {
          if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
          const { error } = await supa.from('articles').delete().eq('id', id);
          if (error) {
            return alert(error.message);
          }
          loadArticles(true);
        };

        window.previewArticle = r => {
          $('previewTitle').textContent = r.title;
          $('previewCover').src = r.cover_url || '';
          $('markdownContent').innerHTML = marked.parse(r.content || '');
          $('previewModal').classList.remove('hidden');
        };

        window.closePreview = () => {
          $('previewModal').classList.add('hidden');
        };

        /********** 5.4 æ–‡ç« åˆ—è¡¨åŠ è½½ & æ— é™æ»šåŠ¨ & æœç´¢ **********/
        searchBtn.onclick = () => loadArticles(true, $('searchInput').value.trim());

        window.addEventListener('scroll', () => {
          if (!loading && window.innerHeight + window.scrollY > document.body.offsetHeight - 80) {
            loadArticles();
          }
        });

        async function loadArticles(reset=false, kw='') {
          if (loading) return;
          loading = true;
          if (reset) {
            tbBody.innerHTML = '';
            page = 1;
          }

          let q = supa.from('articles')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .range((page - 1)*limit, page*limit - 1);
          if (kw) {
            q = q.ilike('title', '%' + kw + '%');
          }
          const { data = [], error } = await q;
          if (error) {
            alert(error.message);
            loading = false;
            return;
          }

          data.forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td data-label="æ ‡é¢˜">${esc(r.title)}</td>
              <td data-label="ä½œè€…">${esc(r.author_email || '')}</td>
              <td data-label="å†…å®¹">${esc((r.content||'').slice(0,60))}â€¦</td>
              <td data-label="åˆ›å»ºæ—¶é—´">${fmt(r.created_at)}</td>
              <td data-label="æ›´æ–°æ—¶é—´">${fmt(r.updated_at)}</td>
              <td data-label="æ˜ŸæœŸ">æ˜ŸæœŸ${wk(r.created_at)}</td>
              <td data-label="å°é¢">${r.cover_url ? `<img src="${r.cover_url}" style="height:40px">` : ''}</td>
              <td data-label="æ“ä½œ">
                <button class="btn" onclick='previewArticle(${JSON.stringify(r).replace(/'/g,"&#39;")})'>é¢„è§ˆ</button>
                <button class="btn" onclick='editArticle(${JSON.stringify(r).replace(/'/g,"&#39;")})'>ç¼–è¾‘</button>
                <button class="btn" onclick="deleteArticle('${r.id}')">åˆ é™¤</button>
              </td>
            `;
            tbBody.appendChild(tr);
          });

          if (data.length === limit) {
            page++;
          }
          loading = false;
        }

        /********** 5.5 AI ç”Ÿæˆæ–‡ç« ç»“æ„ & SEO **********/
        aiBtn.onclick = async () => {
          const topic = $('newTitle').value.trim();
          if (!topic) {
            return alert('è¯·å…ˆè¾“å…¥æ ‡é¢˜');
          }
          try {
            const resp = await fetch('https://gpt.mefans.workers.dev/gpt', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ topic })
            });
            const j = await resp.json();

            let article = j.article_body || j.article || j.content || '';
            let seoDesc  = j.seo_description || '';
            let kws      = j.keywords || '';
            // å¤„ç† GPT å¯èƒ½æŠŠ JSON è¿”å›æˆå­—ç¬¦ä¸²çš„æƒ…å†µ
            if (!article && typeof j === 'string') {
              try {
                const inner = JSON.parse(j);
                article = inner.article_body || inner.article || inner.content || '';
                seoDesc  = inner.seo_description || '';
                kws      = inner.keywords || '';
              } catch (_ignore) {}
            }

            $('newContent').value = article;
            // $('seoDescriptionInput').value = seoDesc; // å¦‚æœä¿ç•™ SEO æè¿°
            // $('keywordsInput').value = kws;           // å¦‚æœä¿ç•™ SEO å…³é”®è¯

            if (editor) {
              await editor.blocks.clear();
              await editor.blocks.insert('paragraph', { text: article.replace(/\n/g, '<br>') });
            }
            alert('âœ… AI å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æ£€æŸ¥å¹¶è°ƒæ•´');
          } catch(e) {
            alert('âŒ GPT ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
          }
        };

        /********** 5.6 ç”Ÿæˆé™æ€ HTML å¹¶ä¸Šä¼  GitHub **********/
        genBtn.onclick = async () => {
          const title   = $('newTitle').value.trim();
          const content = editor
            ? (await editor.save()).blocks.map(b => b.data.text || '').join('\n\n').trim()
            : $('newContent').value.trim();
          if (!title || !content) {
            return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
          }

          // æ„é€ é™æ€é¡µé¢è¦ç”¨åˆ°çš„å˜é‡
          const createdAt = toBJ().split('T')[0];
          const slug      = title
            .toLowerCase()
            .replace(/\s+/g, '-')
            .replace(/[^\w\-]/g, '');
          const coverUrl  = `https://oliverfr.com/covers/${slug}-cover.jpg`;
          const ogImage   = `https://oliverfr.com/og-images/${slug}-og.jpg`;
          const logoUrl   = `https://oliverfr.com/assets/logo.png`;

          // **æœ€å®¹æ˜“é”™çš„ä¸€ç‚¹ï¼šä¸‹é¢è¿™æ®µæ¨¡æ¿å­—ç¬¦ä¸²åŠ¡å¿…å®Œæ•´é—­åˆ**
          const html = `<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>${esc(title)} | MeFan æŠ€æœ¯åšå®¢</title>
  <meta name="description" content="${esc(title)}" />
  <meta name="keywords" content="${esc(title)}" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <meta name="robots" content="index, follow" />
  <link rel="canonical" href="https://oliverfr.com/articles/${slug}.html" />
  <meta property="og:type" content="article" />
  <meta property="og:title" content="${esc(title)}" />
  <meta property="og:description" content="${esc(title)}" />
  <meta property="og:image" content="${ogImage}" />
  <meta property="og:url" content="https://oliverfr.com/articles/${slug}.html" />
  <meta property="og:site_name" content="MeFan æŠ€æœ¯åšå®¢" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="${esc(title)}" />
  <meta name="twitter:description" content="${esc(title)}" />
  <meta name="twitter:image" content="${ogImage}" />
  <script type="application/ld+json">${JSON.stringify({
    "@context":"https://schema.org",
    "@type":"Article",
    headline: title,
    description: title,
    image: ogImage,
    author: { "@type":"Person", name:"Oliver F." },
    publisher: {
      "@type":"Organization",
      name:"MeFan Solutions",
      logo: { "@type":"ImageObject", url: logoUrl }
    },
    datePublished: createdAt,
    dateModified: createdAt,
    mainEntityOfPage: { "@type":"WebPage", "@id":`https://oliverfr.com/articles/${slug}.html` }
  }, null, 2)}</script>
  <style>
    body { font-family: Arial,sans-serif; margin:40px auto; max-width:700px; line-height:1.6; }
    h1 { font-size:28px; margin-bottom:20px; }
    .meta { color:#888; font-size:14px; margin-bottom:20px; }
    img { max-width:100%; margin:20px 0; }
    .logo { display:block; margin:0 auto 20px; height:60px; }
  </style>
</head>
<body>
  <img src="${logoUrl}" alt="MeFan Logo" class="logo" />
  <h1>${esc(title)}</h1>
  <div class="meta">release dateï¼š${createdAt} ï½œ Authorï¼šOliver F.</div>
  <img src="${coverUrl}" alt="${esc(title)} å°é¢" />
  ${marked.parse(content)}
</body>
</html>`;

          // ä¸€å®šè¦åœ¨ä¸Šé¢æœ€åé‚£ä¸ª </html> æ ‡ç­¾åé¢ç´§è·Ÿä¸€ä¸ªåå¼•å· `ï¼Œ
          // å¦åˆ™ä½ çš„è„šæœ¬ä½“å°±ä¼šæå‰ç»ˆç»“ï¼Œåé¢é‚£ä¸€å¤§æ®µä¸šåŠ¡é€»è¾‘éƒ½ä¸ä¼šæ‰§è¡Œäº†ã€‚
          // ä¹Ÿä¸è¦å¿˜äº†ä¸‹é¢è¿™è¡Œï¼šå¿…é¡»å°é—­ const html = ` ... `;

          try {
            const res = await fetch('https://upload-articlejs.mefans.workers.dev/', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ slug, html })
            }).then(r => r.json());

            if (res.success) {
              alert('âœ… å·²å‘å¸ƒä¸Šçº¿ï¼š' + res.url);
            } else {
              alert('âŒ å‘å¸ƒå¤±è´¥ï¼š' + (res.message || JSON.stringify(res)));
            }
          } catch(e) {
            alert('âŒ ç½‘ç»œå¼‚å¸¸ï¼š' + e.message);
          }
        };

      } // bindAfterLoginLogic() ç»“æŸ

    }); // main() ç»“æŸ

  </script>
</body>
</html>
