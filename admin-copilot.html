<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>文章后台管理</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>

<!-- ============= ① 统一配色 / 响应式 ============= -->
<style>
:root{
  --bg:#f8f8f8;--txt:#111;--card:#fff;--border:#d0d0d0;
  --btn:#333;--btn-h:#555;--primary:#226cff
}
@media(prefers-color-scheme:dark){
  :root{--bg:#1e1e1e;--txt:#eee;--card:#272727;--border:#444;--btn:#444;--btn-h:#666}
}
*{box-sizing:border-box}
body{
  margin:0;padding:24px;font:15px/1.6 system-ui,-apple-system,Segoe UI,Helvetica,Arial,sans-serif;
  background:var(--bg);color:var(--txt);display:flex;flex-direction:column;align-items:center
}
h1{margin:0 0 16px;font-size:28px;display:flex;align-items:center;gap:6px}
h2{margin:32px 0 12px;font-size:22px}

.btn{
  padding:10px 24px;margin:4px;border:none;border-radius:4px;
  cursor:pointer;background:var(--btn);color:#fff;line-height:1.2
}
.btn:hover{background:var(--btn-h)}
.btn[disabled]{opacity:.4;cursor:not-allowed}
input[type="text"],textarea{
  width:100%;padding:8px 10px;margin:6px 0;border:1px solid var(--border);border-radius:4px
}
textarea{resize:vertical;min-height:130px}
input[type="file"]{margin:6px 0}

table{
  border-collapse:collapse;width:100%;max-width:1024px;margin:24px 0;background:var(--card);
  border:1px solid var(--border);border-radius:6px;overflow:hidden
}
thead{
  position:sticky;top:0;background:var(--card);box-shadow:0 2px 4px rgba(0,0,0,.04);z-index:1
}
th,td{padding:10px 12px;border-bottom:1px solid var(--border)}
th{font-weight:600;white-space:nowrap;background:rgba(0,0,0,.03)}
tr:nth-child(even) td{background:rgba(0,0,0,.015)}
td.content,td.author{max-width:320px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

tbody tr:hover td{background:rgba(34,108,255,.06)}

.admin-bar{
  width:100%;max-width:1024px;display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:18px
}
.admin-bar>input{flex:1 1 260px;min-width:160px}
.admin-bar>div{display:flex;gap:10px}

#previewModal{
  position:fixed;top:10%;left:50%;transform:translateX(-50%);
  background:var(--card);color:var(--txt);border:1px solid var(--border);border-radius:8px;
  padding:24px;max-width:700px;width:92%;max-height:80vh;overflow-y:auto;z-index:999
}
#markdownContent{white-space:pre-wrap}

@media (max-width:768px){
  h1{font-size:24px}
  table,thead,tbody,tr,td,th{display:block}
  th{display:none}
  tbody tr{margin:0 0 14px;border:1px solid var(--border);border-radius:6px;padding:6px}
  tbody td{
    display:flex;justify-content:space-between;align-items:center;
    border:none;border-bottom:1px solid var(--border);padding:8px 10px
  }
  tbody td:last-child{border-bottom:none}
  tbody td::before{content:attr(data-label);font-weight:600;color:#555}
  td.content,td.author{white-space:normal}
  .btn{flex:1}
}
</style>

<!-- ============= ② 外部依赖 ============= -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
</head>

<body>
<h1>📰 文章后台管理</h1>

<!-- =========== ③ 登录区 =========== -->
<div id="authArea"><button id="loginBtn" class="btn">使用 GitHub 登录</button></div>

<!-- =========== ④ 管理区 =========== -->
<div id="adminArea" class="hidden">

  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="搜索标题关键词…">
    <div>
      <button id="searchBtn" class="btn" disabled>🔍 搜索</button>
      <button id="logoutBtn" class="btn" disabled>退出登录</button>
    </div>
  </div>

  <h2>🆕 新增/编辑文章</h2>
  <input type="text" id="newTitle" placeholder="标题 (用于 GPT 生成)">
  <div style="display:flex;gap:10px;flex-wrap:wrap">
    <button id="toggleToEditor"  class="btn" disabled>📐 可视化模式</button>
    <button id="toggleToTextarea" class="btn hidden" disabled>✏️ Markdown 模式</button>
  </div>

  <div id="editorContainer" class="hidden"
       style="border:1px solid var(--border);min-height:220px;padding:10px;border-radius:4px;background:var(--card)"></div>
  <textarea id="newContent" placeholder="支持 Markdown 格式的内容"></textarea>

  <input type="file" id="coverInput" accept="image/*">

  <div style="display:flex;gap:10px;flex-wrap:wrap;margin:14px 0">
    <button id="submitBtn"             class="btn" disabled>提交</button>
    <button id="cancelEditBtn"         class="btn hidden" disabled>取消编辑</button>
    <button id="generateStaticHtmlBtn" class="btn" disabled>生成静态文章文件</button>
    <button id="aiBtn"                 class="btn" disabled>AI 生成文章结构+SEO</button>
  </div>

  <div style="overflow-x:auto;width:100%">
    <table id="articlesTable">
      <thead>
        <tr>
          <th>标题</th><th>作者</th><th>内容</th><th>创建时间</th><th>更新时间</th>
          <th>星期</th><th>封面</th><th>操作</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="previewModal" class="hidden">
    <h3 id="previewTitle"></h3>
    <img id="previewCover" style="max-width:100%;margin:10px 0">
    <div id="markdownContent"></div>
    <button class="btn" onclick="closePreview()">关闭</button>
  </div>
</div>

<!-- =========== ⑤ 主脚本 =========== -->
<script>
/* ---------- 通用工具 ---------- */
const $   = id => document.getElementById(id);
const esc = s => (s || '').replace(/[&<>"']/g,
             c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const fmt = s => new Date(s).toLocaleString('zh-CN',{hour12:false});
const wk  = s => '日一二三四五六'[new Date(s).getDay()];
const toBJ= () => new Date(Date.now() + 288e5).toISOString();

/* ---------- Supabase ---------- */
const ENDPOINT = 'https://copilot-router.mefans.workers.dev';    // ←改成你的 Worker
const ANON_KEY = 'REPLACE_WITH_ANON_KEY';                        // ←改成你的 anon key
const ADMIN_EMAIL = 'oliveroogle@gmail.com';

const supa = supabase.createClient(ENDPOINT, ANON_KEY);

/* ---------- EditorJS 懒加载 ---------- */
const loadEditorCore = () => new Promise(res=>{
  if (window.EditorJS) return res();
  const s = document.createElement('script');
  s.src   = 'https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2';
  s.onload= res; document.head.appendChild(s);
});

/* ---------- 全局状态 ---------- */
let editor=null, editingId=null, page=1, limit=6, loading=false;

/* ---------- 始终能拿到 Markdown ---------- */
async function safeSave(){
  if(!editor) return $('newContent').value.trim();
  try{
    const d = await editor.save();
    return d.blocks.map(b=>b.data.text||'').join('\n\n').trim();
  }catch{
    return $('newContent').value.trim();
  }
}

/* ============= Ⅰ. 登录 / 登出 / Session ============= */
window.addEventListener('DOMContentLoaded', async()=>{
  $('loginBtn').onclick = () =>
    supa.auth.signInWithOAuth({
      provider:'github',
      options:{redirectTo:location.origin+location.pathname}
    });

  $('logoutBtn').onclick = async()=>{
    await supa.auth.signOut(); location.reload();
  };

  const {data:{session}} = await supa.auth.getSession();
  if(session?.user?.email===ADMIN_EMAIL){
    $('authArea').classList.add('hidden');
    $('adminArea').classList.remove('hidden');
    document.querySelectorAll('.btn').forEach(b=>b.removeAttribute('disabled'));
    loadArticles(true);
  }
});

/* ============= Ⅱ. Markdown ↔ EditorJS ============= */
$('toggleToEditor').onclick = async()=>{
  await loadEditorCore();
  if(editor){await editor.destroy();}

  $('toggleToEditor').classList.add('hidden');
  $('toggleToTextarea').classList.remove('hidden');
  $('newContent').classList.add('hidden');
  $('editorContainer').classList.remove('hidden');

  const holder=$('editorContainer');
  holder.innerHTML='';

  editor=new EditorJS({
    holder,
    tools:{
      paragraph:{class: window.ParagraphTool||window.Paragraph, inlineToolbar:true},
      header   :{class: window.HeaderTool   ||window.Header   , inlineToolbar:true}
    },
    data:{blocks:[{type:'paragraph',data:{text:$('newContent').value.replace(/\n/g,'<br>')}}]}
  });
};

$('toggleToTextarea').onclick=async()=>{
  $('toggleToTextarea').classList.add('hidden');
  $('toggleToEditor').classList.remove('hidden');
  $('editorContainer').classList.add('hidden');
  $('newContent').classList.remove('hidden');
  $('newContent').value = await safeSave();
  if(editor){await editor.destroy();editor=null;}
  $('editorContainer').innerHTML='';
};

/* ============= Ⅲ. 文章列表 ============= */
const tb = document.querySelector('#articlesTable tbody');

function rowHTML(r){
  const payload=encodeURIComponent(JSON.stringify(r));
  return `
<tr>
  <td data-label="标题">${esc(r.title)}</td>
  <td data-label="作者" class="author">${esc(r.author_email||'')}</td>
  <td data-label="内容" class="content">${esc((r.content||'').slice(0,60))}</td>
  <td data-label="创建时间">${fmt(r.created_at)}</td>
  <td data-label="更新时间">${fmt(r.updated_at)}</td>
  <td data-label="星期">星期${wk(r.created_at)}</td>
  <td data-label="封面">${r.cover_url?`<img src="${r.cover_url}" height="40">`:''}</td>
  <td data-label="操作">
    <button class="btn act" data-act="preview" data-row="${payload}">预览</button>
    <button class="btn act" data-act="edit"    data-row="${payload}">编辑</button>
    <button class="btn act" data-act="delete"  data-id ="${r.id}">删除</button>
  </td>
</tr>`;
}

async function loadArticles(reset=false,kw=''){
  if(loading) return; loading=true;
  if(reset){tb.innerHTML=''; page=1;}

  let q=supa.from('articles')
            .select('*')
            .order('created_at',{ascending:false})
            .range((page-1)*limit,page*limit-1);
  if(kw) q=q.ilike('title',`%${kw}%`);
  const {data=[],error}=await q; loading=false;
  if(error) return alert(error.message);

  tb.insertAdjacentHTML('beforeend',data.map(rowHTML).join(''));
  if(data.length===limit) page++;
}

tb.addEventListener('click', e=>{
  const btn=e.target.closest('.act'); if(!btn) return;
  const act=btn.dataset.act;
  if(act==='delete') return deleteArticle(btn.dataset.id);
  const row = JSON.parse(decodeURIComponent(btn.dataset.row));
  if(act==='preview') return previewArticle(row);
  if(act==='edit')    return editArticle(row);
});

$('searchBtn').onclick=()=>loadArticles(true,$('searchInput').value.trim());
window.addEventListener('scroll',()=>{
  if(!loading && innerHeight+scrollY > document.body.offsetHeight-80) loadArticles();
});

/* 预览 / 删除 / 编辑 */
function previewArticle(r){
  $('previewTitle').textContent=r.title;
  $('previewCover').src=r.cover_url||'';
  $('markdownContent').innerHTML=marked.parse(r.content||'');
  $('previewModal').classList.remove('hidden');
}
function closePreview(){$('previewModal').classList.add('hidden');}

async function deleteArticle(id){
  if(!confirm('确定删除？')) return;
  const{error}=await supa.from('articles').delete().eq('id',id);
  if(error) alert(error.message); else loadArticles(true);
}
function editArticle(r){
  editingId=r.id;
  $('newTitle').value=r.title;
  $('newContent').value=r.content;
  $('cancelEditBtn').classList.remove('hidden');
  if(editor){editor.destroy();editor=null;}
  $('toggleToTextarea').click();
  window.scrollTo({top:0,behavior:'smooth'});
}

/* 取消编辑 */
$('cancelEditBtn').onclick=()=>{
  editingId=null;
  $('newTitle').value='';
  $('newContent').value='';
  $('cancelEditBtn').classList.add('hidden');
  if(editor){editor.destroy();editor=null;}
  $('toggleToTextarea').click();
};

/* ============= Ⅴ. 提交（Insert / Update） ============= */
$('submitBtn').onclick=async()=>{
  const title=$('newTitle').value.trim();
  const content=await safeSave();
  if(!title||!content) return alert('标题/内容不能为空');

  const {data:{user}} = await supa.auth.getUser();
  const row={
    title, content,
    author_email:user?.email||'',
    updated_at:toBJ()
  };

  /* 封面上传 */
  if(coverInput.files[0]){
    const f=coverInput.files[0];
    const {data:r,error}=await supa.storage.from('articles')
      .upload(`covers/${Date.now()}_${f.name}`,f,{upsert:true});
    if(error) return alert('封面上传失败：'+error.message);
    row.cover_url = supa.storage.from('articles').getPublicUrl(r.path).data.publicUrl;
  }

  let err;
  if(editingId){
    ({error:err}=await supa.from('articles').update(row).eq('id',editingId));
  }else{
    row.created_at=row.updated_at;
    ({error:err}=await supa.from('articles').insert([row]));
  }
  if(err) return alert('Supabase：'+err.message);

  $('cancelEditBtn').click(); loadArticles(true);
};

/* ============= Ⅵ. GPT 生成 ============= */
$('aiBtn').onclick=async()=>{
  const topic=$('newTitle').value.trim();
  if(!topic) return alert('请先填写标题');

  $('aiBtn').disabled=true; $('aiBtn').textContent='⏳ GPT 生成中…';
  try{
    const j=await fetch(`${ENDPOINT}/gpt`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({topic})
    }).then(r=>r.json());

    if(!j.success) throw new Error(j.message||j.detail||'生成失败');

    $('newContent').value = j.article_body || '';
    if(editor){
      await editor.blocks.clear();
      await editor.blocks.insert('paragraph',{text:j.article_body});
    }
  }catch(e){alert(e.message);}
  finally{$('aiBtn').disabled=false; $('aiBtn').textContent='AI 生成文章结构+SEO';}
};

/* ============= Ⅶ. 生成静态 HTML ============= */
$('generateStaticHtmlBtn').onclick=async()=>{
  const title=$('newTitle').value.trim();
  const content=await safeSave();
  if(!title||!content) return alert('请填写标题和内容');

  const slug=title.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
  const createdAt=toBJ().split('T')[0];
  const logoUrl='https://oliverfr.com/assets/logo.png';

  const html=`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"/>
<title>${esc(title)} | MeFan 技术博客</title>
<meta name="description" content="${esc(title)}"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<link rel="canonical" href="https://oliverfr.com/articles/${slug}.html"/>
<style>body{font-family:Arial,Helvetica,sans-serif;max-width:700px;margin:40px auto;line-height:1.6}h1{font-size:28px}</style>
</head><body>
<img src="${logoUrl}" alt="logo" style="display:block;margin:0 auto 20px;height:60px">
<h1>${esc(title)}</h1>
<div style="color:#888;font-size:14px;margin-bottom:20px">发布日期：${createdAt}</div>
${marked.parse(content)}
</body></html>`;

  $('generateStaticHtmlBtn').disabled=true;
  try{
    const r=await fetch(`${ENDPOINT}/`,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({slug,html})
    }).then(r=>r.json());
    if(!r.success) throw new Error(r.message||r.detail);
    alert('✅ 已发布：'+r.url);
  }catch(e){alert('发布失败：'+e.message);}
  finally{$('generateStaticHtmlBtn').disabled=false;}
};
</script>
</body>
</html>
