<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>文章后台管理</title>
<link rel="icon" href="https://oliverfr.com/assets/favicon.png">
<meta name="viewport" content="width=device-width,initial-scale=1">

<!-- ===== 公共样式 ===== -->
<style>
:root{--bg:#f7f7f7;--txt:#111;--card:#fff;--border:#ccc;--btn:#222;--btn-h:#444}
@media(prefers-color-scheme:dark){
 :root{--bg:#181818;--txt:#eee;--card:#222;--border:#444;--btn:#333;--btn-h:#666}
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--txt);font:16px/1.55 Arial,Helvetica,sans-serif;
     display:flex;flex-direction:column;align-items:center;padding:22px 8px}
h1{font-size:28px;margin:0 0 25px}
h2{font-size:22px;margin:32px 0 14px}

input[type=text],textarea{width:100%;border:1px solid var(--border);border-radius:4px;padding:8px}
textarea{min-height:200px;resize:vertical}
.btn{background:var(--btn);color:#fff;border:none;border-radius:4px;padding:10px 22px;margin:6px;
     cursor:pointer;transition:.14s}
.btn:hover{background:var(--btn-h)}
.btn[disabled]{opacity:.4;cursor:not-allowed}
.hidden{display:none!important}

/* 表格 + 移动折叠 */
table{width:100%;max-width:960px;border-collapse:collapse;margin:26px 0;background:var(--card)}
th,td{border:1px solid var(--border);padding:8px 6px;text-align:left}
th{background:rgba(0,0,0,.06)}
td.content,td.author{max-width:320px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
@media (max-width:768px){
  .admin-bar{flex-direction:column!important}
  table,thead,tbody,tr,th,td{display:block}
  thead{display:none}
  tbody tr{margin:0 0 14px;border:1px solid var(--border)}
  tbody td{display:flex;justify-content:space-between;border:none;border-bottom:1px solid var(--border)}
  tbody td::before{content:attr(data-label);font-weight:700;margin-right:8px}
  #submitBtn,#generateStaticHtmlBtn,#aiBtn,#cancelEditBtn{width:100%}
}

/* 预览模态 */
#previewOverlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:flex;align-items:center;
                justify-content:center;z-index:9999}
#previewModal{background:var(--card);color:var(--txt);padding:24px;border:1px solid var(--border);
              max-width:760px;width:92%;max-height:85vh;overflow:auto;border-radius:6px}
</style>

<!-- ===== 依赖 ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
</head>

<body>
<h1>📰 文章后台管理</h1>

<!-- 登陆区 -->
<div id="authArea">
  <button id="loginBtn" class="btn">使用 GitHub 登录</button>
</div>

<!-- 管理区 -->
<div id="adminArea" class="hidden" style="width:100%;max-width:960px">
  <div class="admin-bar" style="display:flex;justify-content:space-between;gap:10px">
    <input id="searchInput" type="text" placeholder="搜索标题关键词…">
    <div>
      <button id="searchBtn" class="btn" disabled>🔍 搜索</button>
      <button id="logoutBtn" class="btn" disabled>退出登录</button>
    </div>
  </div>

  <h2>🆕 新增/编辑文章</h2>
  <input id="newTitle" type="text" placeholder="标题">

  <div style="display:flex;gap:10px;margin:10px 0">
    <button id="toggleToEditor"  class="btn" disabled>📐 可视化模式</button>
    <button id="toggleToTextarea" class="btn hidden" disabled>✏️ Markdown 模式</button>
  </div>

  <div id="editorContainer" class="hidden"
       style="border:1px solid var(--border);background:var(--card);min-height:240px;padding:10px"></div>
  <textarea id="newContent" placeholder="支持 Markdown 格式的内容"></textarea>

  <input id="coverInput" type="file" accept="image/*" style="margin:10px 0">

  <div style="display:flex;flex-wrap:wrap;gap:10px">
    <button id="submitBtn"             class="btn" disabled>提交</button>
    <button id="cancelEditBtn"         class="btn hidden" disabled>取消编辑</button>
    <button id="generateStaticHtmlBtn" class="btn" disabled>生成静态文章文件</button>
    <button id="aiBtn"                 class="btn" disabled>AI 生成文章结构+SEO</button>
  </div>

  <div style="overflow-x:auto">
    <table id="articlesTable">
      <thead><tr><th>标题</th><th>作者</th><th>内容</th><th>创建时间</th><th>更新时间</th>
                 <th>星期</th><th>封面</th><th>操作</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- 预览模态 -->
<div id="previewOverlay" class="hidden" onclick="closePreview(event)">
  <div id="previewModal" onclick="event.stopPropagation()">
    <h3 id="previewTitle"></h3>
    <img id="previewCover" style="max-width:100%;margin:10px 0">
    <div id="markdownContent"></div>
    <button class="btn" style="margin-top:16px" onclick="closePreview()">关闭</button>
  </div>
</div>

<!-- ===== 主脚本 ===== -->
<script>
/* ---------- 通用 ---------- */
const $ = id=>document.getElementById(id);
const esc=s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const fmt=s=>new Date(s).toLocaleString('zh-CN',{hour12:false});
const wk =s=>'日一二三四五六'[new Date(s).getDay()];
const nowISO = ()=>new Date().toISOString();           // 🔧 直接 UTC，PG 一定可识别

/* ------ 配置（仅改这里三行） ------ */
const ENDPOINT='https://copilot-router.mefans.workers.dev';   // 你的 Worker 网址
const ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';                               // 你的 anon key
const ADMIN_EMAIL='oliveroogle@gmail.com';

const supa = supabase.createClient(ENDPOINT,ANON_KEY);

/* ------ Editor 懒加载 ------ */
let editor=null;
const loadCore = ()=>new Promise(res=>{
  if(window.EditorJS) return res();
  const s=document.createElement('script');
  s.src='https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2';
  s.onload=res;document.head.appendChild(s);
});

/* ------ 状态 ------ */
let editingId=null,page=1,limit=6,loading=false;
const map={};                                 // key → row 缓存
const tbody = ()=>document.querySelector('#articlesTable tbody');

/* ------ 安全取 Markdown ------ */
async function safeSave(){
  if(!editor) return $('newContent').value.trim();
  try{
    const d=await editor.save();
    return d.blocks.map(b=>b.data.text||'').join('\n\n').trim();
  }catch(e){console.warn(e);return $('newContent').value.trim();}
}

/* ===== Ⅰ. 登录检查 ===== */
window.addEventListener('DOMContentLoaded',async()=>{
  $('loginBtn').onclick=()=>supa.auth.signInWithOAuth({
    provider:'github',options:{redirectTo:location.href.split('#')[0]}
  });
  $('logoutBtn').onclick=async()=>{await supa.auth.signOut();location.reload();};

  const {data:{session}}=await supa.auth.getSession();
  if(session?.user?.email===ADMIN_EMAIL){
    $('authArea').classList.add('hidden');
    $('adminArea').classList.remove('hidden');
    document.querySelectorAll('.btn').forEach(b=>b.removeAttribute('disabled'));
    loadArticles(true);
  }
});

/* ===== Ⅱ. 可视化 ↔ Markdown ===== */
$('toggleToEditor').onclick=async()=>{
  await loadCore();
  if(editor) await editor.destroy();

  $('toggleToEditor').classList.add('hidden');
  $('toggleToTextarea').classList.remove('hidden');
  $('newContent').classList.add('hidden');
  $('editorContainer').classList.remove('hidden');

  const clone=$('editorContainer').cloneNode(false);
  $('editorContainer').replaceWith(clone);
  clone.id='editorContainer';

  editor=new EditorJS({
    holder:clone,
    tools:{
      paragraph:{class:Paragraph,inlineToolbar:true},
      header   :{class:Header,inlineToolbar:true},
    },
    data:{blocks:[{type:'paragraph',data:{text:$('newContent').value.replace(/\n/g,'<br>')}}]}
  });
};

$('toggleToTextarea').onclick=async()=>{
  $('toggleToTextarea').classList.add('hidden');
  $('toggleToEditor').classList.remove('hidden');
  $('editorContainer').classList.add('hidden');
  $('newContent').classList.remove('hidden');
  $('newContent').value=await safeSave();
  if(editor){await editor.destroy();editor=null;}
  $('editorContainer').innerHTML='';
};

/* ===== Ⅲ. 列表 / 分页 ===== */
async function loadArticles(reset=false,kw=''){
  if(loading) return;loading=true;
  if(reset){tbody().innerHTML='';page=1;}

  let q=supa.from('articles').select('*')
           .order('created_at',{ascending:false})
           .range((page-1)*limit,page*limit-1);
  if(kw)q=q.ilike('title',`%${kw}%`);

  const {data=[],error}=await q;loading=false;
  if(error)return alert(error.message);

  data.forEach(r=>{
    const key=crypto.randomUUID();
    map[key]=r;
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td data-label="标题">${esc(r.title)}</td>
      <td data-label="作者" class="author">${esc(r.author_email||'')}</td>
      <td data-label="内容" class="content">${esc((r.content||'').slice(0,60))}…</td>
      <td data-label="创建时间">${fmt(r.created_at)}</td>
      <td data-label="更新时间">${fmt(r.updated_at)}</td>
      <td data-label="星期">星期${wk(r.created_at)}</td>
      <td data-label="封面">${r.cover_url?`<img src="${r.cover_url}" height="40">`:''}</td>
      <td data-label="操作">
        <button class="btn" data-k="${key}" onclick="previewRow(this)">预览</button>
        <button class="btn" data-k="${key}" onclick="editRow(this)">编辑</button>
        <button class="btn" onclick="deleteRow('${r.id}')">删除</button>
      </td>`;
    tbody().appendChild(tr);
  });
  if(data.length===limit)page++;
}
$('searchBtn').onclick=()=>loadArticles(true,$('searchInput').value.trim());
window.addEventListener('scroll',()=>{if(!loading&&innerHeight+scrollY>document.body.offsetHeight-80)loadArticles();});

/* ===== Ⅳ. 行操作 ===== */
window.previewRow=btn=>{
  const r=map[btn.dataset.k];
  $('previewTitle').textContent=r.title;
  $('previewCover').src=r.cover_url||'';
  $('markdownContent').innerHTML=marked.parse(r.content||'');
  $('previewOverlay').classList.remove('hidden');
  document.body.style.overflow='hidden';
};
function closePreview(e){
  if(e && e.target.id!=='previewOverlay' && e.target.tagName!=='BUTTON')return;
  $('previewOverlay').classList.add('hidden');
  document.body.style.overflow='';
}
window.editRow=btn=>{
  const r=map[btn.dataset.k];
  editingId=r.id;
  $('newTitle').value=r.title;
  $('newContent').value=r.content;
  $('cancelEditBtn').classList.remove('hidden');
  if(editor){editor.destroy();editor=null;}
  $('toggleToTextarea').click();
  window.scrollTo({top:0,behavior:'smooth'});
};
window.deleteRow=async id=>{
  if(!confirm('确定删除？'))return;
  const {error}=await supa.from('articles').delete().eq('id',id);
  if(error)alert(error.message);else loadArticles(true);
};

/* 取消编辑 */
$('cancelEditBtn').onclick=()=>{
  editingId=null;$('newTitle').value='';$('newContent').value='';
  $('cancelEditBtn').classList.add('hidden');
  if(editor){editor.destroy();editor=null;}
  $('toggleToTextarea').click();
};

/* ===== Ⅴ. 提交 ===== */
$('submitBtn').onclick=async()=>{
  const title=$('newTitle').value.trim();
  const content=await safeSave();
  if(!title||!content)return alert('标题/内容不能为空');

  const {data:{user}}=await supa.auth.getUser();
  const row={title,content,author_email:user?.email||'',updated_at:nowISO()};

  if(coverInput.files[0]){
    const f=coverInput.files[0];
    const {data:ret,error}=await supa.storage.from('articles')
        .upload(`covers/${Date.now()}_${f.name}`,f,{upsert:true});
    if(error)return alert('封面上传失败：'+error.message);
    row.cover_url=supa.storage.from('articles').getPublicUrl(ret.path).data.publicUrl;
  }

  let err;
  if(editingId)({error:err}=await supa.from('articles').update(row).eq('id',editingId));
  else {row.created_at=row.updated_at;({error:err}=await supa.from('articles').insert([row]));}
  if(err)return alert('Supabase：'+err.message);

  $('cancelEditBtn').click();loadArticles(true);
};

/* ===== Ⅵ. AI 生成 ===== */
$('aiBtn').onclick=async()=>{
  const topic=$('newTitle').value.trim();
  if(!topic)return alert('请先填写标题');
  $('aiBtn').disabled=true;$('aiBtn').textContent='⏳ GPT 生成中…';
  try{
    const j=await fetch(`${ENDPOINT}/gpt`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({topic})
    }).then(r=>r.json());
    if(!j.success)throw new Error(j.message||j.detail||'生成失败');
    $('newContent').value=j.article_body||'';
    if(editor){await editor.blocks.clear();await editor.blocks.insert('paragraph',{text:j.article_body});}
  }catch(e){alert(e.message);}
  finally{$('aiBtn').disabled=false;$('aiBtn').textContent='AI 生成文章结构+SEO';}
};

/* ===== Ⅶ. 生成静态 HTML ===== */
$('generateStaticHtmlBtn').onclick=async()=>{
  const title=$('newTitle').value.trim();
  const content=await safeSave();
  if(!title||!content)return alert('请填写标题和内容');

  const slug=title.toLowerCase().replace(/\s+/g,'-').replace(/[^\w\-]/g,'');
  const date=nowISO().slice(0,10);
  const html=`<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8">
<title>${esc(title)} | MeFan 技术博客</title>
<meta name="description" content="${esc(title)}"><meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="canonical" href="https://oliverfr.com/articles/${slug}.html">
<style>body{font:16px/1.7 Arial,Helvetica,sans-serif;max-width:720px;margin:60px auto;padding:0 15px}</style>
</head><body>
<h1>${esc(title)}</h1><p style="color:#777;font-size:14px">发布日期：${date}</p>
${marked.parse(content)}</body></html>`;

  $('generateStaticHtmlBtn').disabled=true;
  try{
    const r=await fetch(`${ENDPOINT}/`,{
      method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({slug,html})
    }).then(r=>r.json());
    if(!r.success)throw new Error(r.message||r.detail);
    alert('✅ 已发布：'+r.url);
  }catch(e){alert('发布失败：'+e.message);}
  finally{$('generateStaticHtmlBtn').disabled=false;}
};
</script>
</body>
</html>
