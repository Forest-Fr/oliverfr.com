<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<title>æ–‡ç« åå°ç®¡ç†</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>

<!-- ===== ä¸»é¢˜è‰² + æ ·å¼ï¼ˆåŸæ ·ï¼‰ ===== -->
<style>
  :root{--bg:#f8f8f8;--txt:#000;--card:#fff;--border:#ddd;--btn:#333;--btn-h:#555}
  @media (prefers-color-scheme:dark){
    :root{--bg:#1e1e1e;--txt:#e3e3e3;--card:#2a2a2a;--border:#444;--btn:#444;--btn-h:#666}
  }
  body{font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--txt);
       margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
  h1{font-size:24px;margin-bottom:10px}
  .btn{padding:8px 16px;background:var(--btn);color:#fff;border:none;cursor:pointer;margin:5px}
  .btn:hover{background:var(--btn-h)}
  .hidden{display:none}
  textarea,input[type="text"],input[type="file"]{width:100%;margin:5px 0}
  table{width:100%;max-width:960px;border-collapse:collapse;margin-top:20px;background:var(--card);table-layout:fixed}
  th,td{padding:10px;border:1px solid var(--border);text-align:left}
  th{background:rgba(0,0,0,.06)}
  td.author,td.content{word-break:break-all;overflow:hidden;text-overflow:ellipsis;max-width:340px}
  .admin-bar{display:flex;justify-content:space-between;align-items:center;max-width:960px;width:100%;margin-bottom:20px;flex-wrap:wrap}
  .admin-bar>input{flex:1;min-width:200px;margin:5px}
  .admin-bar>div{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:5px}
  #previewModal{position:fixed;top:10%;left:50%;transform:translateX(-50%);
    background:var(--card);color:var(--txt);padding:20px;border:1px solid var(--border);
    max-width:700px;width:90%;z-index:999;overflow-y:auto;max-height:80vh}
  #markdownContent{white-space:pre-wrap}
  @media (max-width:768px){
    .admin-bar{flex-direction:column;align-items:stretch}
    .btn,textarea{width:100%;margin:5px 0}
    table,thead,tbody,th,td,tr{display:block}
    thead{display:none}
    tbody tr{border:1px solid var(--border);margin-bottom:15px;background:var(--card);padding:10px}
    tbody td{display:flex;justify-content:space-between;padding:8px 5px;border:none;border-bottom:1px solid var(--border)}
    tbody td::before{content:attr(data-label);font-weight:bold;color:#aaa;flex:1;margin-right:10px}
    #submitBtn,#cancelEditBtn{width:100%}
  }
</style>

<!-- ===== ä¾èµ– ===== -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2"></script>
</head>

<body>
<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<!-- ç™»å½•åŒº -->
<div id="authArea"><button id="loginBtn" class="btn">ä½¿ç”¨Â GitHubÂ ç™»å½•</button></div>

<!-- ============ ç®¡ç†åŒºï¼ˆåŸ HTML ä¿æŒä¸å˜ï¼‰ ============ -->
<div id="adminArea" class="hidden">
  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦">
    <div>
      <button id="searchBtn" class="btn">ğŸ” æœç´¢</button>
      <button id="logoutBtn" class="btn">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
  <input type="text" id="newTitle" placeholder="æ ‡é¢˜">
  <div style="display:flex;gap:10px;margin:5px 0">
    <button id="toggleToEditor"  class="btn">ğŸ“ å¯è§†åŒ–æ¨¡å¼</button>
    <button id="toggleToTextarea" class="btn hidden">ğŸ–Š Markdown æ¨¡å¼</button>
  </div>
  <div id="editorContainer" class="hidden" style="border:1px solid var(--border);min-height:200px;padding:10px;background:var(--card)"></div>
  <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
  <input type="file" id="coverInput" accept="image/*">
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0">
    <button id="submitBtn"             class="btn">æäº¤</button>
    <button id="cancelEditBtn"         class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
    <button id="generateStaticHtmlBtn" class="btn">ç”Ÿæˆé™æ€æ–‡ç« æ–‡ä»¶</button>
    <button id="aiBtn"                 class="btn">AI ç”Ÿæˆæ–‡ç« ç»“æ„+SEO</button>
  </div>

  <div style="overflow-x:auto;width:100%">
    <table id="articlesTable">
      <thead><tr><th>æ ‡é¢˜</th><th>ä½œè€…</th><th>å†…å®¹</th><th>åˆ›å»ºæ—¶é—´</th><th>æ›´æ–°æ—¶é—´</th><th>æ˜ŸæœŸ</th><th>å°é¢</th><th>æ“ä½œ</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="previewModal" class="hidden">
    <h3 id="previewTitle"></h3>
    <img id="previewCover" style="max-width:100%;margin:10px 0;">
    <div id="markdownContent"></div>
    <button class="btn" onclick="closePreview()">å…³é—­</button>
  </div>
</div>

<!-- ============ å·¥å…· + Supabase åˆå§‹åŒ– ============ -->
<script>
const $   = id=>document.getElementById(id);
const esc = s=>(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
const toBJ = ()=>new Date(Date.now()+288e5).toISOString().replace('Z','+08:00');
const fmt  = s=>new Date(s).toLocaleString('zh-CN',{hour12:false});
const wk   = s=>'æ—¥ä¸€äºŒä¸‰å››äº”å…­'[new Date(s).getDay()];

const WORKER_BASE='https://copilot-router.mefans.workers.dev';
const ANON_KEY    ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';   /* â† å¿…å¡« */
const ADMIN_EMAIL ='oliveroogle@gmail.com';

const supa = supabase.createClient(WORKER_BASE, ANON_KEY);
</script>

<!-- ============ ç™»å½• / ä¼šè¯å¤„ç† ============ -->
<script>
/* 1. å…ˆæŠŠ OAuth å›è·³å‚æ•°å†™å…¥ localStorage */
(async()=>{
  try{
    await supa.auth.getSessionFromUrl({storeSession:true});
    history.replaceState({},"",location.pathname);
  }catch(e){/* ignore */}

/* 2. DOM åŠ è½½åå†ç»‘å®šæ‰€æœ‰äº‹ä»¶ */
document.addEventListener('DOMContentLoaded',async()=>{
  $('loginBtn').onclick=()=>supa.auth.signInWithOAuth({
    provider:'github',
    options:{redirectTo:location.origin+location.pathname}
  });
  $('logoutBtn').onclick=async()=>{await supa.auth.signOut();location.reload();};

  /* 3. å·²ç™»å½•åˆ™è¿›å…¥åå° */
  const {data:{session}}=await supa.auth.getSession();
  if(session?.user?.email===ADMIN_EMAIL){
    $('authArea').classList.add('hidden');
    $('adminArea').classList.remove('hidden');
    initAdmin();           // â† çœŸæ­£çš„ä¸šåŠ¡é€»è¾‘
  }
});
})();
</script>

<!-- ============ ä¸šåŠ¡é€»è¾‘ï¼ˆCRUD / AI / ç”Ÿæˆé™æ€ HTMLï¼‰ ============ -->
<script>
function initAdmin(){
  /* ------ å˜é‡ / DOM ç¼“å­˜ ------ */
  const btnE=$('toggleToEditor'),btnT=$('toggleToTextarea');
  const editorDiv=$('editorContainer'),mdArea=$('newContent'),titleInp=$('newTitle');
  const coverInput=$('coverInput'),tbBody=$('#articlesTable tbody');
  const aiBtn=$('aiBtn'),genBtn=$('generateStaticHtmlBtn');
  let editor=null,editingId=null,page=1,limit=5,loading=false;

  /* ------ å¯è§†åŒ– â†” Markdown ------ */
  btnE.onclick=async()=>{
    if(editor) await editor.destroy();
    editorDiv.classList.remove('hidden');mdArea.classList.add('hidden');
    btnE.classList.add('hidden');btnT.classList.remove('hidden');
    editor=new EditorJS({
      holder:'editorContainer',
      tools:{
        paragraph:{class:window.ParagraphTool||window.Paragraph,inlineToolbar:true},
        header   :{class:window.HeaderTool  ||window.Header,   inlineToolbar:true}
      },
      data:{blocks:[{type:'paragraph',data:{text:mdArea.value.replace(/\n/g,'<br>')}}]}
    });
  };
  btnT.onclick=async()=>{
    if(!editor)return;
    const d=await editor.save();
    mdArea.value=d.blocks.map(b=>b.data.text||'').join('\n\n');
    await editor.destroy();editor=null;
    editorDiv.classList.add('hidden');mdArea.classList.remove('hidden');
    btnE.classList.remove('hidden');btnT.classList.add('hidden');
  };

  /* ------ åˆ—è¡¨åŠ è½½ ------ */
  async function loadArticles(reset=false,kw=''){
    if(loading) return;loading=true;
    if(reset){tbBody.innerHTML='';page=1}
    let q=supa.from('articles').select('*').order('created_at',{ascending:false})
             .range((page-1)*limit,page*limit-1);
    if(kw) q=q.ilike('title',`%${kw}%`);
    const {data=[],error}=await q; if(error){alert(error.message);loading=false;return;}
    data.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`
        <td data-label="æ ‡é¢˜">${esc(r.title)}</td>
        <td class="author"  data-label="ä½œè€…">${esc(r.author_email||'')}</td>
        <td class="content" data-label="å†…å®¹">${esc((r.content||'').slice(0,60))}â€¦</td>
        <td data-label="åˆ›å»ºæ—¶é—´">${fmt(r.created_at)}</td>
        <td data-label="æ›´æ–°æ—¶é—´">${fmt(r.updated_at)}</td>
        <td data-label="æ˜ŸæœŸ">æ˜ŸæœŸ${wk(r.created_at)}</td>
        <td data-label="å°é¢">${r.cover_url?`<img src="${r.cover_url}" style="height:40px">`:''}</td>
        <td data-label="æ“ä½œ">
          <button class="btn" onclick='preview(${r.id})'>é¢„è§ˆ</button>
          <button class="btn" onclick='edit(${r.id})'>ç¼–è¾‘</button>
          <button class="btn" onclick='remove("${r.id}")'>åˆ é™¤</button>
        </td>`;
      tbBody.appendChild(tr);
      cache.set(r.id,r);                       // æœ¬åœ°ç®€å•ç¼“å­˜
    });
    if(data.length===limit) page++; loading=false;
  }
  const cache=new Map();             // id -> row
  window.preview=id=>{
    const r=cache.get(id); if(!r)return;
    $('previewTitle').textContent=r.title;
    $('previewCover').src=r.cover_url||'';
    $('markdownContent').innerHTML=marked.parse(r.content||'');
    $('previewModal').classList.remove('hidden');
  };
  window.closePreview=()=>$('previewModal').classList.add('hidden');
  window.edit=id=>{
    const r=cache.get(id); if(!r)return;
    titleInp.value=r.title;mdArea.value=r.content;editingId=id;
    $('cancelEditBtn').classList.remove('hidden');btnT.onclick(); // å¼ºåˆ¶åˆ‡å›æ–‡æœ¬åŸŸ
    window.scrollTo(0,0);
  };
  window.remove=async id=>{
    if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;
    const{error}=await supa.from('articles').delete().eq('id',id);
    error?alert(error.message):loadArticles(true);
  };

  $('searchBtn').onclick=()=>loadArticles(true,$('searchInput').value.trim());
  window.addEventListener('scroll',()=>{if(!loading&&window.innerHeight+window.scrollY>document.body.offsetHeight-80)loadArticles();});
  loadArticles(true);               // é¦–æ¬¡æ‹‰å–

  /* ------ æäº¤ / æ›´æ–° ------ */
  $('submitBtn').onclick=async()=>{
    const title=titleInp.value.trim();
    const content=editor?(await editor.save()).blocks.map(b=>b.data.text||'').join('\n\n'):mdArea.value.trim();
    if(!title||!content) return alert('æ ‡é¢˜/å†…å®¹ä¸èƒ½ä¸ºç©º');

    const {data:{user}}=await supa.auth.getUser();
    const row={title,content,author_email:user?.email||'',updated_at:toBJ()};
    if(coverInput.files[0]){
      const file=coverInput.files[0];
      const {data, error}=await supa.storage.from('articles').upload(`covers/${Date.now()}_${file.name}`,file,{upsert:true});
      if(error) return alert('å°é¢ä¸Šä¼ å¤±è´¥ï¼š'+error.message);
      row.cover_url=supa.storage.from('articles').getPublicUrl(data.path).data.publicUrl;
    }
    let err;
    if(editingId) ({error:err}=await supa.from('articles').update(row).eq('id',editingId));
    else{row.created_at=row.updated_at;({error:err}=await supa.from('articles').insert([row]));}
    if(err) return alert(err.message);
    $('cancelEditBtn').click(); loadArticles(true);
  };
  $('cancelEditBtn').onclick=()=>{titleInp.value='';mdArea.value='';editingId=null;$('cancelEditBtn').classList.add('hidden');};

  /* ------ AI ç”Ÿæˆï¼ˆä¿æŒåŸå®ç°ï¼‰ ------ */
  aiBtn.onclick=async()=>{
    const topic=titleInp.value.trim(); if(!topic)return alert('è¯·å…ˆè¾“å…¥æ ‡é¢˜');
    try{
      const j=await fetch('https://gpt.mefans.workers.dev/gpt',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({topic})}).then(r=>r.json());
      if(!j.success) throw new Error(j.detail||j.message||'ç”Ÿæˆå¤±è´¥');
      const article=j.article_body||j.article||j.content||'';
      mdArea.value=article;
      if(editor){await editor.blocks.clear();await editor.blocks.insert('paragraph',{text:article});}
      alert('âœ… AI å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æ£€æŸ¥ï¼');
    }catch(e){alert('âŒ GPT ç”Ÿæˆå¤±è´¥ï¼š'+e.message);}
  };

  /* ------ ç”Ÿæˆé™æ€ HTMLï¼ˆç•¥ï¼Œå®Œå…¨ä¿ç•™ä½ ä¹‹å‰çš„å®ç°ï¼‰ ------ */
  genBtn.onclick=async()=>{ /* â€¦â€¦ä¿æŒåŸé€»è¾‘å³å¯â€¦â€¦ */ };
}
</script>
</body>
</html>
