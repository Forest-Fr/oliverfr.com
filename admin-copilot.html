<!-- admin-mefan-articles.html â€•â€• 2025-04-26 SEO æ•´åˆ & AI å›å¡«ä¿®æ­£ç‰ˆ -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<title>æ–‡ç« åå°ç®¡ç†</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f8f8f8;margin:0;padding:20px;display:flex;flex-direction:column;align-items:center}
h1{font-size:24px;margin-bottom:10px}
.btn{padding:8px 16px;background:#333;color:#fff;border:none;cursor:pointer;margin:5px}
.btn:hover{background:#555}
.hidden{display:none}
textarea,input[type="text"],input[type="file"]{width:100%;margin:5px 0}
table{width:100%;max-width:960px;border-collapse:collapse;margin-top:20px;background:#fff;table-layout:fixed}
th,td{padding:10px;border:1px solid #ddd;text-align:left}
th{background:#f0f0f0}
td.author,td.content{word-break:break-all;overflow:hidden;text-overflow:ellipsis;max-width:340px}
.admin-bar{display:flex;justify-content:space-between;align-items:center;max-width:960px;width:100%;margin-bottom:20px;flex-wrap:wrap}
.admin-bar>input{flex:1;min-width:200px;margin:5px}
.admin-bar>div{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;margin:5px}
#previewModal{position:fixed;top:10%;left:50%;transform:translateX(-50%);background:#fff;padding:20px;border:1px solid #ccc;max-width:700px;width:90%;z-index:999;overflow-y:auto;max-height:80vh}
#markdownContent{white-space:pre-wrap}
@media (max-width:768px){
  .admin-bar{flex-direction:column;align-items:stretch}
  .btn,textarea{width:100%;margin:5px 0}
  table,thead,tbody,th,td,tr{display:block}
  thead{display:none}
  tbody tr{border:1px solid #ddd;margin-bottom:15px;background:#fff;padding:10px}
  tbody td{display:flex;justify-content:space-between;padding:8px 5px;border:none;border-bottom:1px solid #eee}
  tbody td::before{content:attr(data-label);font-weight:bold;color:#555;flex:1;margin-right:10px}
  #submitBtn,#cancelEditBtn{width:100%}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>
</head>
<body>
<h1>ğŸ“° æ–‡ç« åå°ç®¡ç†</h1>

<!-- ç™»å½•åŒº -->
<div id="authArea">
  <button id="loginBtn" class="btn">ä½¿ç”¨ GitHub ç™»å½•</button>
</div>

<!-- ç®¡ç†åŒº -->
<div id="adminArea" class="hidden">
  <!-- é¡¶éƒ¨æœç´¢ / é€€å‡º -->
  <div class="admin-bar">
    <input type="text" id="searchInput" placeholder="æœç´¢æ ‡é¢˜å…³é”®è¯â€¦">
    <div>
      <button id="searchBtn" class="btn" style="width:auto">ğŸ” æœç´¢</button>
      <button id="logoutBtn" class="btn" style="width:auto">é€€å‡ºç™»å½•</button>
    </div>
  </div>

  <!-- æ–°å¢ / ç¼–è¾‘ -->
  <h2>ğŸ†• æ–°å¢/ç¼–è¾‘æ–‡ç« </h2>
  <input type="text" id="newTitle" placeholder="æ ‡é¢˜">
  <textarea id="seoDescriptionInput" placeholder="SEO æè¿° (å¯é€‰)"></textarea>
  <input type="text" id="keywordsInput" placeholder="SEO å…³é”®è¯ (ç”¨é€—å·åˆ†éš”, å¯é€‰)">
  <div style="display:flex;gap:10px;margin:5px 0">
    <button id="toggleToEditor"  class="btn" style="width:auto">ğŸ“ å¯è§†åŒ–æ¨¡å¼</button>
    <button id="toggleToTextarea" class="btn hidden" style="width:auto">ğŸ–Š Markdown æ¨¡å¼</button>
  </div>
  <div id="editorContainer" class="hidden" style="border:1px solid #ccc;min-height:200px;padding:10px;background:#fff"></div>
  <textarea id="newContent" placeholder="æ”¯æŒ Markdown æ ¼å¼çš„å†…å®¹"></textarea>
  <input type="file" id="coverInput" accept="image/*">
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin:10px 0">
    <button id="submitBtn"         class="btn">æäº¤</button>
    <button id="cancelEditBtn"     class="btn hidden">å–æ¶ˆç¼–è¾‘</button>
    <button id="generateStaticHtmlBtn" class="btn">ç”Ÿæˆé™æ€æ–‡ç« æ–‡ä»¶</button>
    <button id="aiBtn"             class="btn">AI ç”Ÿæˆæ–‡ç« ç»“æ„+SEO</button>
  </div>

  <!-- åˆ—è¡¨ -->
  <div style="overflow-x:auto;width:100%">
    <table id="articlesTable">
      <thead>
        <tr>
          <th>æ ‡é¢˜</th>
          <th>ä½œè€…</th>
          <th>å†…å®¹</th>
          <th>SEO æè¿°</th>
          <th>SEO å…³é”®è¯</th>
          <th>åˆ›å»ºæ—¶é—´</th>
          <th>æ›´æ–°æ—¶é—´</th>
          <th>æ˜ŸæœŸ</th>
          <th>å°é¢</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- é¢„è§ˆå¼¹çª— -->
  <div id="previewModal" class="hidden">
    <h3 id="previewTitle"></h3>
    <img id="previewCover">
    <div id="markdownContent"></div>
    <button class="btn" onclick="closePreview()">å…³é—­</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/paragraph@2.11.0/dist/bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@editorjs/header@2.7.0/dist/bundle.js"></script>

<script>
/* ============ 0.Â åŠ¨æ€åŠ è½½ Editor.js ä¸»åŒ… ============ */
(function loadEditorJS(run) {
  if (window.EditorJS) { run(); return; }
  const s = document.createElement('script');
  s.src   = 'https://cdn.jsdelivr.net/npm/@editorjs/editorjs@2.28.2';
  s.onload = run;
  document.head.appendChild(s);
})(main);

/* ============ 1.Â ä¸»å…¥å£ ============ */
function main() {

/* ---------- 1.1 è¿è¡Œæ—¶å¸¸é‡ ---------- */
const WORKER_BASE = 'https://oliverfr-articles-proxy.mefans.workers.dev'; // SupabaseÂ ä»£ç†
const RAG_URL     = '/api/rag';                                           // å‘é‡æ£€ç´¢ Worker è·¯ç”±
const ANON_KEY   ='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg';          // Supabase anon
const ADMIN_EMAIL = 'oliveroogle@gmail.com';                              // å…è®¸ç™»å½•é‚®ç®±

/* ---------- 1.2 å·¥å…·å‡½æ•° ---------- */
const supa   = supabase.createClient(WORKER_BASE, ANON_KEY);
const $      = id => document.getElementById(id);
const toBJ   = () => new Date(Date.now() + 288e5).toISOString().replace('Z', '+08:00');
const fmt    = s => new Date(s).toLocaleString('zh-CN', { hour12: false });
const wk     = s => 'æ—¥ä¸€äºŒä¸‰å››äº”å…­'[new Date(s).getDay()];
const esc    = s => (s || '').replace(/[&<>"']/g, c => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c]));
const escapeHTML = esc;

/* ---------- 1.3 DOM å…ƒç´ ç¼“å­˜ ---------- */
const btnE          = $('toggleToEditor');
const btnT          = $('toggleToTextarea');
const editorDiv     = $('editorContainer');
const mdArea        = $('newContent');
const titleInp      = $('newTitle');
const seoDescInp    = $('seoDescriptionInput');
const keywordsInp   = $('keywordsInput');
const tbBody        = document.querySelector('#articlesTable tbody');
const aiBtn         = $('aiBtn');
const genBtn        = $('generateStaticHtmlBtn');
const coverInput    = $('coverInput');
const searchInput   = $('searchInput');
const searchBtn     = $('searchBtn');
const submitBtn     = $('submitBtn');
const cancelEditBtn = $('cancelEditBtn');
const loginBtn      = $('loginBtn');
const logoutBtn     = $('logoutBtn');

/* ---------- 1.4 è¿è¡ŒçŠ¶æ€å˜é‡ ---------- */
let editor      = null;
let editingId   = null;
let page        = 1;
let limit       = 5;
let loading     = false;
let authJwt     = '';

/* ============ 2.Â å¯è§†åŒ–ç¼–è¾‘å™¨åˆ‡æ¢ ============ */
btnE.onclick = async () => {
  if (editor) await editor.destroy();
  editorDiv.classList.remove('hidden');
  mdArea.classList.add('hidden');
  btnE.classList.add('hidden');
  btnT.classList.remove('hidden');

  const tools = {};
  if (window.ParagraphTool || window.Paragraph)
    tools.paragraph = { class: window.ParagraphTool || window.Paragraph, inlineToolbar: true };
  if (window.HeaderTool || window.Header)
    tools.header = { class: window.HeaderTool || window.Header, inlineToolbar: true };

  editor = new window.EditorJS({
    holder: 'editorContainer',
    tools,
    data: { blocks: [ { type: 'paragraph', data: { text: mdArea.value.replace(/\n/g, '<br>') } } ] }
  });
};

btnT.onclick = destroyEditor;

async function destroyEditor () {
  if (!editor) return;
  try {
    const s = await editor.save();
    mdArea.value = s.blocks.map(b => b.data.text || '').join('\n\n');
    await editor.destroy();
  } catch (e) { console.warn(e); }
  editor = null;
  editorDiv.classList.add('hidden');
  mdArea.classList.remove('hidden');
  btnE.classList.remove('hidden');
  btnT.classList.add('hidden');
}

/* ============ 3.Â è®¤è¯ä¸åˆå§‹åŒ– ============ */
(async () => {
  try {
    /* 3.1 å¤„ç† OAuth è·³è½¬å‚æ•°ï¼ˆè§£å†³ç§»åŠ¨ç«¯æ— æ³•å›å†™ sessionï¼‰ */
    const { data, error } = await supa.auth.getSessionFromUrl({ storeSession: true });
    if (error) console.warn('OAuth è§£æå¤±è´¥:', error);
    if (data?.session) history.replaceState(null, '', location.pathname);
  } catch (e) { console.error('OAuth å¤„ç†å¼‚å¸¸:', e); }

  /* 3.2 è·å–ä¼šè¯ */
  const { data: { session } } = await supa.auth.getSession();
  if (session?.access_token) authJwt = session.access_token;

  if (session?.user?.email === ADMIN_EMAIL) {
    $('authArea').classList.add('hidden');
    $('adminArea').classList.remove('hidden');
    loadArticles(true);
  }
})();

loginBtn.onclick  = () => supa.auth.signInWithOAuth({ provider: 'github', options: { redirectTo: location.href } });
logoutBtn.onclick = async () => { await supa.auth.signOut(); location.reload(); };

/* ============ 4.Â æ–‡ç«  CRUD ============ */
submitBtn.onclick = async () => {
  const title   = titleInp.value.trim();
  const content = editor
      ? (await editor.save()).blocks.map(b => b.data.text || '').join('\n\n').trim()
      : mdArea.value.trim();
  if (!title || !content) return alert('æ ‡é¢˜/å†…å®¹ä¸èƒ½ä¸ºç©º');

  const { data: { user } } = await supa.auth.getUser();
  const row = {
    title,
    content,
    seo_description: seoDescInp.value.trim(),
    keywords:        keywordsInp.value.trim(),
    author_email:    user?.email || '',
    updated_at:      toBJ()
  };

  /* 4.1 ä¸Šä¼ å°é¢ */
  if (coverInput.files[0]) {
    const file = coverInput.files[0];
    const { data, error } = await supa.storage
      .from('articles')
      .upload(`covers/${Date.now()}_${file.name}`, file, { upsert: true });
    if (error) return alert('å°é¢ä¸Šä¼ å¤±è´¥: ' + error.message);
    row.cover_url = supa.storage.from('articles').getPublicUrl(data.path).data.publicUrl;
  }

  /* 4.2 å†™å…¥ / æ›´æ–°æ–‡ç«  */
  let err;
  if (editingId)
        ({ error: err } = await supa.from('articles').update(row).eq('id', editingId));
  else {
        row.created_at = row.updated_at;
        ({ error: err } = await supa.from('articles').insert([row]));
  }
  if (err) return alert(err.message);

  /* 4.3 å‘é‡åŒæ­¥åˆ° RAG */
  try {
    await fetch(`${RAG_URL}/embed`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': authJwt ? `Bearer ${authJwt}` : 'Bearer x'
      },
      body: JSON.stringify({ text: content })
    });
    console.info('âœ… å‘é‡åŒæ­¥æˆåŠŸ');
  } catch (e) {
    console.warn('âš ï¸ å‘é‡åŒæ­¥å¤±è´¥ï¼ˆä¸å½±å“æ–‡ç« ä¿å­˜ï¼‰ï¼š', e);
  }

  cancelEditBtn.click();
  loadArticles(true);
};

cancelEditBtn.onclick = () => {
  titleInp.value      = '';
  mdArea.value        = '';
  seoDescInp.value    = '';
  keywordsInp.value   = '';
  editingId           = null;
  destroyEditor();
  cancelEditBtn.classList.add('hidden');
};

/* ç¼–è¾‘ */
window.editArticle = r => {
  titleInp.value       = r.title;
  mdArea.value         = r.content;
  seoDescInp.value     = r.seo_description || '';
  keywordsInp.value    = r.keywords || '';
  editingId            = r.id;
  cancelEditBtn.classList.remove('hidden');
  destroyEditor();
  window.scrollTo(0, 0);
};

/* åˆ é™¤ */
window.deleteArticle = async id => {
  if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
  const { error } = await supa.from('articles').delete().eq('id', id);
  if (error) alert(error.message);
  else loadArticles(true);
};

/* é¢„è§ˆ */
window.previewArticle = r => {
  $('previewTitle').textContent = r.title;
  $('previewCover').src         = r.cover_url || '';
  $('markdownContent').innerHTML = marked.parse(r.content || '');
  $('previewModal').classList.remove('hidden');
};
window.closePreview  = () => $('previewModal').classList.add('hidden');

/* ============ 5.Â æ–‡ç« åˆ—è¡¨ & æ— é™æ»šåŠ¨ ============ */
searchBtn.onclick = () => loadArticles(true, searchInput.value.trim());
window.addEventListener('scroll', () => {
  if (!loading && window.innerHeight + window.scrollY > document.body.offsetHeight - 80)
    loadArticles();
});

async function loadArticles (reset = false, kw = '') {
  if (loading) return;
  loading = true;
  if (reset) { tbBody.innerHTML = ''; page = 1; }

  let q = supa.from('articles')
              .select('*')
              .order('created_at', { ascending: false })
              .range((page - 1) * limit, page * limit - 1);
  if (kw) q = q.ilike('title', '%' + kw + '%');

  const { data = [], error } = await q;
  if (error) { alert(error.message); loading = false; return; }

  data.forEach(r => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td data-label="æ ‡é¢˜">${esc(r.title)}</td>
      <td class="author" data-label="ä½œè€…">${esc(r.author_email || '')}</td>
      <td class="content" data-label="å†…å®¹">${esc((r.content || '').slice(0, 60))}â€¦</td>
      <td data-label="SEO æè¿°">${esc(r.seo_description || '')}</td>
      <td data-label="SEO å…³é”®è¯">${esc(r.keywords || '')}</td>
      <td data-label="åˆ›å»ºæ—¶é—´">${fmt(r.created_at)}</td>
      <td data-label="æ›´æ–°æ—¶é—´">${fmt(r.updated_at)}</td>
      <td data-label="æ˜ŸæœŸ">æ˜ŸæœŸ${wk(r.created_at)}</td>
      <td data-label="å°é¢">${r.cover_url ? `<img src="${r.cover_url}" style="height:40px">` : ''}</td>
      <td data-label="æ“ä½œ">
        <button class="btn" onclick='previewArticle(${JSON.stringify(r).replace(/'/g, '&#39;')})'>é¢„è§ˆ</button>
        <button class="btn" onclick='editArticle(${JSON.stringify(r).replace(/'/g, '&#39;')})'>ç¼–è¾‘</button>
        <button class="btn" onclick="deleteArticle('${r.id}')">åˆ é™¤</button>
      </td>`;
    tbBody.appendChild(tr);
  });

  if (data.length === limit) page++;
  loading = false;
}

/* ============ 6.Â AI ç”Ÿæˆæ–‡ç«  & SEO ============ */
aiBtn.onclick = async () => {
  const topic = titleInp.value.trim();
  if (!topic) return alert('è¯·å…ˆè¾“å…¥æ ‡é¢˜');

  try {
    const j = await fetch('https://gpt.mefans.workers.dev/gpt', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ topic })
    }).then(r => r.json());

    /* è§£æå¤šå½¢æ€è¿”å› */
    let article = j.article_body || j.article || j.content || '';
    let seoDesc = j.seo_description || '';
    let kws     = j.keywords || '';

    /* GPT å¯èƒ½æŠŠ JSON ä½œä¸ºå­—ç¬¦ä¸²è¿”å› */
    if (!article && typeof j === 'string') {
      try {
        const inner = JSON.parse(j);
        article = inner.article_body || inner.article || inner.content || '';
        seoDesc = inner.seo_description || '';
        kws     = inner.keywords || '';
      } catch (_) {}
    }

    mdArea.value       = article;
    seoDescInp.value   = seoDesc;
    keywordsInp.value  = kws;

    if (editor) {
      await editor.blocks.clear();
      await editor.blocks.insert('paragraph', { text: article.replace(/\n/g, '<br>') });
    }

    alert('âœ… AI å†…å®¹å·²ç”Ÿæˆï¼Œè¯·æ£€æŸ¥ç¼–è¾‘åŒºå’Œ SEO åŒºåŸŸï¼');
  } catch (e) {
    alert('âŒ GPT ç”Ÿæˆå¤±è´¥ï¼š' + e.message);
  }
};

/* ============ 7.Â ç”Ÿæˆé™æ€ HTML å¹¶ä¸Šä¼  GitHub ============ */
genBtn.onclick = async () => {
  const title   = titleInp.value.trim();
  const content = editor
    ? (await editor.save()).blocks.map(b => b.data.text || '').join('\n\n').trim()
    : mdArea.value.trim();
  if (!title || !content) return alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');

  const seoDesc  = seoDescInp.value.trim() || content.slice(0, 150).replace(/\n/g, ' ').trim();
  const keywords = keywordsInp.value.trim() || `MeFan, ${title}`;
  const createdAt = toBJ().split('T')[0];
  const slug      = title.toLowerCase().replace(/\s+/g, '-').replace(/[^\w\-]/g, '');
  const coverUrl  = `https://oliverfr.com/covers/${slug}-cover.jpg`;
  const ogImageUrl= `https://oliverfr.com/og-images/${slug}-og.jpg`;
  const logoUrl   = `https://oliverfr.com/assets/logo.png`;

 const html = `<!DOCTYPE html>
<html lang="zh-CN"><head><meta charset="UTF-8" />
<title>${escapeHTML(title)} | MeFan æŠ€æœ¯åšå®¢</title>
<meta name="description" content="${escapeHTML(seoDesc)}" />
<meta name="keywords" content="${escapeHTML(keywords)}" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<meta name="robots" content="index, follow" />
<link rel="canonical" href="https://oliverfr.com/articles/${slug}.html" />
<meta property="og:type" content="article" />
<meta property="og:title" content="${escapeHTML(title)}" />
<meta property="og:description" content="${escapeHTML(seoDesc)}" />
<meta property="og:image" content="${ogImageUrl}" />
<meta property="og:url" content="https://oliverfr.com/articles/${slug}.html" />
<meta property="og:site_name" content="MeFan Tech" />
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="${escapeHTML(title)}" />
<meta name="twitter:description" content="${escapeHTML(seoDesc)}" />
<meta name="twitter:image" content="${ogImageUrl}" />
<script type="application/ld+json">${JSON.stringify({
  "@context":"https://schema.org",
  "@type":"Article",
  headline:title,
  description:seoDesc,
  keywords,
  image:ogImageUrl,
  author:{ "@type":"Person", name:"Oliver F." },
  publisher:{
    "@type":"Organization",
    name:"MeFan Solutions",
    logo:{ "@type":"ImageObject", url:logoUrl }
  },
  datePublished:createdAt,
  dateModified:createdAt,
 mainEntityOfPage:{ "@type":"WebPage", "@id":"https://oliverfr.com/articles/"+slug+".html" }
},null,2)}</script>
<style>
body{font-family:Arial,sans-serif;margin:40px auto;max-width:700px;line-height:1.6}
h1{font-size:28px;margin-bottom:20px}
.meta{color:#888;font-size:14px;margin-bottom:20px}
img{max-width:100%;margin:20px 0}
.logo{display:block;margin:0 auto 20px;height:60px}
</style></head><body>
<img src="${logoUrl}" alt="MeFan Logo" class="logo" />
<h1>${escapeHTML(title)}</h1>
<div class="meta">release dateï¼š${createdAt} ï½œ Authorï¼šOliver F.</div>
<img src="${coverUrl}" alt="${escapeHTML(title)} å°é¢å›¾" />
${marked.parse(content)}
</body></html>`;


  try {
    const res = await fetch('https://upload-articlejs.mefans.workers.dev/', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ slug, html })
    }).then(r => r.json());

    if (res.success) alert('âœ… å·²å‘å¸ƒä¸Šçº¿ï¼š' + res.url);
    else alert('âŒ å‘å¸ƒå¤±è´¥ï¼š' + (res.message || JSON.stringify(res)));
  } catch (e) {
    alert('âŒ ç½‘ç»œå¼‚å¸¸ï¼š' + e.message);
  }
};

} /* end main */
</script>

</body>
</html>
