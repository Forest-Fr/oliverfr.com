<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Mini-GPT</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root {
  --radius: 24px;
  --grey: #e4e4e7;
  --bubble: #f7f7f8;
  --side-gap: 190px;
  --font: 16px/1.45 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  overflow-y: auto;           /* 恢复根容器纵向滚动原overflow: hidden; */
    overscroll-behavior-y: auto;/* 允许边界“橡皮筋”回弹并触发浏览器原生下拉刷新 */
  font: var(--font);
  background: #fafafa;
}

body { padding: 40px var(--side-gap) 220px; }

/* 开场提示 */
/* 欢迎语固定底部（动态 JS 调整 bottom） */
#welcome{
  position:fixed;left:50%;transform:translateX(-50%);
  font-size:21px;font-weight:600;line-height:1.2;
  z-index:3000;pointer-events:none;text-align:center;
  max-width:90%;bottom:60px; /* 初始兜底 */
}

/* 聊天区 */
#chat {
  display: flex;
  flex-direction: column;
  gap: 16px;
  height: calc(100vh - 190px);
  padding-left: var(--side-gap);
  overflow-x: auto;
  overflow-y: auto;
  scroll-behavior: smooth;
}

/* 聊天气泡 */
.msg {
  max-width: 100%;
  width: fit-content;
  position: relative;
  padding: 12px 16px;
  background: var(--bubble);
  border-radius: 12px;
  font-size: 15px;
  line-height: 1.55;
  color: #111;
  word-break: break-word;
  white-space: pre-wrap;
}
.msg.bot { align-self: flex-start; margin-left: calc(-1 * var(--side-gap)) !important }
.msg.user { align-self: flex-end; background: #e0f2ff; }
.msg.system { align-self: center; background:#fff3cd; color:#7a5a00; }

/* Clarify 特殊气泡 */
.msg.clarify {
  background: #fffbe6;
  border: 1px solid #f5d36b;
  color: #7a5a00;
}

/* Streaming 高亮动画 */
.msg.streaming {
  background: #eef6ff;
  box-shadow: 0 0 0 1px #d0e6ff inset;
  position: relative;
}
.msg.streaming:after {
  content: '';
  position: absolute;
  right: 6px; bottom: 6px;
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #3b82f6;
  animation: pulseDot 1.2s ease-in-out infinite;
}
@keyframes pulseDot {
  0% { transform: scale(.7); opacity:.4; }
  50% { transform: scale(1); opacity:1; }
  100% { transform: scale(.7); opacity:.4; }
}

/* 图片网格 */
.pics {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: max-content;
  gap: 8px;
  margin-bottom: 8px;
  max-width: 100%;
  overflow-x: auto;
}
.pics img {
  height: 160px;
  width: auto;
  border-radius: 8px;
  object-fit: cover;
  cursor: pointer;
  transition: filter .2s;
}
.pics img:hover { filter: brightness(.9); }
.pics:has(img:only-child) img { height: auto; max-width: 60%; }

/* 复制按钮 */
.copy-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 50%;
  background: #0001;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  color: #555;
  cursor: pointer;
  opacity: 0;
  transition: .15s;
}
.msg.bot:hover .copy-btn { opacity: 1; }
.copy-btn:hover { transform: scale(1.15); }

/* 用户消息外侧操作按钮 */
.msg.user .actions {
  position: absolute;
  bottom: -8px;
  right: -48px;
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: .15s;
}
.msg.user:hover .actions { opacity: 1; }
.action-btn {
  width: 34px;
  height: 34px;
  border-radius: 8px;
  background: #f4f4f4;
  border: 1px solid var(--grey);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: .15s;
}
.action-btn:hover { background: #eaeaea; transform: scale(1.05); }
.action-btn svg { width: 18px; height: 18px; fill: #555; }

.copy-tip {
  position: absolute;
  bottom: 42px;
  right: -2px;
  padding: 4px 8px;
  font-size: 12px;
  background: #000;
  color: #fff;
  border-radius: 6px;
  pointer-events: none;
  opacity: 0;
  animation: tip 2s forwards;
}
@keyframes tip {
  0% { opacity: 0; transform: translateY(4px); }
  10% { opacity: 1; transform: translateY(0); }
  80% { opacity: 1; }
  100% { opacity: 0; transform: translateY(4px); }
}

/* 输入区 */
.composer {
  position: fixed;
  left: 50%;
  bottom: 27px;
  transform: translateX(-50%);
  width: clamp(280px, 90%, 800px);
  z-index: 3000;
}
.box {
  position: relative;
  background: #fff;
  border: 1px solid var(--grey);
  border-radius: var(--radius);
  padding: 16px 64px 60px 64px;
  transition: .2s;
}
.box:focus-within { border-color: #8ab4ff; }
textarea {
  width: 100%;
  min-height: 24px;
  max-height: 180px;
  resize: none;
  overflow-y: auto;
  border: none;
  outline: none;
  background: none;
  font: var(--font);
}
.icon-btn {
  position: absolute;
  bottom: 12px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  cursor: pointer;
}
.plus {
  left: 12px;
  background: #fff;
  border: 1px solid var(--grey);
  font-size: 26px;
}
.plus:hover { background: #f1f1f1; }
.send {
  right: 12px;
  background: #000;
  color: #fff;
  transition: .15s;
}
.send.disabled { opacity: .35; cursor: default; }
.send.loading { opacity: .4; cursor: wait; }
.send.ready:hover { transform: scale(1.08); }
.send svg { width: 24px; height: 24px; fill: #fff; }
.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Clarify Banner */
#clarifyBanner {
  position: absolute;
  left: 16px;
  right: 16px;
  top: 12px;
  background: #fffbe6;
  border: 1px solid #f5d36b;
  color: #7a5a00;
  font-size: 13px;
  padding: 6px 8px;
  border-radius: 8px;
  display: none;
  line-height: 1.35;
}

/* 缩略图 */
.thumbs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
.thumbs img { width: 64px; height: 64px; border-radius: 8px; }
.close {
  position: absolute;
  right: 2px;
  top: 2px;
  width: 20px;
  height: 20px;
  border: none;
  background: #000a;
  color: #fff;
  border-radius: 50%;
  cursor: pointer;
}

/* 遮罩 */
#mask {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fafafa;
  pointer-events: none;
  z-index: 2999;
    display: none;       /新增的* 默认隐藏 */
}

/* 回到底部箭头 */
#scrollBottom {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  width: 44px;
  height: 44px;
  border: 1px solid var(--grey);
  border-radius: 50%;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  box-shadow: 0 1px 3px #0002;
  opacity: 0;
  pointer-events: none;
  transition: .18s;
  z-index: 3001;
}
#scrollBottom.show { opacity: 1; pointer-events: auto; }
#scrollBottom:hover { transform: translateX(-50%) scale(1.08); }

/* footer 注脚 */
.footnote {
  position: fixed;
  left: 50%;
  bottom: 2px;
  transform: translateX(-50%);
  font-size: 13px;
  color: #888;
  white-space: nowrap;
  padding: 2px 6px;
  z-index: 3000;
}

/* 灯箱 */
#lightbox {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 4000;
}
#lightbox img {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 8px;
}

/* 小屏适配 */
@media (max-width: 600px) {
  :root { --side-gap: 12px; }
  body {
    padding-left: var(--side-gap);
    padding-right: var(--side-gap);
  }
  #chat { padding-left: var(--side-gap); }
  .box { padding: 16px 56px 60px 56px; }
  #clarifyBanner { position: static; margin-bottom: 8px; }
}

/* —— 授权弹窗 —— */
#authModal {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0);
  z-index: 1000;
}
#authModal .box {
    position: absolute;
  top: 60px;                /* ✅ 关键：距离顶部190px */
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  border-radius: 12px;
  padding: 24px 32px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  text-align: center;
  min-width: 320px;
}
#authModal h2 { font-size: 1.5rem; margin-bottom: 1rem; }
#authModal input {
  width: 100%; padding: .75rem; font-size: 1rem;
  border: 1px solid #ccc; border-radius: 6px; margin-bottom: 1rem;
}
#authModal button {
  width: 100%; padding: .75rem; font-size: 1rem;
  border: none; border-radius: 6px; background: #3b82f6;
  color: #fff; cursor: pointer; transition: background .2s;
}
#authModal button:disabled { background: #8fbefc; cursor: not-allowed; }
#authErr { color: #d9534f; margin-top: .5rem; font-size: .9rem; display: none; }

/* —— GPT Markdown 可视化支持（原样保留） —— */
.msg.bot code {
  background: #f5f5f5;
  padding: 2px 4px;
  border-radius: 4px;
  font-family: Menlo, Consolas, monospace;
  font-size: 0.95em;
}
.msg.bot pre {
  background: #1e1e1e;
  color: #f8f8f2;
  padding: 1em;
  border-radius: 6px;
  overflow-x: auto;
  margin: 1em 0;
}
.msg.bot pre code { background: none; color: inherit; padding: 0; border-radius: 0; }
pre.qa-report {
  background: #f2f7ff;
  border-left: 4px solid #3b82f6;
  padding: 12px;
  border-radius: 6px;
  margin: 1em 0;
  overflow-x: auto;
  font-family: Menlo, Consolas, monospace;
  font-size: 0.95em;
  color: #1a202c;
}
pre.qa-report code { background: none; padding: 0; color: inherit; white-space: pre-wrap; word-break: break-word; }
.msg.bot blockquote {
  border-left: 4px solid #dfe2e5;
  background: #f9f9f9;
  padding: 0.5em 1em;
  margin: 1em 0;
  color: #555;
}
.msg.bot blockquote.callout { border-left-color: #38a169; background: #f0fff4; }
.msg.bot blockquote.callout > p:first-child { font-weight: bold; }
.msg.bot hr { border: none; border-top: 1px solid #ddd; margin: 1.5em 0; }
.msg.bot ul, .msg.bot ol { margin: 1em 0; padding-left: 1.5em; }
.msg.bot ul ul, .msg.bot ol ol, .msg.bot ul ol, .msg.bot ol ul {
  margin-top: 0.5em; margin-bottom: 0.5em;
}
.msg.bot li.task-list-item {
  list-style: none;
  display: flex;
  align-items: flex-start;
}
.msg.bot li.task-list-item > input[type="checkbox"] {
  margin-right: 0.5em;
  vertical-align: middle;
}
.msg.bot table {
  width: 100%;
  border-collapse: collapse;
  margin: 1em 0;
}
.msg.bot th, .msg.bot td {
  border: 1px solid #ccc;
  padding: 0.6em;
  text-align: left;
}
.msg.bot th { background: #f3f4f6; }
.msg.bot img {
  max-width: 100%;
  border-radius: 6px;
  margin: 1em 0;
}
.msg.bot a { color: #3b82f6; text-decoration: none; }
.msg.bot a:hover { text-decoration: underline; }
.msg.bot .math, .msg.bot .katex {
  display: block;
  margin: 1em 0;
  text-align: center;
}
.msg._meta {
  display: flex !important;
  justify-content: flex-start !important;
  align-items: center !important;
  background: transparent !important;
  padding: 4px 8px !important;
  margin: 4px 0 !important;
}
.msg._meta > * { max-width: none !important; }
.msg._meta .copy-btn { display: none !important; }
</style>
</head>
<body>

<h1 id="welcome">今天有什么议程？</h1>

<main id="chat"></main>
<div id="mask"></div>
<button id="scrollBottom" aria-label="滚动到底部">↓</button>

<div class="composer">
  <div class="box">
    <div id="clarifyBanner"></div> <!-- === NEW Clarify Banner -->
    <div id="thumbs" class="thumbs"></div>
    <textarea id="prompt" rows="1" placeholder="询问任何问题"
              spellcheck="false" autocomplete="off"></textarea>
    <button id="plus" class="icon-btn plus">+</button>
    <button id="send" class="icon-btn send disabled">
      <svg viewBox="0 0 24 24"><path d="M3 20v-6l9-2-9-2V4l18 8z"/></svg>
    </button>
    <input id="file" type="file" accept="image/*" multiple hidden>
  </div>
</div>

<p class="footnote">Mini‑GPT 也可能会犯错。请核查重要信息。</p>

<div id="lightbox"><img alt=""></div>

<div id="authModal">
  <div class="box">
    <h2>请输入授权码</h2>
    <input id="authInput" type="password" placeholder="授权码"/>
    <button id="authBtn" disabled>确认</button>
    <div id="authErr"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  
  <script>
(async () => {
  // 版本保护：避免重复初始化
  if (window._MGPT && window._MGPT.__VERSION__) {
    console.warn('[INIT] 已存在 _MGPT 版本', window._MGPT.__VERSION__, '终止再次初始化。');
    return;
  }

  const FRONTEND_VERSION    = 'fe-stream-20250720-merged-02+auth-rev-02';
  const BASE                = "https://streaming-tts.mefans.workers.dev";
  const API_URL             = BASE + "/admin-api/ws";
  const AUTH_URL            = BASE + "/admin-api/validate-code";
  const DEV_MODE            = false;
  const DEBUG               = true;
  const AUTH_HEADER_MODE    = 'authorization'; // 可 'custom' | 'none'
  let   USE_SSE             = false;
  const MAX_CTX_USER_QUERIES = 8;

  const AUTH_MIN_LEN        = 10;
  const AUTH_PATTERN        = /^[A-Za-z0-9_-]{10,64}$/;
  const AUTH_HEARTBEAT_MS   = 10 * 60 * 1000;

  // Marked 配置
  marked.setOptions({
    gfm:true, breaks:false, sanitize:false, mangle:false,
    headerIds:false, allowDangerousHtml:true
  });

  // DOM 引用
  const chat         = document.getElementById('chat');
  const txt          = document.getElementById('prompt');
  const sendBtn      = document.getElementById('send');
  const plusBtn      = document.getElementById('plus');
  const fileInput    = document.getElementById('file');
  const thumbs       = document.getElementById('thumbs');
  const arrow        = document.getElementById('scrollBottom');
  const composer     = document.querySelector('.composer');
  const welcome      = document.getElementById('welcome');
  const mask         = document.getElementById('mask');
  const lightbox     = document.getElementById('lightbox');
  const lightImg     = lightbox?.querySelector('img') || new Image();
  const clarifyBanner= document.getElementById('clarifyBanner');
  const authModal    = document.getElementById('authModal');
  const authInput    = document.getElementById('authInput');
  const authBtn      = document.getElementById('authBtn');
  const authErr      = document.getElementById('authErr');

  // 会话/状态
  let sessionId = localStorage.getItem('session_id');
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    localStorage.setItem('session_id', sessionId);
  }
  const HISTORY_KEY = `chat_history_${sessionId}`;

  let uploads             = [];
  let isAuthorized        = false;
  let isStreaming         = false;
  let clarifyMode         = false;
  let streamingNode       = null;
  let abortCtrl           = null;
  let deltaBuffer         = '';
  let flushScheduled      = false;
  let firstMessage        = true;
  let lastFullAnswer      = '';
  let rawAnswerBuffer     = '';
  let gotStart            = false;
  let gotDone             = false;
  let sseAvailable        = null;
  let CURRENT_STREAM_TOKEN= '';
  let authHeartbeatTimer  = null;
  let authFailCount       = 0;

  window.SESSION_STATE = window.SESSION_STATE || {
    status:'final_answer',
    lastClarifyQ:'',
    clarifyTimes:0
  };
  window.USER_ROLES            = window.USER_ROLES || [];
  window.SELECTED_INDUSTRY     = window.SELECTED_INDUSTRY || '';
  window.SELECTED_SUB_INDUSTRY = window.SELECTED_SUB_INDUSTRY || '';
  let code = '';

  // 历史读写
  function loadHistory(){
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return;
      const arr = JSON.parse(raw);
      arr.forEach(replayMessage);
      if (arr.length) {
        document.body.style.overflow='auto';
        welcome && welcome.remove();
      }
    } catch(e){ console.warn('历史读取失败', e); }
  }
  function saveMessage(role, content, meta={}){
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      const arr = raw ? JSON.parse(raw) : [];
      arr.push({ role, content, meta, ts: Date.now() });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    } catch(e){ console.warn('历史写入失败', e); }
  }
  function replayMessage(m){
    appendMessage(m.role, m.content, { noSave:true, meta:m.meta });
  }

  // 工具函数
  function chatAtBottom(pad=200){
    if (!chat) return true;
    return chat.scrollHeight - chat.scrollTop - chat.clientHeight < pad;
  }
  function scrollToBottom(force=false){
    if (!chat) return;
    if (force || chatAtBottom()) chat.scrollTop = chat.scrollHeight;
  }
  function autoResize(){
    if (!txt) return;
    txt.style.height='24px';
    txt.style.height = Math.min(txt.scrollHeight, 180)+'px';
  }
  function renderMarkdown(md){
    if (!md) return '';
    try { return marked.parse(md); }
    catch(e){
      return md.replace(/[&<>]/g,s=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[s]))
               .replace(/\n/g,'<br>');
    }
  }
  function safeText(t){ return typeof t==='string'?t:''; }
  function createMsgDiv(role, extra=''){
    const d = document.createElement('div');
    d.className = `msg ${role} ${extra}`.trim();
    chat && chat.appendChild(d);
    return d;
  }
  function stripMarkdown(md=''){
    return md
      .replace(/```[\s\S]*?```/g,'')
      .replace(/`([^`]+)`/g,'$1')
      .replace(/!\[[^\]]*\]\([^)]+\)/g,'')
      .replace(/\[[^\]]*\]\(([^)]+)\)/g,'$1')
      .replace(/[#>*_~`]/g,'')
      .trim();
  }
  function addCopyButton(node, rawText){
    if (node.querySelector('.copy-btn')) return;
    const btn = document.createElement('button');
    btn.className='copy-btn'; btn.textContent='⧉'; btn.title='复制';
    btn.onclick = ()=>{
      navigator.clipboard.writeText(rawText);
      btn.textContent='✔';
      setTimeout(()=>btn.textContent='⧉',1200);
    };
    node.appendChild(btn);
  }
  function appendMessage(role, text, { images=[], streaming=false, noSave=false, meta=null, clarify=false }={}) {
    if (!chat) return;
    if (!text && !images.length && !streaming) return;
    const extras=[];
    if (streaming) extras.push('streaming');
    if (clarify)  extras.push('clarify');
    const div = createMsgDiv(role, extras.join(' '));
    if (streaming && !text) {
      div.innerHTML='<em style="opacity:.55">⌛ 流式生成中...</em>';
    }
    if (images.length) {
      const wrap=document.createElement('div');
      wrap.className='pics';
      images.forEach(src=>{
        const im=new Image();
        im.src=src; im.loading='lazy';
        im.onclick=()=>{ lightImg.src=src; lightbox.style.display='flex'; };
        wrap.appendChild(im);
      });
      div.appendChild(wrap);
    }
    if (text) div.innerHTML += renderMarkdown(safeText(text));
    if (role==='bot' && !streaming && !clarify) {
      addCopyButton(div, stripMarkdown(text));
    }
    if (role==='user') {
      const acts=document.createElement('div');
      acts.className='actions';
      const copyBtn=document.createElement('button');
      copyBtn.className='action-btn';
      copyBtn.innerHTML='<svg viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2..."/></svg>';
      copyBtn.onclick=()=>{navigator.clipboard.writeText(text);};
      const editBtn=document.createElement('button');
      editBtn.className='action-btn';
      editBtn.innerHTML='<svg viewBox="0 0 24 24"><path d="..."/></svg>';
      editBtn.onclick=()=>{ txt.value=text; autoResize(); txt.focus(); };
      acts.append(copyBtn, editBtn);
      div.appendChild(acts);
    }
    if (!noSave && role!=='stream-temp') saveMessage(role, text, { images, meta, clarify });
    scrollToBottom(true);
    return div;
  }
  // 授权相关
  function unlockUI(){
    txt.disabled = plusBtn.disabled = sendBtn.disabled = false;
    mask.style.display = 'none';
    refreshSendState();
  }
  function lockUI(){
    txt.disabled = plusBtn.disabled = sendBtn.disabled = true;
  }
  async function validateCode(value, { silent=false } = {}) {
    console.log('🔑 validateCode 发出的 body：', JSON.stringify({ code: value }));

    if (!value || value.length < AUTH_MIN_LEN || !AUTH_PATTERN.test(value)) {
      if (!silent) {
        authErr.textContent = `格式不正确（需≥${AUTH_MIN_LEN}且仅字母数字-_）`;
        authErr.style.display = 'block';
      }
      return false;
    }
    try {
      const r = await fetch(AUTH_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body:JSON.stringify({ code:value })
      });
      const ct = r.headers.get('Content-Type')||'';
      let data={};
      if (/json/i.test(ct)) data = await r.json().catch(()=>({}));
      if (!r.ok || !data.ok) throw new Error('授权失败');
      const ver = Number(r.headers.get('x-auth-version') || data.code_version || 0);
      localStorage.setItem('auth_code', value);
      localStorage.setItem('auth_code_version', String(ver));
      code = value; isAuthorized = true;
      if (!silent) authModal.style.display='none';
      unlockUI(); startAuthHeartbeat();
      return true;
    } catch(e){
      if (!silent) {
        authErr.textContent = e.message || '验证错误';
        authErr.style.display = 'block';
      }
      return false;
    }
  }
  function forceReAuth(reason='授权码已失效，请重新输入'){
    isAuthorized = false; code = '';
    stopAuthHeartbeat();
    localStorage.removeItem('auth_code');
    localStorage.removeItem('auth_code_version');
    authModal.style.display='flex';
    lockUI();
    if(authErr){ authErr.textContent=reason; authErr.style.display='block'; }
  }
  async function initAuth(){
    if (DEV_MODE) {
      isAuthorized=true; code='dev-bypass';
      authModal.style.display='none'; unlockUI(); return;
    }
    const saved = localStorage.getItem('auth_code');
    if (saved) {
      const ok = await validateCode(saved, { silent:true });
      if (ok) { unlockUI(); startAuthHeartbeat(); return; }
      forceReAuth('本地授权码已失效，请重新输入');
    } else {
      forceReAuth();
    }
  }
  function startAuthHeartbeat(){
    stopAuthHeartbeat();
    authHeartbeatTimer = setInterval(async ()=>{
      if (!code) return;
      const ok = await validateCode(code, { silent:true });
      if (!ok) forceReAuth('授权码失效或已更新，请重新输入');
    }, AUTH_HEARTBEAT_MS);
  }
  function stopAuthHeartbeat(){
    clearInterval(authHeartbeatTimer); authHeartbeatTimer=null;
  }
  authInput.addEventListener('input', ()=>{
    authBtn.disabled = !authInput.value.trim();
    authErr.style.display = 'none';
  });
  authBtn.addEventListener('click', async ()=>{
    authBtn.disabled = true;
    const val = authInput.value.trim();
    await validateCode(val, { silent:false });
    authBtn.disabled = false;
  });

  // SSE 探测
  async function detectSSEOnce(){
    if (sseAvailable!==null) return sseAvailable;
    try {
      const r = await fetch(API_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/json','Accept':'text/event-stream' },
        body: JSON.stringify({ code:'__ping__', lastUserQueries:['ping'] })
      });
      sseAvailable = /text\/event-stream/i.test(r.headers.get('Content-Type')||'')?'yes':'no';
    } catch {
      sseAvailable='no';
    }
    return sseAvailable;
  }

  // 流式请求
  async function streamRequest(payload){
    if (USE_SSE==='auto') USE_SSE = (await detectSSEOnce())==='yes';
    const ctrl = new AbortController();
    abortCtrl = ctrl;
    let finalURL = API_URL + (DEBUG? '?debug=1':'');

    if (code && AUTH_HEADER_MODE==='none') {
      finalURL += (finalURL.includes('?')?'&':'?') + 'code=' + encodeURIComponent(code);
    }

    let httpResp;
    try {
      httpResp = await fetch(finalURL, {
        method:'POST',
        headers: (() => {
          const h={ 'Content-Type':'application/json' };
          if (USE_SSE) h['Accept']='text/event-stream';
          if (code){
            if (AUTH_HEADER_MODE==='authorization') h['Authorization']='Bearer '+code;
            else if (AUTH_HEADER_MODE==='custom')    h['x-auth-code']=code;
          }
          return h;
        })(),
        body: JSON.stringify(payload),
        signal: ctrl.signal
      });
    } catch(e){
      appendMessage('bot', `⚠️ 网络错误：${e.message||e}`);
      stopStreaming();
      return;
    }
    if (!httpResp.ok || !httpResp.body) {
      appendMessage('bot', `⚠️ HTTP ${httpResp.status}`);
      stopStreaming();
      return;
    }

    const isSSE = /text\/event-stream/i.test(httpResp.headers.get('Content-Type')||'');
    DEBUG && console.log('[STREAM_MODE]', isSSE?'SSE':'NDJSON');

    // 用原来 pipeOpenAI / handleEvent 逻辑消费流：
    const reader  = httpResp.body.getReader();
    const decoder = new TextDecoder();
    let buffer='';

    // start
    startStreaming();

    while(true){
      const { done, value } = await reader.read();
      if (done) break;
      buffer += decoder.decode(value, { stream:true });

      if (isSSE) {
        let idx;
        while ((idx=buffer.indexOf('\n\n'))!==-1){
          const block = buffer.slice(0, idx).trim();
          buffer = buffer.slice(idx+2);
          if (!block) continue;
          let eventName='message', dataStr='';
          block.split('\n').forEach(line=>{
            if(line.startsWith('event:')) eventName=line.replace(/^event:\s*/,'').trim();
            else if(line.startsWith('data:'))  dataStr+=line.replace(/^data:\s*/,'');
          });
          if (!dataStr) continue;
          const obj=JSON.parse(dataStr);
          handleEvent(obj, eventName);
        }
      } else {
        let nl;
        while ((nl=buffer.indexOf('\n'))!==-1){
          const rawLine = buffer.slice(0, nl);
          buffer = buffer.slice(nl+1);
          const line=rawLine.trim();
          if (!line) continue;
          const obj=JSON.parse(line);
          handleEvent(obj, obj.event);
        }
      }
    }
    // 尾部处理
    if (isStreaming && !gotDone){
      flushDelta();
      finalizeAnswer(rawAnswerBuffer||deltaBuffer);
    }
    stopStreaming();
  }

  // Streaming 控制 & 事件分发
  function startStreaming(){
    if (isStreaming) return;
    isStreaming=true; deltaBuffer=''; rawAnswerBuffer=''; gotStart=false; gotDone=false;
    streamingNode = appendMessage('bot','',{ streaming:true });
    refreshSendState();
  }
  function stopStreaming(){
    isStreaming=false;
    streamingNode?.classList.remove('streaming');
    refreshSendState();
  }
  function appendDelta(t){
    deltaBuffer+=t;
    if (!flushScheduled) {
      flushScheduled=true;
      requestAnimationFrame(()=>{
        flushScheduled=false;
        if (streamingNode) streamingNode.innerHTML = renderMarkdown(deltaBuffer);
        scrollToBottom();
      });
    }
  }
  function finalizeAnswer(full){
    if (streamingNode) addCopyButton(streamingNode, stripMarkdown(full));
    streamingNode?.classList.remove('streaming');
    const finalText = full||deltaBuffer||'(空回答)';
    streamingNode.innerHTML = marked.parse(finalText);
    lastFullAnswer = finalText;
    // 更新历史
    try {
      const raw=localStorage.getItem(HISTORY_KEY);
      if(raw){
        const arr=JSON.parse(raw);
        for(let i=arr.length-1;i>=0;i--){
          if(arr[i].role==='bot'){
            arr[i].content=finalText; arr[i].ts=Date.now(); break;
          }
        }
        localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
      }
    }catch{}
    exitClarify();
  }
  function handleEvent(evt, eventName){
    if (streamingNode && streamingNode.dataset.streamToken!==CURRENT_STREAM_TOKEN) return;
    switch(eventName||evt.event){
      case 'start':
        gotStart=true; break;
      case 'delta':
        if(evt.text) { rawAnswerBuffer+=evt.text; appendDelta(evt.text); }
        break;
      case 'done':
        gotDone=true; finalizeAnswer(evt.full||rawAnswerBuffer); break;
      case 'clarify':
        stopStreaming(); enterClarify(evt.text); break;
      case 'error':
        if(/unauth/i.test(evt.text)) { forceReAuth('授权失效'); return; }
        stopStreaming(); appendMessage('bot',`⚠️ 出错：${evt.text}`); break;
    }
  }

  // Clarify 控制
  function enterClarify(q){
    clarifyMode=true; window.SESSION_STATE.status='clarify';
    window.SESSION_STATE.lastClarifyQ=q;
    window.SESSION_STATE.clarifyTimes++;
    clarifyBanner.style.display='block';
    clarifyBanner.innerHTML=`<strong>需要澄清：</strong>${q}`;
    appendMessage('bot',q,{ clarify:true });
  }
  function exitClarify(){
    clarifyMode=false; window.SESSION_STATE.status='final_answer';
    clarifyBanner.style.display='none';
  }

  // 构造 Payload
  function collectRecentUserQueries(latest){
    const raw=localStorage.getItem(HISTORY_KEY)||'[]';
    const arr=JSON.parse(raw);
    const users=arr.filter(m=>m.role==='user').map(m=>m.content);
    if(latest) users.push(latest);
    return users.slice(-MAX_CTX_USER_QUERIES);
  }
  function buildPayload(inputText){
    const imgs=uploads.filter(u=>!u.uploading&&u.url).map(u=>u.url);
    return {
      code,
      session_id: sessionId,
      lastUserQueries: collectRecentUserQueries(inputText),
      images: imgs,
      userRoles: window.USER_ROLES,
      industry: window.SELECTED_INDUSTRY,
      subIndustry: window.SELECTED_SUB_INDUSTRY,
      sessionState: window.SESSION_STATE,
      debug: DEBUG
    };
  }

  // 输入 & 发送
  function anyUploading(){ return uploads.some(u=>u.uploading); }
  function refreshSendState(){
    if (isStreaming&&!clarifyMode){
      sendBtn.className='icon-btn send loading';
      return;
    }
    const t=(txt.value||'').trim();
    const canSend=(t||uploads.length)&&!anyUploading();
    sendBtn.className='icon-btn send '+(canSend?'ready':'disabled');
  }
  plusBtn.addEventListener('click',()=>fileInput.click());
  fileInput.addEventListener('change',e=>{/* same mockUpload logic */});
  txt.addEventListener('input',()=>{ autoResize(); refreshSendState(); });

  async function trySend(){
    if(!(DEV_MODE||isAuthorized)){ alert('请先授权'); return; }
    if(anyUploading()) return;
    const inputText=txt.value.trim();
    if(!inputText&&uploads.length===0) return;
    if(clarifyMode) exitClarify();
    CURRENT_STREAM_TOKEN = 'st_'+Date.now();
    displayLargeUserInput(inputText, uploads.map(u=>u.url));
    txt.value=''; autoResize(); /* clear uploads UI */
    refreshSendState();
    const payload=buildPayload(inputText);
    await streamRequest(payload);
  }
  sendBtn.addEventListener('click',()=>{ if(isStreaming&&!clarifyMode) abortCtrl.abort(); else trySend(); });
  txt.addEventListener('keydown',e=>{ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); trySend(); } });
  // 诊断工具：在控制台里调用 window.MGPT_TEST_DIAG() 可打印 /diag 结果
  window.MGPT_TEST_DIAG = async () => {
    try {
      const r = await fetch(BASE + '/diag').then(r => r.json());
      appendMessage('bot',
        '诊断结果:\n```json\n' + JSON.stringify(r, null, 2) + '\n```'
      );
    } catch (e) {
      appendMessage('bot', '诊断失败: ' + e.message);
    }
  };

  // 初始化
  autoResize(); 
  refreshSendState(); 
  // 等待授权通过
  await initAuth();
  loadHistory();
  // 授权 OK 以后再加载历史、放开界面
   unlockUI();
})();
</script>







</body>
</html>
