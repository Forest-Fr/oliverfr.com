<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Mini-GPT</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root {
  --radius: 24px;
  --grey: #e4e4e7;
  --bubble: #f7f7f8;
  --side-gap: 190px;
  --font: 16px/1.45 -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

html, body {
  height: 100%;
  overflow: hidden;
  font: var(--font);
  background: #fafafa;
}

body { padding: 40px var(--side-gap) 220px; }

/* 开场提示 */
/* 欢迎语固定底部（动态 JS 调整 bottom） */
#welcome{
  position:fixed;left:50%;transform:translateX(-50%);
  font-size:21px;font-weight:600;line-height:1.2;
  z-index:3000;pointer-events:none;text-align:center;
  max-width:90%;bottom:60px; /* 初始兜底 */
}

/* 聊天区 */
#chat {
  display: flex;
  flex-direction: column;
  gap: 16px;
  height: calc(100vh - 190px);
  padding-left: var(--side-gap);
  overflow-x: auto;
  overflow-y: auto;
  scroll-behavior: smooth;
}

/* 聊天气泡 */
.msg {
  max-width: 100%;
  width: fit-content;
  position: relative;
  padding: 12px 16px;
  background: var(--bubble);
  border-radius: 12px;
  font-size: 15px;
  line-height: 1.55;
  color: #111;
  word-break: break-word;
  white-space: pre-wrap;
}
.msg.bot { align-self: flex-start; }
.msg.user { align-self: flex-end; background: #e0f2ff; }
.msg.system { align-self: center; background:#fff3cd; color:#7a5a00; }

/* Clarify 特殊气泡 */
.msg.clarify {
  background: #fffbe6;
  border: 1px solid #f5d36b;
  color: #7a5a00;
}

/* Streaming 高亮动画 */
.msg.streaming {
  background: #eef6ff;
  box-shadow: 0 0 0 1px #d0e6ff inset;
  position: relative;
}
.msg.streaming:after {
  content: '';
  position: absolute;
  right: 6px; bottom: 6px;
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #3b82f6;
  animation: pulseDot 1.2s ease-in-out infinite;
}
@keyframes pulseDot {
  0% { transform: scale(.7); opacity:.4; }
  50% { transform: scale(1); opacity:1; }
  100% { transform: scale(.7); opacity:.4; }
}

/* 图片网格 */
.pics {
  display: grid;
  grid-auto-flow: column;
  grid-auto-columns: max-content;
  gap: 8px;
  margin-bottom: 8px;
  max-width: 100%;
  overflow-x: auto;
}
.pics img {
  height: 160px;
  width: auto;
  border-radius: 8px;
  object-fit: cover;
  cursor: pointer;
  transition: filter .2s;
}
.pics img:hover { filter: brightness(.9); }
.pics:has(img:only-child) img { height: auto; max-width: 60%; }

/* 复制按钮 */
.copy-btn {
  position: absolute;
  top: 6px;
  right: 6px;
  width: 24px;
  height: 24px;
  border: none;
  border-radius: 50%;
  background: #0001;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  color: #555;
  cursor: pointer;
  opacity: 0;
  transition: .15s;
}
.msg.bot:hover .copy-btn { opacity: 1; }
.copy-btn:hover { transform: scale(1.15); }

/* 用户消息外侧操作按钮 */
.msg.user .actions {
  position: absolute;
  bottom: -8px;
  right: -48px;
  display: flex;
  gap: 4px;
  opacity: 0;
  transition: .15s;
}
.msg.user:hover .actions { opacity: 1; }
.action-btn {
  width: 34px;
  height: 34px;
  border-radius: 8px;
  background: #f4f4f4;
  border: 1px solid var(--grey);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: .15s;
}
.action-btn:hover { background: #eaeaea; transform: scale(1.05); }
.action-btn svg { width: 18px; height: 18px; fill: #555; }

.copy-tip {
  position: absolute;
  bottom: 42px;
  right: -2px;
  padding: 4px 8px;
  font-size: 12px;
  background: #000;
  color: #fff;
  border-radius: 6px;
  pointer-events: none;
  opacity: 0;
  animation: tip 2s forwards;
}
@keyframes tip {
  0% { opacity: 0; transform: translateY(4px); }
  10% { opacity: 1; transform: translateY(0); }
  80% { opacity: 1; }
  100% { opacity: 0; transform: translateY(4px); }
}

/* 输入区 */
.composer {
  position: fixed;
  left: 50%;
  bottom: 27px;
  transform: translateX(-50%);
  width: clamp(280px, 90%, 800px);
  z-index: 3000;
}
.box {
  position: relative;
  background: #fff;
  border: 1px solid var(--grey);
  border-radius: var(--radius);
  padding: 16px 64px 60px 64px;
  transition: .2s;
}
.box:focus-within { border-color: #8ab4ff; }
textarea {
  width: 100%;
  min-height: 24px;
  max-height: 180px;
  resize: none;
  overflow-y: auto;
  border: none;
  outline: none;
  background: none;
  font: var(--font);
}
.icon-btn {
  position: absolute;
  bottom: 12px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  border: none;
  cursor: pointer;
}
.plus {
  left: 12px;
  background: #fff;
  border: 1px solid var(--grey);
  font-size: 26px;
}
.plus:hover { background: #f1f1f1; }
.send {
  right: 12px;
  background: #000;
  color: #fff;
  transition: .15s;
}
.send.disabled { opacity: .35; cursor: default; }
.send.loading { opacity: .4; cursor: wait; }
.send.ready:hover { transform: scale(1.08); }
.send svg { width: 24px; height: 24px; fill: #fff; }
.spinner {
  width: 24px;
  height: 24px;
  border: 3px solid #fff;
  border-top-color: transparent;
  border-radius: 50%;
  animation: spin .8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* Clarify Banner */
#clarifyBanner {
  position: absolute;
  left: 16px;
  right: 16px;
  top: 12px;
  background: #fffbe6;
  border: 1px solid #f5d36b;
  color: #7a5a00;
  font-size: 13px;
  padding: 6px 8px;
  border-radius: 8px;
  display: none;
  line-height: 1.35;
}

/* 缩略图 */
.thumbs { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px; }
.thumbs img { width: 64px; height: 64px; border-radius: 8px; }
.close {
  position: absolute;
  right: 2px;
  top: 2px;
  width: 20px;
  height: 20px;
  border: none;
  background: #000a;
  color: #fff;
  border-radius: 50%;
  cursor: pointer;
}

/* 遮罩 */
#mask {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  background: #fafafa;
  pointer-events: none;
  z-index: 2999;
}

/* 回到底部箭头 */
#scrollBottom {
  position: fixed;
  left: 50%;
  transform: translateX(-50%);
  width: 44px;
  height: 44px;
  border: 1px solid var(--grey);
  border-radius: 50%;
  background: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  box-shadow: 0 1px 3px #0002;
  opacity: 0;
  pointer-events: none;
  transition: .18s;
  z-index: 3001;
}
#scrollBottom.show { opacity: 1; pointer-events: auto; }
#scrollBottom:hover { transform: translateX(-50%) scale(1.08); }

/* footer 注脚 */
.footnote {
  position: fixed;
  left: 50%;
  bottom: 2px;
  transform: translateX(-50%);
  font-size: 13px;
  color: #888;
  white-space: nowrap;
  padding: 2px 6px;
  z-index: 3000;
}

/* 灯箱 */
#lightbox {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.85);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 4000;
}
#lightbox img {
  max-width: 90vw;
  max-height: 90vh;
  border-radius: 8px;
}

/* 小屏适配 */
@media (max-width: 600px) {
  :root { --side-gap: 12px; }
  body {
    padding-left: var(--side-gap);
    padding-right: var(--side-gap);
  }
  #chat { padding-left: var(--side-gap); }
  .box { padding: 16px 56px 60px 56px; }
  #clarifyBanner { position: static; margin-bottom: 8px; }
}

/* —— 授权弹窗 —— */
#authModal {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  align-items: center;
  background: rgba(0,0,0,0);
  z-index: 1000;
}
#authModal .box {
    position: absolute;
  top: 60px;                /* ✅ 关键：距离顶部190px */
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  border-radius: 12px;
  padding: 24px 32px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  text-align: center;
  min-width: 320px;
}
#authModal h2 { font-size: 1.5rem; margin-bottom: 1rem; }
#authModal input {
  width: 100%; padding: .75rem; font-size: 1rem;
  border: 1px solid #ccc; border-radius: 6px; margin-bottom: 1rem;
}
#authModal button {
  width: 100%; padding: .75rem; font-size: 1rem;
  border: none; border-radius: 6px; background: #3b82f6;
  color: #fff; cursor: pointer; transition: background .2s;
}
#authModal button:disabled { background: #8fbefc; cursor: not-allowed; }
#authErr { color: #d9534f; margin-top: .5rem; font-size: .9rem; display: none; }

/* —— GPT Markdown 可视化支持（原样保留） —— */
.msg.bot code {
  background: #f5f5f5;
  padding: 2px 4px;
  border-radius: 4px;
  font-family: Menlo, Consolas, monospace;
  font-size: 0.95em;
}
.msg.bot pre {
  background: #1e1e1e;
  color: #f8f8f2;
  padding: 1em;
  border-radius: 6px;
  overflow-x: auto;
  margin: 1em 0;
}
.msg.bot pre code { background: none; color: inherit; padding: 0; border-radius: 0; }
pre.qa-report {
  background: #f2f7ff;
  border-left: 4px solid #3b82f6;
  padding: 12px;
  border-radius: 6px;
  margin: 1em 0;
  overflow-x: auto;
  font-family: Menlo, Consolas, monospace;
  font-size: 0.95em;
  color: #1a202c;
}
pre.qa-report code { background: none; padding: 0; color: inherit; white-space: pre-wrap; word-break: break-word; }
.msg.bot blockquote {
  border-left: 4px solid #dfe2e5;
  background: #f9f9f9;
  padding: 0.5em 1em;
  margin: 1em 0;
  color: #555;
}
.msg.bot blockquote.callout { border-left-color: #38a169; background: #f0fff4; }
.msg.bot blockquote.callout > p:first-child { font-weight: bold; }
.msg.bot hr { border: none; border-top: 1px solid #ddd; margin: 1.5em 0; }
.msg.bot ul, .msg.bot ol { margin: 1em 0; padding-left: 1.5em; }
.msg.bot ul ul, .msg.bot ol ol, .msg.bot ul ol, .msg.bot ol ul {
  margin-top: 0.5em; margin-bottom: 0.5em;
}
.msg.bot li.task-list-item {
  list-style: none;
  display: flex;
  align-items: flex-start;
}
.msg.bot li.task-list-item > input[type="checkbox"] {
  margin-right: 0.5em;
  vertical-align: middle;
}
.msg.bot table {
  width: 100%;
  border-collapse: collapse;
  margin: 1em 0;
}
.msg.bot th, .msg.bot td {
  border: 1px solid #ccc;
  padding: 0.6em;
  text-align: left;
}
.msg.bot th { background: #f3f4f6; }
.msg.bot img {
  max-width: 100%;
  border-radius: 6px;
  margin: 1em 0;
}
.msg.bot a { color: #3b82f6; text-decoration: none; }
.msg.bot a:hover { text-decoration: underline; }
.msg.bot .math, .msg.bot .katex {
  display: block;
  margin: 1em 0;
  text-align: center;
}
.msg._meta {
  display: flex !important;
  justify-content: flex-start !important;
  align-items: center !important;
  background: transparent !important;
  padding: 4px 8px !important;
  margin: 4px 0 !important;
}
.msg._meta > * { max-width: none !important; }
.msg._meta .copy-btn { display: none !important; }
</style>
</head>
<body>

<h1 id="welcome">今天有什么议程？</h1>

<main id="chat"></main>
<div id="mask"></div>
<button id="scrollBottom" aria-label="滚动到底部">↓</button>

<div class="composer">
  <div class="box">
    <div id="clarifyBanner"></div> <!-- === NEW Clarify Banner -->
    <div id="thumbs" class="thumbs"></div>
    <textarea id="prompt" rows="1" placeholder="询问任何问题"
              spellcheck="false" autocomplete="off"></textarea>
    <button id="plus" class="icon-btn plus">+</button>
    <button id="send" class="icon-btn send disabled">
      <svg viewBox="0 0 24 24"><path d="M3 20v-6l9-2-9-2V4l18 8z"/></svg>
    </button>
    <input id="file" type="file" accept="image/*" multiple hidden>
  </div>
</div>

<p class="footnote">Mini‑GPT 也可能会犯错。请核查重要信息。</p>

<div id="lightbox"><img alt=""></div>

<div id="authModal">
  <div class="box">
    <h2>请输入授权码</h2>
    <input id="authInput" type="password" placeholder="授权码"/>
    <button id="authBtn" disabled>确认</button>
    <div id="authErr"></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>
marked.setOptions({
  gfm: true,
  breaks: false,
  sanitize: false,
  mangle: false,
  headerIds: false,
  allowDangerousHtml: true
});

document.addEventListener('DOMContentLoaded', () => {
  /* ========== 基础配置 ========== */
  const BASE     = "https://streaming-tts.mefans.workers.dev";
  const API_URL  = BASE + "/admin-api/ws";
  const AUTH_URL = BASE + "/admin-api/validate-code";
  const DEV_MODE = false;
  const DEBUG    = true;

  /* ========== DOM 引用 ========== */
  const chat      = document.getElementById('chat');
  const txt       = document.getElementById('prompt');
  const sendBtn   = document.getElementById('send');
  const plusBtn   = document.getElementById('plus');
  const fileInput = document.getElementById('file');
  const thumbs    = document.getElementById('thumbs');
  const arrow     = document.getElementById('scrollBottom');
  const composer  = document.querySelector('.composer');
  const welcome   = document.getElementById('welcome');
  const mask      = document.getElementById('mask');
  const lightbox  = document.getElementById('lightbox');
  const lightImg  = lightbox.querySelector('img');
  const clarifyBanner = document.getElementById('clarifyBanner');
  const authModal = document.getElementById('authModal');
  const authInput = document.getElementById('authInput');
  const authBtn   = document.getElementById('authBtn');
  const authErr   = document.getElementById('authErr');

  /* ========== 会话状态 ========== */
  let sessionId = localStorage.getItem('session_id');
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    localStorage.setItem('session_id', sessionId);
  }
  const HISTORY_KEY = `chat_history_${sessionId}`;
  let uploads        = [];
  let isAuthorized   = false;
  let isStreaming    = false;
  let clarifyMode    = false;
  let streamingNode  = null;
  let abortCtrl      = null;
  let deltaBuffer    = '';
  let flushScheduled = false;
  let firstMessage   = true;
  let lastFullAnswer = '';

  window.SESSION_STATE = { status:'final_answer', lastClarifyQ:'', clarifyTimes:0 };
  window.USER_ROLES = window.USER_ROLES || [];
  window.SELECTED_INDUSTRY = window.SELECTED_INDUSTRY || '';
  window.SELECTED_SUB_INDUSTRY = window.SELECTED_SUB_INDUSTRY || '';
  let code = '';

  /* ========== 历史记录 ========== */
  function loadHistory() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      if (!raw) return;
      JSON.parse(raw).forEach(m => replayMessage(m));
      if (raw) {
        document.body.style.overflow = 'auto';
        welcome && welcome.remove();
      }
    } catch(e){ console.warn('历史读取失败',e) }
  }
  function saveMessage(role, content, meta={}) {
    try {
      const arr = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');
      arr.push({ role, content, meta, ts: Date.now() });
      localStorage.setItem(HISTORY_KEY, JSON.stringify(arr));
    } catch(e){ console.warn('历史写入失败',e) }
  }
  function replayMessage(m) {
    appendMessage(m.role, m.content, { noSave:true, meta:m.meta });
  }

  /* ========== 工具函数 ========== */
  function chatAtBottom(pad=200) {
    return chat.scrollHeight - chat.scrollTop - chat.clientHeight < pad;
  }
  function scrollToBottom(force=false) {
    if (force || chatAtBottom()) chat.scrollTop = chat.scrollHeight;
  }
  function autoResize() {
    txt.style.height = '24px';
    txt.style.height = Math.min(txt.scrollHeight, 180) + 'px';
  }
  function renderMarkdown(md) {
    if (!md) return '';
    try { return marked.parse(md); }
    catch { return md.replace(/[&<>]/g,s=>'&#'+s.charCodeAt(0)+';').replace(/\n/g,'<br>'); }
  }
  function safeText(t) {
    return typeof t==='string' ? t.replace(/imageHint is not defined/g,'【后端未定义 imageHint】') : '';
  }
  function createMsgDiv(role, extra='') {
    const d = document.createElement('div');
    d.className = `msg ${role} ${extra}`.trim();
    chat.appendChild(d);
    return d;
  }
  function appendMessage(role, text, { images=[], streaming=false, noSave=false, clarify=false }={}) {
    if (!text && !images.length) return;
    const extra = [];
    if (streaming) extra.push('streaming');
    if (clarify)  extra.push('clarify');
    const div = createMsgDiv(role, extra.join(' '));
    if (images.length) {
      const pics = document.createElement('div');
      pics.className = 'pics';
      images.forEach(src => {
        const im = new Image();
        im.src = src;
        im.loading = 'lazy';
        im.onclick = () => { lightImg.src = src; lightbox.style.display='flex'; };
        pics.appendChild(im);
      });
      div.appendChild(pics);
    }
    if (text) div.innerHTML += renderMarkdown(safeText(text));
    // Bot 复制按钮
    if (role==='bot' && !streaming && !clarify) {
      const c = document.createElement('button');
      c.className='copy-btn'; c.textContent='⧉'; c.title='复制';
      c.onclick = () => {
        navigator.clipboard.writeText(text);
        c.textContent='✔'; setTimeout(()=>c.textContent='⧉',1300);
      };
      div.appendChild(c);
    }
    // User 操作按钮
    if (role==='user') {
      const acts = document.createElement('div');
      acts.className='actions';
      const c1 = document.createElement('button');
      c1.className='action-btn'; c1.innerHTML='📋';
      c1.onclick = () => { navigator.clipboard.writeText(text); };
      const c2 = document.createElement('button');
      c2.className='action-btn'; c2.innerHTML='✎';
      c2.onclick = () => { txt.value=text; autoResize(); txt.focus(); };
      acts.append(c1,c2);
      div.appendChild(acts);
    }
    if (!noSave && role!=='stream-temp') saveMessage(role, text, { images, clarify });
    scrollToBottom(true);
    return div;
  }
  function stripMarkdown(md='') {
    return md.replace(/```[\s\S]*?```/g,'')
             .replace(/`([^`]+)`/g,'$1')
             .replace(/\!\[[^\]]*\]\([^)]+\)/g,'')
             .replace(/\[[^\]]*\]\(([^)]+)\)/g,'$1')
             .replace(/[#>*_~`]/g,'').trim();
  }

  /* ========== 授权 ========== */
  function unlockUI() {
    [txt,plusBtn,sendBtn].forEach(el=>el.disabled=false);
    refreshSendState();
    mask.style.display='none';
  }
  function lockUI() {
    [txt,plusBtn,sendBtn].forEach(el=>el.disabled=true);
  }
  function initAuth() {
    if (DEV_MODE) {
      isAuthorized=true; code='dev-bypass'; authModal.style.display='none'; unlockUI(); return;
    }
    const saved = localStorage.getItem('auth_code');
    if (saved) { isAuthorized=true; code=saved; authModal.style.display='none'; unlockUI(); }
    else { isAuthorized=false; lockUI(); authModal.style.display='flex'; }
  }
  authInput.addEventListener('input', ()=>{
    authBtn.disabled = !authInput.value.trim();
    authErr.style.display='none';
  });
  authBtn.addEventListener('click', async ()=>{
    authBtn.disabled=true;
    try {
      const r = await (await fetch(AUTH_URL,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({ code:authInput.value.trim() })
      })).json();
      if(!r.ok) throw new Error('授权失败');
      isAuthorized=true; code=authInput.value.trim();
      localStorage.setItem('auth_code',code);
      authModal.style.display='none';
      unlockUI();
    } catch(e){
      authErr.textContent=e.message; authErr.style.display='block';
    } finally { authBtn.disabled=false; }
  });
  function checkAuthOrWarn() {
    if (DEV_MODE || isAuthorized) return true;
    alert('请先输入授权码！'); return false;
  }

  /* ========== 输入 & 按钮状态 ========== */
  function anyUploading(){ return uploads.some(u=>u.uploading); }
  function refreshSendState(){
    if (isStreaming && !clarifyMode) {
      sendBtn.className='icon-btn send loading';
      sendBtn.innerHTML='<div class="spinner"></div>';
      return;
    }
    const t = txt.value.trim();
    const ready = (t||uploads.length)>0 && !anyUploading();
    let cls='icon-btn send '+(ready?'ready':'disabled');
    if (anyUploading()) cls+=' loading';
    sendBtn.className=cls;
    sendBtn.innerHTML = anyUploading() ? '<div class="spinner"></div>' : '▶';
  }
  txt.addEventListener('input', ()=>{ autoResize(); refreshSendState(); });

  /* ========== 布局 & 滚动 ========== */
  function refreshOverlay(){
    const h = composer.offsetHeight;
    mask.style.height=`${h}px`;
    arrow.style.bottom=`${h+40}px`;
    welcome && (welcome.style.bottom=`${h+60}px`);
  }
  window.addEventListener('resize', refreshOverlay);
  chat.addEventListener('scroll', ()=>arrow.classList.toggle('show', !chatAtBottom()));
  arrow.addEventListener('click', ()=>chat.scrollTop=chat.scrollHeight);

  /* ========== Lightbox ========== */
  lightbox.addEventListener('click', ()=>lightbox.style.display='none');
  window.addEventListener('keyup', e=>e.key==='Escape' && (lightbox.style.display='none'));

  /* ========== 上传（Mock） ========== */
  function handleFiles(list){
    Array.from(list).forEach(f=>{
      if (!f.type.startsWith('image/')) return;
      const wrap = document.createElement('div');
      wrap.style.position='relative';
      wrap.innerHTML=`<img src="${URL.createObjectURL(f)}"><button class="close">✕</button>`;
      thumbs.appendChild(wrap);
      const obj={file:f,url:'',uploading:true,node:wrap};
      uploads.push(obj); refreshSendState();
      wrap.querySelector('button').onclick=()=>{
        uploads=uploads.filter(u=>u!==obj);
        wrap.remove(); refreshSendState();
      };
      // 模拟上传：
      setTimeout(()=>{
        obj.url=URL.createObjectURL(f);
        obj.uploading=false;
        refreshSendState();
      }, 600+Math.random()*400);
    });
  }
  plusBtn.addEventListener('click', ()=>fileInput.click());
  fileInput.addEventListener('change', ()=>handleFiles(fileInput.files));
  document.addEventListener('paste', e=>{
    Array.from(e.clipboardData?.items||[]).forEach(it=>{
      if(it.type.startsWith('image/')) handleFiles([it.getAsFile()]);
    });
  });
  ['dragover','drop'].forEach(evt=>{
    txt.addEventListener(evt, e=>{
      if(evt==='dragover') e.preventDefault();
      else { e.preventDefault(); handleFiles(e.dataTransfer.files); }
    });
  });

  /* ========== Clarify 控制 ========== */
  function enterClarify(question){
    clarifyMode=true;
    window.SESSION_STATE.status='clarification';
    window.SESSION_STATE.lastClarifyQ=question;
    window.SESSION_STATE.clarifyTimes++;
    clarifyBanner.style.display='block';
    clarifyBanner.innerHTML=`<strong>需要澄清：</strong>${question}<br><small>请补充信息后再次发送。</small>`;
    appendMessage('bot',question,{clarify:true});
    refreshSendState();
  }
  function exitClarify(){
    clarifyMode=false;
    clarifyBanner.style.display='none';
    window.SESSION_STATE.status='final_answer';
    refreshSendState();
  }

  /* ========== 流式渲染 ========== */
  function startStreaming(){
    isStreaming=true;
    deltaBuffer='';
    streamingNode=appendMessage('bot','',{streaming:true});
    refreshSendState();
  }
  function stopStreaming(){
    isStreaming=false;
    streamingNode?.classList.remove('streaming');
    refreshSendState();
  }
  function scheduleFlush(){
    if(flushScheduled) return;
    flushScheduled=true;
    requestAnimationFrame(()=>{
      flushScheduled=false;
      streamingNode && (streamingNode.innerHTML=renderMarkdown(deltaBuffer));
      scrollToBottom();
    });
  }
  function appendDelta(t){
    deltaBuffer+=t;
    scheduleFlush();
  }

  /* ========== 核心：streamRequest / 事件分发 / 收尾 / 停止 ========== */
  async function streamRequest(payload) {
    const ctrl = new AbortController();
    abortCtrl = ctrl;

    let resp;
    try {
      resp = await fetch(API_URL, {
        method: 'POST',
        credentials:'include',
        headers:{
          'Content-Type':'application/json',
          'Accept':'application/x-ndjson'
        },
        body: JSON.stringify(payload),
        signal: ctrl.signal
      });
      if (DEBUG) {
        console.log('<< status', resp.status, [...resp.headers.entries()]);
      }
    } catch (e) {
      appendMessage('bot',`⚠️ 网络错误：${e.message}`,{});
      stopStreaming();
      return;
    }
    if (!resp.ok || !resp.body) {
      appendMessage('bot',`⚠️ HTTP ${resp.status}`,{});
      stopStreaming();
      return;
    }

    const reader = resp.body.getReader();
    const dec    = new TextDecoder();
    let buf = '';
    startStreaming();

    while (true) {
      let r;
      try { r = await reader.read(); }
      catch (e) {
        appendMessage('bot', ctrl.signal.aborted ? '⚠️ 已取消。' : '⚠️ 流中断。', {});
        stopStreaming();
        return;
      }
      if (r.done) break;
      buf += dec.decode(r.value, { stream:true });
      let idx;
      while ((idx=buf.indexOf('\n'))!==-1) {
        const line = buf.slice(0, idx).trim();
        buf = buf.slice(idx+1);
        if (!line) continue;
        let evt;
        try { evt = JSON.parse(line); }
        catch { if(DEBUG) console.warn('Parse fail',line); continue; }
        // 分发
        switch(evt.event) {
          case 'delta':
            appendDelta(evt.text||'');
            break;
          case 'clarify':
            stopStreaming();
            evt.text && enterClarify(evt.text);
            break;
          case 'done':
            stopStreaming();
            finalizeAnswer(evt.full||'');
            break;
          case 'error':
            stopStreaming();
            appendMessage('bot',`⚠️ 出错：${evt.text||'Unknown'}`,{});
            break;
        }
      }
    }
  }

  function finalizeAnswer(full='') {
    stopStreaming();
    const node = streamingNode;
    const txt  = full || node?.textContent || '(空回答)';
    if (node) {
      node.classList.remove('streaming');
      node.innerHTML = marked.parse(full||stripMarkdown(node.textContent));
      // 追加复制按钮
      const btn = document.createElement('button');
      btn.className='copy-btn'; btn.textContent='⧉'; btn.onclick=()=>{ navigator.clipboard.writeText(txt); btn.textContent='✔'; setTimeout(()=>btn.textContent='⧉',1300); };
      node.appendChild(btn);
    }
    lastFullAnswer = txt;
  }

  function abortStreaming(){
    abortCtrl?.abort();
    stopStreaming();
    appendMessage('bot','⏹ 已手动停止。');
  }

  /* ========== 发送逻辑 ========== */
  function buildPayload(text){
    const imgs = uploads.filter(u=>!u.uploading&&u.url).map(u=>u.url);
    return {
      code, session_id: sessionId, text,
      images: imgs,
      userRoles: window.USER_ROLES,
      industry: window.SELECTED_INDUSTRY,
      subIndustry: window.SELECTED_SUB_INDUSTRY,
      sessionState: window.SESSION_STATE,
      debug: DEBUG
    };
  }
  async function trySend() {
    if (!checkAuthOrWarn()) return;
    if (anyUploading()) return;
    const t = txt.value.trim();
    const images = uploads.filter(u=>!u.uploading&&u.url).map(u=>u.url);
    if (!t && !images.length) return;

    if (firstMessage){
      firstMessage=false;
      document.body.style.overflow='auto';
      welcome && welcome.remove();
    }

    appendMessage('user', t, { images });
    txt.value=''; autoResize();
    thumbs.innerHTML=''; uploads=[];
    refreshSendState();

    if (clarifyMode) exitClarify();
    streamRequest(buildPayload(t));
  }

  sendBtn.addEventListener('click', ()=>{
    if (isStreaming && !clarifyMode) abortStreaming();
    else trySend();
  });
  txt.addEventListener('keydown', e=>{
    if (e.key==='Enter' && !e.shiftKey) {
      e.preventDefault();
      trySend();
    }
  });

  /* ========== 其他初始化 ========== */
  setInterval(()=>{
    sendBtn.title = isStreaming && !clarifyMode ? '终止回答' : clarifyMode ? '发送澄清' : '发送';
  }, 300);
  window.addEventListener('beforeunload', e=>{
    if (isStreaming){ e.preventDefault(); e.returnValue=''; }
  });
  initAuth();
  autoResize();
  refreshOverlay();
  refreshSendState();
  chat.scrollTop = chat.scrollHeight;
  loadHistory();
});
</script>




</body>
</html>
