

<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Mini-GPT</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon">
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
:root{
  --radius:24px;--grey:#e4e4e7;--bubble:#f7f7f8;
  --side-gap:190px;--font:16px/1.45 -apple-system,BlinkMacSystemFont,
  "Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0}

html,body{height:100%;overflow:hidden;font:var(--font);background:#fafafa}
body{padding:40px var(--side-gap) 220px}

/* 开场提示 */
#welcome{
  position:fixed;left:50%;transform:translateX(-50%);
  font-size:48px;font-weight:600;line-height:1.2;
  z-index:3000;pointer-events:none;text-align:center;max-width:90%;
}

/* 聊天区 */
#chat{
  display:flex;flex-direction:column;gap:16px;
  height:calc(100vh - 190px);
  padding-left:var(--side-gap);
  overflow-x:auto;overflow-y:auto;
}
.msg{
  max-width:100%;width:fit-content;
  position:relative;padding:12px 16px;
  background:var(--bubble);border-radius:12px;
  font-size:15px;line-height:1.55;color:#111;word-break:break-word
}
.msg.bot{align-self:flex-start}
.msg.user{align-self:flex-end;background:#e0f2ff}

/* 图片网格 (横向滚动, 自适应) */
.pics{
  display:grid;grid-auto-flow:column;grid-auto-columns:max-content;
  gap:8px;margin-bottom:8px;max-width:100%;overflow-x:auto
}
.pics img{
  height:160px;width:auto;border-radius:8px;object-fit:cover;
  cursor:pointer;transition:filter .2s
}
.pics img:hover{filter:brightness(.9)}
.pics:has(img:only-child) img{height:auto;max-width:60%}

/* 复制按钮 */
.copy-btn{
  position:absolute;top:6px;right:6px;width:24px;height:24px;border:none;
  border-radius:50%;background:#0001;display:flex;align-items:center;justify-content:center;
  font-size:13px;color:#555;cursor:pointer;opacity:0;transition:.15s}
.msg.bot:hover .copy-btn{opacity:1}
.copy-btn:hover{transform:scale(1.15)}

/* user 外侧动作按钮 */
.msg.user .actions{
  position:absolute;bottom:-8px;right:-48px;display:flex;gap:4px;opacity:0;transition:.15s}
.msg.user:hover .actions{opacity:1}
.action-btn{
  width:34px;height:34px;border-radius:8px;background:#f4f4f4;
  border:1px solid var(--grey);display:flex;align-items:center;justify-content:center;
  cursor:pointer;transition:.15s}
.action-btn:hover{background:#eaeaea;transform:scale(1.05)}
.action-btn svg{width:18px;height:18px;fill:#555}
.copy-tip{
  position:absolute;bottom:42px;right:-2px;padding:4px 8px;font-size:12px;
  background:#000;color:#fff;border-radius:6px;pointer-events:none;
  opacity:0;animation:tip 2s forwards}
@keyframes tip{0%{opacity:0;transform:translateY(4px)}
10%{opacity:1;transform:translateY(0)}80%{opacity:1}
100%{opacity:0;transform:translateY(4px)}}

/* 输入区 */
.composer{
  position:fixed;left:50%;bottom:27px;transform:translateX(-50%);
  width:clamp(280px,90%,800px);z-index:3000}
.box{
  position:relative;background:#fff;border:1px solid var(--grey);border-radius:var(--radius);
  padding:16px 64px 60px 64px;transition:.2s}
.box:focus-within{border-color:#8ab4ff}
textarea{
  width:100%;min-height:24px;max-height:180px;resize:none;overflow-y:auto;
  border:none;outline:none;background:none;font:var(--font)}
.icon-btn{
  position:absolute;bottom:12px;width:40px;height:40px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;border:none;cursor:pointer}
.plus{left:12px;background:#fff;border:1px solid var(--grey);font-size:26px}
.plus:hover{background:#f1f1f1}
.send{right:12px;background:#000;color:#fff;transition:.15s}
.send.disabled{opacity:.35;cursor:default}
.send.loading{opacity:.4;cursor:wait}
.send.ready:hover{transform:scale(1.08)}
.send svg{width:24px;height:24px;fill:#fff}
.spinner{
  width:24px;height:24px;border:3px solid #fff;border-top-color:transparent;
  border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* 缩略图 */
.thumbs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
.thumbs img{width:64px;height:64px;border-radius:8px}
.close{
  position:absolute;right:2px;top:2px;width:20px;height:20px;border:none;
  background:#000a;color:#fff;border-radius:50%;cursor:pointer}

/* 遮罩 */
#mask{
  position:fixed;left:0;right:0;bottom:0;background:#fafafa;pointer-events:none;z-index:2999}

/* 回底部箭头 */
#scrollBottom{
  position:fixed;left:50%;transform:translateX(-50%);
  width:44px;height:44px;border:1px solid var(--grey);border-radius:50%;
  background:#fff;display:flex;align-items:center;justify-content:center;
  font-size:26px;box-shadow:0 1px 3px #0002;opacity:0;pointer-events:none;transition:.18s;
  z-index:3001}
#scrollBottom.show{opacity:1;pointer-events:auto}
#scrollBottom:hover{transform:translateX(-50%) scale(1.08)}

/* footer */
.footnote{
  position:fixed;left:50%;bottom:2px;transform:translateX(-50%);
  font-size:13px;color:#888;white-space:nowrap;padding:2px 6px;z-index:3000}

/* 灯箱 */
#lightbox{
  position:fixed;inset:0;background:rgba(0,0,0,.85);
  display:none;align-items:center;justify-content:center;z-index:4000}
#lightbox img{max-width:90vw;max-height:90vh;border-radius:8px}

/* 小屏 */
@media(max-width:600px){
  :root{--side-gap:12px}
  body{padding-left:var(--side-gap);padding-right:var(--side-gap)}
  #chat{padding-left:var(--side-gap)}
}
/* —— 授权弹窗 #authModal —— */
#authModal {
  position: fixed;
  inset: 0;
  display: flex;
  justify-content: center;
  background: rgba(0,0,0,0);
  z-index: 1000;
}

#authModal .box {
  position: absolute;
  top: 60px;                /* ✅ 关键：距离顶部190px */
  left: 50%;
  transform: translateX(-50%);
  background: rgba(255,255,255,0.95);
  border-radius: 12px;
  padding: 24px 32px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  text-align: center;
  min-width: 320px;
}

#authModal h2 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
}
#authModal input {
  width: 100%;
  padding: .75rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 1rem;
}
#authModal button {
  width: 100%;
  padding: .75rem;
  font-size: 1rem;
  border: none;
  border-radius: 6px;
  background: #3b82f6;
  color: #fff;
  cursor: pointer;
  transition: background .2s;
}
#authModal button:disabled {
  background: #8fbefc;
  cursor: not-allowed;
}
#authErr {
  color: #d9534f;
  margin-top: .5rem;
  font-size: .9rem;
  display: none;
}
/* ====== GPT Markdown 可视化支持 ====== */
/* 1. 行内代码 */
.msg.bot code {
  background: #f5f5f5;
  padding: 2px 4px;
  border-radius: 4px;
  font-family: Menlo, Consolas, monospace;
  font-size: 0.95em;
}

/* 2. 代码块 */
.msg.bot pre {
  background: #1e1e1e;
  color: #f8f8f2;
  padding: 1em;
  border-radius: 6px;
  overflow-x: auto;
  margin: 1em 0;
}
.msg.bot pre code {
  background: none;
  color: inherit;
  padding: 0;
  border-radius: 0;
}

/* 3. 引用块 */
.msg.bot blockquote {
  border-left: 4px solid #dfe2e5;
  background: #f9f9f9;
  padding: 0.5em 1em;
  margin: 1em 0;
  color: #555;
}

/* 4. 分割线 */
.msg.bot hr {
  border: none;
  border-top: 1px solid #ddd;
  margin: 1.5em 0;
}

/* 5. 表格 */
.msg.bot table {
  width: 100%;
  border-collapse: collapse;
  margin: 1em 0;
}
.msg.bot th,
.msg.bot td {
  border: 1px solid #ccc;
  padding: 0.6em;
  text-align: left;
}
.msg.bot th {
  background: #f3f4f6;
}

/* 6. 图片 */
.msg.bot img {
  max-width: 100%;
  border-radius: 6px;
  margin: 1em 0;
}

/* 7. 链接 */
.msg.bot a {
  color: #3b82f6;
  text-decoration: none;
}
.msg.bot a:hover {
  text-decoration: underline;
}

/* 8. 列表 & 嵌套列表 */
.msg.bot ul,
.msg.bot ol {
  margin: 1em 0;
  padding-left: 1.5em;
}
.msg.bot ul ul,
.msg.bot ol ol,
.msg.bot ul ol,
.msg.bot ol ul {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

/* 9. 任务列表 (复选框) */
.msg.bot input[type="checkbox"] {
  margin-right: 0.5em;
  vertical-align: middle;
}
.msg.bot li.task-list-item {
  list-style: none;
  display: flex;
  align-items: flex-start;
}
.msg.bot li.task-list-item > input {
  margin-top: 0.2em;
}

/* 10. 数学公式（LaTeX）——如果使用 KaTeX/MathJax，请自行载入库 */
.msg.bot .math,
.msg.bot .katex {
  display: block;
  margin: 1em 0;
  text-align: center;
}

/* 11. Callout 提示框 */
.msg.bot blockquote.callout {
  border-left-color: #38a169;
  background: #f0fff4;
}
.msg.bot blockquote.callout > p:first-child {
  font-weight: bold;
}

/* —— End of GPT Markdown 可视化支持 —— */
.msg { display: flex; flex-wrap: wrap; margin-bottom: .5rem; padding: .25rem .5rem; border-radius: 6px; }
/**.msg.user { justify-content: flex-start; background: #e0f2ff; color: #1f2937; }**/
.msg.bot, .msg._meta { justify-content: flex-end; background: #f0f0f0; color: #374151; }
.msg > * {
  word-break: break-word;
}

.msg.user > * {
  max-width: 100%;
}

/*--.msg > * { max-width: 80%; word-break: break-word; }--**/
#authModal {
  position: fixed; inset: 0; display: flex; justify-content: center; align-items: center; background: rgba(0,0,0,0); z-index: 1000;
}
#authModal .box {
  background: rgba(255,255,255,0.95); border-radius: 12px; padding: 24px 32px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.15); text-align: center; min-width: 320px;
}
#authModal h2 { font-size: 1.5rem; margin-bottom: 1rem; }
#authModal input { width: 100%; padding: .75rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 1rem; }
#authModal button { width: 100%; padding: .75rem; font-size: 1rem; border: none; border-radius: 6px; background: #3b82f6; color: #fff; cursor: pointer; transition: background .2s; }
#authModal button:disabled { background: #8fbefc; cursor: not-allowed; }
#authErr { color: #d9534f; margin-top: .5rem; font-size: .9rem; display: none; }
@media (max-width: 600px) {
  #main { display: flex; flex-direction: column; max-height: calc(100vh - 2rem);}
  #chat { flex: 1 1 auto; margin-bottom: 12px; min-height: 480px; max-height: 70vh; overflow-y: auto; -webkit-overflow-scrolling: touch;}
}
.msg.bot:not(._meta) { position: relative; flex-direction: column; align-items: stretch; }
.msg.bot:not(._meta) > h1, .msg.bot:not(._meta) > h2, .msg.bot:not(._meta) > h3,
.msg.bot:not(._meta) > p, .msg.bot:not(._meta) > ul, .msg.bot:not(._meta) > ol,
.msg.bot:not(._meta) > table, .msg.bot:not(._meta) > pre, .msg.bot:not(._meta) > blockquote { width: 100% !important; }
.msg.bot:not(._meta) .copy-btn {
  position: absolute; top: 8px; right: 10px; width: auto !important;
  border: none; background: #eef2ff; font-size: .9rem; padding: .15em .45em; border-radius: 4px;
  cursor: pointer; transition: background .18s;
}
.msg.bot:not(._meta) .copy-btn:hover { background: #dbe1ff; }
.msg._meta { width: 100%; display: flex !important; justify-content: flex-end !important; align-items: center !important; }
.msg._meta > * { max-width: none !important; }
.msg._meta .copy-btn { display: none !important; }
/**-.msg.user { justify-content: flex-end !important; }**/
.msg.bot:not(._meta) { justify-content: flex-start !important; }
.msg._meta { justify-content: flex-start !important; }
.msg.bot code { background: #f5f5f5; padding: 2px 4px; border-radius: 4px; font-family: Menlo, Consolas, monospace; font-size: 0.95em;}
.msg.bot pre { background: #1e1e1e; color: #f8f8f2; padding: 1em; border-radius: 6px; overflow-x: auto; margin: 1em 0; }
.msg.bot pre code { background: none; color: inherit; padding: 0; border-radius: 0; }
.msg.bot blockquote { border-left: 4px solid #dfe2e5; background: #f9f9f9; padding: 0.5em 1em; margin: 1em 0; color: #555; }
.msg.bot hr { border: none; border-top: 1px solid #ddd; margin: 1.5em 0; }
.msg.bot table { width: 100%; border-collapse: collapse; margin: 1em 0; }
.msg.bot th, .msg.bot td { border: 1px solid #ccc; padding: 0.6em; text-align: left; }
.msg.bot th { background: #f3f4f6; }
.msg.bot img { max-width: 100%; border-radius: 6px; margin: 1em 0; }
.msg.bot a { color: #3b82f6; text-decoration: none; }
.msg.bot a:hover { text-decoration: underline; }
.msg.bot ul, .msg.bot ol { margin: 1em 0; padding-left: 1.5em; }
.msg.bot ul ul, .msg.bot ol ol, .msg.bot ul ol, .msg.bot ol ul { margin-top: 0.5em; margin-bottom: 0.5em; }
.msg.bot input[type="checkbox"] { margin-right: 0.5em; vertical-align: middle; }
.msg.bot li.task-list-item { list-style: none; display: flex; align-items: flex-start; }
.msg.bot li.task-list-item > input { margin-top: 0.2em; }
.msg.bot .math, .msg.bot .katex { display: block; margin: 1em 0; text-align: center; }
.msg.bot blockquote.callout { border-left-color: #38a169; background: #f0fff4; }
.msg.bot blockquote.callout > p:first-child { font-weight: bold; }

</style>
</head>
<body>

<h1 id="welcome">今天有什么议程？</h1>

<main id="chat"></main>
<div id="mask"></div>
<button id="scrollBottom" aria-label="滚动到底部">↓</button>

<div class="composer">
  <div class="box">
    <div id="thumbs" class="thumbs"></div>
    <textarea id="prompt" rows="1" placeholder="询问任何问题"
              spellcheck="false" autocomplete="off"></textarea>
    <button id="plus" class="icon-btn plus">+</button>
    <button id="send" class="icon-btn send disabled">
      <svg viewBox="0 0 24 24"><path d="M3 20v-6l9-2-9-2V4l18 8z"/></svg>
    </button>
    <input id="file" type="file" accept="image/*" multiple hidden>
  </div>
</div>

<p class="footnote">Mini‑GPT 也可能会犯错。请核查重要信息。</p>

<div id="lightbox"><img alt=""></div>
<div id="authModal">
    <div class="box">
      <h2>请输入授权码</h2>
      <input id="authInput" type="password" placeholder="授权码"/>
      <button id="authBtn" disabled>确认</button>
      <div id="authErr"></div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<script>

document.addEventListener('DOMContentLoaded', () => {
  /* ---------------- DOM & CONFIG ---------------- */
  const BASE     = "https://streaming-tts.mefans.workers.dev/";
  const API_URL  = BASE + "/admin-api/ws";  // Note: this endpoint now handles HTTP POST streaming
  const AUTH     = BASE + "/admin-api/validate-code";
  const DEV_MODE = true; // 开发模式跳过授权

  const authInput  = document.getElementById('authInput');
  const authBtn    = document.getElementById('authBtn');
  const authErr    = document.getElementById('authErr');
  const authModal  = document.getElementById('authModal');
  const txt        = document.getElementById('prompt');
  const plus       = document.getElementById('plus');
  const send       = document.getElementById('send');
  const chat       = document.getElementById('chat');
  const file       = document.getElementById('file');
  const thumbs     = document.getElementById('thumbs');
  const arrow      = document.getElementById('scrollBottom');
  const mask       = document.getElementById('mask');
  const composer   = document.querySelector('.composer');
  const welcome    = document.getElementById('welcome');
  const lightbox   = document.getElementById('lightbox');
  const lightImg   = lightbox.querySelector('img');

  let uploads = [];
  let isAuthorized = false;
  let code = "";
  let sessionId = localStorage.getItem('session_id');
  if (!sessionId) {
    sessionId = crypto.randomUUID();
    localStorage.setItem('session_id', sessionId);
  }

  /* ---------------- UI LOCK/UNLOCK ---------------- */
  function lockUI() {
    txt.disabled = true;
    plus.disabled = true;
    send.disabled = true;
  }
  function unlockUI() {
    txt.disabled = false;
    plus.disabled = false;
    send.disabled = false;
    refreshState();
  }

  /* ---------------- AUTH FLOW ---------------- */
  function initAuth() {
    if (DEV_MODE) {
      isAuthorized = true;
      code = "dev-bypass";
      authModal.style.display = 'none';
      unlockUI();
   // —— 在这里加上这一行 —— 
    document.getElementById('mask').style.display = 'none';
    return;
  }
    const saved = localStorage.getItem('auth_code');
    if (saved) {
      isAuthorized = true;
      code = saved;
      authModal.style.display = 'none';
      unlockUI();
    } else {
      isAuthorized = false;
      lockUI();
      authModal.style.display = 'flex';
    }
  }

  authInput.oninput = () => {
    authBtn.disabled = !authInput.value.trim();
    authErr.style.display = 'none';
  };

  authBtn.onclick = async () => {
    authBtn.disabled = true;
    const c = authInput.value.trim();
    try {
      const { ok } = await fetch(AUTH, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ code: c })
      }).then(r=>r.json());
      if (!ok) throw new Error('授权失败');
      isAuthorized = true;
      code = c;
      localStorage.setItem('auth_code', c);
      authModal.style.display = 'none';
      unlockUI();
    } catch (e) {
      authErr.textContent = e.message;
      authErr.style.display = 'block';
    } finally {
      authBtn.disabled = false;
    }
  };

  function checkAuthOrStop(){
    if (DEV_MODE || isAuthorized) return true;
    alert("请先输入授权码！");
    return false;
  }

  /* ---------------- LAYOUT ---------------- */
  const chatAtBottom = (pad=200)=>chat.scrollHeight-chat.scrollTop-chat.clientHeight<pad;
  const scrollChatBottom=(smooth=true)=>chat.scrollTo({top:chat.scrollHeight,behavior:smooth?'smooth':'auto'});

  function refreshOverlay(){
    const h = composer.offsetHeight;
    mask.style.height = h+'px';
    arrow.style.bottom = h+40+'px';
    welcome.style.bottom = h+60+'px';
  }
  window.addEventListener('resize',refreshOverlay);
  refreshOverlay();

  /* ---------------- INPUT & SEND STATE ---------------- */
  function autoResize(){
    txt.style.height='24px';
    txt.style.height=Math.min(txt.scrollHeight,180)+'px';
  }
  function refreshState(){
    const t = txt.value.trim();
    const uploading = uploads.some(u=>u.uploading);
    send.className = 'icon-btn send' + (uploading?' loading':t||uploads.length?' ready':' disabled');
    send.innerHTML = uploading
      ? '<div class="spinner"></div>'
      : '<svg viewBox="0 0 24 24"><path d="M3 20v-6l9-2-9-2V4l18 8z"/></svg>';
  }
  txt.addEventListener('input',()=>{ autoResize(); refreshState(); });

  /* ---------------- RENDER HELPERS ---------------- */
  function isFencedCode(str){ return /^```/.test(str.trim()); }
  function appendSafeText(el, text){
    text.split(/\n/).forEach((ln,i)=>{
      el.appendChild(document.createTextNode(ln));
      if(i<text.split(/\n/).length-1) el.appendChild(document.createElement('br'));
    });
  }
  function renderMessageText(text){
    if(!text) return null;
    if(isFencedCode(text)){
      const pre = document.createElement('pre');
      const code = document.createElement('code');
      const stripped = text.replace(/^```[^\n]*\n?/, '').replace(/```$/, '');
      code.textContent = stripped;
      pre.appendChild(code);
      return pre;
    } else {
      const span = document.createElement('span');
      appendSafeText(span, text);
      return span;
    }
  }
/* === 新增：Markdown 渲染函数（用 marked.js） === */
  function renderBotContent(rawMarkdown, container) {
    // 1. 先用 marked 转成 HTML
    const html = marked.parse(rawMarkdown);
    // 2. 匹配结尾的 QA‑Report JSON block，提取出来单独渲染
    const qaMatch = rawMarkdown.match(/```json([\s\S]*?)```$/);
    let qaDiv = '';
    if (qaMatch) {
      qaDiv = `<pre class="qa-report"><code>${qaMatch[1].trim()}</code></pre>`;
      // 去掉 markdown 尾部的 report
      container.innerHTML = html.replace(/```json[\s\S]*?```$/, '');
    } else {
      container.innerHTML = html;
    }
    if (qaDiv) container.insertAdjacentHTML('beforeend', qaDiv);
  }
  /* ---------------- STREAM HELPERS ---------------- */
 function createBotBubble(){
    const div = document.createElement('div');
    div.className = 'msg bot';
    chat.appendChild(div);
    scrollChatBottom();
    return div;
  }
  function updateLastBotBubble(text, node){
    // 改为用 Markdown 渲染
    renderBotContent(text, node);
    scrollChatBottom();
  }
  /* ---------------- SEND & STREAM ---------------- */
  let first = true;
  const MAX_BYTES = 128000;

  function sendLargeText(str){
    const enc = new TextEncoder();
    const bytes = enc.encode(str);
    if(bytes.length <= MAX_BYTES){
      append('user', str, uploads.map(u=>u.url));
      return;
    }
    let offset=0, idx=0;
    while(offset < bytes.length){
      const slice = bytes.slice(offset, offset+MAX_BYTES);
      offset += MAX_BYTES;
      const chunk = new TextDecoder().decode(slice);
      append('user', `[第 ${++idx} 部分]\n`+chunk, []);
    }
    if(uploads.length) append('user','[图片]', uploads.map(u=>u.url));
  }

    /* === 新增：Clarify→Confirm→正式答复的状态机逻辑 === */
  async function trySend(){
     // 1. 不再依赖 className 判断按钮是否可点，直接看输入或上传
    if (txt.value.trim() === '' && uploads.length === 0) return;
    if (!checkAuthOrStop()) return;
    if (welcome) { welcome.remove(); }
    if (first) { first = false; document.body.style.overflow = 'auto'; }

    const text = txt.value.trim();
    if (text) {
      sendLargeText(text);
    } else {
      append('user', '', uploads.map(u => u.url));
    }
    txt.value = ''; autoResize();
    uploads.forEach(u => u.node.remove());
    uploads = []; refreshState();

    const botNode = createBotBubble();

    // 2. 构造 payload，字段要和 Worker 里一模一样
    const payload = {
      code: code,
      session_id: sessionId,
      text: text,
      images: uploads.map(u => u.url),
      userRoles: window.USER_ROLES || [],
      industry: window.SELECTED_INDUSTRY || '',
      subIndustry: window.SELECTED_SUB_INDUSTRY || '',
      sessionState: {
        status: window.SESSION_STATE?.status || 'final_answer',
        lastClarifyQ: window.SESSION_STATE?.lastClarifyQ || '',
        clarifyTimes: window.SESSION_STATE?.clarifyTimes || 0,
      }
    };

    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    const reader = res.body.getReader();
    const dec = new TextDecoder();
    let buf = '';

    // 3. DEV_MODE 下直接 answer，不再等待后端澄清标记
    let mode = DEV_MODE ? 'answer' : 'clarify';

    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      buf += dec.decode(value, { stream: true });

      // 只有非 DEV_MODE 时才检查澄清标记
      if (mode === 'clarify' && buf.includes('[CLARIFY]')) {
        const [clarPart, rest] = buf.split('[CLARIFY]');
        if (window.confirm(clarPart.trim())) {
          mode = 'answer';
          buf = rest;
        } else {
          mode = 'answer';
        }
      }

      if (mode === 'answer') {
        updateLastBotBubble(buf, botNode);
      }
    }
  }

  send.addEventListener('click', trySend);
  txt.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      trySend();
    }
  });

  /* ---------------- SCROLL BUTTON ---------------- */
  function toggleArrow(){
    arrow.classList.toggle('show', !chatAtBottom());
  }
  chat.addEventListener('scroll', toggleArrow);
  arrow.addEventListener('click', ()=>scrollChatBottom());

  /* ---------------- APPEND MESSAGES ---------------- */
  function append(who, text='', imgs=[]){
    if(!text && !imgs.length) return;
    const div = document.createElement('div');
    div.className = 'msg ' + who;

    if(imgs.length){
      const pics = document.createElement('div');
      pics.className = 'pics';
      imgs.forEach(src=>{
        const im = new Image();
        im.src = src;
        im.onclick = ()=>{ lightImg.src=src; lightbox.style.display='flex'; };
        pics.appendChild(im);
      });
      div.appendChild(pics);
    }

    if(text){
      const node = renderMessageText(text);
      if(node) div.appendChild(node);
    }

    if(who==='bot'){
      const btn = document.createElement('button');
      btn.className='copy-btn'; btn.textContent='⧉';
      btn.onclick=()=>navigator.clipboard.writeText(text);
      div.appendChild(btn);
    }
    if(who==='user'){
      const acts = document.createElement('div');
      acts.className='actions';
      const btnC = document.createElement('button'); btnC.className='action-btn';
      btnC.innerHTML = '<svg viewBox="0 0 24 24"><path d="M15 2H6a2 2..."/></svg>';
      btnC.onclick=()=>{
        navigator.clipboard.writeText(text);
        const tip = document.createElement('div');
        tip.className='copy-tip'; tip.textContent='已复制';
        div.appendChild(tip);
        setTimeout(()=>tip.remove(),2000);
      };
      const btnE = document.createElement('button'); btnE.className='action-btn';
      btnE.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3 17.25..."/></svg>';
      btnE.onclick=()=>{
        txt.value=text; autoResize(); txt.focus();
      };
      acts.append(btnC, btnE);
      div.appendChild(acts);
    }

    chat.appendChild(div);
    scrollChatBottom(false);

    const imgsEl = div.querySelectorAll('img');
    if(imgsEl.length){
      let loaded=0;
      imgsEl.forEach(img=>{
        if(img.complete) {
          if(++loaded===imgsEl.length) scrollChatBottom();
        } else {
          img.onload=img.onerror=()=>{
            if(++loaded===imgsEl.length) scrollChatBottom();
          };
        }
      });
    }
  }

  /* ---------------- UPLOAD MOCK ---------------- */
  function mockUpload(file){
    return new Promise(r=>setTimeout(()=>r(URL.createObjectURL(file)),800));
  }
  function handleFiles(list){
    [...list].forEach(f=>{
      if(!f.type.startsWith('image/')) return;
      const wrap = document.createElement('div');
      wrap.style.position='relative';
      wrap.innerHTML = `<img src="${URL.createObjectURL(f)}"><button class="close">✕</button>`;
      thumbs.appendChild(wrap);
      const obj = { file:f, url:'', uploading:true, node:wrap };
      uploads.push(obj); refreshState();
      wrap.querySelector('.close').onclick=()=>{
        uploads=uploads.filter(u=>u!==obj);
        wrap.remove(); refreshState();
      };
      mockUpload(f).then(u=>{
        obj.url=u; obj.uploading=false; refreshState();
      });
    });
  }
  plus.addEventListener('click', ()=>file.click());
  file.addEventListener('change', ()=>handleFiles(file.files));
  document.addEventListener('paste', e=>{
    for(const it of e.clipboardData.items){
      if(it.type.startsWith('image/')){
        handleFiles([it.getAsFile()]);
      }
    }
  });
  ['dragover','drop'].forEach(evt=>{
    txt.addEventListener(evt, e=>{
      if(evt==='dragover') e.preventDefault();
      if(evt==='drop'){ e.preventDefault(); handleFiles(e.dataTransfer.files); }
    });
  });

  /* ---------------- LIGHTBOX & START ---------------- */
  lightbox.addEventListener('click', ()=>lightbox.style.display='none');
  window.addEventListener('keyup', e=>{
    if(e.key==='Escape') lightbox.style.display='none';
  });

  autoResize();
  refreshState();
  toggleArrow();

  initAuth();
});
</script>

</body>
</html>
