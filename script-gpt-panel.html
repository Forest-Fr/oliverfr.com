<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>管理后台 — 授权码日志</title>
  <!-- 引入 Icon -->
  <script src="https://unpkg.com/@heroicons/react/outline.js"></script>
  <!-- React / ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for in-browser JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* ------- 全局重置 & 布局 ------- */
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: Arial, sans-serif; background:#f0f2f5; color:#333; }
    .container { max-width:1200px; margin:1rem auto; padding:1rem; }
    button { cursor:pointer; }

    /* ------- 搜索 & 分页 ------- */
    .toolbar { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
    .toolbar input, .toolbar select { padding:.5rem .75rem; border:1px solid #ccc; border-radius:4px; }
    .pagination { display:flex; align-items:center; gap:.5rem; margin-top:1rem; }
    .pagination button { padding:.5rem; border:1px solid #ccc; border-radius:4px; background:#fff; }
    .pagination button:disabled { opacity:.5; cursor:not-allowed; }

    /* ------- 表格样式 ------- */
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { padding:.75rem 1rem; border-bottom:1px solid #eee; text-align:left; }
    thead { background:#fafafa; }
    @media(max-width:768px){
      table { display:none; }
    }

    /* ------- 卡片样式（移动端） ------- */
    .cards { display:none; }
    @media(max-width:768px){
      .cards { display:block; }
      .card { background:#fff; border-radius:6px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 4px rgba(0,0,0,.1); }
      .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
      .card-body { font-size:.9rem; color:#555; white-space:pre-wrap; }
    }

    /* ------- 按钮 & 图标 ------- */
    .icon-btn { background:none; border:none; padding:0; }
    .icon-btn svg { width:1.25rem; height:1.25rem; }

    /* ------- 弹窗 ------- */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; }
    .modal { background:#fff; border-radius:6px; width:90%; max-width:400px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.2); }
    .modal-header { font-size:1.125rem; margin-bottom:.5rem; }
    .modal textarea { width:100%; height:120px; padding:.5rem; border:1px solid #ccc; border-radius:4px; resize:none; }
    .modal-actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:.75rem; }
    .btn { padding:.5rem .75rem; border-radius:4px; border:1px solid transparent; }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-secondary { background:#f5f5f5; color:#333; }
    .btn-danger { background:#d32f2f; color:#fff; }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <script type="text/babel">
  const { useState, useEffect } = React;
  const { PencilIcon, TrashIcon, ChevronLeftIcon, ChevronRightIcon, SearchIcon } = heroicons;

  const API_BASE = "https://script-gpt.mefans.workers.dev/admin-api/logs";

  function AdminDashboard() {
    const [logs, setLogs] = useState([]);
    const [loading, setLoading] = useState(false);
    const [search, setSearch] = useState("");
    const [page, setPage] = useState(1);
    const [pageSize, setPageSize] = useState(10);
    const [total, setTotal] = useState(0);
    const [editing, setEditing] = useState(null);
    const [noteDraft, setNoteDraft] = useState("");

   const fetchLogs = async () => {
  setLoading(true);
  try {
    const params = new URLSearchParams({ q: search, page, pageSize });
    const qs  = params.toString();                       // 把参数序列化成 "q=xx&page=1&pageSize=10"
    const res = await fetch(API_BASE + "?" + qs);        // ← 不要在这一行末尾写“/”
    const json = await res.json();
    setLogs(json.data);
    setTotal(json.total);
  } catch(e){
    console.error(e);
  } finally {
    setLoading(false);
  }
};


    useEffect(fetchLogs, [search, page, pageSize]);

    const handleDelete = async (code) => {
  if (!confirm("确定删除 \"" + code + "\" ?")) return;

      await fetch(\`\${API_BASE}/\${encodeURIComponent(code)}\`,{method:"DELETE"});
      fetchLogs();
    };

    const handleSave = async () => {
      setLoading(true);
      await fetch(\`\${API_BASE}/\${encodeURIComponent(editing.code)}\`, {
        method:"PATCH",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ note: noteDraft })
      });
      setEditing(null);
      fetchLogs();
    };

    const totalPages = Math.ceil(total/pageSize) || 1;

    return (
      <>
        {/* 工具栏 */}
        <div className="toolbar">
          <div style={{position:"relative",flex:"1"}}>
            <SearchIcon className="icon-btn" style={{position:"absolute",left:8,top:8,color:"#888"}}/>
            <input
              className="pl-10 w-full"
              placeholder="搜索授权码或备注…"
              value={search}
              onChange={e=>{ setPage(1); setSearch(e.target.value); }}
            />
          </div>
          <select value={pageSize} onChange={e=>{ setPage(1); setPageSize(+e.target.value); }}>
            {[10,20,50].map(n=><option key={n} value={n}>{n} / 页</option>)}
          </select>
        </div>

        {/* 桌面表格 */}
        <table>
          <thead>
            <tr>
              <th>授权码</th>
              <th>最后使用</th>
              <th>IP</th>
              <th>备注</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody>
            {loading
              ? <tr><td colSpan="5" style={{textAlign:"center",padding:"1rem"}}>加载中…</td></tr>
              : logs.length === 0
                ? <tr><td colSpan="5" style={{textAlign:"center",padding:"1rem"}}>无记录</td></tr>
                : logs.map(log=>(
                    <tr key={log.code}>
                      <td>{log.code}</td>
                      <td>{log.last_used_at||"—"}</td>
                      <td>{log.ip||"—"}</td>
                      <td style={{whiteSpace:"pre-wrap"}}>{log.note||"—"}</td>
                      <td>
                        <button className="icon-btn" title="编辑" onClick={()=>{
                          setEditing(log);
                          setNoteDraft(log.note||"");
                        }}><PencilIcon/></button>
                        <button className="icon-btn" title="删除" onClick={()=>handleDelete(log.code)}><TrashIcon/></button>
                      </td>
                    </tr>
                  ))
            }
          </tbody>
        </table>

        {/* 移动卡片 */}
        <div className="cards">
          {loading
            ? <div style={{textAlign:"center",padding:"1rem"}}>加载中…</div>
            : logs.length===0
              ? <div style={{textAlign:"center",padding:"1rem"}}>无记录</div>
              : logs.map(log=>(
                  <div className="card" key={log.code}>
                    <div className="card-header">
                      <strong>{log.code}</strong>
                      <div>
                        <button className="icon-btn" onClick={()=>{
                          setEditing(log);
                          setNoteDraft(log.note||"");
                        }}><PencilIcon/></button>
                        <button className="icon-btn" onClick={()=>handleDelete(log.code)}><TrashIcon/></button>
                      </div>
                    </div>
                    <div className="card-body">
                      <div>最后使用：{log.last_used_at||"—"}</div>
                      <div>IP：{log.ip||"—"}</div>
                      <div>{log.note||"—"}</div>
                    </div>
                  </div>
                ))
          }
        </div>

        {/* 分页 */}
        <div className="pagination">
          <button disabled={page<=1} onClick={()=>setPage(p=>p-1)}><ChevronLeftIcon/></button>
          <span>第 {page} / {totalPages} 页</span>
          <button disabled={page>=totalPages} onClick={()=>setPage(p=>p+1)}><ChevronRightIcon/></button>
        </div>

        {/* 编辑弹窗 */}
        {editing && (
          <div className="modal-backdrop">
            <div className="modal">
              <div className="modal-header">编辑备注 — {editing.code}</div>
              <textarea
                value={noteDraft}
                onChange={e=>setNoteDraft(e.target.value)}
              />
              <div className="modal-actions">
                <button className="btn btn-secondary" onClick={()=>setEditing(null)}>取消</button>
                <button className="btn btn-primary" onClick={handleSave}>保存</button>
              </div>
            </div>
          </div>
        )}
      </>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<AdminDashboard />);
  </script>
</body>
</html>
