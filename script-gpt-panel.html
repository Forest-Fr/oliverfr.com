
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>管理后台 — 授权码日志</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <style>
    /* —— 全局 —— */
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:Arial,sans-serif; background:#f0f2f5; color:#333; }
    .container { max-width:1200px; margin:1rem auto; padding:1rem; }

    /* —— 工具栏 —— */
    .toolbar { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
    .toolbar .search { position:relative; flex:1; }
    .toolbar .search span { position:absolute; left:8px; top:8px; font-size:1.2rem; color:#888; }
    .toolbar .search input { width:100%; padding:.5rem .75rem .5rem 2.5rem; border:1px solid #ccc; border-radius:4px; }
    .toolbar select { padding:.5rem .75rem; border:1px solid #ccc; border-radius:4px; }

    /* —— 桌面表格 —— */
    .table-wrapper { overflow-x:auto; background:#fff; border-radius:4px; }
    table { width:100%; border-collapse:collapse; min-width:1000px; }
    thead { background:#fafafa; }
    th, td { padding:.75rem 1rem; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th { white-space:nowrap; }
    td.code-cell { font-family:Consolas,monospace; font-size:.85rem; max-width:240px; }
    td.code-cell div { overflow-x:auto; max-height:6em; line-height:1.4; }
    td.actions button { margin-right:.5rem; }

    @media(max-width:768px){
      .table-wrapper { display:none; }
    }

    /* —— 移动卡片 —— */
    .cards { display:none; }
    @media(max-width:768px){
      .cards { display:block; }
      .card { background:#fff; border-radius:6px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 4px rgba(0,0,0,.1); }
      .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
      .card-body { font-size:.9rem; color:#555; white-space:pre-wrap; margin-bottom:.5rem; }
      .card-body .code-preview { font-family:Consolas,monospace; font-size:.8rem; max-height:4em; overflow-y:auto; background:#f9f9f9; padding:.5rem; border-radius:4px; }
      .card-footer { text-align:right; }
      .card-footer button { margin-left:.5rem; }
    }

    /* —— 分页 —— */
    .pagination { display:flex; align-items:center; gap:.5rem; margin-top:1rem; }
    .pagination button { padding:.5rem; border:1px solid #ccc; border-radius:4px; background:#fff; }
    .pagination button:disabled { opacity:.5; cursor:not-allowed; }

    /* —— 弹窗 —— */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal { background:#fff; border-radius:6px; width:90%; max-width:600px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column; }
    .modal-header { padding:1rem; font-size:1.125rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; }
    .modal-body { padding:1rem; overflow:auto; font-family:Consolas,monospace; font-size:.85rem; line-height:1.4; background:#f5f5f5; flex:1; }
    .modal-footer { padding:1rem; border-top:1px solid #eee; text-align:right; }
    .btn { padding:.5rem .75rem; border-radius:4px; border:1px solid transparent; cursor:pointer; }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-secondary { background:#f5f5f5; color:#333; }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <!-- React / ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const API_BASE = "https://oliverfr.com/admin-api/logs";
function AdminDashboard() {
  const [logs, setLogs] = useState([]);
  const [loading, setLoading] = useState(false);
  const [search, setSearch] = useState("");
  const [page, setPage] = useState(1);
  const [pageSize, setPageSize] = useState(10);
  const [total, setTotal] = useState(0);
  const [editing, setEditing] = useState(null);
  const [noteDraft, setNoteDraft] = useState("");
  const [preview, setPreview] = useState({
    open: false,
    code: ""
  });

  // 拉列表
  useEffect(() => {
    async function load() {
      setLoading(true);
      try {
        const params = new URLSearchParams({
          q: search,
          page,
          pageSize
        });
        const res = await fetch(`${API_BASE}?${params.toString()}`);
        if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
        const {
          data,
          total
        } = await res.json();
        setLogs(data);
        setTotal(total);
      } catch (err) {
        console.error("拉日志失败：", err);
      } finally {
        setLoading(false);
      }
    }
    load();
  }, [search, page, pageSize]);

  // 北京时间格式化
  const fmtTime = ts => ts ? new Intl.DateTimeFormat("zh-CN", {
    year: "numeric",
    month: "2-digit",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    second: "2-digit",
    hour12: false,
    timeZone: "Asia/Shanghai"
  }).format(new Date(ts)) : "—";

  // 删除
  const handleDelete = async code => {
    if (!confirm(`确定删除 "${code}"？`)) return;
    await fetch(`${API_BASE}/${encodeURIComponent(code)}`, {
      method: "DELETE"
    });
    setPage(1);
  };

  // 保存备注
  const handleSave = async () => {
    if (!editing) return;
    setLoading(true);
    await fetch(`${API_BASE}/${encodeURIComponent(editing.code)}`, {
      method: "PATCH",
      headers: {
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        note: noteDraft
      })
    });
    setEditing(null);
    setPage(1);
  };
  const totalPages = Math.max(1, Math.ceil(total / pageSize));
  return /*#__PURE__*/React.createElement(React.Fragment, null, /*#__PURE__*/React.createElement("div", {
    className: "toolbar"
  }, /*#__PURE__*/React.createElement("div", {
    className: "search"
  }, /*#__PURE__*/React.createElement("span", null, "\uD83D\uDD0D"), /*#__PURE__*/React.createElement("input", {
    placeholder: "\u641C\u7D22\u6388\u6743\u7801\u6216\u5907\u6CE8\u2026",
    value: search,
    onChange: e => {
      setPage(1);
      setSearch(e.target.value);
    }
  })), /*#__PURE__*/React.createElement("select", {
    value: pageSize,
    onChange: e => {
      setPage(1);
      setPageSize(+e.target.value);
    }
  }, [10, 20, 50].map(n => /*#__PURE__*/React.createElement("option", {
    key: n,
    value: n
  }, n, " / \u9875")))), /*#__PURE__*/React.createElement("div", {
    className: "table-wrapper"
  }, /*#__PURE__*/React.createElement("table", null, /*#__PURE__*/React.createElement("thead", null, /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("th", null, "\u6388\u6743\u7801"), /*#__PURE__*/React.createElement("th", null, "\u4F7F\u7528\u65F6\u95F4"), /*#__PURE__*/React.createElement("th", null, "IP"), /*#__PURE__*/React.createElement("th", null, "Prompt"), /*#__PURE__*/React.createElement("th", null, "Tokens (in/com/total)"), /*#__PURE__*/React.createElement("th", null, "Cost (USD)"), /*#__PURE__*/React.createElement("th", null, "\u5907\u6CE8"), /*#__PURE__*/React.createElement("th", null, "\u5B8C\u6574\u4EE3\u7801"), /*#__PURE__*/React.createElement("th", null, "\u64CD\u4F5C"))), /*#__PURE__*/React.createElement("tbody", null, loading ? /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("td", {
    colSpan: "9",
    style: {
      textAlign: "center",
      padding: "1rem"
    }
  }, "\u52A0\u8F7D\u4E2D\u2026")) : logs.length === 0 ? /*#__PURE__*/React.createElement("tr", null, /*#__PURE__*/React.createElement("td", {
    colSpan: "9",
    style: {
      textAlign: "center",
      padding: "1rem"
    }
  }, "\u65E0\u8BB0\u5F55")) : logs.map(log => /*#__PURE__*/React.createElement("tr", {
    key: log.id || log.code
  }, /*#__PURE__*/React.createElement("td", null, log.code), /*#__PURE__*/React.createElement("td", null, fmtTime(log.timestamp || log.last_used_at)), /*#__PURE__*/React.createElement("td", null, log.ip || "—"), /*#__PURE__*/React.createElement("td", {
    style: {
      whiteSpace: "pre-wrap",
      maxWidth: "120px"
    }
  }, log.prompt || "—"), /*#__PURE__*/React.createElement("td", null, `${log.prompt_tokens || "—"}/${log.completion_tokens || "—"}/${log.total_tokens || "—"}`), /*#__PURE__*/React.createElement("td", null, log.cost_usd != null ? log.cost_usd.toFixed(6) : "—"), /*#__PURE__*/React.createElement("td", {
    style: {
      whiteSpace: "pre-wrap"
    }
  }, log.note || "—"), /*#__PURE__*/React.createElement("td", {
    className: "code-cell"
  }, /*#__PURE__*/React.createElement("div", null, log.full_code || log.resultHtml || "—"), log.full_code && /*#__PURE__*/React.createElement("button", {
    className: "btn btn-secondary",
    onClick: () => setPreview({
      open: true,
      code: log.full_code
    })
  }, "\u9884\u89C8")), /*#__PURE__*/React.createElement("td", {
    className: "actions"
  }, /*#__PURE__*/React.createElement("button", {
    className: "btn btn-secondary",
    onClick: () => {
      setEditing(log);
      setNoteDraft(log.note || "");
    }
  }, "\u270F\uFE0F"), /*#__PURE__*/React.createElement("button", {
    className: "btn btn-secondary",
    onClick: () => handleDelete(log.code)
  }, "\uD83D\uDDD1\uFE0F"))))))), /*#__PURE__*/React.createElement("div", {
    className: "cards"
  }, loading ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: "center",
      padding: "1rem"
    }
  }, "\u52A0\u8F7D\u4E2D\u2026") : logs.length === 0 ? /*#__PURE__*/React.createElement("div", {
    style: {
      textAlign: "center",
      padding: "1rem"
    }
  }, "\u65E0\u8BB0\u5F55") : logs.map(log => /*#__PURE__*/React.createElement("div", {
    className: "card",
    key: log.id || log.code
  }, /*#__PURE__*/React.createElement("div", {
    className: "card-header"
  }, /*#__PURE__*/React.createElement("strong", null, log.code), /*#__PURE__*/React.createElement("div", null, /*#__PURE__*/React.createElement("button", {
    onClick: () => {
      setEditing(log);
      setNoteDraft(log.note || "");
    }
  }, "\u270F\uFE0F"), /*#__PURE__*/React.createElement("button", {
    onClick: () => handleDelete(log.code)
  }, "\uD83D\uDDD1\uFE0F"))), /*#__PURE__*/React.createElement("div", {
    className: "card-body"
  }, /*#__PURE__*/React.createElement("div", null, "\u4F7F\u7528\uFF1A", fmtTime(log.timestamp || log.last_used_at)), /*#__PURE__*/React.createElement("div", null, "IP\uFF1A", log.ip || "—"), /*#__PURE__*/React.createElement("div", null, "Prompt\uFF1A", log.prompt || "—"), /*#__PURE__*/React.createElement("div", null, "Tokens\uFF1A", `${log.prompt_tokens || "—"}/${log.completion_tokens || "—"}/${log.total_tokens || "—"}`), /*#__PURE__*/React.createElement("div", null, "Cost\uFF1A", log.cost_usd != null ? log.cost_usd.toFixed(6) : "—"), /*#__PURE__*/React.createElement("div", null, "\u5907\u6CE8\uFF1A", log.note || "—"), log.full_code && /*#__PURE__*/React.createElement("div", {
    className: "card-footer"
  }, /*#__PURE__*/React.createElement("button", {
    className: "btn btn-secondary",
    onClick: () => setPreview({
      open: true,
      code: log.full_code
    })
  }, "\u67E5\u770B\u4EE3\u7801")))))), /*#__PURE__*/React.createElement("div", {
    className: "pagination"
  }, /*#__PURE__*/React.createElement("button", {
    disabled: page <= 1,
    onClick: () => setPage(p => p - 1)
  }, "\u25C0\uFE0F"), /*#__PURE__*/React.createElement("span", null, "\u7B2C ", page, " / ", totalPages, " \u9875"), /*#__PURE__*/React.createElement("button", {
    disabled: page >= totalPages,
    onClick: () => setPage(p => p + 1)
  }, "\u25B6\uFE0F")), editing && /*#__PURE__*/React.createElement("div", {
    className: "modal-backdrop"
  }, /*#__PURE__*/React.createElement("div", {
    className: "modal"
  }, /*#__PURE__*/React.createElement("div", {
    className: "modal-header"
  }, "\u7F16\u8F91\u5907\u6CE8 \u2014 ", editing.code, /*#__PURE__*/React.createElement("button", {
    className: "btn btn-secondary",
    onClick: () => setEditing(null)
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    style: {
      padding: "1rem"
    }
  }, /*#__PURE__*/React.createElement("textarea", {
    style: {
      width: "100%",
      height: "120px",
      padding: ".5rem",
      border: "1px solid #ccc",
      borderRadius: "4px"
    },
    value: noteDraft,
    onChange: e => setNoteDraft(e.target.value)
  })), /*#__PURE__*/React.createElement("div", {
    className: "modal-footer"
  }, /*#__PURE__*/React.createElement("button", {
    className: "btn btn-secondary",
    onClick: () => setEditing(null)
  }, "\u53D6\u6D88"), /*#__PURE__*/React.createElement("button", {
    className: "btn btn-primary",
    onClick: handleSave
  }, "\u4FDD\u5B58")))), preview.open && /*#__PURE__*/React.createElement("div", {
    className: "modal-backdrop"
  }, /*#__PURE__*/React.createElement("div", {
    className: "modal"
  }, /*#__PURE__*/React.createElement("div", {
    className: "modal-header"
  }, "\u5B8C\u6574\u4EE3\u7801\u9884\u89C8", /*#__PURE__*/React.createElement("button", {
    className: "btn btn-secondary",
    onClick: () => setPreview({
      open: false,
      code: ""
    })
  }, "\u2715")), /*#__PURE__*/React.createElement("div", {
    className: "modal-body"
  }, /*#__PURE__*/React.createElement("pre", {
    style: {
      whiteSpace: "pre-wrap"
    }
  }, preview.code)), /*#__PURE__*/React.createElement("div", {
    className: "modal-footer"
  }, /*#__PURE__*/React.createElement("button", {
    className: "btn btn-primary",
    onClick: () => {
      navigator.clipboard.writeText(preview.code).then(() => {
        alert("已复制到剪贴板");
      });
    }
  }, "\u590D\u5236")))));
}
ReactDOM.createRoot(document.getElementById("root")).render(/*#__PURE__*/React.createElement(AdminDashboard, null));
