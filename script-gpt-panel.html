<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç®¡ç†åå° â€” æˆæƒç æ—¥å¿—</title>
  <!-- React / ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for in-browser JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* ------- å…¨å±€é‡ç½® & å¸ƒå±€ ------- */
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: Arial, sans-serif; background:#f0f2f5; color:#333; }
    .container { max-width:1200px; margin:1rem auto; padding:1rem; }
    button { cursor:pointer; }

    /* ------- æœç´¢ & åˆ†é¡µ ------- */
    .toolbar { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
    .toolbar input, .toolbar select { padding:.5rem .75rem; border:1px solid #ccc; border-radius:4px; }
    .pagination { display:flex; align-items:center; gap:.5rem; margin-top:1rem; }
    .pagination button { padding:.5rem; border:1px solid #ccc; border-radius:4px; background:#fff; }
    .pagination button:disabled { opacity:.5; cursor:not-allowed; }

    /* ------- è¡¨æ ¼æ ·å¼ ------- */
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { padding:.75rem 1rem; border-bottom:1px solid #eee; text-align:left; }
    thead { background:#fafafa; }
    @media(max-width:768px){
      table { display:none; }
    }

    /* ------- å¡ç‰‡æ ·å¼ï¼ˆç§»åŠ¨ç«¯ï¼‰ ------- */
    .cards { display:none; }
    @media(max-width:768px){
      .cards { display:block; }
      .card { background:#fff; border-radius:6px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 4px rgba(0,0,0,.1); }
      .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
      .card-body { font-size:.9rem; color:#555; white-space:pre-wrap; }
    }

    /* ------- å¼¹çª— ------- */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; }
    .modal { background:#fff; border-radius:6px; width:90%; max-width:400px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.2); }
    .modal-header { font-size:1.125rem; margin-bottom:.5rem; }
    .modal textarea { width:100%; height:120px; padding:.5rem; border:1px solid #ccc; border-radius:4px; resize:none; }
    .modal-actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:.75rem; }
    .btn { padding:.5rem .75rem; border-radius:4px; border:1px solid transparent; }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-secondary { background:#f5f5f5; color:#333; }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // è‡ªåŠ¨å–å½“å‰åŸŸå + /admin-api/logs
    const API_BASE = window.location.origin + "/admin-api/logs";

    function AdminDashboard() {
      const [logs, setLogs] = useState([]);
      const [loading, setLoading] = useState(false);
      const [search, setSearch] = useState("");
      const [page, setPage] = useState(1);
      const [pageSize, setPageSize] = useState(10);
      const [total, setTotal] = useState(0);
      const [editing, setEditing] = useState(null);
      const [noteDraft, setNoteDraft] = useState("");

      // æ‹‰å†å²æ—¥å¿—
      const fetchLogs = async () => {
        setLoading(true);
        try {
          const params = new URLSearchParams({ q: search, page, pageSize });
          const res = await fetch(`${API_BASE}?${params.toString()}`);
          if (!res.ok) throw new Error(`æ‹‰æ—¥å¿—å¤±è´¥ï¼š${res.status}`);
          const json = await res.json();
          setLogs(json.data);
          setTotal(json.total);
        } catch (e) {
          console.error("æ‹‰æ—¥å¿—å¤±è´¥:", e);
        } finally {
          setLoading(false);
        }
      };

      // ä¿®æ­£ useEffectï¼Œä¸è¦ç›´æ¥å†™ async () => â€¦
      useEffect(() => {
        fetchLogs();
      }, [search, page, pageSize]);

      const handleDelete = async (code) => {
        if (!confirm(`ç¡®å®šåˆ é™¤ "${code}"ï¼Ÿ`)) return;
        await fetch(`${API_BASE}/${encodeURIComponent(code)}`, { method: "DELETE" });
        fetchLogs();
      };

      const handleSave = async () => {
        setLoading(true);
        await fetch(`${API_BASE}/${encodeURIComponent(editing.code)}`, {
          method: "PATCH",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ note: noteDraft })
        });
        setEditing(null);
        fetchLogs();
      };

      const totalPages = Math.max(1, Math.ceil(total / pageSize));

      return (
        <>
          {/* å·¥å…·æ  */}
          <div className="toolbar">
            <div style={{ position:"relative", flex:1 }}>
              <span style={{ position:"absolute", left:8, top:8, color:"#888" }}>ğŸ”</span>
              <input
                style={{ paddingLeft:"2rem", width:"100%" }}
                placeholder="æœç´¢æˆæƒç æˆ–å¤‡æ³¨â€¦"
                value={search}
                onChange={e => { setPage(1); setSearch(e.target.value); }}
              />
            </div>
            <select value={pageSize} onChange={e => { setPage(1); setPageSize(Number(e.target.value)); }}>
              {[10,20,50].map(n => <option key={n} value={n}>{n} / é¡µ</option>)}
            </select>
          </div>

          {/* æ¡Œé¢è¡¨æ ¼ */}
          <table>
            <thead>
                 <tr>
      <th>æˆæƒç </th>
      <th>ä½¿ç”¨æ—¶é—´</th>
      <th>IP</th>
      <th>Prompt</th>
      <th>Tokens (in/com/total)</th>
      <th>Cost (USD)</th>
      <th>å¤‡æ³¨</th>
      <th>å®Œæ•´ä»£ç </th>
      <th>æ“ä½œ</th>
    </tr>
            </thead>
            <tbody>
              {loading ? (
                <tr><td colSpan="5" style={{ textAlign:"center", padding:"1rem" }}>åŠ è½½ä¸­â€¦</td></tr>
              ) : logs.length === 0 ? (
                <tr><td colSpan="5" style={{ textAlign:"center", padding:"1rem" }}>æ— è®°å½•</td></tr>
              ) : logs.map(log => (
                <tr key={log.id}>
                  <td>{log.code}</td>
                  <td>{log.timestamp||"â€”"}</td>
                  <td>{log.ip||"â€”"}</td>
                  <td style={{ whiteSpace:"pre-wrap" }}>{log.note||"â€”"}</td>
                  <td>
                    <button title="ç¼–è¾‘" onClick={()=>{ setEditing(log); setNoteDraft(log.note||""); }}>âœï¸</button>
                    <button title="åˆ é™¤" onClick={()=>handleDelete(log.code)}>ğŸ—‘</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>

     {/* â€”â€” ç§»åŠ¨å¡ç‰‡ â€”â€” */}
<div className="cards">
  {logs.map(log => (
    <div className="card" key={log.id}>
      <div className="card-header">
        <strong>{log.code}</strong>
        <div>
          <button onClick={/* ... */}>âœï¸</button>
          <button onClick={/* ... */}>ğŸ—‘</button>
        </div>
      </div>
      <div className="card-body">
        <div>ä½¿ç”¨æ—¶é—´ï¼š{new Date(log.timestamp).toLocaleString()}</div>
        <div>IPï¼š{log.ip || "â€”"}</div>
        <div>Promptï¼š{log.prompt}</div>
        <div>Tokensï¼š{log.prompt_tokens}/{log.completion_tokens}/{log.total_tokens}</div>
        <div>Costï¼š{log.cost_usd != null ? log.cost_usd.toFixed(6) : "â€”"}</div>
        <div>å¤‡æ³¨ï¼š{log.note || "â€”"}</div>
        <div style={{ marginTop:"0.5em", fontSize:"0.8em", whiteSpace:"pre-wrap" }}>
          å®Œæ•´ä»£ç ï¼š
          <pre style={{ maxHeight:"6em", overflow:"auto", background:"#fafafa", padding:"0.5em" }}>
            {log.full_code}
          </pre>
        </div>
      </div>
    </div>
  ))}
</div>


          {/* åˆ†é¡µ */}
          <div className="pagination">
            <button disabled={page<=1} onClick={()=>setPage(p=>p-1)}>â—€ï¸</button>
            <span>ç¬¬ {page} / {totalPages} é¡µ</span>
            <button disabled={page>=totalPages} onClick={()=>setPage(p=>p+1)}>â–¶ï¸</button>
          </div>

          {/* ç¼–è¾‘å¼¹çª— */}
          {editing && (
            <div className="modal-backdrop">
              <div className="modal">
                <div className="modal-header">ç¼–è¾‘å¤‡æ³¨ â€” {editing.code}</div>
                <textarea value={noteDraft} onChange={e=>setNoteDraft(e.target.value)} />
                <div className="modal-actions">
                  <button className="btn btn-secondary" onClick={()=>setEditing(null)}>å–æ¶ˆ</button>
                  <button className="btn btn-primary"  onClick={handleSave}>ä¿å­˜</button>
                </div>
              </div>
            </div>
          )}
        </>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<AdminDashboard />);
  </script>
</body>
</html>
