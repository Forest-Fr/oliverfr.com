<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç®¡ç†åå° â€” æˆæƒç æ—¥å¿—</title>
  <!-- React / ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for in-browser JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    /* ------- å…¨å±€é‡ç½® & å¸ƒå±€ ------- */
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: Arial, sans-serif; background:#f0f2f5; color:#333; }
    .container { max-width:1200px; margin:1rem auto; padding:1rem; }
    button { cursor:pointer; }

    /* ------- æœç´¢ & åˆ†é¡µ ------- */
    .toolbar { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
    .toolbar input, .toolbar select { padding:.5rem .75rem; border:1px solid #ccc; border-radius:4px; }
    .pagination { display:flex; align-items:center; gap:.5rem; margin-top:1rem; }
    .pagination button { padding:.5rem; border:1px solid #ccc; border-radius:4px; background:#fff; }
    .pagination button:disabled { opacity:.5; cursor:not-allowed; }

    /* ------- è¡¨æ ¼æ ·å¼ ------- */
    table { width:100%; border-collapse:collapse; background:#fff; }
    th, td { padding:.75rem 1rem; border-bottom:1px solid #eee; text-align:left; }
    thead { background:#fafafa; }
    @media(max-width:768px){
      table { display:none; }
    }

    /* ------- å¡ç‰‡æ ·å¼ï¼ˆç§»åŠ¨ç«¯ï¼‰ ------- */
    .cards { display:none; }
    @media(max-width:768px){
      .cards { display:block; }
      .card { background:#fff; border-radius:6px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 4px rgba(0,0,0,.1); }
      .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
      .card-body { font-size:.9rem; color:#555; white-space:pre-wrap; }
    }

    /* ------- æŒ‰é’® & å›¾æ ‡ ------- */
    .icon-btn { background:none; border:none; padding:0; font-size:1.25rem; }
    .toolbar .icon-btn { position:absolute; left:8px; top:8px; }

    /* ------- å¼¹çª— ------- */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; }
    .modal { background:#fff; border-radius:6px; width:90%; max-width:400px; padding:1rem; box-shadow:0 2px 8px rgba(0,0,0,.2); }
    .modal-header { font-size:1.125rem; margin-bottom:.5rem; }
    .modal textarea { width:100%; height:120px; padding:.5rem; border:1px solid #ccc; border-radius:4px; resize:none; }
    .modal-actions { display:flex; justify-content:flex-end; gap:.5rem; margin-top:.75rem; }
    .btn { padding:.5rem .75rem; border-radius:4px; border:1px solid transparent; }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-secondary { background:#f5f5f5; color:#333; }
  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <script type="text/babel">
  const { useState, useEffect } = React;

  // æ›¿æ¢æˆä½ è‡ªå·±çš„åŸŸå
  const API_BASE = "https://oliverfr.com/admin-api/logs";

  function AdminDashboard() {
    const [logs,    setLogs]    = useState([]);
    const [loading, setLoading] = useState(false);
    const [search,  setSearch]  = useState("");
    const [page,    setPage]    = useState(1);
    const [pageSize,setPageSize]= useState(10);
    const [total,   setTotal]   = useState(0);
    const [editing, setEditing] = useState(null);
    const [noteDraft,setNoteDraft] = useState("");

    // æ‹‰å–åˆ—è¡¨
    const fetchLogs = async () => {
      setLoading(true);
      try {
        const params = new URLSearchParams({ q:search, page, pageSize });
        const res  = await fetch(`${API_BASE}?${params.toString()}`);
        const json = await res.json();
        setLogs(json.data);
        setTotal(json.total);
      } catch(e) {
        console.error(e);
      } finally {
        setLoading(false);
      }
    };

    useEffect(fetchLogs, [search, page, pageSize]);

    // åˆ é™¤
    const handleDelete = async (code) => {
      if (!confirm(`ç¡®å®šåˆ é™¤ "${code}"ï¼Ÿ`)) return;
      await fetch(`${API_BASE}/${encodeURIComponent(code)}`, { method:"DELETE" });
      fetchLogs();
    };

    // ä¿å­˜å¤‡æ³¨
    const handleSave = async () => {
      setLoading(true);
      await fetch(`${API_BASE}/${encodeURIComponent(editing.code)}`, {
        method:  "PATCH",
        headers: { "Content-Type":"application/json" },
        body:    JSON.stringify({ note: noteDraft })
      });
      setEditing(null);
      fetchLogs();
    };

    const totalPages = Math.max(1, Math.ceil(total / pageSize));

    return (
      <>
        {/* å·¥å…·æ  */}
        <div className="toolbar" style={{ position:"relative" }}>
          {/* æœç´¢å›¾æ ‡æ”¹ä¸º ğŸ” */}
          <button className="icon-btn" disabled>ğŸ”</button>
          <input
            style={{ paddingLeft:"2rem", width:"100%" }}
            placeholder="æœç´¢æˆæƒç æˆ–å¤‡æ³¨â€¦"
            value={search}
            onChange={e=>{ setPage(1); setSearch(e.target.value); }}
          />
          <select
            value={pageSize}
            onChange={e=>{ setPage(1); setPageSize(+e.target.value); }}
          >
            {[10,20,50].map(n=>(
              <option key={n} value={n}>{n} / é¡µ</option>
            ))}
          </select>
        </div>

        {/* æ¡Œé¢è¡¨æ ¼ */}
        <table>
          <thead>
            <tr>
              <th>æˆæƒç </th>
              <th>æœ€åä½¿ç”¨</th>
              <th>IP</th>
              <th>å¤‡æ³¨</th>
              <th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {loading ? (
              <tr>
                <td colSpan="5" style={{ textAlign:"center", padding:"1rem" }}>
                  åŠ è½½ä¸­â€¦
                </td>
              </tr>
            ) : logs.length === 0 ? (
              <tr>
                <td colSpan="5" style={{ textAlign:"center", padding:"1rem" }}>
                  æ— è®°å½•
                </td>
              </tr>
            ) : logs.map(log=>(
              <tr key={log.code}>
                <td>{log.code}</td>
                <td>{log.last_used_at||"â€”"}</td>
                <td>{log.ip||"â€”"}</td>
                <td style={{ whiteSpace:"pre-wrap" }}>{log.note||"â€”"}</td>
                <td>
                  {/* ç¼–è¾‘å›¾æ ‡æ”¹ä¸º âœï¸ */}
                  <button className="icon-btn" title="ç¼–è¾‘"
                    onClick={()=>{ setEditing(log); setNoteDraft(log.note||""); }}
                  >âœï¸</button>
                  {/* åˆ é™¤å›¾æ ‡æ”¹ä¸º ğŸ—‘ */}
                  <button className="icon-btn" title="åˆ é™¤"
                    onClick={()=>handleDelete(log.code)}
                  >ğŸ—‘</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>

        {/* ç§»åŠ¨å¡ç‰‡ */}
        <div className="cards">
          {loading ? (
            <div style={{ textAlign:"center", padding:"1rem" }}>åŠ è½½ä¸­â€¦</div>
          ) : logs.length === 0 ? (
            <div style={{ textAlign:"center", padding:"1rem" }}>æ— è®°å½•</div>
          ) : logs.map(log=>(
            <div className="card" key={log.code}>
              <div className="card-header">
                <strong>{log.code}</strong>
                <div>
                  <button className="icon-btn"
                    onClick={()=>{ setEditing(log); setNoteDraft(log.note||""); }}
                  >âœï¸</button>
                  <button className="icon-btn"
                    onClick={()=>handleDelete(log.code)}
                  >ğŸ—‘</button>
                </div>
              </div>
              <div className="card-body">
                <div>æœ€åä½¿ç”¨ï¼š{log.last_used_at||"â€”"}</div>
                <div>IPï¼š{log.ip||"â€”"}</div>
                <div>{log.note||"â€”"}</div>
              </div>
            </div>
          ))}
        </div>

        {/* ç¿»é¡µæ§åˆ¶ï¼šç®­å¤´æ”¹ä¸º â—€ï¸ â–¶ï¸ */}
        <div className="pagination">
          <button disabled={page<=1} onClick={()=>setPage(p=>p-1)}>â—€ï¸</button>
          <span>ç¬¬ {page} / {totalPages} é¡µ</span>
          <button disabled={page>=totalPages} onClick={()=>setPage(p=>p+1)}>â–¶ï¸</button>
        </div>

        {/* ç¼–è¾‘å¼¹çª— */}
        {editing && (
          <div className="modal-backdrop">
            <div className="modal">
              <div className="modal-header">ç¼–è¾‘å¤‡æ³¨ â€” {editing.code}</div>
              <textarea
                value={noteDraft}
                onChange={e=>setNoteDraft(e.target.value)}
              />
              <div className="modal-actions">
                <button className="btn btn-secondary"
                  onClick={()=>setEditing(null)}
                >å–æ¶ˆ</button>
                <button className="btn btn-primary" onClick={handleSave}>
                  ä¿å­˜
                </button>
              </div>
            </div>
          </div>
        )}
      </>
    );
  }

  ReactDOM.createRoot(document.getElementById("root"))
           .render(<AdminDashboard />);
  </script>
</body>
</html>
