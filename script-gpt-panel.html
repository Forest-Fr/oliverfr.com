<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ç®¡ç†åå° â€” æˆæƒç æ—¥å¿—</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <style>
    /* â€”â€” å…¨å±€ â€”â€” */
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family:Arial,sans-serif; background:#f0f2f5; color:#333; }
    .container { max-width:1200px; margin:1rem auto; padding:1rem; }

    /* â€”â€” å·¥å…·æ  â€”â€” */
    .toolbar { display:flex; flex-wrap:wrap; gap:1rem; margin-bottom:1rem; }
    .toolbar .search { position:relative; flex:1; }
    .toolbar .search span { position:absolute; left:8px; top:8px; font-size:1.2rem; color:#888; }
    .toolbar .search input { width:100%; padding:.5rem .75rem .5rem 2.5rem; border:1px solid #ccc; border-radius:4px; }
    .toolbar select { padding:.5rem .75rem; border:1px solid #ccc; border-radius:4px; }

    /* â€”â€” æ¡Œé¢è¡¨æ ¼ â€”â€” */
    .table-wrapper { overflow-x:auto; background:#fff; border-radius:4px; }
    table { width:100%; border-collapse:collapse; min-width:1000px; }
    thead { background:#fafafa; }
    th, td { padding:.75rem 1rem; border-bottom:1px solid #eee; text-align:left; vertical-align:top; }
    th { white-space:nowrap; }
    td.code-cell { font-family:Consolas,monospace; font-size:.85rem; max-width:240px; }
    td.code-cell div { overflow-x:auto; max-height:6em; line-height:1.4; }
    td.actions button { margin-right:.5rem; }

    @media(max-width:768px){
      .table-wrapper { display:none; }
    }

    /* â€”â€” ç§»åŠ¨å¡ç‰‡ â€”â€” */
    .cards { display:none; }
    @media(max-width:768px){
      .cards { display:block; }
      .card { background:#fff; border-radius:6px; padding:1rem; margin-bottom:1rem; box-shadow:0 1px 4px rgba(0,0,0,.1); }
      .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:.5rem; }
      .card-body { font-size:.9rem; color:#555; white-space:pre-wrap; margin-bottom:.5rem; }
      .card-body .code-preview { font-family:Consolas,monospace; font-size:.8rem; max-height:4em; overflow-y:auto; background:#f9f9f9; padding:.5rem; border-radius:4px; }
      .card-footer { text-align:right; }
      .card-footer button { margin-left:.5rem; }
    }

    /* â€”â€” åˆ†é¡µ â€”â€” */
    .pagination { display:flex; align-items:center; gap:.5rem; margin-top:1rem; }
    .pagination button { padding:.5rem; border:1px solid #ccc; border-radius:4px; background:#fff; }
    .pagination button:disabled { opacity:.5; cursor:not-allowed; }

    /* â€”â€” å¼¹çª— â€”â€” */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:flex; align-items:center; justify-content:center; z-index:1000; }
    .modal { background:#fff; border-radius:6px; width:90%; max-width:600px; max-height:90vh; overflow:hidden; display:flex; flex-direction:column; }
    .modal-header { padding:1rem; font-size:1.125rem; border-bottom:1px solid #eee; display:flex; justify-content:space-between; }
    .modal-body { padding:1rem; overflow:auto; font-family:Consolas,monospace; font-size:.85rem; line-height:1.4; background:#f5f5f5; flex:1; }
    .modal-footer { padding:1rem; border-top:1px solid #eee; text-align:right; }
    .btn { padding:.5rem .75rem; border-radius:4px; border:1px solid transparent; cursor:pointer; }
    .btn-primary { background:#1976d2; color:#fff; }
    .btn-secondary { background:#f5f5f5; color:#333; }

/* â€”â€” æˆæƒç å¼¹çª— â€”â€” */
.auth-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 2000;
}
.auth-modal {
  background: #fff;
  border-radius: 8px;
  padding: 2rem;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  text-align: center;
}
.auth-modal h2 {
  margin-bottom: 1rem;
  font-size: 1.5rem;
}
.auth-modal p {
  margin-bottom: 1.5rem;
  color: #666;
  font-size: 0.95rem;
}
.auth-modal .input-group {
  position: relative;
  margin-bottom: 1.5rem;
}
.auth-modal .input-group input {
  width: 100%;
  padding: 0.75rem 2.5rem 0.75rem 0.75rem;
  border: 1px solid #ccc;
  border-radius: 4px;
  font-size: 1rem;
}
.auth-modal .input-group .toggle-eye {
  position: absolute;
  right: 0.75rem;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  cursor: pointer;
  font-size: 1.2rem;
  color: #888;
}
.auth-modal .btn-confirm {
  padding: 0.75rem 1.5rem;
  border: none;
  border-radius: 4px;
  background: #1976d2;
  color: white;
  font-size: 1rem;
  cursor: pointer;
}
.auth-modal .error {
  margin-top: 1rem;
  color: #d9534f;
  font-size: 0.9rem;
}


/* â€”â€” æ‰‹æœºç«¯ï¼ˆâ‰¤768pxï¼‰å¼¹çª—â€”â€” */
@media (max-width: 768px) {
  .auth-modal {
    padding: 1.5rem;
    width: 95%;
    max-width: none;
    border-radius: 6px;
  }
  .auth-modal h2 {
    font-size: 1.25rem;
  }
  .auth-modal p {
    font-size: 0.9rem;
  }
  .auth-modal .input-group input {
    padding: 0.5rem 2.25rem 0.5rem 0.5rem;
    font-size: 0.95rem;
  }
  .auth-modal .input-group .toggle-eye {
    right: 0.5rem;
    font-size: 1.1rem;
  }
  .auth-modal .btn-confirm {
    width: 100%;
    padding: 0.65rem;
    font-size: 1rem;
  }
  .auth-modal .error {
    font-size: 0.85rem;
  }
}

  </style>
</head>
<body>
  <div id="root" class="container"></div>

  <!-- React / ReactDOM -->
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

 <script type="text/babel">
  const { useState, useEffect } = React;
  const API_BASE = "https://oliverfr.com/admin-api/logs";

  // â€”â€” åŸå°ä¸åŠ¨ â€”â€” ä½ çš„ AdminDashboard é€»è¾‘
  function AdminDashboard({ auth }) {
    const [logs, setLogs]           = useState([]);
    const [loading, setLoading]     = useState(false);
    const [search, setSearch]       = useState("");
    const [page, setPage]           = useState(1);
    const [pageSize, setPageSize]   = useState(10);
    const [total, setTotal]         = useState(0);
    const [editing, setEditing]     = useState(null);
    const [noteDraft, setNoteDraft] = useState("");
    const [preview, setPreview]     = useState({ open:false, code:"" });

    // æ‹‰åˆ—è¡¨ï¼ˆåŠ ä¸Š Authorization å¤´ï¼‰
    useEffect(() => {
      async function load() {
        setLoading(true);
        try {
          const params = new URLSearchParams({ q:search, page, pageSize });
          const res = await fetch(`${API_BASE}?${params.toString()}`, {
            headers: { "Authorization": `Bearer ${auth}` }
          });
          if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
          const { data, total } = await res.json();
          setLogs(data);
          setTotal(total);
        } catch(err) {
          console.error("æ‹‰æ—¥å¿—å¤±è´¥ï¼š", err);
        } finally {
          setLoading(false);
        }
      }
      load();
    }, [auth, search, page, pageSize]);

    // åŒ—äº¬æ—¶é—´æ ¼å¼åŒ–
    const fmtTime = ts => ts
      ? new Intl.DateTimeFormat("zh-CN", {
          year:"numeric",month:"2-digit",day:"2-digit",
          hour:"2-digit",minute:"2-digit",second:"2-digit",
          hour12:false, timeZone:"Asia/Shanghai"
        }).format(new Date(ts))
      : "â€”";

    // åˆ é™¤
    const handleDelete = async code => {
      if (!confirm(`ç¡®å®šåˆ é™¤ "${code}"ï¼Ÿ`)) return;
      await fetch(`${API_BASE}/${encodeURIComponent(code)}`, {
        method:"DELETE",
        headers: { "Authorization": `Bearer ${auth}` }
      });
      setPage(1);
    };

    // ä¿å­˜å¤‡æ³¨
    const handleSave = async () => {
      if (!editing) return;
      setLoading(true);
      await fetch(`${API_BASE}/${encodeURIComponent(editing.code)}`, {
        method:"PATCH",
        headers:{
          "Content-Type":"application/json",
          "Authorization": `Bearer ${auth}`
        },
        body: JSON.stringify({ note:noteDraft })
      });
      setEditing(null);
      setPage(1);
    };

    const totalPages = Math.max(1, Math.ceil(total/pageSize));

    return <>
      {/* å·¥å…·æ  */}
      <div className="toolbar">
        <div className="search">
          <span>ğŸ”</span>
          <input
            placeholder="æœç´¢æˆæƒç æˆ–å¤‡æ³¨â€¦"
            value={search}
            onChange={e=>{ setPage(1); setSearch(e.target.value); }}
          />
        </div>
        <select value={pageSize} onChange={e=>{ setPage(1); setPageSize(+e.target.value); }}>
          {[10,20,50].map(n=> <option key={n} value={n}>{n} / é¡µ</option>)}
        </select>
      </div>

      {/* æ¡Œé¢è¡¨æ ¼ */}
      <div className="table-wrapper">
        <table>
          <thead>
            <tr>
              <th>æˆæƒç </th><th>ä½¿ç”¨æ—¶é—´</th><th>IP</th><th>Prompt</th>
              <th>Tokens (in/com/total)</th><th>Cost (USD)</th><th>å¤‡æ³¨</th>
              <th>å®Œæ•´ä»£ç </th><th>æ“ä½œ</th>
            </tr>
          </thead>
          <tbody>
            {loading
              ? <tr><td colSpan="9" style={{textAlign:"center",padding:"1rem"}}>åŠ è½½ä¸­â€¦</td></tr>
              : logs.length===0
                ? <tr><td colSpan="9" style={{textAlign:"center",padding:"1rem"}}>æ— è®°å½•</td></tr>
                : logs.map(log=>(
                  <tr key={log.id||log.code}>
                    <td>{log.code}</td>
                    <td>{fmtTime(log.timestamp||log.last_used_at)}</td>
                    <td>{log.ip||"â€”"}</td>
                    <td style={{whiteSpace:"pre-wrap",maxWidth:"120px"}}>{log.prompt||"â€”"}</td>
                    <td>{`${log.prompt_tokens||"â€”"}/${log.completion_tokens||"â€”"}/${log.total_tokens||"â€”"}`}</td>
                    <td>{log.cost_usd!=null?log.cost_usd.toFixed(6):"â€”"}</td>
                    <td style={{whiteSpace:"pre-wrap"}}>{log.note||"â€”"}</td>
                    <td className="code-cell">
                      <div>
                        {log.full_code || log.resultHtml || "â€”"}
                      </div>
                      {log.full_code &&
                        <button className="btn btn-secondary"
                          onClick={()=>setPreview({open:true,code:log.full_code})}
                        >é¢„è§ˆ</button>}
                    </td>
                    <td className="actions">
                      <button className="btn btn-secondary"
                        onClick={()=>{ setEditing(log); setNoteDraft(log.note||""); }}
                      >âœï¸</button>
                      <button className="btn btn-secondary"
                        onClick={()=>handleDelete(log.code)}
                      >ğŸ—‘ï¸</button>
                    </td>
                  </tr>
                ))
            }
          </tbody>
        </table>
      </div>

      {/* ç§»åŠ¨å¡ç‰‡ */}
      <div className="cards">
        {loading
          ? <div style={{textAlign:"center",padding:"1rem"}}>åŠ è½½ä¸­â€¦</div>
          : logs.length===0
            ? <div style={{textAlign:"center",padding:"1rem"}}>æ— è®°å½•</div>
            : logs.map(log=>(
              <div className="card" key={log.id||log.code}>
                <div className="card-header">
                  <strong>{log.code}</strong>
                  <div>
                    <button onClick={()=>{ setEditing(log); setNoteDraft(log.note||""); }}>âœï¸</button>
                    <button onClick={()=>handleDelete(log.code)}>ğŸ—‘ï¸</button>
                  </div>
                </div>
                <div className="card-body">
                  <div>ä½¿ç”¨ï¼š{fmtTime(log.timestamp||log.last_used_at)}</div>
                  <div>IPï¼š{log.ip||"â€”"}</div>
                  <div>Promptï¼š{log.prompt||"â€”"}</div>
                  <div>Tokensï¼š{`${log.prompt_tokens||"â€”"}/${log.completion_tokens||"â€”"}/${log.total_tokens||"â€”"}`}</div>
                  <div>Costï¼š{log.cost_usd!=null?log.cost_usd.toFixed(6):"â€”"}</div>
                  <div>å¤‡æ³¨ï¼š{log.note||"â€”"}</div>
                  {log.full_code &&
                    <div className="card-footer">
                      <button className="btn btn-secondary"
                        onClick={()=>setPreview({open:true,code:log.full_code})}
                      >æŸ¥çœ‹ä»£ç </button>
                    </div>}
                </div>
              </div>
            ))
        }
      </div>

      {/* åˆ†é¡µ */}
      <div className="pagination">
        <button disabled={page<=1} onClick={()=>setPage(p=>p-1)}>â—€ï¸</button>
        <span>ç¬¬ {page} / {totalPages} é¡µ</span>
        <button disabled={page>=totalPages} onClick={()=>setPage(p=>p+1)}>â–¶ï¸</button>
      </div>

      {/* ç¼–è¾‘å¤‡æ³¨å¼¹çª— */}
      {editing && (
        <div className="modal-backdrop">
          <div className="modal">
            <div className="modal-header">
              ç¼–è¾‘å¤‡æ³¨ â€” {editing.code}
              <button className="btn btn-secondary" onClick={()=>setEditing(null)}>âœ•</button>
            </div>
            <div style={{padding:"1rem"}}>
              <textarea
                style={{width:"100%",height:"120px",padding:".5rem",border:"1px solid #ccc",borderRadius:"4px"}}
                value={noteDraft}
                onChange={e=>setNoteDraft(e.target.value)}
              />
            </div>
            <div className="modal-footer">
              <button className="btn btn-secondary" onClick={()=>setEditing(null)}>å–æ¶ˆ</button>
              <button className="btn btn-primary" onClick={handleSave}>ä¿å­˜</button>
            </div>
          </div>
        </div>
      )}

      {/* ä»£ç é¢„è§ˆå¼¹çª— */}
      {preview.open && (
        <div className="modal-backdrop">
          <div className="modal">
            <div className="modal-header">
              å®Œæ•´ä»£ç é¢„è§ˆ
              <button className="btn btn-secondary" onClick={()=>setPreview({open:false,code:""})}>âœ•</button>
            </div>
            <div className="modal-body">
              <pre style={{whiteSpace:"pre-wrap"}}>{preview.code}</pre>
            </div>
            <div className="modal-footer">
              <button className="btn btn-primary" onClick={()=>{navigator.clipboard.writeText(preview.code).then(()=>alert("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿"));}}>å¤åˆ¶</button>
            </div>
          </div>
        </div>
      )}
    </>;

  }

  // â€”â€” æ–°å¢ï¼šæˆæƒå¼¹çª—ç»„ä»¶ â€”â€” 
  function AuthModal({ onConfirm, error }) {
    const [code, setCode] = useState("");
    const [show, setShow] = useState(false);
    return (
      <div className="auth-backdrop">
        <div className="auth-modal">
          <h2>è¯·è¾“å…¥æˆæƒç </h2>
          <p>åªæœ‰é€šè¿‡æˆæƒåï¼Œæ‰èƒ½æŸ¥çœ‹æ­¤åå°å†…å®¹ã€‚</p>
          <div className="input-group">
            <input
              type={show ? "text" : "password"}
              value={code}
              onChange={e => setCode(e.target.value)}
              placeholder="æˆæƒç "
            />
            <button className="toggle-eye" onClick={() => setShow(s => !s)}>
              {show ? "ğŸ™ˆ" : "ğŸ‘ï¸"}
            </button>
          </div>
          <button className="btn-confirm" onClick={() => onConfirm(code)}>ç¡®è®¤</button>
          {error && <div className="error">{error}</div>}
        </div>
      </div>
    );
  }

  // â€”â€” æ–°å¢ï¼šæœ€å¤–å±‚ Main å…¥å£ â€”â€” 
  function Main() {
    const [authCode, setAuthCode] = useState(sessionStorage.getItem("authCode")||"");
    const [error, setError] = useState("");
    const [validated, setValidated] = useState(false);

    // éªŒè¯å‡½æ•°ï¼šå°è¯•æ‹‰ä¸€æ¬¡æ•°æ®
    const validate = async code => {
      try {
        const res = await fetch(`${API_BASE}?page=1&pageSize=1`, {
          headers: { "Authorization": `Bearer ${code}` }
        });
        if (!res.ok) throw new Error();
        sessionStorage.setItem("authCode", code);
        setValidated(true);
      } catch {
        setError("æˆæƒç æ— æ•ˆï¼Œè¯·é‡è¯•");
        sessionStorage.removeItem("authCode");
      }
    };

    if (!validated) {
      return <AuthModal onConfirm={validate} error={error} />;
    }
    return <AdminDashboard auth={authCode} />;
  }

  // â€”â€” æ¸²æŸ“ Main è€Œä¸æ˜¯ç›´æ¥ AdminDashboard â€”â€” 


  </script>
</body>
</html>
