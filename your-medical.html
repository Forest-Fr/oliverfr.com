<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>医疗 Copilot</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <style>
    body { margin:0; padding:0; font-family:sans-serif; background:#f0f2f5; display:flex; flex-direction:column; height:100vh; }
    .chat-container { flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
    .bubble { max-width:70%; padding:12px; border-radius:8px; word-break:break-word; }
    .patient { background:#e6f7ff; align-self:flex-start; }
    .assistant { background:#f6ffed; align-self:flex-end; }
    .loading { opacity:0.6; }
    .controls, .extra-controls { padding:12px; background:#fff; border-top:1px solid #ddd; display:flex; flex-wrap:wrap; gap:8px; }
    textarea { flex:1 1 100%; height:60px; padding:8px; border:1px solid #ccc; border-radius:4px; resize:none; }
    input[type=file] { flex:1; }
    video { display:none; width:200px; height:150px; border:1px solid #ccc; border-radius:4px; }
    canvas { display:none; }
    button { padding:10px; border:none; border-radius:4px; font-size:14px; cursor:pointer; }
    button:hover { opacity:0.9; }
    #btnListen { background:#1890ff; color:#fff; }
    #btnDiagnose { background:#52c41a; color:#fff; }
    #btnAddText { background:#722ed1; color:#fff; }
    #btnOpenCam, #btnSnap { background:#fa8c16; color:#fff; }
  </style>
</head>
<body>

  <div class="chat-container" id="chat"></div>

  <div class="controls">
    <button id="btnListen">开始录音</button>
    <button id="btnDiagnose">获取诊断建议</button>
  </div>

  <div class="extra-controls">
    <textarea id="manualText" placeholder="手动输入患者描述…"></textarea>
    <button id="btnAddText">添加描述</button>
    <input type="file" id="imgUpload" accept="image/*"/>
    <button id="btnOpenCam">打开摄像头</button>
    <button id="btnSnap">拍照识别</button>
    <video id="videoPreview" autoplay muted></video>
    <canvas id="camCanvas"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <script>
  (function(){
    const WORKER_ENDPOINT = 'https://admin-your-medical.mefans.workers.dev/api/medical-diagnosis';

    const chatEl     = document.getElementById('chat');
    const btnListen  = document.getElementById('btnListen');
    const btnAddText = document.getElementById('btnAddText');
    const manualText = document.getElementById('manualText');
    const imgUpload  = document.getElementById('imgUpload');
    const btnOpenCam = document.getElementById('btnOpenCam');
    const btnSnap    = document.getElementById('btnSnap');
    const btnDiagnose= document.getElementById('btnDiagnose');
    const video      = document.getElementById('videoPreview');
    const canvas     = document.getElementById('camCanvas');

    let stream=null, listening=false, recognition=null;
    const messages=[];

    function appendMessage(role, text, loading=false) {
      const div = document.createElement('div');
      div.className = 'bubble '+role+(loading?' loading':'');
      div.textContent = loading?(role==='assistant'?'诊断中…':text):text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
      messages.push({role,text,el:div});
      return messages[messages.length-1];
    }

    // 语音识别
    const SpeechRecognition = window.SpeechRecognition||window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      recognition=new SpeechRecognition();
      recognition.lang='zh-CN';
      recognition.continuous=true;
      recognition.onresult=e=>{
        const text=Array.from(e.results)
          .slice(e.resultIndex)
          .map(r=>r[0].transcript)
          .join('');
        appendMessage('patient',text);
      };
    }
    btnListen.addEventListener('click',()=>{
      if(!recognition) return alert('浏览器不支持语音识别');
      listening=!listening;
      btnListen.textContent=listening?'停止录音':'开始录音';
      listening?recognition.start():recognition.stop();
    });

    // 手动输入
    btnAddText.addEventListener('click',()=>{
      const text=manualText.value.trim();
      if(!text) return;
      appendMessage('patient',text);
      manualText.value='';
    });

    // 本地OCR
    imgUpload.addEventListener('change',async()=>{
      const file=imgUpload.files[0]; if(!file) return;
      appendMessage('patient','正在识别本地图像…',true);
      const {data:{text}}=await Tesseract.recognize(file,'chi_sim');
      const last=messages.pop(); chatEl.removeChild(last.el);
      appendMessage('patient',text);
      imgUpload.value='';
    });

    // 摄像头打开/关
    btnOpenCam.addEventListener('click',async()=>{
      if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream=null; video.style.display='none'; btnOpenCam.textContent='打开摄像头';
      } else {
        try{
          stream=await navigator.mediaDevices.getUserMedia({video:true});
          video.srcObject=stream; video.style.display='block'; btnOpenCam.textContent='关闭摄像头';
        }catch(e){alert('无法访问摄像头：'+e.message);}
      }
    });

    // 拍照OCR
    btnSnap.addEventListener('click',async()=>{
      if(!stream) return alert('请先打开摄像头');
      canvas.width=video.videoWidth; canvas.height=video.videoHeight;
      canvas.getContext('2d').drawImage(video,0,0);
      appendMessage('patient','正在识别拍照图像…',true);
      canvas.toBlob(async blob=>{
        const {data:{text}}=await Tesseract.recognize(blob,'chi_sim');
        const last=messages.pop(); chatEl.removeChild(last.el);
        appendMessage('patient',text);
      },'image/png');
    });

   // 获取诊断建议
btnDiagnose.addEventListener('click', async () => {
  const transcript = messages
    .filter(m => m.role === 'patient')
    .map(m => m.text)
    .join('\n');
  if (!transcript) return alert('请先输入患者描述');

  const code = prompt('请输入 13 位授权码');
  if (!code) return;

  // loading 占位
  const placeholder = appendMessage('assistant', '', true);

  // 请求 Worker
  const resp = await fetch(WORKER_ENDPOINT, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ code, transcript })
  });

  if (resp.status === 401) {
    placeholder.el.textContent = '授权失败，请检查授权码';
    placeholder.el.classList.remove('loading');
    return;
  }
  if (!resp.ok) {
    placeholder.el.textContent = `错误 ${resp.status}`;
    placeholder.el.classList.remove('loading');
    return;
  }

  // —— 新：按行解析 SSE —— 
  const reader = resp.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';
  while (true) {
    const { value, done } = await reader.read();
    if (done) break;
    // 累积文本
    buffer += decoder.decode(value, { stream: true });
    // 拆行
    const lines = buffer.split('\n');
    // 保留最后一行（可能不完整）
    buffer = lines.pop();
    for (let line of lines) {
      line = line.trim();
      if (!line.startsWith('data:')) continue;
      const payload = line.slice(5).trim();
      if (payload === '[DONE]') {
        // 完成
        reader.cancel();
        return;
      }
      try {
        const parsed = JSON.parse(payload);
        const delta = parsed.choices?.[0]?.delta?.content;
        if (delta) {
          placeholder.el.textContent += delta;
          placeholder.el.classList.remove('loading');
          chatEl.scrollTop = chatEl.scrollHeight;
        }
      } catch (e) {
        console.warn('无法解析 SSE 行：', line, e);
      }
    }
  }
  // —— 解析结束 —— 
});


    // 欢迎
    appendMessage('assistant','欢迎使用医疗 Copilot，可语音、手动、上传或拍照描述病情。');

  })();
  </script>

</body>
</html>
