<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>医疗 Copilot</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
  <style>
    body { margin:0; padding:0; font-family:sans-serif; background:#f0f2f5; display:flex; flex-direction:column; height:100vh; }
    .chat-container { flex:1; overflow:auto; padding:16px; display:flex; flex-direction:column; gap:8px; }
    .bubble { max-width:70%; padding:12px; border-radius:8px; word-break:break-word; }
    .patient { background:#e6f7ff; align-self:flex-start; }
    .assistant { background:#f6ffed; align-self:flex-end; }
    .loading { opacity:0.6; }
    .controls, .extra-controls { padding:12px; background:#fff; border-top:1px solid #ddd; display:flex; flex-wrap:wrap; gap:8px; }
    textarea { flex:1 1 100%; height:60px; padding:8px; border:1px solid #ccc; border-radius:4px; resize:none; }
    input[type=file] { flex:1; }
    video { display:none; width:200px; height:150px; border:1px solid #ccc; border-radius:4px; }
    canvas { display:none; }
    button { padding:10px; border:none; border-radius:4px; font-size:14px; cursor:pointer; }
    button:hover { opacity:0.9; }
    #btnListen { background:#1890ff; color:#fff; }
    #btnDiagnose { background:#52c41a; color:#fff; }
    #btnAddText { background:#722ed1; color:#fff; }
    #btnOpenCam, #btnSnap { background:#fa8c16; color:#fff; }
  </style>
</head>
<body>

  <div class="chat-container" id="chat"></div>

  <div class="controls">
    <button id="btnListen">开始录音</button>
    <button id="btnDiagnose">获取诊断建议</button>
  </div>

  <div class="extra-controls">
    <textarea id="manualText" placeholder="手动输入患者描述…"></textarea>
    <button id="btnAddText">添加描述</button>
    <input type="file" id="imgUpload" accept="image/*"/>
    <button id="btnOpenCam">打开摄像头</button>
    <button id="btnSnap">拍照识别</button>
    <video id="videoPreview" autoplay muted></video>
    <canvas id="camCanvas"></canvas>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
  <script>
 (function () {
  /* ---------- 1. 配置 ---------- */
 const WORKER_ENDPOINT = '/api/medical-diagnosis';   // 仅路径
  /* ---------- 2. DOM / 状态 ---------- */
  const $ = id => document.getElementById(id);
  const chatEl      = $('chat');
  const btnListen   = $('btnListen');
  const btnDiagnose = $('btnDiagnose');
  const btnAddText  = $('btnAddText');
  const manualText  = $('manualText');
  const imgUpload   = $('imgUpload');
  const btnOpenCam  = $('btnOpenCam');
  const btnSnap     = $('btnSnap');
  const video       = $('videoPreview');
  const canvas      = $('camCanvas');

  let stream = null,
      listening = false,
      recognition = null;
  const messages = [];          // { role, text, el }

  /* ---------- 3. 渲染气泡 ---------- */
  function appendMessage (role, text, loading = false) {
    const div = document.createElement('div');
    div.className = `bubble ${role}${loading ? ' loading' : ''}`;
    div.innerHTML = loading && role === 'assistant' ? '诊断中…' : text;
    chatEl.appendChild(div);
    chatEl.scrollTop = chatEl.scrollHeight;
    const msg = { role, text, el: div };
    messages.push(msg);
    return msg;
  }

  /* ---------- 4. 语音 ---------- */
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  if (SR) {
    recognition = new SR();
    recognition.lang = 'zh-CN';
    recognition.continuous = true;
    recognition.onresult = e => {
      const txt = Array.from(e.results).slice(e.resultIndex).map(r => r[0].transcript).join('');
      appendMessage('patient', txt);
    };
  }
  btnListen.onclick = () => {
    if (!recognition) return alert('浏览器不支持语音识别');
    listening = !listening;
    btnListen.textContent = listening ? '停止录音' : '开始录音';
    listening ? recognition.start() : recognition.stop();
  };

  /* ---------- 5. 手动输入 ---------- */
  btnAddText.onclick = () => {
    const txt = manualText.value.trim();
    if (txt) appendMessage('patient', txt);
    manualText.value = '';
  };

  /* ---------- 6. OCR（文件 & 摄像头） ---------- */
  imgUpload.onchange = async () => {
    const f = imgUpload.files[0];
    if (!f) return;
    const holder = appendMessage('patient', '正在识别本地图像…', true);
    const { data: { text } } = await Tesseract.recognize(f, 'chi_sim');
    holder.el.remove();
    appendMessage('patient', text);
    imgUpload.value = '';
  };

  btnOpenCam.onclick = async () => {
    if (stream) {                            // 关闭
      stream.getTracks().forEach(t => t.stop());
      stream = null;
      video.style.display = 'none';
      btnOpenCam.textContent = '打开摄像头';
      return;
    }
    try {
      stream = await navigator.mediaDevices.getUserMedia({ video: true });
      video.srcObject = stream;
      video.style.display = 'block';
      btnOpenCam.textContent = '关闭摄像头';
    } catch (e) {
      alert('无法访问摄像头：' + e.message);
    }
  };

  btnSnap.onclick = async () => {
    if (!stream) return alert('请先打开摄像头');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const holder = appendMessage('patient', '正在识别拍照图像…', true);
    canvas.toBlob(async blob => {
      const { data: { text } } = await Tesseract.recognize(blob, 'chi_sim');
      holder.el.remove();
      appendMessage('patient', text);
    }, 'image/png');
  };

  /* ---------- 7. 文本后处理（格式化） ---------- */
  function formatDiagnosis (raw) {
    return raw
      .replace(/\r\n/g, '\n')                 // 统一换行
      .replace(/(?:^|\n)\s*(\d+)[\.\、]/g, '\n<strong>$1.</strong> ') // 数字序号
      .replace(/(?:^|\n)[①②③④⑤⑥⑦⑧⑨]/g, m => '\n<strong>' + m.trim() + '</strong> ')
      .replace(/\n/g, '<br/>');
  }

  /* ---------- 8. 获取诊断 ---------- */
  btnDiagnose.onclick = async () => {
    const transcript = messages.filter(m => m.role === 'patient').map(m => m.text).join('\n');
    if (!transcript) return alert('请先输入患者描述');

    const code = prompt('请输入 13 位授权码');
    if (!code) return;

    const place = appendMessage('assistant', '', true);

    const resp = await fetch(`${WORKER_ENDPOINT}/api/medical-diagnosis`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ code, transcript })
    });

    if (resp.status === 401) { place.el.textContent = '授权失败，请检查授权码'; return; }
    if (!resp.ok)            { place.el.textContent = `错误 ${resp.status}`;   return; }

    const reader  = resp.body.getReader();
    const decoder = new TextDecoder('utf-8');
    let full = '', buf = '', lastTick = Date.now();

    while (true) {
      const { value, done } = await reader.read();
      if (done) break;
      buf += decoder.decode(value, { stream: true });

      // 超时保护（8 秒无新 token 认为结束，避免网络抖动卡死）
      if (Date.now() - lastTick > 8000) break;
      lastTick = Date.now();

      // 拆分成事件块
      const pieces = buf.split('\n\n');
      buf = pieces.pop();   // 留可能未完整的尾巴

      for (const p of pieces) {
        const m = p.match(/^data:\s*(.*)$/m);
        if (!m) continue;
        if (m[1] === '[DONE]') continue;
        full += m[1];
      }
    }

    // 渲染
    place.el.classList.remove('loading');
    place.el.innerHTML = formatDiagnosis(full);
    chatEl.scrollTop = chatEl.scrollHeight;
  };

  /* ---------- 9. 欢迎 ---------- */
  appendMessage('assistant', '欢迎使用医疗 Copilot，可语音、手动、上传或拍照描述病情。');
})();
  </script>

</body>
</html>
