<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>医疗 Copilot</title>
<link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>

<style>
:root{--bg:#f0f2f5;--patient:#e6f7ff;--assistant:#f6ffed;
      --primary:#1890ff;--success:#52c41a;--purple:#722ed1;--orange:#fa8c16}
*{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto}
body{background:var(--bg);display:flex;min-height:100vh;flex-direction:column}
.app{flex:1;display:flex;overflow:hidden}

/* ---------- 侧栏 ---------- */
.sidebar{position:fixed;top:0;bottom:0;left:0;width:220px;background:#fff;
  border-right:1px solid #ddd;overflow:auto;transition:transform .3s ease;z-index:999}
.sidebar h3{margin:12px 0 8px;padding-left:48px;font-size:15px;color:#666;font-weight:600}
#toc section{border-bottom:1px solid #eee;padding-bottom:4px;margin-bottom:6px}
#toc a{display:block;padding:6px 12px 6px 36px;font-size:13px;color:#555;text-decoration:none}
#toc a:hover{background:#f5f5f5}
#btnCloseSidebar{position:absolute;top:10px;right:10px;width:28px;height:28px;border:none;
  display:flex;align-items:center;justify-content:center;
  border-radius:50%;background:#fff;color:#444;font-size:18px;cursor:pointer;
  box-shadow:0 0 4px rgba(0,0,0,.25)}
#btnCloseSidebar:hover{background:#eee;color:#000}

/* ---------- 主区 ---------- */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden}
.chat-container{flex:1;overflow:auto;padding:16px;display:flex;flex-direction:column;gap:8px}
.bubble{max-width:70%;padding:12px;border-radius:8px;word-break:break-word}
.bubble ul{padding-left:1.2em;margin:.4em 0}          /* 黑点不再跑出去 */
.bubble li{list-style-position:inside}
.patient{background:var(--patient);align-self:flex-start}
.assistant{background:var(--assistant);align-self:flex-end}
.loading{opacity:.6}

.controls,.extra-controls{padding:12px;background:#fff;border-top:1px solid #ddd;display:flex;flex-wrap:wrap;gap:8px}
textarea{flex:1 1 100%;height:60px;padding:8px;border:1px solid #ccc;border-radius:4px;resize:none}
input[type=file]{flex:1}
video{display:none;width:200px;height:150px;border:1px solid #ccc;border-radius:4px}
canvas{display:none}
button{padding:10px;border:none;border-radius:4px;font-size:14px;cursor:pointer}
button:hover{opacity:.9}

/* 按钮配色 */
#btnListen{background:var(--primary);color:#fff}
#btnDiagnose{background:var(--success);color:#fff}
#btnAddText{background:var(--purple);color:#fff}
#btnOpenCam,#btnSnap{background:var(--orange);color:#fff}
#btnToggleView{background:#13c2c2;color:#fff}
#btnCopy{background:#2f54eb;color:#fff}
#btnPDF{background:#fa541c;color:#fff}
#btnRead{background:#d46b08;color:#fff}

.retry-btn{margin-left:8px;padding:2px 8px;font-size:12px;border-radius:4px;border:none;background:#1890ff;color:#fff;cursor:pointer}

/* 汉堡 / overlay */
#btnMenu{position:fixed;top:8px;left:8px;background:#555;color:#fff;border-radius:4px;
  padding:6px 10px;border:none;z-index:1001}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.25);z-index:998;display:none}

/* 医生 / 患者列隐藏 */
.doctor-hide .patient-explain{display:none}
.patient-hide .doctor-order{display:none}

/* ---------- 移动端 ---------- */
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0)}
  .overlay.show{display:block}
  .controls button,.extra-controls button,#btnMenu{flex:1 1 calc(50% - 8px)}


       #btnCloseSidebar {
    display: flex;
    align-items: center;
    justify-content: center;
    line-height: 1; /* 避免 line-height 影响垂直居中 */
  
}
  textarea,input[type=file]{flex:1 1 100%}
  video{width:100%;height:auto}
}

/* ======== 桌面端固定展开侧栏，隐藏汉堡 / 关闭按钮 / 遮罩 ======== */
@media (min-width: 769px) {
  #btnMenu,
  #btnCloseSidebar,
  .overlay { display: none !important; }

  .sidebar {                   /* 始终可见 */
    transform: none !important;
  }
}

/* 统一定义：只要 .show 就显示遮罩（移动端用） */
.overlay.show {
  display: block;
}
/* ======= Desktop push-right & collapsible ======= */
@media (min-width:769px){
  .sidebar       { position:fixed; left:0; top:0; bottom:0;
                   width:220px;   transition:width .25s ease; }
  .sidebar.collapsed { width:48px; }

  /* 主区域整体右移；随侧栏宽度平滑变化 */
  .main { margin-left:220px; transition:margin-left .25s ease; }
  .sidebar.collapsed ~ .main { margin-left:48px; }

  /* 汉堡和遮罩隐藏；×按钮也隐藏（用箭头） */
  #btnMenu, .overlay, #btnCloseSidebar { display:none !important; }
}

/* 收缩按钮样式（放在侧栏左边缘居中） */
#btnCollapse {
  position:absolute; top:50%; right:-13px; translate:0 -50%;
  width:26px; height:26px; border-radius:50%; border:none;
  background:#666; color:#fff; cursor:pointer; z-index:1000;
  display:flex; align-items:center; justify-content:center;
  font-size:14px; transition:transform .25s;
}
.sidebar.collapsed #btnCollapse { transform:rotate(180deg); }

</style>
</head>
<body>

<!-- 遮罩 -->
<div class="overlay" id="overlay"></div>

<!-- 汉堡按钮 -->
<button id="btnMenu">☰</button>

<div class="app">

  <!-- 侧边栏 -->
  <div class="sidebar" id="sidebar">
    <button id="btnCloseSidebar">×</button>
    <h3>目录</h3>
    <div id="toc"></div>

    <!-- 折叠按钮：桌面端显示，移动端已在 CSS 隐藏 -->
    <button id="btnCollapse">❬</button>
  </div><!-- sidebar -->

  <!-- 主内容 -->
  <div class="main">
    <div class="chat-container" id="chat"></div>

    <div class="controls">
      <button id="btnListen">开始录音</button>
      <button id="btnDiagnose">获取诊断</button>
      <button id="btnToggleView">患者视图</button>
      <button id="btnCopy">复制报告</button>
      <button id="btnPDF">导出 PDF</button>
      <button id="btnRead">朗读速览</button>
    </div>

    <div class="extra-controls">
      <textarea id="manualText" placeholder="手动输入患者描述…"></textarea>
      <button id="btnAddText">添加描述</button>
      <input type="file" id="imgUpload" accept="image/*"/>
      <button id="btnOpenCam">打开摄像头</button>
      <button id="btnSnap">拍照识别</button>
      <video id="videoPreview" autoplay muted></video>
      <canvas id="camCanvas"></canvas>
    </div>
  </div>
</div>


<!-- 依赖 -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@2.1.5/dist/tesseract.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js"></script>

<script>
/* =======================  医疗 Copilot 主脚本 v2 ======================= */
document.addEventListener('DOMContentLoaded', () => {

  /* ---------- 基础配置 ---------- */
  const API_BASE = 'https://admin-your-medical.mefans.workers.dev';   // ← 按需修改
  const DEBUG    = false;
  const log = (...a)=>DEBUG&&console.log('[DEBUG]',...a);

  /* ---------- Toast ---------- */
  const toast = msg => {
    const d=document.createElement('div');
    Object.assign(d.style,{position:'fixed',top:'20px',left:'50%',transform:'translateX(-50%)',
      background:'#ff4d4f',color:'#fff',padding:'6px 12px',borderRadius:'4px',zIndex:2e3,fontSize:'13px'});
    d.textContent=msg;document.body.appendChild(d);setTimeout(()=>d.remove(),2500);
  };

  /* ---------- DOM ---------- */
  const $ = id => document.getElementById(id);
  const chat=$('chat'),tocBox=$('toc'),sidebar=$('sidebar'),overlay=$('overlay');
  const btnMenu=$('btnMenu'),btnClose=$('btnCloseSidebar');
  const btnListen=$('btnListen'),btnDiag=$('btnDiagnose'),btnToggle=$('btnToggleView');
  const btnAdd=$('btnAddText'),btnCopy=$('btnCopy'),btnPDF=$('btnPDF'),btnRead=$('btnRead');
  const btnCam=$('btnOpenCam'),btnSnap=$('btnSnap'),imgUp=$('imgUpload');
  const manual=$('manualText'),video=$('videoPreview'),canvas=$('camCanvas');

  /* ---------- 状态 ---------- */
  let view='doctor',stream=null,recog=null,msgs=[],lastReq=null;

  /* ---------- 工具 ---------- */
  const append=(role,html,loading=false)=>{
    const div=document.createElement('div');
    div.className=`bubble ${role}${loading?' loading':''}`;
    div.innerHTML=html;chat.appendChild(div);chat.scrollTop=chat.scrollHeight;
    const m={role,text:html,el:div};msgs.push(m);return m;
  };

  /** 目录生成：只给新报告插一段，不改旧 id **/
  function buildTOC(bubbleEl){
    const sec=document.createElement('section');
    sec.innerHTML=`<strong>${new Date().toLocaleTimeString()}</strong>`;
    const nav=document.createElement('nav');sec.appendChild(nav);

    bubbleEl.querySelectorAll('h1,h2').forEach(h=>{
      if(!h.id) h.id='h_'+Math.random().toString(36).slice(2,9);   // 只没 id 时才赋
      const a=document.createElement('a');a.href='#'+h.id;
      a.textContent=h.textContent.replace(/^[0-9.]+\s*/,'');
      nav.appendChild(a);
    });
    tocBox.prepend(sec);
  }

  /* ---------- 侧栏 (移动端) ---------- */
  btnMenu?.addEventListener('click',()=>{sidebar.classList.add('open');overlay.classList.add('show');});
  btnClose?.addEventListener('click', closeSB);
  overlay?.addEventListener('click', closeSB);
  function closeSB(){sidebar.classList.remove('open');overlay.classList.remove('show');}

  /* ---------- 视图切换 ---------- */
  function applyView(){
    document.body.classList.toggle('patient-hide',view==='patient');
    document.body.classList.toggle('doctor-hide', view==='doctor');
    btnToggle.textContent = view==='doctor'?'患者视图':'医生视图';
  }
  btnToggle?.addEventListener('click',()=>{view=view==='doctor'?'patient':'doctor';applyView();});
  applyView();

  /* ---------- 语音识别 ---------- */
  btnListen?.addEventListener('click',()=>{
    const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
    if(!SR) return toast('浏览器不支持语音识别');
    if(!recog){recog=new SR();recog.lang='zh-CN';recog.continuous=true;
      recog.onresult=e=>{
        const txt=Array.from(e.results).slice(e.resultIndex).map(r=>r[0].transcript).join('');
        append('patient',txt);
      };
    }
    const listening = btnListen.dataset.on==='1';
    if(listening){recog.stop();btnListen.dataset.on='0';btnListen.textContent='开始录音';}
    else{recog.start();btnListen.dataset.on='1';btnListen.textContent='停止录音';}
  });

  /* ---------- 手动输入 ---------- */
  btnAdd?.addEventListener('click',()=>{
    const t=manual.value.trim();
    if(t) append('patient',t);
    manual.value='';manual.blur();
  });

  /* ---------- OCR ---------- */
  imgUp?.addEventListener('change',async()=>{
    const f=imgUp.files[0];if(!f) return;
    const h=append('patient','正在识别…',true);
    const {data:{text}}=await Tesseract.recognize(f,'chi_sim');
    h.el.remove();append('patient',text);imgUp.value='';
  });

  /* ---------- 摄像头 / 拍照 ---------- */
  btnCam?.addEventListener('click',async()=>{
    if(stream){stream.getTracks().forEach(t=>t.stop());stream=null;
      video.style.display='none';btnCam.textContent='打开摄像头';return;}
    try{stream=await navigator.mediaDevices.getUserMedia({video:true});
      video.srcObject=stream;video.style.display='block';btnCam.textContent='关闭摄像头';}
    catch(e){toast('无法访问摄像头：'+e.message);}
  });
  btnSnap?.addEventListener('click',()=>{
    if(!stream) return toast('请先打开摄像头');
    canvas.width=video.videoWidth;canvas.height=video.videoHeight;
    canvas.getContext('2d').drawImage(video,0,0);
    const h=append('patient','识别中…',true);
    canvas.toBlob(async blob=>{
      const {data:{text}}=await Tesseract.recognize(blob,'chi_sim');
      h.el.remove();append('patient',text);
    },'image/png');
  });

  /* ---------- 诊断 ---------- */
  btnDiag?.addEventListener('click',()=>{
    const transcript=msgs.filter(m=>m.role==='patient').map(m=>m.text).join('\n');
    if(!transcript) return toast('请先输入内容');
    const code=prompt('请输入 13 位授权码'); if(!code) return;
    runDiagnosis(code,transcript);
  });

  async function runDiagnosis(code, transcript, bubble=null){
    if(!bubble) bubble=append('assistant','',true);
    lastReq={code,transcript};

    let resp;
    try{
      resp=await fetch(`${API_BASE}/api/medical-diagnosis`,{
        method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({code,transcript})
      });
    }catch(e){return showRetry(bubble,'网络错误:'+e.message);}
    if(resp.status===401) return showRetry(bubble,'授权失败');
    if(!resp.ok)          return showRetry(bubble,'错误 '+resp.status);

    /* 流解析 */
    let md='',buf='';const reader=resp.body.pipeThrough(new TextDecoderStream()).getReader();
    while(true){
      const {value,done}=await reader.read();if(done)break;
      buf+=value;
      let idx;while((idx=buf.indexOf('\n\n'))!==-1){
        const chunk=buf.slice(0,idx).trim();buf=buf.slice(idx+2);
        if(!chunk.startsWith('data:'))continue;
        const p=chunk.slice(5).trim();if(p==='[DONE]')continue;
        md+=JSON.parse(p).content;
      }
    }

    bubble.el.classList.remove('loading');
    bubble.el.innerHTML=marked.parse(md.trim());
    bubble.text=md.trim();
    bubble.el.querySelectorAll('table tr').forEach(tr=>{
      const [d,p]=tr.children;if(p){d.classList.add('doctor-order');p.classList.add('patient-explain');}
    });
    buildTOC(bubble.el);
    if(view==='patient') applyView();
  }

  function showRetry(bubble,msg){
    bubble.el.innerHTML=`${msg} <button class="retry-btn">重试</button>`;
    bubble.el.classList.remove('loading');
    bubble.el.querySelector('.retry-btn').addEventListener('click',()=>{
      if(lastReq) runDiagnosis(lastReq.code,lastReq.transcript,bubble);
    });
  }

  /* ---------- Copy / PDF / Read ---------- */
  btnCopy?.addEventListener('click',()=>{
    const last=[...msgs].reverse().find(m=>m.role==='assistant');if(!last) return toast('暂无报告');
    navigator.clipboard.writeText(last.text||last.el.textContent).then(()=>toast('已复制'));
  });
  btnPDF?.addEventListener('click',()=>{
    const last=[...msgs].reverse().find(m=>m.role==='assistant');if(!last) return toast('暂无报告');
    html2pdf().set({margin:10,filename:'report.pdf',html2canvas:{scale:2}}).from(last.el).save();
  });
  btnRead?.addEventListener('click',()=>{
    const last=[...msgs].reverse().find(m=>m.role==='assistant');if(!last) return toast('暂无报告');
    const t=last.el.querySelector('ul li')?.textContent||last.el.textContent.slice(0,150);
    const s=window.speechSynthesis;s.cancel();const u=new SpeechSynthesisUtterance(t);u.lang='zh-CN';s.speak(u);
  });

  /* ---------- 欢迎语 ---------- */
  append('assistant','欢迎使用医疗 Copilot，可语音、手动、上传或拍照描述病情。');
  log('Init ok');
});
/* ======== 屏宽变化时自动校正侧栏状态 ======== */
function syncSidebar() {
  const isDesktop = window.innerWidth >= 769;
  if (isDesktop) {
    sidebar.classList.remove('open');          // 始终展开
    overlay.classList.remove('show');          // 桌面不需要遮罩
  }
}
window.addEventListener('resize', syncSidebar);
syncSidebar();          // 首次加载立即校正

/* 按钮只在移动端才触发展开/收起 */
btnMenu?.addEventListener('click', () => {
  if (window.innerWidth < 769) {
    sidebar.classList.add('open');
    overlay.classList.add('show');
  }
});

      /* ======= 折叠按钮 & 自适应 ======= */
const btnCollapse=document.createElement('button');
btnCollapse.id='btnCollapse';
btnCollapse.title='折叠/展开目录';
btnCollapse.textContent='❬';            // → ❬ ❭
sidebar.appendChild(btnCollapse);

/* 点击切换宽度 */
btnCollapse.addEventListener('click',()=>{
  sidebar.classList.toggle('collapsed');
});

/* 首次进入或窗口缩放时同步状态：桌面推右，移动端恢复 */
function syncLayout(){
  const desktop = window.innerWidth >= 769;
  if(!desktop){
    sidebar.classList.remove('collapsed');           // 移动端保持正常宽
    document.body.classList.remove('desktop');       // 标记可选
  }else{
    document.body.classList.add('desktop');
  }
}
window.addEventListener('resize', syncLayout);
syncLayout();                  // 首次执行

/* ============ 额外：桌面端隐藏汉堡 ============ */
/* 在 CSS 中添加：
@media(min-width:769px){ #btnMenu{display:none} }
*/
</script>

</body>
</html>
