<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>🔑 管理后台 · 语音助手</title>
  <style>/* ... 保留你原有的样式 ... */</style>
</head>
<body>
  <div id="container">
    <h1>🔑 管理后台 · 语音助手</h1>

    <!-- 登录区 -->
    <div id="authArea">
      <button id="loginBtn">使用 GitHub 登录</button>
    </div>

    <!-- 管理区 -->
    <div id="adminArea" style="display:none">
      <button id="logoutBtn">退出登录</button>
      <table>
        <thead>…</thead>
        <tbody id="recordsBody">
          <tr><td colspan="6">请先登录…</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
  (function(){
    const WORKER = location.origin;
    const authArea    = document.getElementById('authArea');
    const adminArea   = document.getElementById('adminArea');
    const loginBtn    = document.getElementById('loginBtn');
    const logoutBtn   = document.getElementById('logoutBtn');
    const recordsBody = document.getElementById('recordsBody');

    // 1. 登录跳转到 Worker → Supabase OAuth
    loginBtn.onclick = () => {
      location.href = 
        `${WORKER}/auth-proxy/auth/v1/authorize?provider=github&redirect_to=${encodeURIComponent(WORKER)}`;
    };

    // 2. 登出：清 Cookie 并刷新
    logoutBtn.onclick = async () => {
      await fetch(`${WORKER}/auth-proxy/auth/v1/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      location.reload();
    };

    // 3. 检查是否已登录（看 Cookie）
    async function checkLogin() {
      const resp = await fetch(`${WORKER}/admin-api/check-session`, {
        credentials: 'include'
      });
      return resp.ok;
    }

    // 4. 拉记录
    async function loadRecords() {
      recordsBody.innerHTML = '<tr><td colspan="6">加载中…</td></tr>';
      try {
        const resp = await fetch(`${WORKER}/admin-api/records`, {
          credentials: 'include'
        });
        if (!resp.ok) throw new Error(resp.status);
        const list = await resp.json();
        if (!list.length) {
          recordsBody.innerHTML = '<tr><td colspan="6">暂无记录</td></tr>';
        } else {
          recordsBody.innerHTML = list.map(r=>`
            <tr>
              <td>${new Date(r.created_at).toLocaleString()}</td>
              <td>${r.original||''}</td>
              <td>${r.translated_en||''}</td>
              <td>${r.tokens||''}</td>
              <td>${r.cost||''}</td>
              <td>${r.ip||''}</td>
            </tr>
          `).join('');
        }
      } catch(e) {
        recordsBody.innerHTML = `<tr><td colspan="6">拉取失败：${e.message}</td></tr>`;
      }
    }

    // 5. 初始化：检查登录状态
    checkLogin().then(isLogin=>{
      if (isLogin) {
        authArea.style.display  = 'none';
        adminArea.style.display = 'block';
        loadRecords();
      } else {
        authArea.style.display  = 'block';
        adminArea.style.display = 'none';
      }
    });
  })();
  </script>
</body>
</html>
