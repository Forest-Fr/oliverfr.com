<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>🔑 管理后台 · 语音助手</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
<style>
  /* —— 新版全局与布局 —— */
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
    background: #f0f2f5;
  }
  .container {
    max-width: 960px;
    margin: 1rem auto;
    padding: 1rem;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  h1 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  /* —— 顶部标题 —— */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }

  /* —— 控件 区：搜索 + 登出 —— */
  #controls {
    padding: 16px;
    background: #fff;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }
  #controls input,
  #controls button {
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
  }

  /* —— 表格 容器 —— */
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-top: 16px;
    background: #fff;
  }

  /* —— 列宽与固定布局 —— */
  #convTable {
    width: 100%;
    min-width: 1260px;      /* 根据所有列宽之和 */
    table-layout: fixed;    /* 启用固定列宽 */
    border-collapse: collapse;
  }
  #convTable th,
  #convTable td {
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: left;
    vertical-align: top;
    line-height: 1.6;
    word-break: break-word;
  }
  #convTable th {
    background: #fafafa;
  }
  /* 指定各列固定宽度 */
  #convTable th:nth-child(1),
  #convTable td:nth-child(1) { width: 150px; }   /* 创建时间 */
  #convTable th:nth-child(2),
  #convTable td:nth-child(2) { width: 150px; }   /* 更新时间 */
  #convTable th:nth-child(3),
  #convTable td:nth-child(3) { width: 120px; }   /* IP */
  #convTable th:nth-child(4),
  #convTable td:nth-child(4) { width: 120px; }   /* 原文 */
  #convTable th:nth-child(5),
  #convTable td:nth-child(5) { width: 400px; }   /* 翻译 */
  #convTable th:nth-child(6),
  #convTable td:nth-child(6) { width: 80px; }    /* 模式 */
  #convTable th:nth-child(7),
  #convTable td:nth-child(7) { width: 80px; }    /* Tokens */
  #convTable th:nth-child(8),
  #convTable td:nth-child(8) { width: 80px; }    /* Cost */
  #convTable th:nth-child(9),
  #convTable td:nth-child(9) { width: 100px; }   /* 操作 */

  .empty {
    text-align: center;
    padding: 24px;
    color: #888;
  }

  /* —— 桌面端长文本省略 + 悬停展开 —— */
  #convTable td[data-label="翻译"] {
    max-height: 4.8em;             /* 3 行 */
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }
  #convTable td[data-label="翻译"]:hover {
    overflow: auto;
    -webkit-line-clamp: unset;
    white-space: normal;
    background: #f9f9f9;
    position: relative;
    z-index: 1;
  }

  /* —— 操作按钮 —— */
  .btnPreview,
  .btnEdit,
  .btnDel {
    margin-right: 6px;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }
  .btnPreview {
    background: #1890ff;
    color: #fff;
  }
  .btnEdit {
    background: #52c41a;
    color: #fff;
  }
  .btnDel {
    background: #fa541c;
    color: #fff;
  }

  /* —— 分页 —— */
  #pager {
    margin: 16px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  #pager button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }
  #pager .active {
    background: #24292e;
    color: #fff;
  }

  /* —— 弹窗 —— */
  #detailModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .4);
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  #detailModal .modal-content {
    position: relative;
    background: #fff;
    width: 90%;
    max-width: 600px;
    max-height: 80%;
    overflow: auto;
    border-radius: 8px;
    padding: 16px;
  }
  #detailModal .close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 20px;
    background: none;
    border: none;
    cursor: pointer;
  }

  /* —— 移动端卡片式 响应式 —— */
  @media (max-width: 768px) {
    html,
    body {
      overflow-x: hidden;
    }
    #controls,
    #pager {
      justify-content: space-between;
    }
    /* 隐藏表头 */
    #convTable thead {
      display: none;
    }
    #convTable,
    #convTable tbody,
    #convTable tr {
      display: block;
      width: 100%;
    }
    #convTable tr {
      margin-bottom: 1em;
      padding: 0.5em;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }
    #convTable td {
      display: flex;
      justify-content: space-between;
      padding: 0.5em 0;
      border: none;
      border-bottom: 1px solid #eee;
      vertical-align: top;
      line-height: 1.4;
    }
    #convTable td:last-of-type {
      border-bottom: none;
    }
    #convTable td::before {
      content: attr(data-label);
      font-weight: 600;
      margin-right: 8px;
    }
    /* 移动端翻译摘要 2 行 */
    #convTable td[data-label="翻译"] {
      max-height: 3em;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .more-toggle {
      display: block;
      font-size: 0.85rem;
      color: #1890ff;
      cursor: pointer;
      margin-top: 0.5em;
    }
    .table-container {
      padding: 0 16px;
      box-sizing: border-box;
    }
    #pager {
      justify-content: center;
      padding: 0 16px;
    }
  }
</style>



</head>
<body>
  <div class="container">
    <!-- 标题 -->
    <header>
      <h1>🔑 管理后台 · 语音助手</h1>
      <!-- 可选：将登录/退出按钮放到这里 -->
    </header>

    <!-- 搜索 + 退出 -->
    <div id="controls">
      <input id="searchInput" placeholder="搜索原文或翻译…"/>               <!-- ← 保留原功能 -->
      <button id="logoutBtn">退出登录</button>                         <!-- ← 保留原功能 -->
    </div>

    <!-- 数据表格 -->
    <div class="table-container">
      <table id="convTable">
        <thead>
          <tr>
            <th>创建时间</th><th>更新时间</th><th>IP</th>
            <th>原文</th><th>翻译</th><th>模式</th><th>Tokens</th><th>Cost</th><th>操作</th>
          </tr>
        </thead>
        <tbody id="recordsBody">
          <tr class="empty"><td colspan="9">加载中…</td></tr>           <!-- ← colspan 调整 -->
        </tbody>
      </table>
    </div>

    <!-- 分页 -->
    <div id="pager"></div>                                          <!-- ← 原 <ul> 替换 -->

  </div>

  <!-- 弹窗 详情/编辑 -->
  <div id="detailModal">
    <div class="modal-content">
      <button class="close-btn" id="modalClose">&times;</button>
      <div id="modalBody"></div>
      <div style="text-align:right; margin-top:1rem;">
        <button id="modalSave" class="btnEdit">保存</button>       <!-- 复用 .btnEdit -->
        <button id="modalDelete" class="btnDel">删除</button>     <!-- 复用 .btnDel -->
      </div>
    </div>
  </div>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  ;(async()=>{

    // —— 1. 初始化 Supabase 客户端 ——（不变）
    const SUPA_URL = 'https://wrgfrjwwtxyonbqxxnvp.supabase.co'
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg'
    const supa = createClient(SUPA_URL, ANON_KEY, {
      auth: { detectSessionInUrl:true, persistSession:true }
    })

    // —— 2. DOM 引用 ——（改动 ID/Class）
    const loginBtn    = document.getElementById('loginBtn')    // 若需要 GitHub 登录
    const logoutBtn   = document.getElementById('logoutBtn')
    const searchIn    = document.getElementById('searchInput')
    const recordsBody = document.getElementById('recordsBody')
    const pager       = document.getElementById('pager')
    const modal       = document.getElementById('detailModal')
    const modalBody   = document.getElementById('modalBody')
    const modalClose  = document.getElementById('modalClose')
    const modalSave   = document.getElementById('modalSave')
    const modalDelete = document.getElementById('modalDelete')

    let allRecords  = [], currentPage = 1, pageSize = 10, activeRecord = null

    // —— 3. 登录态监听 & 初始检查 ——（不变）
    supa.auth.onAuthStateChange((_, session)=>{
      if(session) loadPage(1)
      else location.reload()
    })
    const { data:{ session } } = await supa.auth.getSession()
    if(!session) supa.auth.signInWithOAuth({ provider:'github', options:{ redirectTo:window.location.href } })

    logoutBtn.onclick = async()=>{
      await supa.auth.signOut()
      location.reload()
    }

    // —— 4. 拉记录 & 渲染 & 分页 ——（渲染加 data-label，分页改为按钮）
    async function loadPage(page=1){
      currentPage=page
      recordsBody.innerHTML = '<tr class="empty"><td colspan="9">加载中…</td></tr>'
      try {
        const from = (page-1)*pageSize, to = page*pageSize-1
        const { data, error } = await supa
          .from('translations')
          .select('id,created_at,updated_at,ip,original,translated_en,mode,tokens,cost')
          .order('created_at',{ascending:false})
          .range(from,to)
        if(error) throw error
        allRecords = data||[]
        renderTable(allRecords)
        renderPagination(page)
      } catch(e){
        recordsBody.innerHTML = `<tr class="empty"><td colspan="9">加载失败：${e.message}</td></tr>`
      }
    }

    function renderTable(list){
      const kw = searchIn.value.trim().toLowerCase()
      const rows = list.filter(r=>
        !kw ||
        (r.original||'').toLowerCase().includes(kw) ||
        (r.translated_en||'').toLowerCase().includes(kw)
      )
      if(!rows.length){
        recordsBody.innerHTML = '<tr class="empty"><td colspan="9">无匹配结果</td></tr>'
        return
      }
      recordsBody.innerHTML = rows.map(r=>`
        <tr>
          <td data-label="创建时间">${new Date(r.created_at).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai'})}</td>
          <td data-label="更新时间">${new Date(r.updated_at).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai'})}</td>
          <td data-label="IP">${r.ip||''}</td>
          <td data-label="原文">${r.original||''}</td>
          <td data-label="翻译">${r.translated_en||''}</td>
          <td data-label="模式">${r.mode||''}</td>
          <td data-label="Tokens">${r.tokens||0}</td>
          <td data-label="Cost">${r.cost||0}</td>
          <td data-label="操作">
            <button class="btnPreview" data-id="${r.id}">查看</button>
          </td>
        </tr>
      `).join('')
      recordsBody.querySelectorAll('.btnPreview').forEach(btn=>{
        btn.onclick = ()=> openModal(btn.dataset.id)
      })
    }

    function renderPagination(page){
      const total = allRecords.length
      const pages = Math.ceil(total/pageSize)||1
      pager.innerHTML = ''
      for(let i=1; i<=pages; i++){
        const b = document.createElement('button')
        b.textContent = i
        if(i===page) b.classList.add('active')
        b.onclick = ()=> loadPage(i)
        pager.appendChild(b)
      }
    }

    searchIn.addEventListener('input', ()=> renderTable(allRecords))

    // —— 5. 弹窗 查看/编辑/删除 ——（改动 ID/Class）
    function openModal(id){
      activeRecord = allRecords.find(r=>r.id===id)
      modalBody.innerHTML = `
        <h2>记录详情</h2>
        <p><strong>创建时间：</strong>${new Date(activeRecord.created_at).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai'})}</p>
        <p><strong>更新时间：</strong>${new Date(activeRecord.updated_at).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai'})}</p>
        <p><strong>IP：</strong>${activeRecord.ip||''}</p>
        <label>原文：<textarea id="m_o" style="width:100%;height:4rem">${activeRecord.original||''}</textarea></label>
        <label>翻译：<textarea id="m_t" style="width:100%;height:4rem">${activeRecord.translated_en||''}</textarea></label>
      `
      modal.style.display = 'flex'
    }
    modalClose.onclick = ()=> modal.style.display='none'

    modalSave.onclick = async()=>{
      const o = document.getElementById('m_o').value
      const t = document.getElementById('m_t').value
      const { error } = await supa
        .from('translations')
        .update({ original:o, translated_en:t })
        .eq('id',activeRecord.id)
      if(error) alert('更新失败：'+error.message)
      else { modal.style.display='none'; loadPage(currentPage) }
    }
    modalDelete.onclick = async()=>{
      if(!confirm('确定要删除？')) return
      const { error } = await supa
        .from('translations')
        .delete()
        .eq('id',activeRecord.id)
      if(error) alert('删除失败：'+error.message)
      else { modal.style.display='none'; loadPage(currentPage) }
    }

    // —— 6. 启动 —— 
    loadPage(1)

  })()
  </script>
</body>
</html>
