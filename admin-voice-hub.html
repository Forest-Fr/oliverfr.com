<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ”‘ ç®¡ç†åå° Â· è¯­éŸ³åŠ©æ‰‹</title>
  <style>
    body { margin:0; padding:0; font-family:'Segoe UI',sans-serif; background:#f0f2f5; }
    .container { max-width:960px; margin:1rem auto; padding:1rem; background:#fff; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }
    h1 { font-size:1.5rem; margin-bottom:1rem; }
    .toolbar { display:flex; flex-wrap:wrap; justify-content:space-between; align-items:center; margin-bottom:1rem; }
    .search { flex:1; min-width:200px; margin-right:1rem; }
    .search input { width:100%; padding:.5rem 1rem; border:1px solid #ccc; border-radius:4px; }
    .table-wrapper { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; }
    th, td { padding:.5rem; border:1px solid #ddd; text-align:left; }
    th { background:#fafafa; }
    .btn { padding:.4rem .8rem; border:none; border-radius:4px; cursor:pointer; }
    .btn-primary { background:#24292e; color:#fff; }
    .btn-danger  { background:#e53e3e; color:#fff; }

    /* Pagination */
    .pagination { display:flex; list-style:none; padding:0; margin:1rem 0; }
    .pagination li { margin:0 .25rem; }
    .pagination button { padding:.4rem .8rem; border:1px solid #ccc; background:#fff; border-radius:4px; cursor:pointer; }
    .pagination .active { background:#24292e; color:#fff; border-color:#24292e; }

    /* Modal */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.3); display:none; justify-content:center; align-items:center; }
    .modal { background:#fff; border-radius:8px; max-width:90%; width:500px; max-height:80%; overflow:auto; padding:1rem; position:relative; }
    .modal-header { display:flex; justify-content:space-between; align-items:center; }
    .modal-header h2 { margin:0; font-size:1.25rem; }
    .modal-close { background:none; border:none; font-size:1.25rem; cursor:pointer; }
    @media (max-width:600px) {
      th, td { font-size:.9rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”‘ ç®¡ç†åå° Â· è¯­éŸ³åŠ©æ‰‹</h1>
    <div class="toolbar">
      <div class="search"><input id="searchInput" placeholder="æœç´¢åŸæ–‡æˆ–ç¿»è¯‘â€¦" /></div>
      <button id="logoutBtn" class="btn btn-danger">é€€å‡ºç™»å½•</button>
    </div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>æ—¶é—´</th>
            <th>åŸæ–‡</th>
            <th>ç¿»è¯‘</th>
            <th>æ¨¡å¼</th>
            <th>Tokens</th>
            <th>Cost</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="recordsBody">
          <tr><td colspan="7">åŠ è½½ä¸­â€¦</td></tr>
        </tbody>
      </table>
    </div>
    <ul id="pagination" class="pagination"></ul>
  </div>

  <!-- é¢„è§ˆ/ç¼–è¾‘å¼¹çª— -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">è®°å½•è¯¦æƒ…</h2>
        <button id="modalClose" class="modal-close">Ã—</button>
      </div>
      <div id="modalBody"></div>
      <div style="text-align:right; margin-top:1rem;">
        <button id="modalSave" class="btn btn-primary">ä¿å­˜</button>
        <button id="modalDelete" class="btn btn-danger">åˆ é™¤</button>
      </div>
    </div>
  </div>

  <script>
    const BASE = 'https://translate-assistant.mefans.workers.dev';
    const RECORDS_URL = BASE + '/admin-api/records';
    let currentPage = 1;
    const pageSize = 10;
    let allRecords = [];

    document.getElementById('logoutBtn').onclick = () => {
      fetch(BASE + '/auth-proxy/auth/v1/logout', { method:'POST', credentials:'include' })
        .then(()=> location.reload());
    };

    // è½½å…¥è®°å½•
    async function loadRecords(page=1, filter=''){
      const offset = (page-1)*pageSize;
      const resp = await fetch(`${RECORDS_URL}?limit=${pageSize}&offset=${offset}`, { credentials:'include' });
      if(!resp.ok) return alert('åŠ è½½å¤±è´¥');
      const list = await resp.json();
      allRecords = list;
      renderTable(list, filter);
      renderPagination(page);
    }

    // æ¸²æŸ“è¡¨æ ¼
    function renderTable(list, filter){
      const tbody = document.getElementById('recordsBody');
      tbody.innerHTML = '';
      const f = filter.toLowerCase();
      list.filter(r => !f||r.original.toLowerCase().includes(f)||r.translated_en.toLowerCase().includes(f))
        .forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${new Date(r.created_at).toLocaleString()}</td>
            <td>${r.original||''}</td>
            <td>${r.translated_en||''}</td>
            <td>${r.mode||''}</td>
            <td>${r.tokens||0}</td>
            <td>${r.cost||0}</td>
            <td><button class="btn btn-primary" data-id="${r.id}">æŸ¥çœ‹/ç¼–è¾‘</button></td>
          `;
          tbody.appendChild(tr);
        });
      // ç»‘å®šæŸ¥çœ‹æŒ‰é’®
      Array.from(tbody.querySelectorAll('button')).forEach(btn=>{
        btn.onclick = ()=>openModal(btn.dataset.id);
      });
    }

    // åˆ†é¡µ
    function renderPagination(page){
      const total = 1000; // é¢„ä¼°æˆ–åå°æä¾›
      const pages = Math.ceil(total/pageSize);
      const ul = document.getElementById('pagination');
      ul.innerHTML = '';
      for(let i=1;i<=pages;i++){
        const li = document.createElement('li');
        li.innerHTML = `<button ${i===page?'class="active"':''}>${i}</button>`;
        li.firstChild.onclick = ()=>{ currentPage=i; loadRecords(i,document.getElementById('searchInput').value); };
        ul.appendChild(li);
      }
    }

    // æ¨¡æ€æ¡†
    const backdrop = document.getElementById('modalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalClose = document.getElementById('modalClose');
    const modalSave  = document.getElementById('modalSave');
    const modalDelete= document.getElementById('modalDelete');
    let activeRecord = null;

    function openModal(id){
      activeRecord = allRecords.find(r=>r.id===id);
      modalTitle.textContent = `è®°å½• ${id}`;
      modalBody.innerHTML = `
        <label>åŸæ–‡:<textarea id="m_original" style="width:100%;height:4rem">${activeRecord.original}</textarea></label>
        <label>ç¿»è¯‘:<textarea id="m_translated" style="width:100%;height:4rem">${activeRecord.translated_en}</textarea></label>
      `;
      backdrop.style.display = 'flex';
    }
    modalClose.onclick = ()=> backdrop.style.display='none';
    modalSave.onclick = async ()=>{
      const o = document.getElementById('m_original').value;
      const t = document.getElementById('m_translated').value;
      await fetch(`${RECORDS_URL}?id=eq.${activeRecord.id}`,{
        method:'PATCH', credentials:'include',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ original:o, translated_en:t })
      });
      backdrop.style.display='none';
      loadRecords(currentPage, document.getElementById('searchInput').value);
    };
    modalDelete.onclick = async ()=>{
      await fetch(`${RECORDS_URL}?id=eq.${activeRecord.id}`,{
        method:'DELETE', credentials:'include'
      });
      backdrop.style.display='none';
      loadRecords(currentPage, document.getElementById('searchInput').value);
    };

    // æœç´¢
    document.getElementById('searchInput').addEventListener('input', e=>{
      renderTable(allRecords, e.target.value);
    });

    // åˆå§‹åŠ è½½
    loadRecords(1, '');
  </script>
</body>
</html>
