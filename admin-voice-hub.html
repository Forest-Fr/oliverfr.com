<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>ğŸ”‘ ç®¡ç†åå° Â· è¯­éŸ³åŠ©æ‰‹</title>
  <link rel="icon" href="MeFan Logo.png" type="image/x-icon"/>
<style>
  /* â€”â€” æ–°ç‰ˆå…¨å±€ä¸å¸ƒå±€ â€”â€” */
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
    background: #f0f2f5;
  }
  .container {
    max-width: 960px;
    margin: 1rem auto;
    padding: 1rem;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }
  h1 {
    font-size: 1.5rem;
    margin-bottom: 1rem;
  }

  /* â€”â€” é¡¶éƒ¨æ ‡é¢˜ â€”â€” */
  header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 0;
  }
  header h1 {
    margin: 0;
    font-size: 1.5rem;
  }

  /* â€”â€” æ§ä»¶ åŒºï¼šæœç´¢ + ç™»å‡º â€”â€” */
  #controls {
    padding: 16px;
    background: #fff;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }
  #controls input,
  #controls button {
    padding: 6px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 1rem;
  }

  /* â€”â€” è¡¨æ ¼ å®¹å™¨ â€”â€” */
  .table-container {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-top: 16px;
    background: #fff;
  }

  /* â€”â€” åˆ—å®½ä¸å›ºå®šå¸ƒå±€ â€”â€” */
  #convTable {
    width: 100%;
    min-width: 1260px;      /* æ ¹æ®æ‰€æœ‰åˆ—å®½ä¹‹å’Œ */
    table-layout: fixed;    /* å¯ç”¨å›ºå®šåˆ—å®½ */
    border-collapse: collapse;
  }
  #convTable th,
  #convTable td {
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: left;
    vertical-align: top;
    line-height: 1.6;
    word-break: break-word;
  }
  #convTable th {
    background: #fafafa;
  }
  /* æŒ‡å®šå„åˆ—å›ºå®šå®½åº¦ */
  #convTable th:nth-child(1),
  #convTable td:nth-child(1) { width: 150px; }   /* åˆ›å»ºæ—¶é—´ */
  #convTable th:nth-child(2),
  #convTable td:nth-child(2) { width: 150px; }   /* æ›´æ–°æ—¶é—´ */
  #convTable th:nth-child(3),
  #convTable td:nth-child(3) { width: 120px; }   /* IP */
  #convTable th:nth-child(4),
  #convTable td:nth-child(4) { width: 120px; }   /* åŸæ–‡ */
  #convTable th:nth-child(5),
  #convTable td:nth-child(5) { width: 400px; }   /* ç¿»è¯‘ */
  #convTable th:nth-child(6),
  #convTable td:nth-child(6) { width: 80px; }    /* æ¨¡å¼ */
  #convTable th:nth-child(7),
  #convTable td:nth-child(7) { width: 80px; }    /* Tokens */
  #convTable th:nth-child(8),
  #convTable td:nth-child(8) { width: 80px; }    /* Cost */
  #convTable th:nth-child(9),
  #convTable td:nth-child(9) { width: 100px; }   /* æ“ä½œ */

  .empty {
    text-align: center;
    padding: 24px;
    color: #888;
  }

  /* â€”â€” æ¡Œé¢ç«¯é•¿æ–‡æœ¬çœç•¥ + æ‚¬åœå±•å¼€ â€”â€” */
  #convTable td[data-label="ç¿»è¯‘"] {
    max-height: 4.8em;             /* 3 è¡Œ */
    overflow: hidden;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
  }
  #convTable td[data-label="ç¿»è¯‘"]:hover {
    overflow: auto;
    -webkit-line-clamp: unset;
    white-space: normal;
    background: #f9f9f9;
    position: relative;
    z-index: 1;
  }

  /* â€”â€” æ“ä½œæŒ‰é’® â€”â€” */
  .btnPreview,
  .btnEdit,
  .btnDel {
    margin-right: 6px;
    padding: 4px 8px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }
  .btnPreview {
    background: #1890ff;
    color: #fff;
  }
  .btnEdit {
    background: #52c41a;
    color: #fff;
  }
  .btnDel {
    background: #fa541c;
    color: #fff;
  }

  /* â€”â€” åˆ†é¡µ â€”â€” */
  #pager {
    margin: 16px 0;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }
  #pager button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    white-space: nowrap;
  }
  #pager .active {
    background: #24292e;
    color: #fff;
  }

  /* â€”â€” å¼¹çª— â€”â€” */
  #detailModal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .4);
    align-items: center;
    justify-content: center;
    z-index: 2000;
  }
  #detailModal .modal-content {
    position: relative;
    background: #fff;
    width: 90%;
    max-width: 600px;
    max-height: 80%;
    overflow: auto;
    border-radius: 8px;
    padding: 16px;
  }
  #detailModal .close-btn {
    position: absolute;
    top: 12px;
    right: 12px;
    font-size: 20px;
    background: none;
    border: none;
    cursor: pointer;
  }

  /* â€”â€” ç§»åŠ¨ç«¯å¡ç‰‡å¼ å“åº”å¼ â€”â€” */
  @media (max-width: 768px) {
    html,
    body {
      overflow-x: hidden;
    }
    #controls,
    #pager {
      justify-content: space-between;
    }
    /* éšè—è¡¨å¤´ */
    #convTable thead {
      display: none;
    }
    #convTable,
    #convTable tbody,
    #convTable tr {
      display: block;
      width: 100%;
    }
    #convTable tr {
      margin-bottom: 1em;
      padding: 0.5em;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: #fff;
    }
    #convTable td {
      display: flex;
      justify-content: space-between;
      padding: 0.5em 0;
      border: none;
      border-bottom: 1px solid #eee;
      vertical-align: top;
      line-height: 1.4;
    }
    #convTable td:last-of-type {
      border-bottom: none;
    }
    #convTable td::before {
      content: attr(data-label);
      font-weight: 600;
      margin-right: 8px;
    }
    /* ç§»åŠ¨ç«¯ç¿»è¯‘æ‘˜è¦ 2 è¡Œ */
    #convTable td[data-label="ç¿»è¯‘"] {
      max-height: 3em;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }
    .more-toggle {
      display: block;
      font-size: 0.85rem;
      color: #1890ff;
      cursor: pointer;
      margin-top: 0.5em;
    }
    .table-container {
      padding: 0 16px;
      box-sizing: border-box;
    }
    #pager {
      justify-content: center;
      padding: 0 16px;
    }
  }
</style>



</head>
<body>
  <div class="container">
    <!-- æ ‡é¢˜ -->
    <header>
      <h1>ğŸ”‘ ç®¡ç†åå° Â· è¯­éŸ³åŠ©æ‰‹</h1>
      <!-- å¯é€‰ï¼šå°†ç™»å½•/é€€å‡ºæŒ‰é’®æ”¾åˆ°è¿™é‡Œ -->
    </header>

    <!-- æœç´¢ + é€€å‡º -->
    <div id="controls">
      <input id="searchInput" placeholder="æœç´¢åŸæ–‡æˆ–ç¿»è¯‘â€¦"/>               <!-- â† ä¿ç•™åŸåŠŸèƒ½ -->
      <button id="logoutBtn">é€€å‡ºç™»å½•</button>                         <!-- â† ä¿ç•™åŸåŠŸèƒ½ -->
    </div>

    <!-- æ•°æ®è¡¨æ ¼ -->
    <div class="table-container">
      <table id="convTable">
        <thead>
          <tr>
            <th>åˆ›å»ºæ—¶é—´</th><th>æ›´æ–°æ—¶é—´</th><th>IP</th>
            <th>åŸæ–‡</th><th>ç¿»è¯‘</th><th>æ¨¡å¼</th><th>Tokens</th><th>Cost</th><th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="recordsBody">
          <tr class="empty"><td colspan="9">åŠ è½½ä¸­â€¦</td></tr>           <!-- â† colspan è°ƒæ•´ -->
        </tbody>
      </table>
    </div>

    <!-- åˆ†é¡µ -->
    <div id="pager"></div>                                          <!-- â† åŸ <ul> æ›¿æ¢ -->

  </div>

  <!-- å¼¹çª— è¯¦æƒ…/ç¼–è¾‘ -->
  <div id="detailModal">
    <div class="modal-content">
      <button class="close-btn" id="modalClose">&times;</button>
      <div id="modalBody"></div>
      <div style="text-align:right; margin-top:1rem;">
        <button id="modalSave" class="btnEdit">ä¿å­˜</button>       <!-- å¤ç”¨ .btnEdit -->
        <button id="modalDelete" class="btnDel">åˆ é™¤</button>     <!-- å¤ç”¨ .btnDel -->
      </div>
    </div>
  </div>

  <script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  ;(async()=>{

    // â€”â€” 1. åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯ â€”â€”ï¼ˆä¸å˜ï¼‰
    const SUPA_URL = 'https://wrgfrjwwtxyonbqxxnvp.supabase.co'
    const ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndyZ2Zyand3dHh5b25icXh4bnZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM2Nzk3ODYsImV4cCI6MjA1OTI1NTc4Nn0.ffm6g20BG36c8ROghk95rtl3dBO-vXM7-_xVMrQdfPg'
    const supa = createClient(SUPA_URL, ANON_KEY, {
      auth: { detectSessionInUrl:true, persistSession:true }
    })

    // â€”â€” 2. DOM å¼•ç”¨ â€”â€”ï¼ˆæ”¹åŠ¨ ID/Classï¼‰
    const loginBtn    = document.getElementById('loginBtn')    // è‹¥éœ€è¦ GitHub ç™»å½•
    const logoutBtn   = document.getElementById('logoutBtn')
    const searchIn    = document.getElementById('searchInput')
    const recordsBody = document.getElementById('recordsBody')
    const pager       = document.getElementById('pager')
    const modal       = document.getElementById('detailModal')
    const modalBody   = document.getElementById('modalBody')
    const modalClose  = document.getElementById('modalClose')
    const modalSave   = document.getElementById('modalSave')
    const modalDelete = document.getElementById('modalDelete')

    let allRecords  = [], currentPage = 1, pageSize = 10, activeRecord = null

    // â€”â€” 3. ç™»å½•æ€ç›‘å¬ & åˆå§‹æ£€æŸ¥ â€”â€”ï¼ˆä¸å˜ï¼‰
    supa.auth.onAuthStateChange((_, session)=>{
      if(session) loadPage(1)
      else location.reload()
    })
    const { data:{ session } } = await supa.auth.getSession()
    if(!session) supa.auth.signInWithOAuth({ provider:'github', options:{ redirectTo:window.location.href } })

    logoutBtn.onclick = async()=>{
      await supa.auth.signOut()
      location.reload()
    }

    // â€”â€” 4. æ‹‰è®°å½• & æ¸²æŸ“ & åˆ†é¡µ â€”â€”ï¼ˆæ¸²æŸ“åŠ  data-labelï¼Œåˆ†é¡µæ”¹ä¸ºæŒ‰é’®ï¼‰
    async function loadPage(page=1){
      currentPage=page
      recordsBody.innerHTML = '<tr class="empty"><td colspan="9">åŠ è½½ä¸­â€¦</td></tr>'
      try {
        const from = (page-1)*pageSize, to = page*pageSize-1
        const { data, error } = await supa
          .from('translations')
          .select('id,created_at,updated_at,ip,original,translated_en,mode,tokens,cost')
          .order('created_at',{ascending:false})
          .range(from,to)
        if(error) throw error
        allRecords = data||[]
        renderTable(allRecords)
        renderPagination(page)
      } catch(e){
        recordsBody.innerHTML = `<tr class="empty"><td colspan="9">åŠ è½½å¤±è´¥ï¼š${e.message}</td></tr>`
      }
    }

    function renderTable(list){
      const kw = searchIn.value.trim().toLowerCase()
      const rows = list.filter(r=>
        !kw ||
        (r.original||'').toLowerCase().includes(kw) ||
        (r.translated_en||'').toLowerCase().includes(kw)
      )
      if(!rows.length){
        recordsBody.innerHTML = '<tr class="empty"><td colspan="9">æ— åŒ¹é…ç»“æœ</td></tr>'
        return
      }
      recordsBody.innerHTML = rows.map(r=>`
        <tr>
          <td data-label="åˆ›å»ºæ—¶é—´">${new Date(r.created_at).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai'})}</td>
          <td data-label="æ›´æ–°æ—¶é—´">${new Date(r.updated_at).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai'})}</td>
          <td data-label="IP">${r.ip||''}</td>
          <td data-label="åŸæ–‡">${r.original||''}</td>
          <td data-label="ç¿»è¯‘">${r.translated_en||''}</td>
          <td data-label="æ¨¡å¼">${r.mode||''}</td>
          <td data-label="Tokens">${r.tokens||0}</td>
          <td data-label="Cost">${r.cost||0}</td>
          <td data-label="æ“ä½œ">
            <button class="btnPreview" data-id="${r.id}">æŸ¥çœ‹</button>
          </td>
        </tr>
      `).join('')
      recordsBody.querySelectorAll('.btnPreview').forEach(btn=>{
        btn.onclick = ()=> openModal(btn.dataset.id)
      })
    }

    function renderPagination(page){
      const total = allRecords.length
      const pages = Math.ceil(total/pageSize)||1
      pager.innerHTML = ''
      for(let i=1; i<=pages; i++){
        const b = document.createElement('button')
        b.textContent = i
        if(i===page) b.classList.add('active')
        b.onclick = ()=> loadPage(i)
        pager.appendChild(b)
      }
    }

    searchIn.addEventListener('input', ()=> renderTable(allRecords))

    // â€”â€” 5. å¼¹çª— æŸ¥çœ‹/ç¼–è¾‘/åˆ é™¤ â€”â€”ï¼ˆæ”¹åŠ¨ ID/Classï¼‰
    function openModal(id){
      activeRecord = allRecords.find(r=>r.id===id)
      modalBody.innerHTML = `
        <h2>è®°å½•è¯¦æƒ…</h2>
        <p><strong>åˆ›å»ºæ—¶é—´ï¼š</strong>${new Date(activeRecord.created_at).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai'})}</p>
        <p><strong>æ›´æ–°æ—¶é—´ï¼š</strong>${new Date(activeRecord.updated_at).toLocaleString('zh-CN',{timeZone:'Asia/Shanghai'})}</p>
        <p><strong>IPï¼š</strong>${activeRecord.ip||''}</p>
        <label>åŸæ–‡ï¼š<textarea id="m_o" style="width:100%;height:4rem">${activeRecord.original||''}</textarea></label>
        <label>ç¿»è¯‘ï¼š<textarea id="m_t" style="width:100%;height:4rem">${activeRecord.translated_en||''}</textarea></label>
      `
      modal.style.display = 'flex'
    }
    modalClose.onclick = ()=> modal.style.display='none'

    modalSave.onclick = async()=>{
      const o = document.getElementById('m_o').value
      const t = document.getElementById('m_t').value
      const { error } = await supa
        .from('translations')
        .update({ original:o, translated_en:t })
        .eq('id',activeRecord.id)
      if(error) alert('æ›´æ–°å¤±è´¥ï¼š'+error.message)
      else { modal.style.display='none'; loadPage(currentPage) }
    }
    modalDelete.onclick = async()=>{
      if(!confirm('ç¡®å®šè¦åˆ é™¤ï¼Ÿ')) return
      const { error } = await supa
        .from('translations')
        .delete()
        .eq('id',activeRecord.id)
      if(error) alert('åˆ é™¤å¤±è´¥ï¼š'+error.message)
      else { modal.style.display='none'; loadPage(currentPage) }
    }

    // â€”â€” 6. å¯åŠ¨ â€”â€” 
    loadPage(1)

  })()
  </script>
</body>
</html>
