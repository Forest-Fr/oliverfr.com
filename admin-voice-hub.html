<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ğŸ”‘ ç®¡ç†åå° Â· è¯­éŸ³åŠ©æ‰‹</title>
  <style>/* ... ä¿ç•™ä½ åŸæœ‰çš„æ ·å¼ ... */</style>
</head>
<body>
  <div id="container">
    <h1>ğŸ”‘ ç®¡ç†åå° Â· è¯­éŸ³åŠ©æ‰‹</h1>

    <!-- ç™»å½•åŒº -->
    <div id="authArea">
      <button id="loginBtn">ä½¿ç”¨ GitHub ç™»å½•</button>
    </div>

    <!-- ç®¡ç†åŒº -->
    <div id="adminArea" style="display:none">
      <button id="logoutBtn">é€€å‡ºç™»å½•</button>
      <table>
        <thead>â€¦</thead>
        <tbody id="recordsBody">
          <tr><td colspan="6">è¯·å…ˆç™»å½•â€¦</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
  (function(){
    const WORKER = location.origin;
    const authArea    = document.getElementById('authArea');
    const adminArea   = document.getElementById('adminArea');
    const loginBtn    = document.getElementById('loginBtn');
    const logoutBtn   = document.getElementById('logoutBtn');
    const recordsBody = document.getElementById('recordsBody');

    // 1. ç™»å½•è·³è½¬åˆ° Worker â†’ Supabase OAuth
    loginBtn.onclick = () => {
      location.href = 
        `${WORKER}/auth-proxy/auth/v1/authorize?provider=github&redirect_to=${encodeURIComponent(WORKER)}`;
    };

    // 2. ç™»å‡ºï¼šæ¸… Cookie å¹¶åˆ·æ–°
    logoutBtn.onclick = async () => {
      await fetch(`${WORKER}/auth-proxy/auth/v1/logout`, {
        method: 'POST',
        credentials: 'include'
      });
      location.reload();
    };

    // 3. æ£€æŸ¥æ˜¯å¦å·²ç™»å½•ï¼ˆçœ‹ Cookieï¼‰
    async function checkLogin() {
      const resp = await fetch(`${WORKER}/admin-api/check-session`, {
        credentials: 'include'
      });
      return resp.ok;
    }

    // 4. æ‹‰è®°å½•
    async function loadRecords() {
      recordsBody.innerHTML = '<tr><td colspan="6">åŠ è½½ä¸­â€¦</td></tr>';
      try {
        const resp = await fetch(`${WORKER}/admin-api/records`, {
          credentials: 'include'
        });
        if (!resp.ok) throw new Error(resp.status);
        const list = await resp.json();
        if (!list.length) {
          recordsBody.innerHTML = '<tr><td colspan="6">æš‚æ— è®°å½•</td></tr>';
        } else {
          recordsBody.innerHTML = list.map(r=>`
            <tr>
              <td>${new Date(r.created_at).toLocaleString()}</td>
              <td>${r.original||''}</td>
              <td>${r.translated_en||''}</td>
              <td>${r.tokens||''}</td>
              <td>${r.cost||''}</td>
              <td>${r.ip||''}</td>
            </tr>
          `).join('');
        }
      } catch(e) {
        recordsBody.innerHTML = `<tr><td colspan="6">æ‹‰å–å¤±è´¥ï¼š${e.message}</td></tr>`;
      }
    }

    // 5. åˆå§‹åŒ–ï¼šæ£€æŸ¥ç™»å½•çŠ¶æ€
    checkLogin().then(isLogin=>{
      if (isLogin) {
        authArea.style.display  = 'none';
        adminArea.style.display = 'block';
        loadRecords();
      } else {
        authArea.style.display  = 'block';
        adminArea.style.display = 'none';
      }
    });
  })();
  </script>
</body>
</html>
