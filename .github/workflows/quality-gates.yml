name: Quality Gates
 
on:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  smoke-and-lighthouse:
    runs-on: ubuntu-latest
    env:
      SITE_URL: ${{ secrets.SITE_URL }}
      TTS_API_URL: ${{ vars.TTS_API_URL }}
    steps:
      - uses: actions/checkout@v4

      # 1) 前端页面健康检查（允许 2xx/3xx）
      - name: Smoke check - page is reachable
        run: |
          set -Eeuo pipefail
          : "${SITE_URL:?SITE_URL is empty}"
          code=$(curl -ILs -o /dev/null -w "%{http_code}\n" "$SITE_URL")
          echo "HTTP $code"
          if [ "$code" -ge 200 ] && [ "$code" -lt 400 ]; then exit 0; else exit 1; fi

      # 2) （可选）后端 API 健康检查（200/401/403/404/405视为可接受）
      - name: Smoke check - API reachable (optional)
        if: env.TTS_API_URL != ''
        run: |
          set -Eeuo pipefail
          code=$(curl -fsSL -o /dev/null -w "%{http_code}\n" "$TTS_API_URL" || true)
          echo "HTTP $code"
          case "$code" in 200|401|403|404|405) exit 0 ;; *) exit 1 ;; esac

      # 2.5) 先验证配置文件真的在仓库根目录
      - name: Verify lhci config exists at repo root
        run: |
          echo "PWD=$(pwd)"
          ls -la
          test -f .lighthouserc.json || (echo "MISSING: .lighthouserc.json at repo root" && exit 1)
          echo "Found .lighthouserc.json"

      # 3) Lighthouse
      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: ${{ env.SITE_URL }}
          uploadArtifacts: true
          temporaryPublicStorage: true
          configPath: .lighthouserc.json
