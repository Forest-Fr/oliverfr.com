<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Document Platform Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-page: #0b1120;
      --bg-card: #020617;
      --bg-soft: #020617;
      --border-subtle: rgba(148, 163, 184, 0.3);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-strong: #0ea5e9;
      --danger: #ef4444;
      --success: #22c55e;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-card: 0 18px 45px rgba(15, 23, 42, 0.65);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* È°∂ÈÉ®Ê†è */
    .topbar {
      padding: 10px 18px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.75));
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #38bdf8 40%, #0f172a 80%);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.6),
                  0 0 25px rgba(56, 189, 248, 0.9);
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.02em;
    }

    .title-block span {
      font-size: 11px;
      color: var(--text-sub);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-subtle);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.85);
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #6b7280;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .status-dot.ok {
      background: var(--success);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }

    .status-dot.bad {
      background: var(--danger);
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.9);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      padding: 6px 14px;
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
    }

    .btn-primary {
      background: linear-gradient(to right, var(--accent), var(--accent-strong));
      border-color: transparent;
      color: #0f172a;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(56, 189, 248, 0.45);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
    }

    .btn-primary:hover {
      box-shadow: 0 12px 28px rgba(56, 189, 248, 0.6);
    }

    .btn-icon {
      font-size: 14px;
    }

    /* ‰∏ªÂ∏ÉÂ±Ä */
    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap: 14px;
      padding: 14px 18px 18px;
    }

    /* Â∑¶‰æßÂàóË°® */
    .sidebar {
      background: radial-gradient(circle at top left, #020617 0, #020617 60%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-card);
      padding: 14px 14px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      /* ===== [PATCH INSERT] enable absolute children in sidebar (non-breaking) ===== */
position: relative;
/* ===== [PATCH END] ===== */

    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 4px;
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .tag-pill {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-sub);
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 7px 10px 7px 24px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
    }

    .search-box input::placeholder {
      color: #6b7280;
    }

    .search-box-icon {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: #6b7280;
    }

    .doc-list {
      margin: 0;
      padding: 4px 0 0;
      list-style: none;
      flex: 1;
      overflow: auto;
            /* ===== [PATCH INSERT] make scrollbar visible (non-breaking) ===== */
      scrollbar-width: thin;                 /* Firefox */
      scrollbar-color: rgba(148,163,184,.55) transparent;

    }
    /* ===== [PATCH INSERT] webkit scrollbar (non-breaking) ===== */
    .doc-list::-webkit-scrollbar { width: 10px; }
    .doc-list::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,.45);
      border-radius: 999px;
      border: 2px solid rgba(2,6,23,.8);
    }
    .doc-list::-webkit-scrollbar-track { background: transparent; }

    .doc-item {
      padding: 8px 8px;
      border-radius: 10px;
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.12s ease-out, transform 0.12s ease-out;
    }

    .doc-item:hover {
      background: rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .doc-item.active {
      background: linear-gradient(to right, rgba(56, 189, 248, 0.2), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(56, 189, 248, 0.7);
    }

    .doc-icon {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      background: rgba(30, 64, 175, 0.6);
      color: #e5e7eb;
    }

    .doc-meta {
      flex: 1;
      overflow: hidden;
    }

    .doc-name {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .doc-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .doc-status-pill {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #9ca3af;
      white-space: nowrap;
    }

    .doc-status-pill.ready {
      border-color: rgba(34, 197, 94, 0.85);
      color: var(--success);
    }

    .doc-status-pill.processing {
      border-color: rgba(234, 179, 8, 0.9);
      color: #facc15;
    }

    /* Âè≥‰æß‰∏ª‰Ωì */
    .main {
      background: radial-gradient(circle at top right, #020617 0, #020617 60%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-card);
      padding: 14px 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .main-title {
      font-size: 15px;
      font-weight: 600;
    }

    .main-subtitle {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .main-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tab-bar {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .tab-btn {
      border: none;
      background: transparent;
      color: var(--text-sub);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
    }

    .tab-btn.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .main-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    .card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }

    .upload-zone {
      border-radius: 10px;
      border: 1px dashed rgba(75, 85, 99, 1);
      padding: 14px 10px;
      text-align: center;
      cursor: pointer;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.95));
      transition: border-color 0.15s ease-out, background 0.15s ease-out;
    }

    .upload-zone.dragover {
      border-color: var(--accent);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.8), rgba(8, 47, 73, 0.95));
    }

    .upload-main {
      font-size: 13px;
      margin-bottom: 4px;
    }

    .upload-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .upload-zone input[type="file"] {
      display: none;
    }

    .upload-btn-row {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .upload-list {
      margin: 6px 0 0;
      padding: 0;
      list-style: none;
      max-height: 140px;
      overflow: auto;
      font-size: 11px;
    }

    .upload-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 4px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.8);
      margin-bottom: 3px;
    }

    .upload-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .upload-status {
      color: var(--text-sub);
      white-space: nowrap;
    }

    .upload-status.ok {
      color: var(--success);
    }

    .upload-status.error {
      color: var(--danger);
    }

    .preview-frame {
      flex: 1;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top, #020617, #020617);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      font-size: 12px;
    }

    .preview-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
    }

    .meta-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .meta-table tr + tr {
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .meta-table th,
    .meta-table td {
      padding: 5px 4px;
      text-align: left;
    }

    .meta-table th {
      width: 90px;
      color: var(--text-sub);
      font-weight: 400;
    }

    /* Toast */
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-main);
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 50;
      box-shadow: 0 15px 40px rgba(15, 23, 42, 0.8);
    }

    .toast.show {
      display: flex;
    }

    .toast.ok {
      border-color: rgba(34, 197, 94, 0.9);
    }

    .toast.error {
      border-color: rgba(239, 68, 68, 0.9);
    }

/* ===== [PATCH INSERT] sidebar scroll arrows (non-breaking) ===== */
.scroll-arrows {
  position: absolute;
  right: 10px;
  top: 92px;               /* ÈÅøÂºÄÊ†áÈ¢ò‰∏éÊêúÁ¥¢Ê°Ü */
  bottom: 12px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  pointer-events: none;    /* ÂÆπÂô®‰∏çÂêÉÁÇπÂáªÔºåÂè™ËÆ©ÊåâÈíÆÂêÉ */
  z-index: 5;
}

.scroll-btn {
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.85);
  color: var(--text-main);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  pointer-events: auto;
  opacity: 0;
  transform: translateY(0);
  transition: opacity .15s ease-out, transform .15s ease-out;
  box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
}

.scroll-btn.show {
  opacity: 1;
}

.scroll-btn:active {
  transform: translateY(1px);
}

@media (max-width: 900px) {
  .scroll-arrows { top: 86px; }
}
/* ===== [PATCH END] ===== */

    
    /* ÁßªÂä®Á´ØÈÄÇÈÖç */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        padding: 10px;
      }

      .sidebar {
        order: 2;
        height: 220px;
      }

      .main {
        order: 1;
      }

      .main-body {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="topbar-left">
      <div class="logo-dot"></div>
      <div class="title-block">
        <h1>Document Platform Console</h1>
        <span>Áªü‰∏ÄÊñáÊ°£‰∏ä‰º† / È¢ÑËßà / ÂØºÂá∫ ¬∑ Cloud Run + Cloudflare Worker</span>
      </div>
    </div>
    <div class="topbar-right">
      <div class="pill">
        <span class="status-dot" id="healthDot"></span>
        <span id="healthText">Checking...</span>
      </div>
      <div class="pill">
        <span>ÁéØÂ¢É</span>
        <strong id="envLabel">prod</strong>
      </div>
      <button class="btn" id="btnToggleMock">
        <span class="btn-icon">üß™</span>
        <span>Mock Êï∞ÊçÆ</span>
      </button>
      <button class="btn-primary btn" id="btnNewUpload">
        <span class="btn-icon">Ôºã</span>
        <span>‰∏ä‰º†ÊñáÊ°£</span>
      </button>
    </div>
  </header>

  <main class="layout">
    <!-- Â∑¶‰æßÔºöÊñáÊ°£ÂàóË°® -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Documents</div>
        <div class="tag-pill" id="docCountTag">0 items</div>
      </div>

      <div class="search-box">
        <span class="search-box-icon">üîç</span>
        <input type="search" id="searchInput" placeholder="ÊêúÁ¥¢Êñá‰ª∂Âêç / Á±ªÂûã..." />
      </div>

      <ul class="doc-list" id="docList"></ul>

    <!-- ===== [PATCH INSERT] sidebar scroll arrows (non-breaking) ===== -->
<div class="scroll-arrows" aria-hidden="true">
  <button class="scroll-btn" id="btnScrollUp" title="Âêë‰∏ä">‚ñ≤</button>
  <button class="scroll-btn" id="btnScrollDown" title="Âêë‰∏ã">‚ñº</button>
</div>
<!-- ===== [PATCH END] ===== -->
  
    </aside>

    <!-- Âè≥‰æßÔºö‰∏ä‰º† + È¢ÑËßà + ËØ¶ÊÉÖ -->
    <section class="main">
      <div class="main-header">
        <div>
          <div class="main-title">ÊñáÊ°£Â∑•‰ΩúÂè∞</div>
          <div class="main-subtitle" id="mainSubtitle">
            Âè≥‰æß‰∏ä‰º†Êñá‰ª∂ÔºåÂ∑¶‰æßÊü•ÁúãÂàóË°®ÔºõÂêéÁ´ØÈÄöËøá Worker ÂÜôÂÖ• r1doc GCS Ê°∂„ÄÇ
          </div>
        </div>
        <div class="main-header-right">
          <div class="tab-bar">
            <button class="tab-btn active" data-tab="upload">‰∏ä‰º†</button>
            <button class="tab-btn" data-tab="preview">È¢ÑËßà</button>
            <button class="tab-btn" data-tab="meta">ËØ¶ÊÉÖ</button>
          </div>
        </div>
      </div>

      <div class="main-body">
        <!-- Â∑¶Ôºö‰∏ä‰º†Âå∫ / ËØ¶ÊÉÖÔºàÈöè tab ÂàáÊç¢Ôºâ -->
        <div class="card" id="cardLeft">
          <div class="card-header">
            <div>
              <div class="card-title" id="cardLeftTitle">‰∏ä‰º†ÊñáÊ°£</div>
              <div class="card-subtitle" id="cardLeftSubtitle">
                ÊîØÊåÅ Excel / Word / PDF Á≠âÂ∏∏ËßÅÂäûÂÖ¨Êñá‰ª∂ÔºåÂçïÊñá‰ª∂ÊúÄÂ§ßÂª∫ËÆÆ &lt; 20MB„ÄÇ
              </div>
            </div>
          </div>

          <!-- Upload ÂÜÖÂÆπ -->
          <div id="uploadSection">
            <div class="upload-zone" id="uploadZone">
              <div class="upload-main">ÊãñÊãΩÊñá‰ª∂Âà∞Ê≠§Â§ÑÔºåÊàñÁÇπÂáªÈÄâÊã©Êñá‰ª∂</div>
              <div class="upload-sub">Ëá™Âä®ÂΩíÊ°£Âà∞ÂêéÁ´ØÁöÑ r1doc GCS Ê°∂ ¬∑ Â§öÊñá‰ª∂‰∏ä‰º†ÂèØÊâπÈáèÂ§ÑÁêÜ</div>
              <div class="upload-btn-row">
                <label class="btn">
                  <span class="btn-icon">üìÅ</span>
                  <span>ÈÄâÊã©Êñá‰ª∂</span>
                  <input id="fileInput" type="file" multiple />
                </label>
              </div>
            </div>

            <ul class="upload-list" id="uploadList"></ul>
          </div>

          <!-- Meta ÂÜÖÂÆπÔºàtab ÂàáÊç¢ÊòæÁ§∫Ôºâ -->
          <div id="metaSection" style="display:none;">
            <table class="meta-table">
              <tbody id="metaBody">
                <tr><th>Êñá‰ª∂Âêç</th><td id="metaName">-</td></tr>
                <tr><th>Á±ªÂûã</th><td id="metaKind">-</td></tr>
                <tr><th>Â§ßÂ∞è</th><td id="metaSize">-</td></tr>
                <tr><th>Áä∂ÊÄÅ</th><td id="metaStatus">-</td></tr>
                <tr><th>ÂàõÂª∫Êó∂Èó¥</th><td id="metaCreated">-</td></tr>
                <tr><th>‰∏ãËΩΩÂú∞ÂùÄ</th><td id="metaDownload">-</td></tr>
                <tr><th>È¢ÑËßàÂú∞ÂùÄ</th><td id="metaPreview">-</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Âè≥ÔºöÈ¢ÑËßà -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">ÊñáÊ°£È¢ÑËßà</div>
              <div class="card-subtitle" id="previewSubtitle">
                ÈÄâÊã©Â∑¶‰æßÂàóË°®‰∏≠ÁöÑÊñáÊ°£ÂêéÔºåÂú®Ê≠§Â§ÑËøõË°å PDF / Office Âú®Á∫øÈ¢ÑËßàÔºàÁî±ÂêéÁ´Ø Worker Êèê‰æõÔºâ„ÄÇ
              </div>
            </div>
            <!-- ===== [PATCH INSERT] unified preview actions (non-breaking) ===== -->
<button class="btn" id="btnDownloadRaw" disabled>‰∏ãËΩΩ</button>
<button class="btn" id="btnRefreshSelected" disabled>Âà∑Êñ∞</button>
<!-- ===== [PATCH END] ===== -->

            <button class="btn" id="btnOpenRaw" disabled>
              Âú®Êñ∞Á™óÂè£ÊâìÂºÄ
            </button>
          </div>
          <div class="preview-frame" id="previewFrame">
            <span id="previewPlaceholder">Â∞öÊú™ÈÄâÊã©‰ªª‰ΩïÊñáÊ°£„ÄÇ</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">
    <span id="toastIcon">‚ÑπÔ∏è</span>
    <span id="toastText">Message</span>
  </div>

  <script>
    // ============ Âü∫Á°ÄÈÖçÁΩÆ ============

// 1) ÊîπÊàê‰Ω†ÁöÑ Cloudflare Worker Âú∞ÂùÄÔºà‰Ω†Áé∞Âú®ÁöÑÁõÆÊ†áËÅîÂä®ÂêéÁ´ØÔºâ
const API_BASE ='https://doc.mefans.workers.dev';

// ÂèØÈÄâÔºöÂ¶ÇÊûú Worker ÂºÄ‰∫Ü API_KEY Ê†°È™åÔºàenv.API_KEYÔºâÔºåËøôÈáåÂ°´Âêå‰∏ÄÊää keyÔºà‰∏çÂ°´Âàô‰øùÊåÅÁ©∫Â≠óÁ¨¶‰∏≤Ôºâ
const API_KEY = '';

// 2) ÊòØÂê¶‰ΩøÁî®ÂâçÁ´Ø Mock Êï∞ÊçÆ
// ËßÑÂàôÔºöÊú¨Âú∞Ôºàlocalhost / fileÔºâÈªòËÆ§ MockÔºõÁ∫ø‰∏äÈªòËÆ§Áõ¥ËøûÂêéÁ´ØÔºõÂèØÁî® ?mock=1 Âº∫Âà∂ Mock
const _qs = new URLSearchParams(location.search);
const _forceMock = _qs.get('mock') === '1';
const _forceLive = _qs.get('live') === '1';
const _isLocal = (location.protocol === 'file:') || /localhost|127\.0\.0\.1/i.test(location.hostname);

let USE_MOCK = _forceMock ? true : (_forceLive ? false : _isLocal);


    const state = {
      docs: [],
      filteredDocs: [],
      selectedDocId: null,
      pendingUploads: []
    };

    // ============ Â∑•ÂÖ∑ÂáΩÊï∞ ============

    function showToast(message, type = 'info', timeout = 2600) {
      const toast = document.getElementById('toast');
      const textEl = document.getElementById('toastText');
      const iconEl = document.getElementById('toastIcon');

      textEl.textContent = message;
      toast.classList.remove('ok', 'error');
      if (type === 'ok') {
        toast.classList.add('ok');
        iconEl.textContent = '‚úÖ';
      } else if (type === 'error') {
        toast.classList.add('error');
        iconEl.textContent = '‚ö†Ô∏è';
      } else {
        iconEl.textContent = '‚ÑπÔ∏è';
      }

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), timeout);
    }

    function formatBytes(bytes) {
      if (!bytes && bytes !== 0) return '-';
      const units = ['B', 'KB', 'MB', 'GB'];
      let b = Number(bytes);
      let u = 0;
      while (b >= 1024 && u < units.length - 1) {
        b /= 1024;
        u++;
      }
      return b.toFixed(1) + ' ' + units[u];
    }

    function formatTime(ts) {
      if (!ts) return '-';
      try {
        const d = new Date(ts);
        return d.toLocaleString('zh-CN', { hour12: false });
      } catch {
        return ts;
      }
    }

    // ÁÆÄÂçï fetch Â∞ÅË£Ö
    async function apiFetch(path, options = {}) {
      const url = API_BASE.replace(/\/$/, '') + path;
      const resp = await fetch(url, {
        ...options,
headers: {
  'Accept': 'application/json',
  ...(API_KEY ? { 'x-api-key': API_KEY } : {}),
  ...(options.headers || {})
}

      });
      const ct = resp.headers.get('content-type') || '';
      let body = null;
      if (ct.includes('application/json')) {
        body = await resp.json();
      } else {
        body = await resp.text();
      }

      if (!resp.ok) {
        const err = new Error('HTTP ' + resp.status);
        err.status = resp.status;
        err.body = body;
        throw err;
      }
      return body;
    }

    // ===== [PATCH BEGIN] robust helpers for live chain (non-breaking) =====
function _joinUrl(base, path) {
  const b = (base || '').replace(/\/+$/, '');
  const p = (path || '').startsWith('/') ? path : '/' + path;
  return b + p;
}

async function apiTry(paths, options = {}) {
  let lastErr = null;
  for (const p of paths) {
    try {
      return await apiFetch(p, options);
    } catch (e) {
      lastErr = e;
    }
  }
  throw lastErr || new Error('All endpoints failed');
}

function _uuidv4() {
  // ‰ºòÂÖàÁî® crypto.randomUUIDÔºõ‰∏çÊîØÊåÅÂàô fallback
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  const buf = new Uint8Array(16);
  crypto.getRandomValues(buf);
  buf[6] = (buf[6] & 0x0f) | 0x40;
  buf[8] = (buf[8] & 0x3f) | 0x80;
  const hex = [...buf].map(b => b.toString(16).padStart(2, '0')).join('');
  return `${hex.slice(0, 8)}-${hex.slice(8, 12)}-${hex.slice(12, 16)}-${hex.slice(16, 20)}-${hex.slice(20)}`;
}

function _inferKindFromAny(x) {
  const k = (x || '').toString().toLowerCase();
  if (k.includes('pdf')) return 'pdf';
  if (k.includes('word') || k.includes('doc')) return 'word';
  if (k.includes('excel') || k.includes('xls') || k.includes('sheet') || k.includes('csv')) return 'excel';
  return 'other';
}

function _buildWorkerDownloadUrl(storagePath) {
  if (!storagePath) return null;
  return _joinUrl(API_BASE, '/download') + '?key=' + encodeURIComponent(storagePath);
}

function _normalizeDoc(raw) {
  const r = raw && typeof raw === 'object' ? raw : {};
  const files = Array.isArray(r.files) ? r.files : [];

  // ‰ºòÂÖàÁî® input/output Êñá‰ª∂ËæÖÂä©Ë°•ÈΩêÂ≠óÊÆµ
  const inputFile = files.find(f => String(f?.file_role || '').toLowerCase() === 'input') || null;
  const outputFile = files.find(f => String(f?.file_role || '').toLowerCase() === 'output') || null;

  const id = r.id || r.job_id || r.doc_id || (r.job && r.job.id) || null;

  // ===== [PATCH INSERT BEGIN] prefer original filename for display (non-breaking) =====
  function _basenameLike(s) {
    const v = String(s || '');
    const noQuery = v.split('?')[0];
    const last = noQuery.split('/').pop();
    return (last || v || '').trim();
  }

  // ‰ºòÂÖàÂ±ïÁ§∫‚ÄúÁî®Êà∑ÂéüÂßãÊñá‰ª∂Âêç‚ÄùÔºåÈÅøÂÖçÂêéÁ´Ø name=storage_path / uuid ÂØºËá¥ÂàóË°®Áúã‰∏çÊáÇ
  const name =
    _basenameLike(
      r.original_name ||
      r.filename ||
      inputFile?.original_name ||
      inputFile?.name ||
      r.name ||
      '(Êó†ÂêçÁß∞)'
    );
  // ===== [PATCH INSERT END] prefer original filename for display (non-breaking) =====


  const kind =
    r.kind ||
    r.file_type ||
    inputFile?.file_type ||
    _inferKindFromAny(name);

  const sizeBytes =
    r.size_bytes ||
    r.size ||
    inputFile?.size_bytes ||
    inputFile?.size ||
    null;

  const createdAt =
    r.created_at ||
    r.inserted_at ||
    (r.job && r.job.created_at) ||
    inputFile?.created_at ||
    null;

  const status =
    r.status ||
    r.job_status ||
    (r.job && r.job.status) ||
    'unknown';

  // preview/download ‰ºòÂÖàÁî®ÂêéÁ´ØÁõ¥Êé•ÁªôÁöÑ urlÔºõÂê¶ÂàôÁî® storage_path Êãº Worker /download
  const previewUrl =
    r.preview_url ||
    r.previewUrl ||
    outputFile?.preview_url ||
    outputFile?.signed_url ||
    outputFile?.url ||
    (outputFile?.storage_path ? _buildWorkerDownloadUrl(outputFile.storage_path) : null);

  const downloadUrl =
    r.download_url ||
    r.downloadUrl ||
    outputFile?.download_url ||
    outputFile?.signed_url ||
    outputFile?.url ||
    (outputFile?.storage_path ? _buildWorkerDownloadUrl(outputFile.storage_path) : null);

  return {
    id,
    name,
    kind,
    size_bytes: sizeBytes,
    created_at: createdAt,
    status,
    preview_url: previewUrl,
    download_url: downloadUrl,
    _raw: r
  };
}

function _normalizeDocsResponse(data) {
  // ÂÖºÂÆπÔºöArray / {docs:[]} / {items:[]} / {data:[]} / {jobs:[]} Á≠â
  let arr = [];
  if (Array.isArray(data)) arr = data;
  else if (data && typeof data === 'object') {
    if (Array.isArray(data.docs)) arr = data.docs;
    else if (Array.isArray(data.items)) arr = data.items;
    else if (Array.isArray(data.data)) arr = data.data;
    else if (Array.isArray(data.jobs)) arr = data.jobs;
    else if (Array.isArray(data.documents)) arr = data.documents;
  }
  return arr.map(_normalizeDoc).filter(d => d.id);
}
// ===== [PATCH END] =====
// ===== [PATCH INSERT] pending uploads merge (non-breaking) =====
function _sameName(a, b) {
  const x = String(a || '').trim().toLowerCase();
  const y = String(b || '').trim().toLowerCase();
  return x && y && x === y;
}

function _mergePendingIntoDocs(serverDocs) {
  const arr = Array.isArray(serverDocs) ? serverDocs.slice() : [];
  const byId = new Map(arr.map(d => [d.id, d]));

  // Âè™Êää‚Äú‰ªçÊú™Âú®ÊúçÂä°Á´ØÂá∫Áé∞‚ÄùÁöÑ pending ÂêàÂπ∂ÂõûÂéª
  const remain = [];
  for (const p of (state.pendingUploads || [])) {
    const hitById = p && p.id && byId.has(p.id);
    const hitByName = arr.some(s => _sameName(s?.name, p?.name));
    if (hitById || hitByName) {
      // ÊúçÂä°Á´ØÂ∑≤Âá∫Áé∞Ôºö‰∏çÂÜç‰øùÁïô pending
      continue;
    }
    remain.push(p);
    if (p && p.id && !byId.has(p.id)) {
      arr.unshift(p); // pending ÊîæÊúÄÂâçÔºåËÆ©Áî®Êà∑Á´ãÂàªÁúãÂà∞
      byId.set(p.id, p);
    } else if (p && !p.id) {
      arr.unshift(p);
    }
  }

  state.pendingUploads = remain;
  return arr;
}
// ===== [PATCH END] =====


    // ============ Health Ê£ÄÊü• ============

async function refreshHealth() {
  const dot = document.getElementById('healthDot');
  const text = document.getElementById('healthText');

  dot.classList.remove('ok', 'bad');
  text.textContent = 'Checking...';

  try {
    let data;
    if (USE_MOCK) {
      data = { status: 'ok', env: 'dev', ts: new Date().toISOString() };
      await new Promise(r => setTimeout(r, 300));
    } else {
      data = await apiTry(['/health', '/healthz', '/'], { method: 'GET' });
    }
    dot.classList.add('ok');
    text.textContent = 'Healthy ¬∑ ' + (data.env || 'unknown');
    document.getElementById('envLabel').textContent = data.env || 'prod';
  } catch (e) {
    dot.classList.add('bad');
    text.textContent = 'Unhealthy';
    showToast('Health Ê£ÄÊü•Â§±Ë¥•Ôºö' + (e.message || e), 'error');
  }
}


    // ============ Mock Êï∞ÊçÆ ============

    function buildMockDocs() {
      const now = new Date();
      const iso = (offsetMin) => new Date(now.getTime() - offsetMin * 60000).toISOString();

      return [
        {
          id: 'doc_mock_001',
          name: 'Á§∫‰æãÊä•Ë°®-Â≠£Â∫¶Êî∂ÂÖ•.xlsx',
          kind: 'excel',
          size_bytes: 234567,
          created_at: iso(10),
          status: 'ready',
          preview_url: 'https://example.com/preview/mock1',
          download_url: 'https://example.com/download/mock1'
        },
        {
          id: 'doc_mock_002',
          name: 'SLA-ÊúçÂä°ÂçèËÆÆ-v1.2.docx',
          kind: 'word',
          size_bytes: 145678,
          created_at: iso(60),
          status: 'processing',
          preview_url: null,
          download_url: 'https://example.com/download/mock2'
        },
        {
          id: 'doc_mock_003',
          name: 'Âπ≥Âè∞ÊÄª‰ΩìÊû∂ÊûÑÂõæ.pdf',
          kind: 'pdf',
          size_bytes: 756231,
          created_at: iso(180),
          status: 'ready',
          preview_url: 'https://example.com/preview/mock3',
          download_url: 'https://example.com/download/mock3'
        }
      ];
    }

async function loadDocs() {
  let docs;
  if (USE_MOCK) {
    docs = buildMockDocs();
    state.docs = docs;
    applyFilter();
    return;
  }

  // LiveÔºöÂ∞ùËØïÂ§ö‰∏™ÂèØËÉΩÁöÑ Worker ÂàóË°®Á´ØÁÇπÔºàÈÅøÂÖçÂêéÁ´ØË∑ØÂæÑÂèòÂä®ÂØºËá¥ÂâçÁ´Ø‰∏çÂèØÁî®Ôºâ
  const data = await apiTry(
    ['/v1/docs', '/docs', '/v1/doc-jobs', '/api/doc-jobs', '/v1/doc-files', '/api/doc-files'],
    { method: 'GET' }
  );

const serverDocs = _normalizeDocsResponse(data);
state.docs = _mergePendingIntoDocs(serverDocs);
applyFilter();

}


    function applyFilter() {
      const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      let list = state.docs;
      if (q) {
        list = list.filter(d => (d.name || '').toLowerCase().includes(q));
      }
      state.filteredDocs = list;
      renderDocList();
    }

    function renderDocList() {
      const ul = document.getElementById('docList');
      ul.innerHTML = '';
      const countTag = document.getElementById('docCountTag');
      countTag.textContent = state.filteredDocs.length + ' items';

      state.filteredDocs.forEach(doc => {
        const li = document.createElement('li');
        li.className = 'doc-item' + (doc.id === state.selectedDocId ? ' active' : '');
        li.dataset.id = doc.id;

        const icon = document.createElement('div');
        icon.className = 'doc-icon';
        const k = (doc.kind || '?').substring(0, 1).toUpperCase();
        icon.textContent = k;

        const meta = document.createElement('div');
        meta.className = 'doc-meta';

        const name = document.createElement('div');
        name.className = 'doc-name';
        name.textContent = doc.name || '(Êó†ÂêçÁß∞)';

        const sub = document.createElement('div');
        sub.className = 'doc-sub';
        sub.textContent = (doc.kind || '-') + ' ¬∑ ' + formatBytes(doc.size_bytes) + ' ¬∑ ' + formatTime(doc.created_at);

        meta.appendChild(name);
        meta.appendChild(sub);

        const status = document.createElement('div');
        status.className = 'doc-status-pill ' + (doc.status || '');
        status.textContent = doc.status || '-';

        li.appendChild(icon);
        li.appendChild(meta);
        li.appendChild(status);
        ul.appendChild(li);
      });
    }

    function getSelectedDoc() {
      return state.docs.find(d => d.id === state.selectedDocId) || null;
    }

    function selectDoc(docId) {
      state.selectedDocId = docId;
      renderDocList();
      updateMetaPanel();
      updatePreviewPanel();
        // ===== [PATCH INSERT BEGIN] auto scroll selected item into view (non-breaking) =====
  requestAnimationFrame(() => {
    const li = document.querySelector(`.doc-item[data-id="${CSS && CSS.escape ? CSS.escape(docId) : docId}"]`);
    if (li && li.scrollIntoView) li.scrollIntoView({ block: 'nearest', inline: 'nearest' });
  });
  // ===== [PATCH INSERT END] auto scroll selected item into view (non-breaking) =====

    }

    function updateMetaPanel() {
      const doc = getSelectedDoc();
      document.getElementById('metaName').textContent = doc ? doc.name : '-';
      document.getElementById('metaKind').textContent = doc ? doc.kind : '-';
      document.getElementById('metaSize').textContent = doc ? formatBytes(doc.size_bytes) : '-';
      document.getElementById('metaStatus').textContent = doc ? doc.status : '-';
      document.getElementById('metaCreated').textContent = doc ? formatTime(doc.created_at) : '-';

      const downloadEl = document.getElementById('metaDownload');
      const previewEl = document.getElementById('metaPreview');
      //downloadEl.textContent = doc && doc.download_url ? doc.download_url : '-';
      //previewEl.textContent = doc && doc.preview_url ? doc.preview_url : '-';
      downloadEl.innerHTML = (doc && doc.download_url)
  ? `<a href="${doc.download_url}" target="_blank" rel="noopener noreferrer">${doc.download_url}</a>`
  : '-';

previewEl.innerHTML = (doc && doc.preview_url)
  ? `<a href="${doc.preview_url}" target="_blank" rel="noopener noreferrer">${doc.preview_url}</a>`
  : '-';

    }

    function updatePreviewPanel() {
      const frame = document.getElementById('previewFrame');
      frame.innerHTML = '';
      const btnOpen = document.getElementById('btnOpenRaw');
const btnDownload = document.getElementById('btnDownloadRaw');
const btnRefresh = document.getElementById('btnRefreshSelected');

      const doc = getSelectedDoc();
      if (!doc) {
        const span = document.createElement('span');
        span.id = 'previewPlaceholder';
        span.textContent = 'Â∞öÊú™ÈÄâÊã©‰ªª‰ΩïÊñáÊ°£„ÄÇ';
        frame.appendChild(span);
        btnOpen.disabled = true;
        btnDownload.disabled = true;
btnRefresh.disabled = true;

        return;
      }

      // ===== [PATCH INSERT BEGIN] preview iframe for pdf + office (non-breaking) =====
      function _isPdfUrl(u) {
        try {
          const clean = String(u || '').split('?')[0].toLowerCase();
          return clean.endsWith('.pdf');
        } catch { return false; }
      }

      function _buildOfficeEmbedUrl(rawUrl) {
        // Office Âú®Á∫øÈ¢ÑËßàÂøÖÈ°ªÁî®ÂèØÂÖ¨ÁΩëËÆøÈóÆÁöÑÊñá‰ª∂ URLÔºõËøôÈáåÁî® MS Office Viewer embed
        return 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(rawUrl);
      }

      const urlForPreview = doc.preview_url || null;
      const urlForDownload = doc.download_url || null;

if (urlForPreview) {
  const iframe = document.createElement('iframe');

  const isPdf = (doc.kind === 'pdf') || _isPdfUrl(urlForPreview);
  const isOffice = (doc.kind === 'word' || doc.kind === 'excel');

  // Â¶ÇÊûú preview_url Êú¨Ë∫´Â∞±ÊòØ pdf ÊàñÂ∑≤ÊòØ office viewerÔºåÂàôÁõ¥Êé•Áî®
  if (isPdf || String(urlForPreview).includes('officeapps.live.com')) {
    iframe.src = urlForPreview;
  } else if (isOffice) {
    // preview_url ÊåáÂêë docx/xlsx Á≠âÊó∂ÔºåËµ∞ Office Viewer ‰ª•Ëé∑ÂæóÊõ¥Á®≥ÂÆöÈ¢ÑËßà
    iframe.src = _buildOfficeEmbedUrl(urlForPreview);
  } else {
    iframe.src = urlForPreview;
  }

  frame.appendChild(iframe);
      } else if (urlForDownload) {
        // ÂêéÁ´ØÊ≤°Áªô preview_urlÔºåÂàôÊ†πÊçÆÁ±ªÂûãÁî® download_url Â∞ùËØïÁîüÊàêÂèØÁî®È¢ÑËßà
        const iframe = document.createElement('iframe');

        if (doc.kind === 'pdf' || _isPdfUrl(urlForDownload)) {
          iframe.src = urlForDownload;
          frame.appendChild(iframe);
        } else if (doc.kind === 'word' || doc.kind === 'excel') {
          iframe.src = _buildOfficeEmbedUrl(urlForDownload);
          frame.appendChild(iframe);
        } else {
          const span = document.createElement('span');
          span.textContent = 'ËØ•Êñá‰ª∂Á±ªÂûãÊöÇ‰∏çÊîØÊåÅÂÜÖÂµåÈ¢ÑËßàÔºåÂèØÁÇπÂáªÂè≥‰∏äËßíÂú®Êñ∞Á™óÂè£ÊâìÂºÄ„ÄÇ';
          frame.appendChild(span);
        }
      } else {
        const span = document.createElement('span');
        span.textContent = 'ËØ•ÊñáÊ°£Â∞öÊú™ÁîüÊàêÈ¢ÑËßàÔºåËØ∑Á®çÂêéÂà∑Êñ∞„ÄÇ';
        frame.appendChild(span);
      }
      // ===== [PATCH INSERT END] preview iframe for pdf + office (non-breaking) =====


   const hasLink = !!(doc.preview_url || doc.download_url);
btnOpen.disabled = !hasLink;
btnDownload.disabled = !hasLink;
btnRefresh.disabled = !doc; // ÈÄâ‰∏≠ÊñáÊ°£Âç≥ÂèØÂà∑Êñ∞

    }

    // ============ ‰∏ä‰º†ÈÄªËæëÔºàÂâçÁ´ØÂç†‰ΩçÔºåÂêéÁ´ØÂÆûÁé∞ÂêéÁõ¥Êé•ÊâìÈÄöÔºâ ============

    function bindUploadZone() {
      const zone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');

      function openFileDialog() {
        fileInput.click();
      }

   // ===== [PATCH INSERT BEGIN] prevent double-trigger file dialog (non-breaking) =====
zone.addEventListener('click', (e) => {
  // ÁÇπÂáªÂÜÖÈÉ® label / input / button Êó∂Ôºå‰∏çÂÜçËÆ© zone ÂÜçÊ¨°Ëß¶Âèë fileInput.click()
  if (e.target && e.target.closest && (
    e.target.closest('label') ||
    e.target.closest('input[type="file"]') ||
    e.target.closest('button') ||
    e.target.closest('a')
  )) {
    return;
  }
  openFileDialog();
});

// È¢ùÂ§ñÂÖúÂ∫ïÔºölabel Ëá™Ë∫´ÁÇπÂáªÊó∂ÈòªÊ≠¢ÂÜíÊ≥°ÔºåÂΩªÂ∫ïÈÅøÂÖç‚ÄúÁÇπ‰∏ÄÊ¨°Ëß¶Âèë‰∏§Ê¨°‚Äù
try {
  const _label = zone.querySelector('label');
  if (_label) _label.addEventListener('click', (ev) => ev.stopPropagation());
} catch {}
// ===== [PATCH INSERT END] prevent double-trigger file dialog (non-breaking) =====


      ;['dragenter', 'dragover'].forEach(ev => {
        zone.addEventListener(ev, e => {
          e.preventDefault();
          e.stopPropagation();
          zone.classList.add('dragover');
        });
      });

      ;['dragleave', 'drop'].forEach(ev => {
        zone.addEventListener(ev, e => {
          e.preventDefault();
          e.stopPropagation();
          zone.classList.remove('dragover');
        });
      });

      zone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files && files.length) {
          handleFiles(files);
        }
      });

      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length) {
          handleFiles(fileInput.files);
          fileInput.value = '';
        }
      });
    }

async function handleFiles(fileList) {
  const uploadList = document.getElementById('uploadList');

  // FileList Âú®Áé∞‰ª£ÊµèËßàÂô®ÂèØËø≠‰ª£ÔºõËøôÈáåËΩ¨Êï∞ÁªÑÊõ¥Á®≥
  const files = Array.from(fileList || []);

  for (const file of files) {
    const li = document.createElement('li');
    li.className = 'upload-item';

    const name = document.createElement('div');
    name.className = 'upload-name';
    name.textContent = file.name;

    const status = document.createElement('div');
    status.className = 'upload-status';
    status.textContent = 'ÂáÜÂ§á‰∏ä‰º†...';

    li.appendChild(name);
    li.appendChild(status);
    uploadList.appendChild(li);

    try {
      if (USE_MOCK) {
        status.textContent = '‰∏ä‰º†ÊàêÂäüÔºàmockÔºâ';
        status.classList.add('ok');

        const mockDoc = {
          id: 'doc_mock_' + Math.random().toString(16).slice(2, 8),
          name: file.name,
          kind: guessKindFromName(file.name),
          size_bytes: file.size,
          created_at: new Date().toISOString(),
          status: 'processing',
          preview_url: null,
          download_url: null
        };
        state.docs.unshift(mockDoc);
        applyFilter();
      } else {
        status.textContent = '‰∏ä‰º†‰∏≠...';

        // ÁîüÊàê job_idÔºàËã•ÂêéÁ´Ø‰∏çÈúÄË¶ÅÂèØÂøΩÁï•ÔºõËã•ÈúÄË¶ÅÂàôÈìæË∑ØËÉΩÁõ¥Êé•Ë∑ëÈÄöÔºâ
        const jobId = _uuidv4();

        // ÂÖàÂ∞ùËØï Worker /uploadÔºà‰∏é cloudrun_doc_job.py ÁöÑ upload/download Ë∑ØÁî±‰∏ÄËá¥Ôºâ
        try {
          const form = new FormData();
          form.append('file', file);

          // ‰∏éÂêéÁ´ØÁ∫¶ÂÆöÂ≠óÊÆµÔºàÊó†ÂàôÂêéÁ´ØÂèØÂøΩÁï•ÔºõÊúâÂàôÈìæË∑ØÁõ¥Êé•Èó≠ÁéØÔºâ
          form.append('job_id', jobId);
          form.append('file_role', 'input');
          form.append('file_type', guessKindFromName(file.name));
          form.append('original_name', file.name);

          const resp = await apiFetch('/upload', { method: 'POST', body: form });

          status.textContent = '‰∏ä‰º†ÊàêÂäü';
          status.classList.add('ok');

          // Á´ãÂç≥ÊèíÂÖ•‰∏ÄÊù°‚Äúprocessing‚ÄùÔºå‰øùÊåÅÁé∞Êúâ‰ΩìÈ™åÔºõÈöèÂêéÂà∑Êñ∞ÂàóË°®ÊãøÂêéÁ´ØÁúüÂÆûÊï∞ÊçÆ
          const newId = (resp && (resp.job_id || resp.id)) || jobId;

          state.docs.unshift({
            id: newId,
            name: file.name,
            kind: guessKindFromName(file.name),
            size_bytes: file.size,
            created_at: new Date().toISOString(),
            status: (resp && resp.status) || 'processing',
            preview_url: (resp && resp.preview_url) || null,
            download_url: (resp && resp.download_url) || null
          });
          // ===== [PATCH INSERT] keep local pending to avoid disappearing (non-breaking) =====
state.pendingUploads.unshift({
  id: newId,
  name: file.name,
  kind: guessKindFromName(file.name),
  size_bytes: file.size,
  created_at: new Date().toISOString(),
  status: (resp && resp.status) || 'processing',
  preview_url: (resp && resp.preview_url) || null,
  download_url: (resp && resp.download_url) || null
});
// ===== [PATCH END] =====

          applyFilter();

          // ===== [PATCH INSERT BEGIN] ensure doc appears + auto focus (non-breaking) =====
          // ÂÖàÊää‚ÄúÊú¨Âú∞Âç†‰ΩçÊù°ÁõÆ‚ÄùÈÄâ‰∏≠ÔºåËÆ©Áî®Êà∑Á´ãÂàªÂèØËßÅ
          selectDoc(newId);

          // ÂÜçËΩÆËØ¢Âà∑Êñ∞Âá†Ê¨°ÔºåÁ≠âÂæÖÂêéÁ´ØÂÖ•Â∫ì/ÂàóË°®‰∏ÄËá¥ÊÄßÂÆåÊàêÔºàÈÅøÂÖç‚Äú‰∏ä‰º†ÊàêÂäü‰ΩÜÂàóË°®ÈáåÊ≤°Êúâ‚ÄùÔºâ
          async function _pollRefreshUntilVisible(targetId, targetName) {
            const waits = [400, 800, 1200]; // ÊÄªËÆ°ÊúÄÂ§ö ~2.4sÔºåË∂≥Â§üË¶ÜÁõñÂ∏∏ËßÅÂÜôÂÖ•Âª∂Ëøü
            for (const ms of waits) {
              await new Promise(r => setTimeout(r, ms));
              try { await loadDocs(); } catch {}
              const hit = state.docs.find(d => d.id === targetId) ||
                          state.docs.find(d => (d.name || '').toLowerCase() === (targetName || '').toLowerCase());
              if (hit) {
                selectDoc(hit.id);
                return true;
              }
            }
            return false;
          }

          await _pollRefreshUntilVisible(newId, file.name);
          // ===== [PATCH INSERT END] ensure doc appears + auto focus (non-breaking) =====

        } catch (e1) {
          // ÈôçÁ∫ßÔºöÂÖºÂÆπÊóßÂÆûÁé∞ÔºàÂ¶ÇÊûúÂêéÁ´Ø‰ªçÁÑ∂Êèê‰æõ /v1/docsÔºâ
          const form2 = new FormData();
          form2.append('file', file);

          await apiFetch('/v1/docs', { method: 'POST', body: form2 });

          status.textContent = '‰∏ä‰º†ÊàêÂäü';
          status.classList.add('ok');

          await loadDocs();
        }
      }
    } catch (e) {
      console.error(e);
      status.textContent = 'Â§±Ë¥•Ôºö' + ((e && e.message) || e);
      status.classList.add('error');
      showToast('‰∏ä‰º†Â§±Ë¥•Ôºö' + file.name, 'error');
    }
  }
}


    function guessKindFromName(name) {
      const lower = (name || '').toLowerCase();
      if (lower.endsWith('.xlsx') || lower.endsWith('.xls')) return 'excel';
      if (lower.endsWith('.doc') || lower.endsWith('.docx')) return 'word';
      if (lower.endsWith('.pdf')) return 'pdf';
      return 'other';
    }

    // ============ Tab ÂàáÊç¢ ============

    function bindTabs() {
      const tabs = document.querySelectorAll('.tab-btn');
      const uploadSection = document.getElementById('uploadSection');
      const metaSection = document.getElementById('metaSection');
      const leftTitle = document.getElementById('cardLeftTitle');
      const leftSubtitle = document.getElementById('cardLeftSubtitle');

      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          tabs.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.dataset.tab;

          if (tab === 'upload') {
            uploadSection.style.display = '';
            metaSection.style.display = 'none';
            leftTitle.textContent = '‰∏ä‰º†ÊñáÊ°£';
            leftSubtitle.textContent = 'ÊîØÊåÅ Excel / Word / PDFÔºåÂ§öÊñá‰ª∂ÊãñÊãΩ‰∏ä‰º†„ÄÇ';
          } else if (tab === 'meta') {
            uploadSection.style.display = 'none';
            metaSection.style.display = '';
            leftTitle.textContent = 'ÊñáÊ°£ËØ¶ÊÉÖ';
            leftSubtitle.textContent = 'Â±ïÁ§∫ÂΩìÂâçÈÄâ‰∏≠ÊñáÊ°£ÁöÑÂÖÉ‰ø°ÊÅØÂíåÈìæÊé•„ÄÇ';
          } else {
            // preview tab ‰∏ªË¶ÅÂΩ±ÂìçÂè≥‰æßËØ¥ÊòéÔºå‰∏çÊîπÂèòÂ∑¶Âç°ÂÜÖÂÆπ
            uploadSection.style.display = '';
            metaSection.style.display = 'none';
            leftTitle.textContent = '‰∏ä‰º†ÊñáÊ°£';
            leftSubtitle.textContent = 'ÊîØÊåÅ Excel / Word / PDFÔºåÂ§öÊñá‰ª∂ÊãñÊãΩ‰∏ä‰º†„ÄÇ';
          }
        });
      });
    }

    // ============ ÂàùÂßãÂåñ ============

    function bindGlobalEvents() {
      document.getElementById('docList').addEventListener('click', e => {
        const item = e.target.closest('.doc-item');
        if (!item) return;
        selectDoc(item.dataset.id);
      });

      document.getElementById('searchInput').addEventListener('input', () => {
        applyFilter();
      });

      document.getElementById('btnNewUpload').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      document.getElementById('btnToggleMock').addEventListener('click', async () => {
        USE_MOCK = !USE_MOCK;
        const btn = document.getElementById('btnToggleMock');
        btn.style.opacity = USE_MOCK ? '1' : '0.6';
        showToast('Mock Ê®°ÂºèÔºö' + (USE_MOCK ? 'ÂºÄÂêØ' : 'ÂÖ≥Èó≠ÔºàÂ∞ÜÁõ¥Ëøû API_BASEÔºâ'));
        await refreshHealth();
        await loadDocs();
      });

      document.getElementById('btnOpenRaw').addEventListener('click', () => {
        const doc = getSelectedDoc();
        if (!doc) return;
        const url = doc.preview_url || doc.download_url;
        if (url) window.open(url, '_blank');
      });
    }

    // ===== [PATCH INSERT] unified preview actions handlers (non-breaking) =====
document.getElementById('btnDownloadRaw').addEventListener('click', () => {
  const doc = getSelectedDoc();
  if (!doc) return;
  const url = doc.download_url || doc.preview_url;
  if (url) window.open(url, '_blank');
});

document.getElementById('btnRefreshSelected').addEventListener('click', async () => {
  const cur = getSelectedDoc();
  await loadDocs();
  // Â∞ΩÈáè‰øùÁïôÂΩìÂâçÈÄâ‰∏≠
  if (cur && cur.id) selectDoc(cur.id);
});
// ===== [PATCH END] =====

// ===== [PATCH INSERT] sidebar scroll arrows logic (non-breaking) =====
(function initSidebarScrollArrows() {
  const list = document.getElementById('docList');
  const up = document.getElementById('btnScrollUp');
  const down = document.getElementById('btnScrollDown');
  if (!list || !up || !down) return;

  function refresh() {
    const max = list.scrollHeight - list.clientHeight;
    const y = list.scrollTop;

    // ÊúâÂèØÊªöÂä®ÂÜÖÂÆπÊâçÊòæÁ§∫
    const canScroll = max > 4;
    const showUp = canScroll && y > 6;
    const showDown = canScroll && y < max - 6;

    up.classList.toggle('show', !!showUp);
    down.classList.toggle('show', !!showDown);
  }

  up.addEventListener('click', () => {
    list.scrollBy({ top: -Math.max(120, list.clientHeight * 0.65), behavior: 'smooth' });
  });
  down.addEventListener('click', () => {
    list.scrollBy({ top: Math.max(120, list.clientHeight * 0.65), behavior: 'smooth' });
  });

  list.addEventListener('scroll', refresh, { passive: true });
  window.addEventListener('resize', refresh);

  // È¶ñÊ¨°Âà∑Êñ∞
  requestAnimationFrame(refresh);
})();
// ===== [PATCH END] =====

    async function bootstrap() {
      bindUploadZone();
      bindTabs();
      bindGlobalEvents();

      await refreshHealth();
      await loadDocs();
    }

    document.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</body>
</html>






