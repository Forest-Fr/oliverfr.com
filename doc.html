<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>Document Platform Console</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg-page: #0b1120;
      --bg-card: #020617;
      --bg-soft: #020617;
      --border-subtle: rgba(148, 163, 184, 0.3);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-strong: #0ea5e9;
      --danger: #ef4444;
      --success: #22c55e;
      --text-main: #e5e7eb;
      --text-sub: #9ca3af;
      --radius-lg: 16px;
      --radius-md: 10px;
      --shadow-card: 0 18px 45px rgba(15, 23, 42, 0.65);
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "PingFang SC", "Microsoft YaHei", sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%, #000 100%);
      color: var(--text-main);
    }

    body {
      display: flex;
      flex-direction: column;
    }

    /* é¡¶éƒ¨æ  */
    .topbar {
      padding: 10px 18px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
      backdrop-filter: blur(16px);
      background: linear-gradient(to bottom, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.75));
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #e0f2fe, #38bdf8 40%, #0f172a 80%);
      box-shadow: 0 0 0 1px rgba(148, 163, 184, 0.6),
                  0 0 25px rgba(56, 189, 248, 0.9);
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .title-block h1 {
      margin: 0;
      font-size: 18px;
      letter-spacing: 0.02em;
    }

    .title-block span {
      font-size: 11px;
      color: var(--text-sub);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .pill {
      border-radius: 999px;
      padding: 4px 10px;
      border: 1px solid var(--border-subtle);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(15, 23, 42, 0.85);
    }

    .status-dot {
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: #6b7280;
      box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .status-dot.ok {
      background: var(--success);
      box-shadow: 0 0 8px rgba(34, 197, 94, 0.9);
    }

    .status-dot.bad {
      background: var(--danger);
      box-shadow: 0 0 8px rgba(239, 68, 68, 0.9);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      padding: 6px 14px;
      color: var(--text-main);
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.15s ease-out;
    }

    .btn-primary {
      background: linear-gradient(to right, var(--accent), var(--accent-strong));
      border-color: transparent;
      color: #0f172a;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(56, 189, 248, 0.45);
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
    }

    .btn-primary:hover {
      box-shadow: 0 12px 28px rgba(56, 189, 248, 0.6);
    }

    .btn-icon {
      font-size: 14px;
    }

    /* ä¸»å¸ƒå±€ */
    .layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap: 14px;
      padding: 14px 18px 18px;
    }

    /* å·¦ä¾§åˆ—è¡¨ */
    .sidebar {
      background: radial-gradient(circle at top left, #020617 0, #020617 60%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-card);
      padding: 14px 14px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 0;
      /* ===== [PATCH INSERT] enable absolute children in sidebar (non-breaking) ===== */
position: relative;
/* ===== [PATCH END] ===== */

    }

    .sidebar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 4px;
    }

    .sidebar-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #9ca3af;
    }

    .tag-pill {
      border-radius: 999px;
      padding: 2px 8px;
      font-size: 10px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-sub);
    }

    .search-box {
      position: relative;
    }

    .search-box input {
      width: 100%;
      padding: 7px 10px 7px 24px;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
    }

    .search-box input::placeholder {
      color: #6b7280;
    }

    .search-box-icon {
      position: absolute;
      left: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 11px;
      color: #6b7280;
    }

    .doc-list {
      margin: 0;
      padding: 4px 0 0;
      list-style: none;
      flex: 1;
      overflow: auto;
            /* ===== [PATCH INSERT] make scrollbar visible (non-breaking) ===== */
      scrollbar-width: thin;                 /* Firefox */
      scrollbar-color: rgba(148,163,184,.55) transparent;

    }
    /* ===== [PATCH INSERT] webkit scrollbar (non-breaking) ===== */
    .doc-list::-webkit-scrollbar { width: 10px; }
    .doc-list::-webkit-scrollbar-thumb {
      background: rgba(148,163,184,.45);
      border-radius: 999px;
      border: 2px solid rgba(2,6,23,.8);
    }
    .doc-list::-webkit-scrollbar-track { background: transparent; }

    .doc-item {
      padding: 8px 8px;
      border-radius: 10px;
      margin-bottom: 4px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: background 0.12s ease-out, transform 0.12s ease-out;
    }

    .doc-item:hover {
      background: rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .doc-item.active {
      background: linear-gradient(to right, rgba(56, 189, 248, 0.2), rgba(15, 23, 42, 0.95));
      border: 1px solid rgba(56, 189, 248, 0.7);
    }

    .doc-icon {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      background: rgba(30, 64, 175, 0.6);
      color: #e5e7eb;
    }

    .doc-meta {
      flex: 1;
      overflow: hidden;
    }

    .doc-name {
      font-size: 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .doc-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .doc-status-pill {
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #9ca3af;
      white-space: nowrap;
    }

    .doc-status-pill.ready {
      border-color: rgba(34, 197, 94, 0.85);
      color: var(--success);
    }

    .doc-status-pill.processing {
      border-color: rgba(234, 179, 8, 0.9);
      color: #facc15;
    }

    /* å³ä¾§ä¸»ä½“ */
    .main {
      background: radial-gradient(circle at top right, #020617 0, #020617 60%, #020617 100%);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-card);
      padding: 14px 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      min-height: 0;
    }

    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
    }

    .main-title {
      font-size: 15px;
      font-weight: 600;
    }

    .main-subtitle {
      font-size: 12px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    .main-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .tab-bar {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(55, 65, 81, 0.9);
    }

    .tab-btn {
      border: none;
      background: transparent;
      color: var(--text-sub);
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      cursor: pointer;
    }

    .tab-btn.active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      font-weight: 600;
    }

    .main-body {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.2fr);
      gap: 12px;
      flex: 1;
      min-height: 0;
    }

    .card {
      border-radius: var(--radius-md);
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: rgba(15, 23, 42, 0.9);
      padding: 10px 11px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 500;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-sub);
    }

    .upload-zone {
      border-radius: 10px;
      border: 1px dashed rgba(75, 85, 99, 1);
      padding: 14px 10px;
      text-align: center;
      cursor: pointer;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.9), rgba(15, 23, 42, 0.95));
      transition: border-color 0.15s ease-out, background 0.15s ease-out;
    }

    .upload-zone.dragover {
      border-color: var(--accent);
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.8), rgba(8, 47, 73, 0.95));
    }

    .upload-main {
      font-size: 13px;
      margin-bottom: 4px;
    }

    .upload-sub {
      font-size: 11px;
      color: var(--text-sub);
    }

    .upload-zone input[type="file"] {
      display: none;
    }

    .upload-btn-row {
      margin-top: 10px;
      display: flex;
      justify-content: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .upload-list {
      margin: 6px 0 0;
      padding: 0;
      list-style: none;
      max-height: 140px;
      overflow: auto;
      font-size: 11px;
    }

    .upload-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 4px;
      border-radius: 6px;
      background: rgba(15, 23, 42, 0.8);
      margin-bottom: 3px;
    }

    .upload-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .upload-status {
      color: var(--text-sub);
      white-space: nowrap;
    }

    .upload-status.ok {
      color: var(--success);
    }

    .upload-status.error {
      color: var(--danger);
    }

    .preview-frame {
      flex: 1;
      border-radius: 8px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: radial-gradient(circle at top, #020617, #020617);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7280;
      font-size: 12px;
    }

    .preview-frame iframe {
      width: 100%;
      height: 100%;
      border: none;
      background: #fff;
    }

    .meta-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }

    .meta-table tr + tr {
      border-top: 1px solid rgba(31, 41, 55, 0.9);
    }

    .meta-table th,
    .meta-table td {
      padding: 5px 4px;
      text-align: left;
    }

    .meta-table th {
      width: 90px;
      color: var(--text-sub);
      font-weight: 400;
    }

    /* Toast */
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: var(--text-main);
      font-size: 12px;
      display: none;
      align-items: center;
      gap: 8px;
      z-index: 50;
      box-shadow: 0 15px 40px rgba(15, 23, 42, 0.8);
    }

    .toast.show {
      display: flex;
    }

    .toast.ok {
      border-color: rgba(34, 197, 94, 0.9);
    }

    .toast.error {
      border-color: rgba(239, 68, 68, 0.9);
    }

/* ===== [PATCH INSERT] sidebar scroll arrows (non-breaking) ===== */
.scroll-arrows {
  position: absolute;
  right: 10px;
  top: 92px;               /* é¿å¼€æ ‡é¢˜ä¸æœç´¢æ¡† */
  bottom: 12px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
  pointer-events: none;    /* å®¹å™¨ä¸åƒç‚¹å‡»ï¼Œåªè®©æŒ‰é’®åƒ */
  z-index: 5;
}

.scroll-btn {
  width: 34px;
  height: 34px;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.85);
  color: var(--text-main);
  display: inline-flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  pointer-events: auto;
  opacity: 0;
  transform: translateY(0);
  transition: opacity .15s ease-out, transform .15s ease-out;
  box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
}

.scroll-btn.show {
  opacity: 1;
}

.scroll-btn:active {
  transform: translateY(1px);
}

@media (max-width: 900px) {
  .scroll-arrows { top: 86px; }
}
/* ===== [PATCH END] ===== */

    
    /* ç§»åŠ¨ç«¯é€‚é… */
    @media (max-width: 900px) {
      .layout {
        grid-template-columns: 1fr;
        padding: 10px;
      }

      .sidebar {
        order: 2;
        height: 220px;
      }

      .main {
        order: 1;
      }

      .main-body {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>

  <header class="topbar">
    <div class="topbar-left">
      <div class="logo-dot"></div>
      <div class="title-block">
        <h1>Document Platform Console</h1>
        <span>ç»Ÿä¸€æ–‡æ¡£ä¸Šä¼  / é¢„è§ˆ / å¯¼å‡º Â· Cloud Run + Cloudflare Worker</span>
      </div>
    </div>
    <div class="topbar-right">
      <div class="pill">
        <span class="status-dot" id="healthDot"></span>
        <span id="healthText">Checking...</span>
      </div>
      <div class="pill">
        <span>ç¯å¢ƒ</span>
        <strong id="envLabel">prod</strong>
      </div>
      <button class="btn" id="btnToggleMock">
        <span class="btn-icon">ğŸ§ª</span>
        <span>Mock æ•°æ®</span>
      </button>
      <button class="btn-primary btn" id="btnNewUpload">
        <span class="btn-icon">ï¼‹</span>
        <span>ä¸Šä¼ æ–‡æ¡£</span>
      </button>
    </div>
  </header>

  <main class="layout">
    <!-- å·¦ä¾§ï¼šæ–‡æ¡£åˆ—è¡¨ -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-title">Documents</div>
        <div class="tag-pill" id="docCountTag">0 items</div>
      </div>

      <div class="search-box">
        <span class="search-box-icon">ğŸ”</span>
        <input type="search" id="searchInput" placeholder="æœç´¢æ–‡ä»¶å / ç±»å‹..." />
      </div>

      <ul class="doc-list" id="docList"></ul>

    <!-- ===== [PATCH INSERT] sidebar scroll arrows (non-breaking) ===== -->
<div class="scroll-arrows" aria-hidden="true">
  <button class="scroll-btn" id="btnScrollUp" title="å‘ä¸Š">â–²</button>
  <button class="scroll-btn" id="btnScrollDown" title="å‘ä¸‹">â–¼</button>
</div>
<!-- ===== [PATCH END] ===== -->
  
    </aside>

    <!-- å³ä¾§ï¼šä¸Šä¼  + é¢„è§ˆ + è¯¦æƒ… -->
    <section class="main">
      <div class="main-header">
        <div>
          <div class="main-title">æ–‡æ¡£å·¥ä½œå°</div>
          <div class="main-subtitle" id="mainSubtitle">
            å³ä¾§ä¸Šä¼ æ–‡ä»¶ï¼Œå·¦ä¾§æŸ¥çœ‹åˆ—è¡¨ï¼›åç«¯é€šè¿‡ Worker å†™å…¥ r1doc GCS æ¡¶ã€‚
          </div>
        </div>
        <div class="main-header-right">
          <div class="tab-bar">
            <button class="tab-btn active" data-tab="upload">ä¸Šä¼ </button>
            <button class="tab-btn" data-tab="preview">é¢„è§ˆ</button>
            <button class="tab-btn" data-tab="meta">è¯¦æƒ…</button>
          </div>
        </div>
      </div>

      <div class="main-body">
        <!-- å·¦ï¼šä¸Šä¼ åŒº / è¯¦æƒ…ï¼ˆéš tab åˆ‡æ¢ï¼‰ -->
        <div class="card" id="cardLeft">
          <div class="card-header">
            <div>
              <div class="card-title" id="cardLeftTitle">ä¸Šä¼ æ–‡æ¡£</div>
              <div class="card-subtitle" id="cardLeftSubtitle">
                æ”¯æŒ Excel / Word / PDF ç­‰å¸¸è§åŠå…¬æ–‡ä»¶ï¼Œå•æ–‡ä»¶æœ€å¤§å»ºè®® &lt; 20MBã€‚
              </div>
            </div>
          </div>

          <!-- Upload å†…å®¹ -->
          <div id="uploadSection">
            <div class="upload-zone" id="uploadZone">
              <div class="upload-main">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„ï¼Œæˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
              <div class="upload-sub">è‡ªåŠ¨å½’æ¡£åˆ°åç«¯çš„ r1doc GCS æ¡¶ Â· å¤šæ–‡ä»¶ä¸Šä¼ å¯æ‰¹é‡å¤„ç†</div>
              <div class="upload-btn-row">
                <label class="btn">
                  <span class="btn-icon">ğŸ“</span>
                  <span>é€‰æ‹©æ–‡ä»¶</span>
                  <input id="fileInput" type="file" multiple />
                </label>
              </div>
            </div>

            <ul class="upload-list" id="uploadList"></ul>
          </div>

          <!-- Meta å†…å®¹ï¼ˆtab åˆ‡æ¢æ˜¾ç¤ºï¼‰ -->
          <div id="metaSection" style="display:none;">
            <table class="meta-table">
              <tbody id="metaBody">
                <tr><th>æ–‡ä»¶å</th><td id="metaName">-</td></tr>
                <tr><th>ç±»å‹</th><td id="metaKind">-</td></tr>
                <tr><th>å¤§å°</th><td id="metaSize">-</td></tr>
                <tr><th>çŠ¶æ€</th><td id="metaStatus">-</td></tr>
                <tr><th>åˆ›å»ºæ—¶é—´</th><td id="metaCreated">-</td></tr>
                <tr><th>ä¸‹è½½åœ°å€</th><td id="metaDownload">-</td></tr>
                <tr><th>é¢„è§ˆåœ°å€</th><td id="metaPreview">-</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- å³ï¼šé¢„è§ˆ -->
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">æ–‡æ¡£é¢„è§ˆ</div>
              <div class="card-subtitle" id="previewSubtitle">
                é€‰æ‹©å·¦ä¾§åˆ—è¡¨ä¸­çš„æ–‡æ¡£åï¼Œåœ¨æ­¤å¤„è¿›è¡Œ PDF / Office åœ¨çº¿é¢„è§ˆï¼ˆç”±åç«¯ Worker æä¾›ï¼‰ã€‚
              </div>
            </div>
            <!-- ===== [PATCH INSERT] unified preview actions (non-breaking) ===== -->
<button class="btn" id="btnDownloadRaw" disabled>ä¸‹è½½</button>
<button class="btn" id="btnRefreshSelected" disabled>åˆ·æ–°</button>
<!-- ===== [PATCH END] ===== -->

            <button class="btn" id="btnOpenRaw" disabled>
              åœ¨æ–°çª—å£æ‰“å¼€
            </button>
          </div>
          <div class="preview-frame" id="previewFrame">
            <span id="previewPlaceholder">å°šæœªé€‰æ‹©ä»»ä½•æ–‡æ¡£ã€‚</span>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div class="toast" id="toast">
    <span id="toastIcon">â„¹ï¸</span>
    <span id="toastText">Message</span>
  </div>

  <script>
    // ============ åŸºç¡€é…ç½® ============

// 1) æ”¹æˆä½ çš„ Cloudflare Worker åœ°å€ï¼ˆä½ ç°åœ¨çš„ç›®æ ‡è”åŠ¨åç«¯ï¼‰
const API_BASE ='https://doc.mefans.workers.dev';

// å¯é€‰ï¼šå¦‚æœ Worker å¼€äº† API_KEY æ ¡éªŒï¼ˆenv.API_KEYï¼‰ï¼Œè¿™é‡Œå¡«åŒä¸€æŠŠ keyï¼ˆä¸å¡«åˆ™ä¿æŒç©ºå­—ç¬¦ä¸²ï¼‰
const API_KEY = '';

// 2) æ˜¯å¦ä½¿ç”¨å‰ç«¯ Mock æ•°æ®
// è§„åˆ™ï¼šæœ¬åœ°ï¼ˆlocalhost / fileï¼‰é»˜è®¤ Mockï¼›çº¿ä¸Šé»˜è®¤ç›´è¿åç«¯ï¼›å¯ç”¨ ?mock=1 å¼ºåˆ¶ Mock
const _qs = new URLSearchParams(location.search);
const _forceMock = _qs.get('mock') === '1';
const _forceLive = _qs.get('live') === '1';
const _isLocal = (location.protocol === 'file:') || /localhost|127\.0\.0\.1/i.test(location.hostname);

let USE_MOCK = _forceMock ? true : (_forceLive ? false : _isLocal);


    const state = {
      docs: [],
      filteredDocs: [],
      selectedDocId: null,
      pendingUploads: []
    };
// ===== [PATCH INSERT BEGIN] persist pending/docs selection (non-breaking) =====
const LS_PENDING_KEY = 'doc_platform_pending_uploads_v1';
const LS_SELECTED_KEY = 'doc_platform_selected_doc_id_v1';

function _safeJsonParse(s, fallback) {
  try { return JSON.parse(s); } catch { return fallback; }
}

function loadLocalState() {
  // pending uploadsï¼ˆç”¨äºâ€œä¸Šä¼ æˆåŠŸä½†åç«¯åˆ—è¡¨å»¶è¿Ÿ/å¤±è´¥â€æ—¶åˆ·æ–°ä¸ä¸¢ï¼‰
  const pending = _safeJsonParse(localStorage.getItem(LS_PENDING_KEY) || '[]', []);
  if (Array.isArray(pending)) state.pendingUploads = pending;

  // æ¢å¤ä¸Šæ¬¡é€‰ä¸­
  const sid = (localStorage.getItem(LS_SELECTED_KEY) || '').trim();
  if (sid) state.selectedDocId = sid;
}

function saveLocalState() {
  try {
    localStorage.setItem(LS_PENDING_KEY, JSON.stringify(state.pendingUploads || []));
    if (state.selectedDocId) localStorage.setItem(LS_SELECTED_KEY, String(state.selectedDocId));
  } catch {}
}
// ===== [PATCH INSERT END] persist pending/docs selection (non-breaking) =====

    // ============ å·¥å…·å‡½æ•° ============

    function showToast(message, type = 'info', timeout = 2600) {
      const toast = document.getElementById('toast');
      const textEl = document.getElementById('toastText');
      const iconEl = document.getElementById('toastIcon');

      textEl.textContent = message;
      toast.classList.remove('ok', 'error');
      if (type === 'ok') {
        toast.classList.add('ok');
        iconEl.textContent = 'âœ…';
      } else if (type === 'error') {
        toast.classList.add('error');
        iconEl.textContent = 'âš ï¸';
      } else {
        iconEl.textContent = 'â„¹ï¸';
      }

      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), timeout);
    }

    function formatBytes(bytes) {
      if (!bytes && bytes !== 0) return '-';
      const units = ['B', 'KB', 'MB', 'GB'];
      let b = Number(bytes);
      let u = 0;
      while (b >= 1024 && u < units.length - 1) {
        b /= 1024;
        u++;
      }
      return b.toFixed(1) + ' ' + units[u];
    }

    function formatTime(ts) {
      if (!ts) return '-';
      try {
        const d = new Date(ts);
        return d.toLocaleString('zh-CN', { hour12: false });
      } catch {
        return ts;
      }
    }

    // ç®€å• fetch å°è£…
    async function apiFetch(path, options = {}) {
      const url = API_BASE.replace(/\/$/, '') + path;
      const resp = await fetch(url, {
        ...options,
headers: {
  'Accept': 'application/json',
  ...(API_KEY ? { 'x-api-key': API_KEY } : {}),
  ...(options.headers || {})
}

      });
      const ct = resp.headers.get('content-type') || '';
      let body = null;
      if (ct.includes('application/json')) {
        body = await resp.json();
      } else {
        body = await resp.text();
      }

      if (!resp.ok) {
        const err = new Error('HTTP ' + resp.status);
        err.status = resp.status;
        err.body = body;
        throw err;
      }
      return body;
    }

    // ===== [PATCH BEGIN] robust helpers for live chain (non-breaking) =====
function _joinUrl(base, path) {
  const b = (base || '').replace(/\/+$/, '');
  const p = (path || '').startsWith('/') ? path : '/' + path;
  return b + p;
}

async function apiTry(paths, options = {}) {
  let lastErr = null;
  for (const p of paths) {
    try {
      return await apiFetch(p, options);
    } catch (e) {
      lastErr = e;
    }
  }
  throw lastErr || new Error('All endpoints failed');
}

function _uuidv4() {
  // ä¼˜å…ˆç”¨ crypto.randomUUIDï¼›ä¸æ”¯æŒåˆ™ fallback
  if (crypto && crypto.randomUUID) return crypto.randomUUID();
  const buf = new Uint8Array(16);
  crypto.getRandomValues(buf);
  buf[6] = (buf[6] & 0x0f) | 0x40;
  buf[8] = (buf[8] & 0x3f) | 0x80;
  const hex = [...buf].map(b => b.toString(16).padStart(2, '0')).join('');
  return `${hex.slice(0, 8)}-${hex.slice(8, 12)}-${hex.slice(12, 16)}-${hex.slice(16, 20)}-${hex.slice(20)}`;
}

function _inferKindFromAny(x) {
  const k = (x || '').toString().toLowerCase();
  if (k.includes('pdf')) return 'pdf';
  if (k.includes('word') || k.includes('doc')) return 'word';
  if (k.includes('excel') || k.includes('xls') || k.includes('sheet') || k.includes('csv')) return 'excel';
  return 'other';
}

// ===== [PATCH REPLACE BEGIN] _buildWorkerDownloadUrl: force inline + optional filename (non-breaking) =====
function _buildWorkerDownloadUrl(storagePath, opts = {}) {
  if (!storagePath) return null;

  const base = _joinUrl(API_BASE, '/download');
  const params = new URLSearchParams();
  params.set('key', storagePath);

  // å¼ºåˆ¶ inline=1ï¼šå¯¹ office viewer æ›´å‹å¥½ï¼ˆä½ åç«¯å·²æ”¯æŒï¼‰
  params.set('inline', '1');

  // å¯é€‰ï¼šæŠŠ filename å¸¦ä¸Šï¼ˆå³ä¾¿åç«¯æš‚æ—¶å¿½ç•¥ä¹Ÿæ— å‰¯ä½œç”¨ï¼›åç«¯æ”¯æŒåç«‹åˆ»ç”Ÿæ•ˆï¼‰
  if (opts && opts.filename) {
    params.set('filename', String(opts.filename));
  }

  return base + '?' + params.toString();
}
// ===== [PATCH REPLACE END] =====


function _normalizeDoc(raw) {
  const r = raw && typeof raw === 'object' ? raw : {};
  const files = Array.isArray(r.files) ? r.files : [];

  // ä¼˜å…ˆç”¨ input/output æ–‡ä»¶è¾…åŠ©è¡¥é½å­—æ®µ
  const inputFile = files.find(f => String(f?.file_role || '').toLowerCase() === 'input') || null;
  //const outputFile = files.find(f => String(f?.file_role || '').toLowerCase() === 'output') || null;

  // ===== [PATCH INSERT BEGIN] accept more output roles (non-breaking) =====
const _role = (f) => String(f?.file_role || '').toLowerCase();
const _ft = (f) => String(f?.file_type || f?.kind || '').toLowerCase();

// ä¼˜å…ˆæ‰¾â€œæ˜ç¡®çš„äº§ç‰©è§’è‰²â€ï¼Œå†é™çº§æ‰¾â€œé input çš„ç¬¬ä¸€ä¸ªæ–‡ä»¶â€ï¼Œæœ€åæ‰¾â€œpdf ç±»å‹æ–‡ä»¶â€
const outputFile =
  files.find(f => ['output', 'preview', 'render', 'rendered', 'converted', 'result'].includes(_role(f))) ||
  files.find(f => _role(f) && _role(f) !== 'input') ||
  files.find(f => _ft(f).includes('pdf')) ||
  null;
// ===== [PATCH INSERT END] accept more output roles (non-breaking) =====

  

  const id = r.id || r.job_id || r.doc_id || (r.job && r.job.id) || null;

  // ===== [PATCH INSERT BEGIN] prefer original filename for display (non-breaking) =====
  function _basenameLike(s) {
    const v = String(s || '');
    const noQuery = v.split('?')[0];
    const last = noQuery.split('/').pop();
    return (last || v || '').trim();
  }

  // ä¼˜å…ˆå±•ç¤ºâ€œç”¨æˆ·åŸå§‹æ–‡ä»¶åâ€ï¼Œé¿å…åç«¯ name=storage_path / uuid å¯¼è‡´åˆ—è¡¨çœ‹ä¸æ‡‚
  const name =
    _basenameLike(
      r.original_name ||
      r.filename ||
      inputFile?.original_name ||
      inputFile?.name ||
      r.name ||
      '(æ— åç§°)'
    );
  // ===== [PATCH INSERT END] prefer original filename for display (non-breaking) =====


  const kind =
    r.kind ||
    r.file_type ||
    inputFile?.file_type ||
    _inferKindFromAny(name);

  const sizeBytes =
    r.size_bytes ||
    r.size ||
    inputFile?.size_bytes ||
    inputFile?.size ||
    null;

  const createdAt =
    r.created_at ||
    r.inserted_at ||
    (r.job && r.job.created_at) ||
    inputFile?.created_at ||
    null;

  const status =
    r.status ||
    r.job_status ||
    (r.job && r.job.status) ||
    'unknown';

  // preview/download ä¼˜å…ˆç”¨åç«¯ç›´æ¥ç»™çš„ urlï¼›å¦åˆ™ç”¨ storage_path æ‹¼ Worker /download
  const previewUrl =
    r.preview_url ||
    r.previewUrl ||
    outputFile?.preview_url ||
    outputFile?.signed_url ||
    outputFile?.url ||
   // (outputFile?.storage_path ? _buildWorkerDownloadUrl(outputFile.storage_path) : null);
    (outputFile?.storage_path ? _buildWorkerDownloadUrl(outputFile.storage_path, { filename: name }) : null);


  const downloadUrl =
    r.download_url ||
    r.downloadUrl ||
    outputFile?.download_url ||
    outputFile?.signed_url ||
    outputFile?.url ||
   // (outputFile?.storage_path ? _buildWorkerDownloadUrl(outputFile.storage_path) : null);
    (inputFile?.storage_path ? _buildWorkerDownloadUrl(inputFile.storage_path, { filename: name }) : null);

// ===== [PATCH INSERT BEGIN] source_url fallback from input (non-breaking) =====
const sourceUrl =
  r.source_url ||
  r.sourceUrl ||
  inputFile?.signed_url ||
  inputFile?.url ||
  (inputFile?.storage_path ? _buildWorkerDownloadUrl(inputFile.storage_path) : null);
// ===== [PATCH INSERT END] source_url fallback from input (non-breaking) =====

  return {
    id,
    name,
    kind,
    size_bytes: sizeBytes,
    created_at: createdAt,
    status,
    preview_url: previewUrl,
    download_url: downloadUrl,
    source_url: sourceUrl,

    _raw: r
  };
}

function _normalizeDocsResponse(data) {
  // å…¼å®¹ï¼šArray / {docs:[]} / {items:[]} / {data:[]} / {jobs:[]} ç­‰
  let arr = [];
  if (Array.isArray(data)) arr = data;
  else if (data && typeof data === 'object') {
    if (Array.isArray(data.docs)) arr = data.docs;
    else if (Array.isArray(data.items)) arr = data.items;
    else if (Array.isArray(data.data)) arr = data.data;
    else if (Array.isArray(data.jobs)) arr = data.jobs;
    else if (Array.isArray(data.documents)) arr = data.documents;
  }
  return arr.map(_normalizeDoc).filter(d => d.id);
}
// ===== [PATCH END] =====
// ===== [PATCH INSERT] pending uploads merge (non-breaking) =====
function _sameName(a, b) {
  const x = String(a || '').trim().toLowerCase();
  const y = String(b || '').trim().toLowerCase();
  return x && y && x === y;
}

function _mergePendingIntoDocs(serverDocs) {
  const arr = Array.isArray(serverDocs) ? serverDocs.slice() : [];
  const byId = new Map(arr.map(d => [d.id, d]));

  // åªæŠŠâ€œä»æœªåœ¨æœåŠ¡ç«¯å‡ºç°â€çš„ pending åˆå¹¶å›å»
  const remain = [];
  for (const p of (state.pendingUploads || [])) {
    const hitById = p && p.id && byId.has(p.id);
    const hitByName = arr.some(s => _sameName(s?.name, p?.name));
    if (hitById || hitByName) {
      // æœåŠ¡ç«¯å·²å‡ºç°ï¼šä¸å†ä¿ç•™ pending
      continue;
    }
    remain.push(p);
    if (p && p.id && !byId.has(p.id)) {
      arr.unshift(p); // pending æ”¾æœ€å‰ï¼Œè®©ç”¨æˆ·ç«‹åˆ»çœ‹åˆ°
      byId.set(p.id, p);
    } else if (p && !p.id) {
      arr.unshift(p);
    }
  }

  state.pendingUploads = remain;
  return arr;
}
// ===== [PATCH END] =====


    // ============ Health æ£€æŸ¥ ============

async function refreshHealth() {
  const dot = document.getElementById('healthDot');
  const text = document.getElementById('healthText');

  dot.classList.remove('ok', 'bad');
  text.textContent = 'Checking...';

  try {
    let data;
    if (USE_MOCK) {
      data = { status: 'ok', env: 'dev', ts: new Date().toISOString() };
      await new Promise(r => setTimeout(r, 300));
    } else {
      data = await apiTry(['/health', '/healthz', '/'], { method: 'GET' });
    }
    dot.classList.add('ok');
    text.textContent = 'Healthy Â· ' + (data.env || 'unknown');
    document.getElementById('envLabel').textContent = data.env || 'prod';
  } catch (e) {
    dot.classList.add('bad');
    text.textContent = 'Unhealthy';
    showToast('Health æ£€æŸ¥å¤±è´¥ï¼š' + (e.message || e), 'error');
  }
}


    // ============ Mock æ•°æ® ============

    function buildMockDocs() {
      const now = new Date();
      const iso = (offsetMin) => new Date(now.getTime() - offsetMin * 60000).toISOString();

      return [
        {
          id: 'doc_mock_001',
          name: 'ç¤ºä¾‹æŠ¥è¡¨-å­£åº¦æ”¶å…¥.xlsx',
          kind: 'excel',
          size_bytes: 234567,
          created_at: iso(10),
          status: 'ready',
          preview_url: 'https://example.com/preview/mock1',
          download_url: 'https://example.com/download/mock1'
        },
        {
          id: 'doc_mock_002',
          name: 'SLA-æœåŠ¡åè®®-v1.2.docx',
          kind: 'word',
          size_bytes: 145678,
          created_at: iso(60),
          status: 'processing',
          preview_url: null,
          download_url: 'https://example.com/download/mock2'
        },
        {
          id: 'doc_mock_003',
          name: 'å¹³å°æ€»ä½“æ¶æ„å›¾.pdf',
          kind: 'pdf',
          size_bytes: 756231,
          created_at: iso(180),
          status: 'ready',
          preview_url: 'https://example.com/preview/mock3',
          download_url: 'https://example.com/download/mock3'
        }
      ];
    }

async function loadDocs() {
  let docs;
  if (USE_MOCK) {
    docs = buildMockDocs();
    state.docs = docs;
    applyFilter();
    // ===== [PATCH INSERT] persist pending after list refresh (non-breaking) =====
saveLocalState();
// ===== [PATCH END] =====

    return;
  }

  // Liveï¼šå°è¯•å¤šä¸ªå¯èƒ½çš„ Worker åˆ—è¡¨ç«¯ç‚¹ï¼ˆé¿å…åç«¯è·¯å¾„å˜åŠ¨å¯¼è‡´å‰ç«¯ä¸å¯ç”¨ï¼‰
  const data = await apiTry(
    ['/v1/docs', '/docs', '/v1/doc-jobs', '/api/doc-jobs', '/v1/doc-files', '/api/doc-files'],
    { method: 'GET' }
  );

const serverDocs = _normalizeDocsResponse(data);
state.docs = _mergePendingIntoDocs(serverDocs);
applyFilter();

}


    function applyFilter() {
      const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
      let list = state.docs;
      if (q) {
        list = list.filter(d => (d.name || '').toLowerCase().includes(q));
      }
      state.filteredDocs = list;
      renderDocList();
    }

    function renderDocList() {
      const ul = document.getElementById('docList');
      ul.innerHTML = '';
      const countTag = document.getElementById('docCountTag');
      countTag.textContent = state.filteredDocs.length + ' items';

      state.filteredDocs.forEach(doc => {
        const li = document.createElement('li');
        li.className = 'doc-item' + (doc.id === state.selectedDocId ? ' active' : '');
        li.dataset.id = doc.id;

        const icon = document.createElement('div');
        icon.className = 'doc-icon';
        const k = (doc.kind || '?').substring(0, 1).toUpperCase();
        icon.textContent = k;

        const meta = document.createElement('div');
        meta.className = 'doc-meta';

        const name = document.createElement('div');
        name.className = 'doc-name';
        name.textContent = doc.name || '(æ— åç§°)';

        const sub = document.createElement('div');
        sub.className = 'doc-sub';
        sub.textContent = (doc.kind || '-') + ' Â· ' + formatBytes(doc.size_bytes) + ' Â· ' + formatTime(doc.created_at);

        meta.appendChild(name);
        meta.appendChild(sub);

        const status = document.createElement('div');
        status.className = 'doc-status-pill ' + (doc.status || '');
        status.textContent = doc.status || '-';

        li.appendChild(icon);
        li.appendChild(meta);
        li.appendChild(status);
        ul.appendChild(li);
      });
    }

    function getSelectedDoc() {
      return state.docs.find(d => d.id === state.selectedDocId) || null;
    }

    function selectDoc(docId) {
      state.selectedDocId = docId;
      renderDocList();
      updateMetaPanel();
      updatePreviewPanel();
      // ===== [PATCH INSERT] persist selected id (non-breaking) =====
saveLocalState();
// ===== [PATCH END] =====

        // ===== [PATCH INSERT BEGIN] auto scroll selected item into view (non-breaking) =====
  requestAnimationFrame(() => {
    const li = document.querySelector(`.doc-item[data-id="${CSS && CSS.escape ? CSS.escape(docId) : docId}"]`);
    if (li && li.scrollIntoView) li.scrollIntoView({ block: 'nearest', inline: 'nearest' });
  });
  // ===== [PATCH INSERT END] auto scroll selected item into view (non-breaking) =====

    }

    function updateMetaPanel() {
      const doc = getSelectedDoc();
      document.getElementById('metaName').textContent = doc ? doc.name : '-';
      document.getElementById('metaKind').textContent = doc ? doc.kind : '-';
      document.getElementById('metaSize').textContent = doc ? formatBytes(doc.size_bytes) : '-';
      document.getElementById('metaStatus').textContent = doc ? doc.status : '-';
      document.getElementById('metaCreated').textContent = doc ? formatTime(doc.created_at) : '-';

      const downloadEl = document.getElementById('metaDownload');
      const previewEl = document.getElementById('metaPreview');
      //downloadEl.textContent = doc && doc.download_url ? doc.download_url : '-';
      //previewEl.textContent = doc && doc.preview_url ? doc.preview_url : '-';
      downloadEl.innerHTML = (doc && doc.download_url)
  ? `<a href="${doc.download_url}" target="_blank" rel="noopener noreferrer">${doc.download_url}</a>`
  : '-';

previewEl.innerHTML = (doc && doc.preview_url)
  ? `<a href="${doc.preview_url}" target="_blank" rel="noopener noreferrer">${doc.preview_url}</a>`
  : '-';

    }

    function updatePreviewPanel() {
      const frame = document.getElementById('previewFrame');
      frame.innerHTML = '';
      const btnOpen = document.getElementById('btnOpenRaw');
const btnDownload = document.getElementById('btnDownloadRaw');
const btnRefresh = document.getElementById('btnRefreshSelected');

      const doc = getSelectedDoc();
      if (!doc) {
        const span = document.createElement('span');
        span.id = 'previewPlaceholder';
        span.textContent = 'å°šæœªé€‰æ‹©ä»»ä½•æ–‡æ¡£ã€‚';
        frame.appendChild(span);
        btnOpen.disabled = true;
        btnDownload.disabled = true;
btnRefresh.disabled = true;

        return;
      }

      // ===== [PATCH INSERT BEGIN] preview iframe for pdf + office (non-breaking) =====
      function _isPdfUrl(u) {
        try {
          const clean = String(u || '').split('?')[0].toLowerCase();
          return clean.endsWith('.pdf');
        } catch { return false; }
      }

      function _buildOfficeEmbedUrl(rawUrl) {
        // Office åœ¨çº¿é¢„è§ˆå¿…é¡»ç”¨å¯å…¬ç½‘è®¿é—®çš„æ–‡ä»¶ URLï¼›è¿™é‡Œç”¨ MS Office Viewer embed
        return 'https://view.officeapps.live.com/op/embed.aspx?src=' + encodeURIComponent(rawUrl);
      }
// ===== [PATCH INSERT BEGIN] office preview helpers (non-breaking) =====
function _isOfficeEmbed(u) {
  return String(u || '').includes('view.officeapps.live.com');
}

function _ensureInlineWorkerDownload(u) {
  try {
    const s = String(u || '');
    if (!s) return s;
    // åªå¯¹ä½ çš„ Worker ä¸‹è½½é“¾æ¥è¡¥ inline=1ï¼ˆä¸é‡å¤æ·»åŠ ï¼‰
    if (s.startsWith(API_BASE) && (s.includes('/download?') || s.includes('/file?'))) {
      const url = new URL(s);
      if (!url.searchParams.get('inline')) url.searchParams.set('inline', '1');
      return url.toString();
    }
    return s;
  } catch {
    return u;
  }
}
// ===== [PATCH INSERT END] office preview helpers (non-breaking) =====

const urlForPreview = doc.preview_url || null;
const urlForDownload = doc.download_url || null;
const urlForSource = doc.source_url || null;

// å…³é”®ï¼šOffice é¢„è§ˆä¸€å®šè¦ç”¨â€œåŸå§‹ docx/xlsx çš„ raw URLâ€ï¼Œè€Œä¸æ˜¯ pdf/å…¶å®ƒäº§ç‰©
let officeRaw = urlForDownload || urlForSource || urlForPreview || null;
officeRaw = _ensureInlineWorkerDownload(officeRaw);

if (urlForPreview) {
  const iframe = document.createElement('iframe');

  const isPdf = (doc.kind === 'pdf') || _isPdfUrl(urlForPreview);
  const isOffice = (doc.kind === 'word' || doc.kind === 'excel');

  // å·²æ˜¯ office embed æˆ– pdfï¼šç›´æ¥ç”¨
  if (isPdf || _isOfficeEmbed(urlForPreview)) {
    iframe.src = urlForPreview;
  } else if (isOffice) {
    // Officeï¼šå¼ºåˆ¶ç”¨ rawï¼ˆä¼˜å…ˆ download/sourceï¼‰ï¼Œé¿å… preview_url æŒ‡å‘ pdf/html å¯¼è‡´å¤±è´¥
    iframe.src = _buildOfficeEmbedUrl(officeRaw || urlForPreview);
  } else {
    iframe.src = urlForPreview;
  }

  frame.appendChild(iframe);

} else if (urlForDownload) {
  const iframe = document.createElement('iframe');

  if (doc.kind === 'pdf' || _isPdfUrl(urlForDownload)) {
    iframe.src = _ensureInlineWorkerDownload(urlForDownload);
    frame.appendChild(iframe);
  } else if (doc.kind === 'word' || doc.kind === 'excel') {
    iframe.src = _buildOfficeEmbedUrl(_ensureInlineWorkerDownload(urlForDownload));
    frame.appendChild(iframe);
  } else {
    const span = document.createElement('span');
    span.textContent = 'è¯¥æ–‡ä»¶ç±»å‹æš‚ä¸æ”¯æŒå†…åµŒé¢„è§ˆï¼Œå¯ç‚¹å‡»å³ä¸Šè§’åœ¨æ–°çª—å£æ‰“å¼€ã€‚';
    frame.appendChild(span);
  }

} else if (urlForSource && (doc.kind === 'word' || doc.kind === 'excel')) {
  const iframe = document.createElement('iframe');
  iframe.src = _buildOfficeEmbedUrl(_ensureInlineWorkerDownload(urlForSource));
  frame.appendChild(iframe);

} else if (urlForSource && (doc.kind === 'pdf')) {
  const iframe = document.createElement('iframe');
  iframe.src = _ensureInlineWorkerDownload(urlForSource);
  frame.appendChild(iframe);

} else {
  const span = document.createElement('span');
  span.textContent = 'è¯¥æ–‡æ¡£å°šæœªç”Ÿæˆé¢„è§ˆï¼Œè¯·ç¨ååˆ·æ–°ã€‚';
  frame.appendChild(span);
}


      // ===== [PATCH INSERT END] preview iframe for pdf + office (non-breaking) =====


   //const hasLink = !!(doc.preview_url || doc.download_url);
      const hasLink = !!(doc.preview_url || doc.download_url || doc.source_url);

btnOpen.disabled = !hasLink;
btnDownload.disabled = !hasLink;
btnRefresh.disabled = !doc; // é€‰ä¸­æ–‡æ¡£å³å¯åˆ·æ–°

    }

    // ============ ä¸Šä¼ é€»è¾‘ï¼ˆå‰ç«¯å ä½ï¼Œåç«¯å®ç°åç›´æ¥æ‰“é€šï¼‰ ============

    function bindUploadZone() {
      const zone = document.getElementById('uploadZone');
      const fileInput = document.getElementById('fileInput');

      function openFileDialog() {
        fileInput.click();
      }

   // ===== [PATCH INSERT BEGIN] prevent double-trigger file dialog (non-breaking) =====
zone.addEventListener('click', (e) => {
  // ç‚¹å‡»å†…éƒ¨ label / input / button æ—¶ï¼Œä¸å†è®© zone å†æ¬¡è§¦å‘ fileInput.click()
  if (e.target && e.target.closest && (
    e.target.closest('label') ||
    e.target.closest('input[type="file"]') ||
    e.target.closest('button') ||
    e.target.closest('a')
  )) {
    return;
  }
  openFileDialog();
});

// é¢å¤–å…œåº•ï¼šlabel è‡ªèº«ç‚¹å‡»æ—¶é˜»æ­¢å†’æ³¡ï¼Œå½»åº•é¿å…â€œç‚¹ä¸€æ¬¡è§¦å‘ä¸¤æ¬¡â€
try {
  const _label = zone.querySelector('label');
  if (_label) _label.addEventListener('click', (ev) => ev.stopPropagation());
} catch {}
// ===== [PATCH INSERT END] prevent double-trigger file dialog (non-breaking) =====


      ;['dragenter', 'dragover'].forEach(ev => {
        zone.addEventListener(ev, e => {
          e.preventDefault();
          e.stopPropagation();
          zone.classList.add('dragover');
        });
      });

      ;['dragleave', 'drop'].forEach(ev => {
        zone.addEventListener(ev, e => {
          e.preventDefault();
          e.stopPropagation();
          zone.classList.remove('dragover');
        });
      });

      zone.addEventListener('drop', e => {
        const files = e.dataTransfer.files;
        if (files && files.length) {
          handleFiles(files);
        }
      });

      fileInput.addEventListener('change', () => {
        if (fileInput.files && fileInput.files.length) {
          handleFiles(fileInput.files);
          fileInput.value = '';
        }
      });
    }

async function handleFiles(fileList) {
  const uploadList = document.getElementById('uploadList');

  // FileList åœ¨ç°ä»£æµè§ˆå™¨å¯è¿­ä»£ï¼›è¿™é‡Œè½¬æ•°ç»„æ›´ç¨³
  const files = Array.from(fileList || []);

  for (const file of files) {
    const li = document.createElement('li');
    li.className = 'upload-item';

    const name = document.createElement('div');
    name.className = 'upload-name';
    name.textContent = file.name;

    const status = document.createElement('div');
    status.className = 'upload-status';
    status.textContent = 'å‡†å¤‡ä¸Šä¼ ...';

    li.appendChild(name);
    li.appendChild(status);
    uploadList.appendChild(li);

    try {
      if (USE_MOCK) {
        status.textContent = 'ä¸Šä¼ æˆåŠŸï¼ˆmockï¼‰';
        status.classList.add('ok');

        const mockDoc = {
          id: 'doc_mock_' + Math.random().toString(16).slice(2, 8),
          name: file.name,
          kind: guessKindFromName(file.name),
          size_bytes: file.size,
          created_at: new Date().toISOString(),
          status: 'processing',
          preview_url: null,
          download_url: null
        };
        state.docs.unshift(mockDoc);
        applyFilter();
      } else {
        status.textContent = 'ä¸Šä¼ ä¸­...';

        // ç”Ÿæˆ job_idï¼ˆè‹¥åç«¯ä¸éœ€è¦å¯å¿½ç•¥ï¼›è‹¥éœ€è¦åˆ™é“¾è·¯èƒ½ç›´æ¥è·‘é€šï¼‰
        const jobId = _uuidv4();

        // å…ˆå°è¯• Worker /uploadï¼ˆä¸ cloudrun_doc_job.py çš„ upload/download è·¯ç”±ä¸€è‡´ï¼‰
        try {
          const form = new FormData();
          form.append('file', file);

          // ä¸åç«¯çº¦å®šå­—æ®µï¼ˆæ— åˆ™åç«¯å¯å¿½ç•¥ï¼›æœ‰åˆ™é“¾è·¯ç›´æ¥é—­ç¯ï¼‰
          form.append('job_id', jobId);
          form.append('file_role', 'input');
          form.append('file_type', guessKindFromName(file.name));
          form.append('original_name', file.name);

          const resp = await apiFetch('/upload', { method: 'POST', body: form });

          status.textContent = 'ä¸Šä¼ æˆåŠŸ';
          status.classList.add('ok');

          // ç«‹å³æ’å…¥ä¸€æ¡â€œprocessingâ€ï¼Œä¿æŒç°æœ‰ä½“éªŒï¼›éšååˆ·æ–°åˆ—è¡¨æ‹¿åç«¯çœŸå®æ•°æ®
          const newId = (resp && (resp.job_id || resp.id)) || jobId;

          state.docs.unshift({
            id: newId,
            name: file.name,
            kind: guessKindFromName(file.name),
            size_bytes: file.size,
            created_at: new Date().toISOString(),
            status: (resp && resp.status) || 'processing',
            preview_url: (resp && resp.preview_url) || null,
            download_url: (resp && resp.download_url) || null
          });
          // ===== [PATCH INSERT] keep local pending to avoid disappearing (non-breaking) =====
state.pendingUploads.unshift({
  id: newId,
  name: file.name,
  kind: guessKindFromName(file.name),
  size_bytes: file.size,
  created_at: new Date().toISOString(),
  status: (resp && resp.status) || 'processing',
  preview_url: (resp && resp.preview_url) || null,
  download_url: (resp && resp.download_url) || null
});
// ===== [PATCH END] =====

          applyFilter();
// ===== [PATCH INSERT] persist pending immediately (non-breaking) =====
saveLocalState();
// ===== [PATCH END] =====

          // ===== [PATCH INSERT BEGIN] ensure doc appears + auto focus (non-breaking) =====
          // å…ˆæŠŠâ€œæœ¬åœ°å ä½æ¡ç›®â€é€‰ä¸­ï¼Œè®©ç”¨æˆ·ç«‹åˆ»å¯è§
          selectDoc(newId);

          // å†è½®è¯¢åˆ·æ–°å‡ æ¬¡ï¼Œç­‰å¾…åç«¯å…¥åº“/åˆ—è¡¨ä¸€è‡´æ€§å®Œæˆï¼ˆé¿å…â€œä¸Šä¼ æˆåŠŸä½†åˆ—è¡¨é‡Œæ²¡æœ‰â€ï¼‰
          async function _pollRefreshUntilVisible(targetId, targetName) {
            const waits = [400, 800, 1200]; // æ€»è®¡æœ€å¤š ~2.4sï¼Œè¶³å¤Ÿè¦†ç›–å¸¸è§å†™å…¥å»¶è¿Ÿ
            for (const ms of waits) {
              await new Promise(r => setTimeout(r, ms));
              try { await loadDocs(); } catch {}
              const hit = state.docs.find(d => d.id === targetId) ||
                          state.docs.find(d => (d.name || '').toLowerCase() === (targetName || '').toLowerCase());
              if (hit) {
                selectDoc(hit.id);
                return true;
              }
            }
            return false;
          }

          await _pollRefreshUntilVisible(newId, file.name);
          // ===== [PATCH INSERT END] ensure doc appears + auto focus (non-breaking) =====

        } catch (e1) {
          // é™çº§ï¼šå…¼å®¹æ—§å®ç°ï¼ˆå¦‚æœåç«¯ä»ç„¶æä¾› /v1/docsï¼‰
          const form2 = new FormData();
          form2.append('file', file);

          await apiFetch('/v1/docs', { method: 'POST', body: form2 });

          status.textContent = 'ä¸Šä¼ æˆåŠŸ';
          status.classList.add('ok');

          await loadDocs();
        }
      }
    } catch (e) {
      console.error(e);
      status.textContent = 'å¤±è´¥ï¼š' + ((e && e.message) || e);
      status.classList.add('error');
      showToast('ä¸Šä¼ å¤±è´¥ï¼š' + file.name, 'error');
    }
  }
}


    function guessKindFromName(name) {
      const lower = (name || '').toLowerCase();
      if (lower.endsWith('.xlsx') || lower.endsWith('.xls')) return 'excel';
      if (lower.endsWith('.doc') || lower.endsWith('.docx')) return 'word';
      if (lower.endsWith('.pdf')) return 'pdf';
      return 'other';
    }

    // ============ Tab åˆ‡æ¢ ============

    function bindTabs() {
      const tabs = document.querySelectorAll('.tab-btn');
      const uploadSection = document.getElementById('uploadSection');
      const metaSection = document.getElementById('metaSection');
      const leftTitle = document.getElementById('cardLeftTitle');
      const leftSubtitle = document.getElementById('cardLeftSubtitle');

      tabs.forEach(btn => {
        btn.addEventListener('click', () => {
          tabs.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          const tab = btn.dataset.tab;

          if (tab === 'upload') {
            uploadSection.style.display = '';
            metaSection.style.display = 'none';
            leftTitle.textContent = 'ä¸Šä¼ æ–‡æ¡£';
            leftSubtitle.textContent = 'æ”¯æŒ Excel / Word / PDFï¼Œå¤šæ–‡ä»¶æ‹–æ‹½ä¸Šä¼ ã€‚';
          } else if (tab === 'meta') {
            uploadSection.style.display = 'none';
            metaSection.style.display = '';
            leftTitle.textContent = 'æ–‡æ¡£è¯¦æƒ…';
            leftSubtitle.textContent = 'å±•ç¤ºå½“å‰é€‰ä¸­æ–‡æ¡£çš„å…ƒä¿¡æ¯å’Œé“¾æ¥ã€‚';
          } else {
            // preview tab ä¸»è¦å½±å“å³ä¾§è¯´æ˜ï¼Œä¸æ”¹å˜å·¦å¡å†…å®¹
            uploadSection.style.display = '';
            metaSection.style.display = 'none';
            leftTitle.textContent = 'ä¸Šä¼ æ–‡æ¡£';
            leftSubtitle.textContent = 'æ”¯æŒ Excel / Word / PDFï¼Œå¤šæ–‡ä»¶æ‹–æ‹½ä¸Šä¼ ã€‚';
          }
        });
      });
    }

    // ============ åˆå§‹åŒ– ============

    function bindGlobalEvents() {
      document.getElementById('docList').addEventListener('click', e => {
        const item = e.target.closest('.doc-item');
        if (!item) return;
        selectDoc(item.dataset.id);
      });

      document.getElementById('searchInput').addEventListener('input', () => {
        applyFilter();
      });

      document.getElementById('btnNewUpload').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });

      document.getElementById('btnToggleMock').addEventListener('click', async () => {
        USE_MOCK = !USE_MOCK;
        const btn = document.getElementById('btnToggleMock');
        btn.style.opacity = USE_MOCK ? '1' : '0.6';
        showToast('Mock æ¨¡å¼ï¼š' + (USE_MOCK ? 'å¼€å¯' : 'å…³é—­ï¼ˆå°†ç›´è¿ API_BASEï¼‰'));
        await refreshHealth();
        await loadDocs();
      });

      document.getElementById('btnOpenRaw').addEventListener('click', () => {
        const doc = getSelectedDoc();
        if (!doc) return;
        //const url = doc.preview_url || doc.download_url;
        const url = doc.preview_url || doc.download_url || doc.source_url;

        if (url) window.open(url, '_blank');
      });
    }

    // ===== [PATCH INSERT] unified preview actions handlers (non-breaking) =====
document.getElementById('btnDownloadRaw').addEventListener('click', () => {
  const doc = getSelectedDoc();
  if (!doc) return;
  //const url = doc.download_url || doc.preview_url;
  const url = doc.download_url || doc.preview_url || doc.source_url;

  if (url) window.open(url, '_blank');
});

document.getElementById('btnRefreshSelected').addEventListener('click', async () => {
  const cur = getSelectedDoc();
  await loadDocs();
  // å°½é‡ä¿ç•™å½“å‰é€‰ä¸­
  if (cur && cur.id) selectDoc(cur.id);
});
// ===== [PATCH END] =====

// ===== [PATCH INSERT] sidebar scroll arrows logic (non-breaking) =====
(function initSidebarScrollArrows() {
  const list = document.getElementById('docList');
  const up = document.getElementById('btnScrollUp');
  const down = document.getElementById('btnScrollDown');
  if (!list || !up || !down) return;

  function refresh() {
    const max = list.scrollHeight - list.clientHeight;
    const y = list.scrollTop;

    // æœ‰å¯æ»šåŠ¨å†…å®¹æ‰æ˜¾ç¤º
    const canScroll = max > 4;
    const showUp = canScroll && y > 6;
    const showDown = canScroll && y < max - 6;

    up.classList.toggle('show', !!showUp);
    down.classList.toggle('show', !!showDown);
  }

  up.addEventListener('click', () => {
    list.scrollBy({ top: -Math.max(120, list.clientHeight * 0.65), behavior: 'smooth' });
  });
  down.addEventListener('click', () => {
    list.scrollBy({ top: Math.max(120, list.clientHeight * 0.65), behavior: 'smooth' });
  });

  list.addEventListener('scroll', refresh, { passive: true });
  window.addEventListener('resize', refresh);

  // é¦–æ¬¡åˆ·æ–°
  requestAnimationFrame(refresh);
})();
// ===== [PATCH END] =====

    async function bootstrap() {
      bindUploadZone();
      bindTabs();
      bindGlobalEvents();
// ===== [PATCH INSERT BEGIN] restore local state before first load (non-breaking) =====
loadLocalState();
// å…ˆæŠŠæœ¬åœ° pending åˆå¹¶æ¸²æŸ“å‡ºæ¥ï¼ˆå³ä¾¿åç«¯æš‚æ—¶ä¸å¯ç”¨ï¼Œä¹Ÿä¸ç©ºï¼‰
if (Array.isArray(state.pendingUploads) && state.pendingUploads.length) {
  state.docs = _mergePendingIntoDocs([]);
  applyFilter();
}
// ===== [PATCH INSERT END] restore local state before first load (non-breaking) =====

      await refreshHealth();
      await loadDocs();
    }

    document.addEventListener('DOMContentLoaded', bootstrap);
  </script>
</body>
</html>









